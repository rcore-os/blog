<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">
  
  <link rel="stylesheet" href="/blog/lib/animate-css/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rcore-os.github.io","root":"/blog/","scheme":"Muse","version":"8.0.0-rc.4","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}}};
  </script>

  <meta name="description" content="总结报告很高兴参加第三阶段ArceOS Unikernel的课程学习与训练，经过第三阶段的学习，让我对rust、unikernel、linux等都有了更深入的理解。经过这些实验与练习，提升了我对rust语言的理解，感受到rust的条件编译的强大。学习了ArceOS的层次结构、模块化设计理念，让我对Unikernel的概念有了更具象化的理解。十分感谢石磊老师的细心讲解、助教老师孙应娥的热心帮忙以及群">
<meta property="og:type" content="article">
<meta property="og:title" content="2023开源操作系统训练营第三阶段总结报告-ChenDe">
<meta property="og:url" content="http://rcore-os.github.io/blog/2023/11/30/2023%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-ChenDe/index.html">
<meta property="og:site_name" content="rcore-os Blog">
<meta property="og:description" content="总结报告很高兴参加第三阶段ArceOS Unikernel的课程学习与训练，经过第三阶段的学习，让我对rust、unikernel、linux等都有了更深入的理解。经过这些实验与练习，提升了我对rust语言的理解，感受到rust的条件编译的强大。学习了ArceOS的层次结构、模块化设计理念，让我对Unikernel的概念有了更具象化的理解。十分感谢石磊老师的细心讲解、助教老师孙应娥的热心帮忙以及群">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-11-30T10:25:00.000Z">
<meta property="article:modified_time" content="2025-05-15T07:29:16.681Z">
<meta property="article:author" content="rcore-os Group">
<meta property="article:tag" content="2023秋冬季开源操作系统训练营">
<meta property="article:tag" content="第三阶段总结报告">
<meta property="article:tag" content="author:chiiydd">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://rcore-os.github.io/blog/2023/11/30/2023%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-ChenDe/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>2023开源操作系统训练营第三阶段总结报告-ChenDe | rcore-os Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">rcore-os Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#总结报告"><span class="nav-number">1.</span> <span class="nav-text">总结报告</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#第一周练习"><span class="nav-number">1.1.</span> <span class="nav-text">第一周练习</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#练习-1-amp-2"><span class="nav-number">1.1.1.</span> <span class="nav-text">练习 1 &amp;2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习3"><span class="nav-number">1.1.2.</span> <span class="nav-text">练习3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习5"><span class="nav-number">1.1.3.</span> <span class="nav-text">练习5</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二周练习"><span class="nav-number">1.2.</span> <span class="nav-text">第二周练习</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#练习1-amp-2"><span class="nav-number">1.2.1.</span> <span class="nav-text">练习1&amp;2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习3-1"><span class="nav-number">1.2.2.</span> <span class="nav-text">练习3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习4"><span class="nav-number">1.2.3.</span> <span class="nav-text">练习4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习5-1"><span class="nav-number">1.2.4.</span> <span class="nav-text">练习5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习6"><span class="nav-number">1.2.5.</span> <span class="nav-text">练习6</span></a></li></ol></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rcore-os Group</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">618</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">559</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content post posts-expand">
          

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2023/11/30/2023%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-ChenDe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          2023开源操作系统训练营第三阶段总结报告-ChenDe
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-11-30 10:25:00" itemprop="dateCreated datePublished" datetime="2023-11-30T10:25:00+00:00">2023-11-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-15 07:29:16" itemprop="dateModified" datetime="2025-05-15T07:29:16+00:00">2025-05-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/oscamp-2023fall-arceos-unikernel/" itemprop="url" rel="index"><span itemprop="name">oscamp 2023fall arceos unikernel</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="总结报告"><a href="#总结报告" class="headerlink" title="总结报告"></a>总结报告</h1><p>很高兴参加第三阶段ArceOS Unikernel的课程学习与训练，<br>经过第三阶段的学习，让我对rust、unikernel、linux等都有了更深入的理解。经过这些实验与练习，提升了我对rust语言的理解，感受到rust的条件编译的强大。学习了ArceOS的层次结构、模块化设计理念，让我对Unikernel的概念有了更具象化的理解。十分感谢石磊老师的细心讲解、助教老师孙应娥的热心帮忙以及群里的同学们的讨论指导。</p>
<p>下面是逐个练习的总结与反思。</p>
<h2 id="第一周练习"><a href="#第一周练习" class="headerlink" title="第一周练习"></a>第一周练习</h2><h3 id="练习-1-amp-2"><a href="#练习-1-amp-2" class="headerlink" title="练习 1 &amp;2"></a>练习 1 &amp;2</h3><blockquote>
<p>练习1</p>
<p>支持彩色打印println!。以apps/helloworld为测试应用。<br>要求：不能在helloworld程序本身改，要在下面的库或更深层次的组件修改</p>
<p>练习2(附加题)</p>
<p>支持HashMap数据类型。以apps/memtest为测试应用。<br>要求：在ulib/axstd中支持HashMap类型</p>
<p>预期输出：执行 make A=apps/memtest ARCH=riscv64 run</p>
</blockquote>
<p>思路：练习1就是在println!宏的实现上添加带颜色的格式控制就可以了。<br>练习2根据提示是参考rust官方的hash表实现，但是官方实现内容太多了，错综复杂的依赖不好解决。根据老师在群里的提示，只需要实现测试用到的函数(new、iter、insert等)就好了，然后就顺利解决了。</p>
<p>我在参考官方库的时候，发现官方库实际是在 用hashbrown::hash_map，进行二次封装的。所以这个练习有一个偷懒的做法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use hashbrown::hash_map as HashMap;</span><br></pre></td></tr></table></figure>
<h3 id="练习3"><a href="#练习3" class="headerlink" title="练习3"></a>练习3</h3><blockquote>
<p>练习3</p>
<p>为内存分配器实现新的内存算法early，禁用其它算法。early分配算法以apps/memtest为测试应用。</p>
</blockquote>
<p>这题是我卡的最久的一个练习，我一开始以为需要涉及底层内存的分配(实际上是分配好底层的内存了)，实际上为了简化练习，底层内存已经分配固定了，只是需要给应用分配地址。<br>因此我一开始走了很多弯路，我的原本的想法是将byteAllocator和pageAllocator进行结合，或者是使用byteAllocator和BitAlloc结合。导致这样的想法是为以为BitAlloc是会控制底层的内存分配(不得不说实在太蠢了)。</p>
<p>尝试了各种方法后，请教了王格格同学，知道了正确的做法:维护byte_pos和page_pos来进行内存分配就好了。</p>
<p>实际的细节中要注意内存地址的对齐，为在练习5中发现了在练习3中的问题。即内存地址的大小和地址都要进行对齐。</p>
<blockquote>
<p>练习4</p>
<p>解析dtb(FDT的二进制格式)，打印物理内存范围和所有的virtio_mmio范围。以apps/memtest为测试应<br>用。<br>当ArceOS启动时，上一级SBI向我们传递了dtb的指针，一直会传递到axruntime，我们就在<br>axruntime中执行解析并打印。</p>
</blockquote>
<p>思路：需要查阅相关资料，了解DTB，了解FDT相关的内容。感谢群里的郝淼同学分享的hermit-dtb库，解析dtb很方便。在解析的过程中需要注意的点是内存地址和大小的字段在reg字段中，需要将reg一分为二。</p>
<h3 id="练习5"><a href="#练习5" class="headerlink" title="练习5"></a>练习5</h3><blockquote>
<p>练习5</p>
<p>把协作式调度算法fifo改造为抢占式调度算法。让测试应用通过</p>
</blockquote>
<p>难点：主要是要理解arcos中的调度模块的代码，启用preemt的feature。</p>
<h2 id="第二周练习"><a href="#第二周练习" class="headerlink" title="第二周练习"></a>第二周练习</h2><h3 id="练习1-amp-2"><a href="#练习1-amp-2" class="headerlink" title="练习1&amp;2"></a>练习1&amp;2</h3><blockquote>
<p>练习 1：</p>
<p>main 函数中，固定设置 app_size = 32，这个显然是不合理甚至危险的。<br>请为 image 设计一个头结构，包含应用的长度信息，loader 在加载应用时获取它的实际大小。执行通过。</p>
<p>练习 2：</p>
<p>在练习 1 的基础上，扩展 image 头结构，让 image 可以包含两个应用。<br>第二个应用包含唯一的汇编代码是 ebreak 。<br>如实验 1 的方式，打印出每一个应用的二进制代码</p>
</blockquote>
<p>练习1和练习2是关系紧密的，都是要给image添加文件头，可以直接做练习2。</p>
<p>我们需要知道应用的数量，以及每个应用的字节长度，所以很自然地可以想到，首先文件头第一个字段应该是 <strong>应用数量</strong>，然后接着是每个应用的<strong>应用大小</strong>,最后是每个应用的<strong>应用二进制内容</strong>。</p>
<p>因此我设计的文件格式如下<br>| field| length|<br>| ———– | ———– |<br>| app_amount| 2 bytes|<br>| app0_size | 2 bytes|<br>| app1_size | 2 bytes|<br>| ……    | 2 bytes|<br>| appn_size | 2 bytes|<br>| app0_bin  | app0_size bytes|<br>| app1_bin  | app1_size bytes|<br>| …….   |  …….|<br>| appn_bin  | appn_size bytes|</p>
<p>应用数量和应用大小字段长度都是2个字节,因此我用rust写了个小程序将文件头写入文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;参数是 需要合并的app文件名称</span><br><span class="line">let mut args &#x3D;env::args();</span><br><span class="line">args.next();</span><br><span class="line">let files_number:u16&#x3D;args.len() as u16;</span><br><span class="line"></span><br><span class="line">let mut output_file: File &#x3D;File::create(&quot;new_apps.bin&quot;).expect(&quot;open fails&quot;);</span><br><span class="line">output_file.write(&amp;files_number.to_be_bytes()).expect(&quot;write file numbers fails&quot;);</span><br><span class="line"></span><br><span class="line">for file in args&#123;</span><br><span class="line">    let length:u16&#x3D; fs::metadata(file.clone()).expect(&quot;open file fails&quot;).len() as u16;</span><br><span class="line">    println!(&quot;APP:&#123;&#125;:&#123;&#125;&quot;,file,length);</span><br><span class="line">    output_file.write(&amp;length.to_be_bytes()).expect(&quot;writing file length fails&quot;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">args&#x3D;env::args();</span><br><span class="line">args.next();</span><br><span class="line">for file in args&#123;</span><br><span class="line">    let mut source_file&#x3D;File::open(file).expect(&quot;Opening file fails&quot;);</span><br><span class="line">    let mut buffer&#x3D;Vec::new();</span><br><span class="line">    source_file.read_to_end(&amp;mut buffer).expect(&quot;reading file fails.&quot;);</span><br><span class="line">    output_file.write_all(&amp;buffer).expect(&quot;writing file fails.&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相应的在arcos中的loader程序就要先读取前两个字节，获取app数量，然后再依次读取app长度和app的内容</p>
<p>要注意的细节：要维持文件大小在32M,否则qemu无法加载，文件大小在Makefile文件中写死了。</p>
<h3 id="练习3-1"><a href="#练习3-1" class="headerlink" title="练习3"></a>练习3</h3><blockquote>
<p>练习 3：</p>
<p>批处理方式执行两个单行代码应用，第一个应用的单行代码是 nop ，第二个的是 wfi </p>
</blockquote>
<p>思路：如何把控制权重新回到arceos中，重新返回到loader中执行</p>
<h3 id="练习4"><a href="#练习4" class="headerlink" title="练习4"></a>练习4</h3><blockquote>
<p>练习 4：</p>
<p>本实验已经实现了1 号调用 - SYS_HELLO，2 号调用 - SYS_PUTCHAR，请实现 3 号调用 -<br>SYS_TERMINATE 功能调用，作用是让 ArceOS 退出，相当于 OS 关机。</p>
</blockquote>
<p>思路：熟悉arceOS的代码，寻找相关的模块代码。我的想法是关机的调用实际上是应该控制硬件来进行操作的，可能跟sbi相关的，应该在硬件抽象层，所以为主要是看了axhal模块的代码。然后发现了相关的调用代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; Shutdown the whole system, including all CPUs.</span><br><span class="line">pub fn terminate() -&gt; ! &#123;</span><br><span class="line">    info!(&quot;Shutting down...&quot;);</span><br><span class="line">    sbi_rt::system_reset(sbi_rt::Shutdown, sbi_rt::NoReason);</span><br><span class="line">    warn!(&quot;It should shutdown!&quot;);</span><br><span class="line">    loop &#123;</span><br><span class="line">        crate::arch::halt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以只需要在loader中调用这个terminate函数就可以实现关机操作。</p>
<h3 id="练习5-1"><a href="#练习5-1" class="headerlink" title="练习5"></a>练习5</h3><blockquote>
<p>练习5 </p>
<p>照如下要求改造应用 hello_app：</p>
<ol>
<li>把三个功能调用的汇编实现封装为函数，以普通函数方式调用。例如，SYS_PUTCHAR 封装为<br>fn putchar(c: char) 。</li>
<li>基于打印字符函数 putchar 实现一个高级函数 fn puts(s: &amp;str) ，可以支持输出字符串。</li>
<li>应用 hello_app 的执行顺序是：Hello 功能、打印字符串功能、退出功能。</li>
</ol>
</blockquote>
<p>思路：将三部分调用的内联汇编代码都封装在函数中，在入口函数中顺序调用即可。</p>
<p>看样子不难的程序我又卡了很久很久，跟编译器斗智斗勇了很久。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">unsafe extern &quot;C&quot; fn _start(_entry:usize)&#123;</span><br><span class="line">    ENTRY&#x3D;_entry;</span><br><span class="line">    hello();</span><br><span class="line">    puts(&quot;ArceOS exercise 5.&quot;);</span><br><span class="line">    terminate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>理想的执行过程是依次调用hello、puts、terminate函数后退出。但是无论怎么尝试，程序只会执行第一个调用的函数后退出。我就很疑惑:能够执行第一个调用的函数，那说明我的函数封装应该没有问题，可是为什么无论调用多少次，只会执行一次。而且调用多少次都不会改变编译生成的文件大小。然后我又生成了汇编代码进行查看。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">_start:</span><br><span class="line">	addi	sp, sp, -32</span><br><span class="line">	sd	ra, 24(sp)</span><br><span class="line">	sd	s0, 16(sp)</span><br><span class="line">	sd	s1, 8(sp)</span><br><span class="line">	sd	s2, 0(sp)</span><br><span class="line">	addi	s0, sp, 32</span><br><span class="line">	mv	s1, a0</span><br><span class="line">.Lpcrel_hi0:</span><br><span class="line">	auipc	s2, %pcrel_hi(_ZN9hello_app5ENTRY17hc4afe4ceb535dcc3E.0)</span><br><span class="line">	sd	a0, %pcrel_lo(.Lpcrel_hi0)(s2)</span><br><span class="line">	mv	t2, a0</span><br><span class="line">	#APP</span><br><span class="line"></span><br><span class="line">	li	t0, 1</span><br><span class="line">	mv	a7, t2</span><br><span class="line">	slli	t0, t0, 3</span><br><span class="line">	add	t1, a7, t0</span><br><span class="line">	ld	t1, 0(t1)</span><br><span class="line">	jalr	t1</span><br><span class="line"></span><br><span class="line">	#NO_APP</span><br><span class="line">	ld	a0, %pcrel_lo(.Lpcrel_hi0)(s2)</span><br><span class="line">	bne	a0, s1, .LBB0_2</span><br><span class="line">	ld	ra, 24(sp)</span><br><span class="line">	ld	s0, 16(sp)</span><br><span class="line">	ld	s1, 8(sp)</span><br><span class="line">	ld	s2, 0(sp)</span><br><span class="line">	addi	sp, sp, 32</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>
<p>然后发现start内确实只有我第一个调用函数的汇编代码。难道是为我的代码被编译器给优化了?<br>然后尝试了各种方法，改成debug模式，修改优化等级，修改使用的寄存器等。比如在Cargo.toml中修改优化等级为0。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[profile.dev]</span><br><span class="line">opt-level &#x3D; 0</span><br></pre></td></tr></table></figure>
<p>均没有任何效果。<br>然后为又重新审视了每个汇编代码块。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">unsafe fn hello() &#123;</span><br><span class="line">        core::arch::asm!(&quot;</span><br><span class="line">        li t0, &#123;abi_num&#125;</span><br><span class="line">        mv a7,t2</span><br><span class="line">        slli t0, t0, 3</span><br><span class="line">        add t1, a7, t0</span><br><span class="line">        ld t1, (t1)</span><br><span class="line">        jalr t1</span><br><span class="line">        &quot;,</span><br><span class="line">        abi_num &#x3D; const SYS_HELLO,</span><br><span class="line">        in(&quot;t2&quot;) ENTRY,</span><br><span class="line">        clobber_abi(&quot;C&quot;),     &#x2F;&#x2F; 告诉编译器 clobber 了通用寄存器</span><br><span class="line">        options(noreturn) </span><br><span class="line">        )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后发现了问题所在:options(noreturn)是告诉编译器这段汇编代码没有返回，也就是说后面的代码永远也不会执行，因此编译器会把后面调用的函数代码全都丢掉。因此只会执行第一次函数调用。注释掉即可解决问题。</p>
<h3 id="练习6"><a href="#练习6" class="headerlink" title="练习6"></a>练习6</h3><blockquote>
<p>练习 6：</p>
<ol>
<li>仿照 hello_app 再实现一个应用，唯一功能是打印字符 ‘D’。</li>
<li>现在有两个应用，让它们分别有自己的地址空间。</li>
<li>让 loader 顺序加载、执行这两个应用。这里有个问题，第一个应用打印后，不能进行无限循环<br>之类的阻塞，想办法让控制权回到 loader，再由 loader 执行下一个应用。</li>
</ol>
</blockquote>
<p>思路:需要为每个应用分配独立的地址空间，并在跳转到app之前切换到app的地址空间，返回时再重新切换回内核空间。</p>
<p>因此在切换到app的地址空间之前，需要先保存当前的satp寄存器的值，执行完app后重新加载。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/2023%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5/" rel="tag"># 2023秋冬季开源操作系统训练营</a>
              <a href="/blog/tags/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A/" rel="tag"># 第三阶段总结报告</a>
              <a href="/blog/tags/author-chiiydd/" rel="tag"># author:chiiydd</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/2023/11/29/2023%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E9%A1%B9%E7%9B%AE%E4%B8%80%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-dooooling/" rel="prev" title="2023开源操作系统训练营第三阶段项目一总结报告-dooooling">
      <i class="fa fa-chevron-left"></i> 2023开源操作系统训练营第三阶段项目一总结报告-dooooling
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/2023/12/01/2023-autumn-hwy-%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93/" rel="next" title="2023-autumn-hwy-第三阶段总结">
      2023-autumn-hwy-第三阶段总结 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rcore-os Group</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>


  















  

  

  

</body>
</html>
