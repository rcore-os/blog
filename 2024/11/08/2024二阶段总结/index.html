<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">
  
  <link rel="stylesheet" href="/blog/lib/animate-css/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rcore-os.github.io","root":"/blog/","scheme":"Muse","version":"8.0.0-rc.4","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}}};
  </script>

  <meta name="description" content="2024二阶段总结在这一阶段，我对我的学习可以划分两个比较明显的时期，一个是前期比较懵懂地入门，一个是中后期的速通。">
<meta property="og:type" content="article">
<meta property="og:title" content="2024二阶段总结">
<meta property="og:url" content="http://rcore-os.github.io/blog/2024/11/08/2024%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="rcore-os Blog">
<meta property="og:description" content="2024二阶段总结在这一阶段，我对我的学习可以划分两个比较明显的时期，一个是前期比较懵懂地入门，一个是中后期的速通。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-11-08T11:22:39.000Z">
<meta property="article:modified_time" content="2025-05-15T07:28:04.527Z">
<meta property="article:author" content="rcore-os Group">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://rcore-os.github.io/blog/2024/11/08/2024%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>2024二阶段总结 | rcore-os Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">rcore-os Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#2024二阶段总结"><span class="nav-number">1.</span> <span class="nav-text">2024二阶段总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#入门"><span class="nav-number">1.1.</span> <span class="nav-text">入门</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#速通"><span class="nav-number">1.2.</span> <span class="nav-text">速通</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一些图"><span class="nav-number">1.3.</span> <span class="nav-text">一些图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#第一章"><span class="nav-number">1.3.1.</span> <span class="nav-text">第一章</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第二章"><span class="nav-number">1.3.2.</span> <span class="nav-text">第二章</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第三章"><span class="nav-number">1.3.3.</span> <span class="nav-text">第三章</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第四章"><span class="nav-number">1.3.4.</span> <span class="nav-text">第四章</span></a></li></ol></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rcore-os Group</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">617</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">559</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content post posts-expand">
          

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/11/08/2024%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          2024二阶段总结
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-08 11:22:39" itemprop="dateCreated datePublished" datetime="2024-11-08T11:22:39+00:00">2024-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-15 07:28:04" itemprop="dateModified" datetime="2025-05-15T07:28:04+00:00">2025-05-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="2024二阶段总结"><a href="#2024二阶段总结" class="headerlink" title="2024二阶段总结"></a>2024二阶段总结</h1><p>在这一阶段，我对我的学习可以划分两个比较明显的时期，一个是前期比较懵懂地入门，一个是中后期的速通。</p>
<a id="more"></a>
<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><p>刚刚接触时我是懵逼的、接触了几天后我是迷茫的，看了前两章后，有不少地方还是不太明白，我意识到我对一些相关知识的掌握是非常欠缺的。所以我暂停了一下。</p>
<p>在暂停后，我找了一些相关的资料（如riscv reader即riscv开放架构之道、riscv体系结构与实践，看了一些相关的视频（如plct lab放在B站上的<a href="https://gitee.com/unicornx/riscv-operating-system-mooc" target="_blank" rel="noopener">循序渐进，学习开发一个 RISC-V 上的操作系统</a>mooc，mooc看完了，书没有看完。</p>
<p>在对一些相关的知识有了一些了解。然后我又回到了rCore上，我重新审视了前两章，学习了第三章，并在前三章分别画了一些序列图、c4图、类图等十几张图，帮助我梳理与理解，为后面的学习打下了基础。</p>
<h2 id="速通"><a href="#速通" class="headerlink" title="速通"></a>速通</h2><p>接着，经过前面的时间消耗，所剩时间已经不多了，而且新知识可能忘的会比较快，所以在我看来已经堪堪入门后，就开始了速通（当然，这里的速通是相对于前三章而言的，不是各位大佬眼里的速通，是入门改）。</p>
<p>rCore每一章都是循序渐进的，我在每一章中花的时间主要是在文档的阅读和对系统架构、代码的理解上，花在lab上的时间反而并不多，仅有的在lab上卡住的几次，也大多由于看错题、粗心漏掉一些东西。</p>
<p>这一时期基本上就是看文档、做lab、看文档、做lab，如此循环，两点一线 – 学习的乏味。</p>
<h2 id="一些图"><a href="#一些图" class="headerlink" title="一些图"></a>一些图</h2><p>这些图有的可能有点不太对，但应该也差不了多少。</p>
<h3 id="第一章"><a href="#第一章" class="headerlink" title="第一章"></a>第一章</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">!include https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;plantuml-stdlib&#x2F;C4-PlantUML&#x2F;master&#x2F;C4_Component.puml</span><br><span class="line"></span><br><span class="line">Container(os, &quot;os&quot;, &quot;crate&quot;, &quot;kernel&quot;)</span><br><span class="line">&#39; Container(sbi, &quot;sbi.rs&quot;, &quot;crate&quot;, &quot;封装 RustSBI&quot;)</span><br><span class="line">Container(rustsbi, &quot;rustsbi&quot;, &quot;bin&quot;, &quot;&quot;)</span><br><span class="line">Container(log, &quot;log&quot;, &quot;crate&quot;, &quot;日志库&quot;)</span><br><span class="line">Container(hart, &quot;hart&quot;, &quot;hardware thread&quot;, &quot;qemu模拟的硬件线程&quot;)</span><br><span class="line"></span><br><span class="line">&#39; Rel(os, app, &quot;启动app&quot;)</span><br><span class="line">&#39; Rel(os, riscv, &quot;管理csr寄存器&quot;)</span><br><span class="line">&#39; Rel(os, lazy_static, &quot;静态变量初始化&quot;)</span><br><span class="line">&#39; Rel(os, sbi, &quot;&quot;)</span><br><span class="line">Rel(os, log, &quot;日志输出&quot;)</span><br><span class="line">Rel(os, rustsbi, &quot;调用 RustSBI&quot;)</span><br><span class="line">Rel(os, hart, &quot;trap&quot;)</span><br><span class="line">Rel(hart, rustsbi, &quot;中断处理&quot;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">!include https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;plantuml-stdlib&#x2F;C4-PlantUML&#x2F;master&#x2F;C4_Component.puml</span><br><span class="line"></span><br><span class="line">Container_Boundary(os, &quot;os&quot;, &quot;kernel&quot;)&#123;</span><br><span class="line">    Component(main, &quot;os&#x2F;src&#x2F;main.rs&quot;, &quot;mod&quot;, &quot;操作系统主入口，负责初始化（清理 BSS 段）和启动各个组件&quot;) </span><br><span class="line">    Component(lang_items, &quot;os&#x2F;src&#x2F;lang_items.rs&quot;, &quot;mod&quot;, &quot;Rust 语言项&quot;)</span><br><span class="line">    Component(console, &quot;os&#x2F;src&#x2F;console.rs&quot;, &quot;mod&quot;, &quot;负责输出信息&quot;)</span><br><span class="line">    Component(logging, &quot;os&#x2F;src&#x2F;logging.rs&quot;, &quot;mod&quot;, &quot;日志库封装&quot;)</span><br><span class="line">    Component(sbi, &quot;os&#x2F;src&#x2F;sbi.rs&quot;, &quot;mod&quot;, &quot;封装 sbi_rs&quot;)</span><br><span class="line">&#125;</span><br><span class="line">Lay_L(console, lang_items)</span><br><span class="line">Lay_L(lang_items , logging)</span><br><span class="line"></span><br><span class="line">Container(app, &quot;app&quot;, &quot;crate&quot;, &quot;应用程序&quot;)</span><br><span class="line">Container(sbi_rs, &quot;sbi_rs&quot;, &quot;crate&quot;, &quot;封装 RustSBI&quot;)</span><br><span class="line">Container(rustsbi, &quot;rustsbi&quot;, &quot;bin&quot;, &quot;RustSBI 的实现&quot;)</span><br><span class="line">Container(log, &quot;log&quot;, &quot;crate&quot;, &quot;日志库&quot;)</span><br><span class="line"></span><br><span class="line">BiRel(app, os, &quot;系统调用 \n 启动app&quot;)</span><br><span class="line">Rel_D(main, console, &quot;println!()&quot;)</span><br><span class="line">Rel_D(main, logging, &quot;init()&quot;)</span><br><span class="line">Rel(main, log, &quot;log相关函数&quot;)</span><br><span class="line">Rel(console, sbi, &quot;console_putchar() \n console_getchar() \n system_reset()&quot;)</span><br><span class="line">Rel(log, console, &quot;println!()&quot;)</span><br><span class="line">Rel(sbi, sbi_rs, &quot;调用 RustSBI 的封装&quot;)</span><br><span class="line">Rel(sbi_rs, rustsbi, &quot;调用 RustSBI&quot;)</span><br><span class="line">Rel(lang_items, sbi, &quot;发生 panic 时调用shutdown()&quot;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">config:</span><br><span class="line">  theme: neo</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">sequenceDiagram</span><br><span class="line">    autonumber</span><br><span class="line">    participant User</span><br><span class="line">    participant Qemu as Qemu Initializer</span><br><span class="line">    participant Bootloader as Bootloader &lt;br&gt; rustsbi-qemu.bin</span><br><span class="line">    participant Entry.asm</span><br><span class="line"></span><br><span class="line">    box os&#x2F;src&#x2F;main.rs</span><br><span class="line">    participant rust_main as fn &lt;br&gt; rust_main</span><br><span class="line">    participant clear_bss as fn &lt;br&gt; clear_bss</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    participant console as os&#x2F;src&#x2F;console.rs</span><br><span class="line">    </span><br><span class="line">    box os&#x2F;src&#x2F;sbi.rs</span><br><span class="line">    participant console_putchar as fn &lt;br&gt; console_putchar</span><br><span class="line">    participant shutdown as fn &lt;br&gt; shutdown</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    participant sbi_rt as crate &lt;br&gt; sbi_rt  </span><br><span class="line">  </span><br><span class="line">    box os&#x2F;src&#x2F;lang_items.rs</span><br><span class="line">    participant lang_items_panic as fn &lt;br&gt; panic</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    User-&gt;&gt;Qemu: Execute Qemu</span><br><span class="line">    Qemu-&gt;&gt;Qemu: Initialize virt machine &lt;br&gt; Load bootloader (rustsbi-qemu.bin) to 0x80000000 &lt;br&gt; Load kernel image (os.bin) to 0x80200000</span><br><span class="line">    Qemu-&gt;&gt;Qemu: Set PC to 0x1000</span><br><span class="line">    Qemu-&gt;&gt;Qemu: Execute first instruction at 0x1000</span><br><span class="line">    Qemu-&gt;&gt;Bootloader: Jump to 0x80000000</span><br><span class="line">    Bootloader-&gt;&gt;Bootloader: Initialize somethings</span><br><span class="line">    Bootloader-&gt;&gt;Entry.asm: Jump to 0x80200000</span><br><span class="line">    Entry.asm-&gt;&gt;Entry.asm: Set stack pointer (sp) to boot_stack_top</span><br><span class="line">    Entry.asm-&gt;&gt;rust_main: Call rust_main</span><br><span class="line">    rust_main-&gt;&gt;clear_bss: clear_bss()</span><br><span class="line"></span><br><span class="line">    rust_main -&gt;&gt; console: println!()</span><br><span class="line">    console -&gt;&gt; console: print()</span><br><span class="line">    console -&gt;&gt; console_putchar: console_putchar()</span><br><span class="line">    console_putchar -&gt;&gt; sbi_rt::console_putchar()</span><br><span class="line"></span><br><span class="line">    rust_main -&gt;&gt; shutdown: shutdown()</span><br><span class="line">    shutdown -&gt;&gt; sbi_rt: system_reset()</span><br><span class="line"></span><br><span class="line">    opt when panic</span><br><span class="line">    lang_items_panic -&gt;&gt; shutdown: shutdown()</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<h3 id="第二章"><a href="#第二章" class="headerlink" title="第二章"></a>第二章</h3>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">!include https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;plantuml-stdlib&#x2F;C4-PlantUML&#x2F;master&#x2F;C4_Component.puml</span><br><span class="line">&#39; !include &lt;C4&#x2F;C4_Container&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Container(os, &quot;os&quot;, &quot;crate&quot;, &quot;kernel&quot;)</span><br><span class="line">Container(app, &quot;app&quot;, &quot;crate&quot;, &quot;应用程序&quot;)</span><br><span class="line">Container(riscv, &quot;riscv&quot;, &quot;crate&quot;, &quot;Low level access to RISC-V processors&quot;)</span><br><span class="line">Container(lazy_static, &quot;lazy_static&quot;, &quot;crate&quot;, &quot;A macro for declaring lazily evaluated statics&quot;)</span><br><span class="line">Container(rustsbi, &quot;rustsbi&quot;, &quot;bin&quot;, &quot;&quot;)</span><br><span class="line">Container(log, &quot;log&quot;, &quot;crate&quot;, &quot;日志库&quot;)</span><br><span class="line">Container(hart, &quot;hart&quot;, &quot;hardware thread&quot;, &quot;qemu模拟的硬件线程&quot;)</span><br><span class="line"></span><br><span class="line">Rel(os, app, &quot;启动app&quot;)</span><br><span class="line">Rel(os, riscv, &quot;操作csr寄存器&quot;)</span><br><span class="line">Rel(os, lazy_static, &quot;静态变量初始化&quot;)</span><br><span class="line">Rel(os, log, &quot;日志输出&quot;)</span><br><span class="line">Rel(os, hart, &quot;trap&quot;)</span><br><span class="line">Rel(hart, rustsbi, &quot;中断处理&quot;)</span><br><span class="line">Rel(app, hart, &quot;trap&quot;)</span><br><span class="line">Rel(hart, os, &quot;中断处理 by trap.S::__alltraps&quot;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">!include https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;plantuml-stdlib&#x2F;C4-PlantUML&#x2F;master&#x2F;C4_Component.puml</span><br><span class="line"></span><br><span class="line">Container_Boundary(user, &quot;user&quot;, &quot;应用程序&quot;)&#123;</span><br><span class="line">    Component(app, &quot;app&quot;, &quot;应用程序&quot;)</span><br><span class="line">    Component(lib, &quot;lib&quot;, &quot;&quot;, &quot;app入口和库&quot;)</span><br><span class="line">    Component(console, &quot;console&quot;,  &quot;&quot;, &quot;负责格式化输出&quot;)</span><br><span class="line">    Component(syscall, &quot;syscall&quot;, &quot;&quot;, &quot;系统调用&quot;)</span><br><span class="line">    Component(lang_item, &quot;lang_item&quot;, &quot;&quot;, &quot;处理panic&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Container(os, &quot;os&quot;, &quot;crate&quot;, &quot;kernel&quot;)</span><br><span class="line">&#39; Container(app, &quot;app&quot;, &quot;crate&quot;, &quot;应用程序&quot;)</span><br><span class="line">Container(riscv, &quot;riscv&quot;, &quot;crate&quot;, &quot;Low level access to RISC-V processors&quot;)</span><br><span class="line">Container(lazy_static, &quot;lazy_static&quot;, &quot;crate&quot;, &quot;A macro for declaring lazily evaluated statics&quot;)</span><br><span class="line">Container(rustsbi, &quot;rustsbi&quot;, &quot;bin&quot;, &quot;&quot;)</span><br><span class="line">Container(log, &quot;log&quot;, &quot;crate&quot;, &quot;日志库&quot;)</span><br><span class="line">Container(hart, &quot;hart&quot;, &quot;hardware thread&quot;, &quot;qemu模拟的硬件线程&quot;)</span><br><span class="line"></span><br><span class="line">Rel(os, lib, &quot;由__restore启动&quot;)</span><br><span class="line">Rel(lib, app, &quot;启动main()&quot;)</span><br><span class="line">Rel(app, console, &quot;调用println!()&quot;)</span><br><span class="line">Rel(console, lib, &quot;调用write()&quot;)</span><br><span class="line">Rel(lib, syscall, &quot;调用sys_write(), sys_exit()&quot;)</span><br><span class="line">Rel(syscall, hart, &quot;ecall&quot;)</span><br><span class="line">Rel(lang_item, console, &quot;当user panic时调用&quot;)</span><br><span class="line">Rel(lang_item, lib, &quot;当user panic时调用\n exit()&quot;)</span><br><span class="line"></span><br><span class="line">&#39; Rel(os, app, &quot;启动app&quot;)</span><br><span class="line">Rel(os, riscv, &quot;操作csr寄存器&quot;)</span><br><span class="line">Rel(os, lazy_static, &quot;静态变量初始化&quot;)</span><br><span class="line">Rel(os, hart, &quot;ecall&quot;)</span><br><span class="line">Rel(os, log, &quot;日志输出&quot;)</span><br><span class="line">&#39; Rel(app, hart, &quot;trap&quot;)</span><br><span class="line">Rel(hart, rustsbi, &quot;Trap处理&quot;)</span><br><span class="line">Rel(hart, os, &quot;Trap处理 by trap.S::__alltraps&quot;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">!include https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;plantuml-stdlib&#x2F;C4-PlantUML&#x2F;master&#x2F;C4_Component.puml</span><br><span class="line">&#39; !include &lt;C4&#x2F;C4_Container&gt;</span><br><span class="line"></span><br><span class="line">Container_Boundary(os, &quot;os&quot;, &quot;kernel&quot;)&#123;</span><br><span class="line">    Component(main, &quot;os&#x2F;src&#x2F;main.rs&quot;, &quot;mod&quot;, &quot;初始化 Trap处理并加载和执行应用&quot;) </span><br><span class="line">    Component(lang_items, &quot;os&#x2F;src&#x2F;lang_items.rs&quot;, &quot;mod&quot;, &quot;实现panic_handler&quot;)</span><br><span class="line">    Component(console, &quot;os&#x2F;src&#x2F;console.rs&quot;, &quot;mod&quot;, &quot;将打印字符的 SBI 接口封装实现格式化输出&quot;)</span><br><span class="line">    Component(logging, &quot;os&#x2F;src&#x2F;logging.rs&quot;, &quot;mod&quot;, &quot;日志库封装&quot;)</span><br><span class="line">    Component(sbi, &quot;os&#x2F;src&#x2F;sbi.rs&quot;, &quot;mod&quot;, &quot;封装 sbi&quot;)</span><br><span class="line">    Component(batch, &quot;os&#x2F;src&#x2F;batch.rs&quot;, &quot;mod&quot;, &quot;user_app批处理&quot;)</span><br><span class="line">    Component(trap, &quot;os&#x2F;src&#x2F;trap&#x2F;&quot;, &quot;mod&quot;, &quot;Trap处理&quot;)</span><br><span class="line">    Component(syscall, &quot;os&#x2F;src&#x2F;syscall&#x2F;&quot;, &quot;mod&quot;, &quot;系统调用&quot;)</span><br><span class="line">    Component(sync, &quot;os&#x2F;src&#x2F;sync&#x2F;&quot;, &quot;mod&quot;, &quot;包装了Refcell，&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&#39; Lay_L(console, lang_items)</span><br><span class="line">&#39; Lay_L(lang_items , logging)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Container(user, &quot;user&quot;, &quot;crate&quot;, &quot;应用程序&quot;)</span><br><span class="line">Container(rustsbi, &quot;rustsbi&quot;, &quot;bin&quot;, &quot;&quot;)</span><br><span class="line">Container(log, &quot;log&quot;, &quot;crate&quot;, &quot;日志库&quot;)</span><br><span class="line">Container(riscv, &quot;riscv&quot;, &quot;crate&quot;, &quot;Low level access to RISC-V processors&quot;)</span><br><span class="line">Container(lazy_static, &quot;lazy_static&quot;, &quot;crate&quot;, &quot;A macro for declaring lazily evaluated statics&quot;)</span><br><span class="line">Container(hart, &quot;hart&quot;, &quot;Hardware Thread&quot;, &quot;qemu模拟的硬件线程&quot;)</span><br><span class="line"></span><br><span class="line">Rel_D(main, console, &quot;&quot;)</span><br><span class="line">Rel_D(main, logging, &quot;init()&quot;)</span><br><span class="line">Rel(logging, log, &quot;impl Log&quot;)</span><br><span class="line">Rel_L(main, log, &quot;log相关函数&quot;)</span><br><span class="line">Rel(main, batch, &quot;init() \n run_next_app()&quot;)</span><br><span class="line">Rel(main, trap, &quot;init()&quot;)</span><br><span class="line">Rel(trap, console, &quot;&quot;)</span><br><span class="line">Rel(trap, riscv, &quot;csr寄存器操作&quot;)</span><br><span class="line">Rel(trap, syscall, &quot;处理syscall&quot;)</span><br><span class="line">Rel(trap, user, &quot;通过trap.S::__restore\n 启动user&quot;)</span><br><span class="line">Rel(batch, sync, &quot;UPSafeCell&quot;)</span><br><span class="line">Rel(batch, lazy_static, &quot;延迟初始化user_MANAGER&quot;)</span><br><span class="line">BiRel(batch, trap, &quot;run_next_app()\n context相关操作 trap.S::__restore&quot;)</span><br><span class="line">Rel(syscall, batch, &quot;run_next_app()&quot;)</span><br><span class="line">Rel(console, sbi, &quot;console_putchar()&quot;)</span><br><span class="line">Rel(log, console, &quot;&quot;)</span><br><span class="line">Rel(sbi, hart, &quot;ecall&quot;)</span><br><span class="line">Rel(hart, sbi, &quot;中断处理&quot;)</span><br><span class="line">Rel(user, hart, &quot;trap&quot;)</span><br><span class="line">Rel(hart, trap, &quot;中断处理\n by trap.S::__alltraps&quot;)</span><br><span class="line">Rel(lang_items, console, &quot;发生 os panic 时\n调用println!()&quot;)</span><br><span class="line">Rel(lang_items, sbi, &quot;发生 os panic 时\n调用shutdown()&quot;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">zenuml</span><br><span class="line"></span><br><span class="line">title 除第一单元的内容外os的初始化</span><br><span class="line"></span><br><span class="line">main</span><br><span class="line">trap as &quot;trap&#x2F;mod.rs&quot;</span><br><span class="line">batch</span><br><span class="line">context as &quot;trap&#x2F;context.rs&quot;</span><br><span class="line">traps as &quot;trap&#x2F;trap.S&quot;</span><br><span class="line">riscv as &quot;riscv crate&quot;</span><br><span class="line"></span><br><span class="line">main -&gt; main.clear_bss()</span><br><span class="line">trap.init() &#123;</span><br><span class="line">    riscv.&quot;stvec:write(__alltraps as usize, TrapMode::Direct)&quot;</span><br><span class="line">&#125;</span><br><span class="line">batch.init() &#123;</span><br><span class="line">    print_app_info() &#123;</span><br><span class="line">        &#x2F;&#x2F; 第一次加载APP_MANAGER</span><br><span class="line">        &quot;APP_MANAGER.exclusive_access().print_app_info()&quot; &#123;</span><br><span class="line">            &#x2F;&#x2F; 会初始化num_app, current_app, app_start</span><br><span class="line">            &quot;UPSafeCell::new&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">batch.run_next_app() &#123;</span><br><span class="line">    &quot;app_manager.get_current_app()&quot; &#123;</span><br><span class="line">        return current_app</span><br><span class="line">    &#125; </span><br><span class="line">    &quot;app_manager.load_app(current_app)&quot;</span><br><span class="line">    &quot;app_manager.current_app +&#x3D; 1&quot;</span><br><span class="line">    &quot;drop(app_manager)&quot;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 设置sstatus中的spp位为User，&lt;br&gt;初始化cx&#123;x, status: status, sepc: entry&#125;，并设置sp即cx.x[2]为user_stack_top</span><br><span class="line">    &quot;context.AppContext.app_init_context(APP_BASE_ADDRESS as entry, USER_STACK.get_sp() as sp,)&quot; &#123;</span><br><span class="line">        return ct</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 将cx压入kernal_stack中，并返回kernal_stack_top即cx_ptr</span><br><span class="line">    &quot;KERNEL_STACK.push_context()&quot; &#123;</span><br><span class="line">        return cx_ptr</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 用cx的内容设置好通用寄存器的字，并用sret返回</span><br><span class="line">    traps.__restore(kernal_stack_top)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">zenuml</span><br><span class="line">title user</span><br><span class="line"></span><br><span class="line">app</span><br><span class="line">lib</span><br><span class="line">console</span><br><span class="line">lib</span><br><span class="line">syscall</span><br><span class="line">panic</span><br><span class="line"></span><br><span class="line">lib.run() &#123;</span><br><span class="line">    lib -&gt; lib.clear_bss()</span><br><span class="line">app.main() &#123;</span><br><span class="line">  console.println() &#123;</span><br><span class="line">    print() &#123;</span><br><span class="line">      ConsoleBuffer.write_fmt() &#123;</span><br><span class="line">        write_str() &#123;</span><br><span class="line">         lib.write() &#123;</span><br><span class="line">          syscall.sys_write() &#123;</span><br><span class="line">            syscall()</span><br><span class="line">          &#125;</span><br><span class="line">         &#125; </span><br><span class="line">        &#125;  </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lib -&gt; lib.exit() &#123;</span><br><span class="line">  syscall.sys_exit() &#123;</span><br><span class="line">    syscall()  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">opt &#123;</span><br><span class="line">    panic.panic() &#123;</span><br><span class="line">        console.println() &#123;</span><br><span class="line">            print() &#123;</span><br><span class="line">                ConsoleBuffer.write_fmt() &#123;</span><br><span class="line">                write_str() &#123;</span><br><span class="line">                lib.write() &#123;</span><br><span class="line">                    syscall.sys_write() &#123;</span><br><span class="line">                    syscall()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; </span><br><span class="line">                &#125;  </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        lib.exit(-1) &#123;</span><br><span class="line">            syscall.sys_exit(-1) &#123;</span><br><span class="line">                syscall()  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">zenuml</span><br><span class="line">title 系统调用的过程</span><br><span class="line"></span><br><span class="line">user_syscall as &quot;user&#x2F;syscall.rs&quot;</span><br><span class="line">Hart</span><br><span class="line">traps as &quot;os&#x2F;src&#x2F;trap&#x2F;trap.S&quot;</span><br><span class="line">trap as &quot;os&#x2F;src&#x2F;trap&#x2F;mod.rs&quot;</span><br><span class="line">console as &quot;os&#x2F;src&#x2F;console.rs&quot;</span><br><span class="line">batch as &quot;os&#x2F;src&#x2F;batch.rs&quot;</span><br><span class="line">os_lang_items as &quot;os&#x2F;src&#x2F;os_lang_items.rs&quot;</span><br><span class="line">os_syscall as &quot;os&#x2F;src&#x2F;syscall&#x2F;mod.rs&quot;</span><br><span class="line">fs as &quot;os&#x2F;src&#x2F;syscall&#x2F;fs.rs&quot;</span><br><span class="line">process as &quot;os&#x2F;src&#x2F;syscall&#x2F;process.rs&quot;</span><br><span class="line"></span><br><span class="line">user_syscall -&gt; Hart.ecall() &#123;</span><br><span class="line">    &#x2F;&#x2F; 设置sstatus.SPP为 CPU当前的特权级（U&#x2F;S）</span><br><span class="line">    &#x2F;&#x2F; 设置sepc,scause,stval</span><br><span class="line">    &quot;设置trap相关的csr寄存器&quot;</span><br><span class="line">    &#x2F;&#x2F;CPU 会跳转到stvec所设置的Trap 处理入口地址，</span><br><span class="line">    &#x2F;&#x2F;并将当前特权级设置为 S，然后从Trap 处理入口地址处开始执行</span><br><span class="line">    &#x2F;&#x2F;该位置在os&#x2F;src&#x2F;main.rs调用os&#x2F;src&#x2F;trap&#x2F;mod.rs::init()时设置</span><br><span class="line">    &#x2F;&#x2F;保存几乎所有通用寄存器以及sstatus和sepc</span><br><span class="line">    traps.__alltraps &#123;</span><br><span class="line">        trap.trap_hander(cx_ptr) &#123;</span><br><span class="line">            &#x2F;&#x2F; 根据 scause 进行匹配</span><br><span class="line">            if (&quot;Exception::UserEnvCall&quot;) &#123;</span><br><span class="line">                &quot;cx.sepc +&#x3D; 4&quot;</span><br><span class="line">                os_syscall.&quot;syscall(cx.x[17], [cx.x[10], cx.x[11], cx.x[12]])&quot; &#123;</span><br><span class="line">                    &#x2F;&#x2F; 根据 syscall_id 进行匹配</span><br><span class="line">                    if (SYSCALL_WRITE) &#123;</span><br><span class="line">                        fs.&quot;sys_write(args[0], args[1] as *const u8, args[2])&quot; &#123;</span><br><span class="line">                            console.print()</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else if (SYSCALL_EXIT) &#123;</span><br><span class="line">                        process.&quot;sys_exit(args[0] as i32)&quot; &#123;</span><br><span class="line">                            logging.&quot;trace!()&quot;</span><br><span class="line">                            batch.run_next_app()</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        core.&quot;panic!()&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (&quot;Exception::StoreFault | Exception::StorePageFault&quot;) &#123;</span><br><span class="line">                console.println()</span><br><span class="line">                batch.run_next_app()</span><br><span class="line">            &#125; else if (&quot;Exception::IllegalInstruction&quot;) &#123;</span><br><span class="line">                console.println()</span><br><span class="line">                batch.run_next_app()</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                core.panic() &#123;</span><br><span class="line">                    os_lang_items.panic() &#123;</span><br><span class="line">                        console.println()</span><br><span class="line">                        sbi.&quot;shutdown()&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return cx_ptr</span><br><span class="line">        &#125;</span><br><span class="line">        __restore</span><br><span class="line">        sret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第三章"><a href="#第三章" class="headerlink" title="第三章"></a>第三章</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">!include https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;plantuml-stdlib&#x2F;C4-PlantUML&#x2F;master&#x2F;C4_Component.puml</span><br><span class="line"></span><br><span class="line">Container(os, &quot;os&quot;, &quot;crate&quot;, &quot;kernel&quot;)</span><br><span class="line">Container(app, &quot;app&quot;, &quot;crate&quot;, &quot;应用程序&quot;)</span><br><span class="line">Container(riscv, &quot;riscv&quot;, &quot;crate&quot;, &quot;Low level access to RISC-V processors&quot;)</span><br><span class="line">Container(lazy_static, &quot;lazy_static&quot;, &quot;crate&quot;, &quot;A macro for declaring lazily evaluated statics&quot;)</span><br><span class="line">Container(rustsbi, &quot;rustsbi&quot;, &quot;bin&quot;, &quot;&quot;)</span><br><span class="line">Container(log, &quot;log&quot;, &quot;crate&quot;, &quot;日志库&quot;)</span><br><span class="line">Container(hart, &quot;hart&quot;, &quot;hardware thread&quot;, &quot;qemu模拟的硬件线程&quot;)</span><br><span class="line"></span><br><span class="line">Rel(os, app, &quot;启动app&quot;)</span><br><span class="line">Rel(os, riscv, &quot;操作csr寄存器&quot;)</span><br><span class="line">Rel(os, lazy_static, &quot;静态变量初始化&quot;)</span><br><span class="line">Rel(os, log, &quot;日志输出&quot;)</span><br><span class="line">Rel(os, hart, &quot;trap&quot;)</span><br><span class="line">Rel(hart, rustsbi, &quot;中断处理&quot;)</span><br><span class="line">Rel(app, hart, &quot;trap&quot;)</span><br><span class="line">Rel(hart, os, &quot;中断处理 by trap.S::__alltraps&quot;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">!include https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;plantuml-stdlib&#x2F;C4-PlantUML&#x2F;master&#x2F;C4_Component.puml</span><br><span class="line"></span><br><span class="line">Container_Boundary(os, &quot;os&quot;, &quot;kernel&quot;)&#123;</span><br><span class="line">    Component(main, &quot;os&#x2F;src&#x2F;main.rs&quot;, &quot;mod&quot;, &quot;初始化 Trap 处理并加载和执行应用&quot;) </span><br><span class="line">    Component(lang_items, &quot;os&#x2F;src&#x2F;lang_items.rs&quot;, &quot;mod&quot;, &quot;实现 panic_handler&quot;)</span><br><span class="line">    Component(console, &quot;os&#x2F;src&#x2F;console.rs&quot;, &quot;mod&quot;, &quot;将打印字符的 SBI 接口封装实现格式化输出&quot;)</span><br><span class="line">    Component(sbi, &quot;os&#x2F;src&#x2F;sbi.rs&quot;, &quot;mod&quot;, &quot;封装 SBI&quot;)</span><br><span class="line">    Component(trap, &quot;os&#x2F;src&#x2F;trap&#x2F;&quot;, &quot;mod&quot;, &quot;Trap 处理&quot;)</span><br><span class="line">    Component(syscall, &quot;os&#x2F;src&#x2F;syscall&#x2F;&quot;, &quot;mod&quot;, &quot;系统调用&quot;)</span><br><span class="line">    Component(loader, &quot;os&#x2F;src&#x2F;loader.rs&quot;, &quot;mod&quot;, &quot;将应用加载到内存并进行管理&quot;)</span><br><span class="line">    Component(sync, &quot;os&#x2F;src&#x2F;sync&#x2F;&quot;, &quot;mod&quot;, &quot;包装了 RefCell，实现内核内部的可变性&quot;)</span><br><span class="line">    Component(task, &quot;os&#x2F;src&#x2F;task&#x2F;&quot;, &quot;mod&quot;, &quot;任务管理&quot;)</span><br><span class="line">    Component(timer, &quot;os&#x2F;src&#x2F;timer.rs&quot;, &quot;mod&quot;, &quot;RISC-V timer-related functionality&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Container(user, &quot;user&quot;, &quot;crate&quot;, &quot;应用程序&quot;)</span><br><span class="line">Container(rustsbi, &quot;rustsbi&quot;, &quot;bin&quot;, &quot;SBI 实现&quot;)</span><br><span class="line">Container(riscv, &quot;riscv&quot;, &quot;crate&quot;, &quot;低级别访问 RISC-V 处理器&quot;)</span><br><span class="line">Container(lazy_static, &quot;lazy_static&quot;, &quot;crate&quot;, &quot;延迟初始化的静态变量宏&quot;)</span><br><span class="line">Container(hart, &quot;hart&quot;, &quot;Hardware Thread&quot;, &quot;QEMU 模拟的硬件线程&quot;)</span><br><span class="line"></span><br><span class="line">Rel(main, console, &quot;&quot;)</span><br><span class="line">Rel(main, trap, &quot;初始化 Trap 处理\n 启用supervisor timer interrupt&quot;)</span><br><span class="line">Rel(main, loader, &quot;加载应用到内存&quot;)</span><br><span class="line">Rel(main, timer, &quot;Set the next timer interrupt&quot;)</span><br><span class="line">Rel(main, task, &quot;初始化任务管理\n并运行第一个任务&quot;)</span><br><span class="line">Rel(trap, riscv, &quot;操作 CSR 寄存器&quot;)</span><br><span class="line">Rel(trap, syscall, &quot;处理系统调用&quot;)</span><br><span class="line">Rel(trap, hart, &quot;通过 trap.S::__restore 启动用户态应用&quot;)</span><br><span class="line">Rel(task, sync, &quot;使用 RefCell 包装TaskManager内部的可变部分&quot;)</span><br><span class="line">Rel(task, lazy_static, &quot;使用 lazy_static! 定义TASK_MANAGER&quot;)</span><br><span class="line">Rel(task, loader, &quot;init_app_cx&quot;)</span><br><span class="line">Rel(syscall, console, &quot;处理 sys_write&quot;)</span><br><span class="line">Rel(syscall, task, &quot;退出或挂起当前任务，\n并运行下一个&quot;)</span><br><span class="line">Rel(syscall, timer, &quot;get_time_us()&quot;)</span><br><span class="line">Rel(console, sbi, &quot;使用 console_putchar 通过 SBI 输出字符&quot;)</span><br><span class="line">Rel(sbi, hart, &quot;通过 &#96;ecall&#96; 与硬件线程交互&quot;)</span><br><span class="line">Rel(user, hart, &quot;用户态应用通过 &#96;ecall&#96; 发起系统调用&quot;)</span><br><span class="line">Rel(hart, trap, &quot;处理中断和系统调用，由 trap.S::__alltraps进入&quot;)</span><br><span class="line">Rel(hart, rustsbi, &quot;处理 SBI 调用&quot;)</span><br><span class="line">Rel(lang_items, console, &quot;发生 OS panic 时调用 println!()&quot;)</span><br><span class="line">Rel(lang_items, sbi, &quot;发生 OS panic 时调用 shutdown()&quot;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">!include https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;plantuml-stdlib&#x2F;C4-PlantUML&#x2F;master&#x2F;C4_Component.puml</span><br><span class="line"></span><br><span class="line">Container_Boundary(user, &quot;user&quot;, &quot;应用程序&quot;)&#123;</span><br><span class="line">    Component(app, &quot;app&quot;, &quot;应用程序&quot;)</span><br><span class="line">    Component(lib, &quot;lib&quot;, &quot;&quot;, &quot;app入口和库&quot;)</span><br><span class="line">    Component(console, &quot;console&quot;,  &quot;&quot;, &quot;负责格式化输出&quot;)</span><br><span class="line">    Component(syscall, &quot;syscall&quot;, &quot;&quot;, &quot;系统调用&quot;)</span><br><span class="line">    Component(lang_item, &quot;lang_item&quot;, &quot;&quot;, &quot;处理panic&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Container(os, &quot;os&quot;, &quot;crate&quot;, &quot;kernel&quot;)</span><br><span class="line">&#39; Container(app, &quot;app&quot;, &quot;crate&quot;, &quot;应用程序&quot;)</span><br><span class="line">Container(riscv, &quot;riscv&quot;, &quot;crate&quot;, &quot;Low level access to RISC-V processors&quot;)</span><br><span class="line">Container(lazy_static, &quot;lazy_static&quot;, &quot;crate&quot;, &quot;A macro for declaring lazily evaluated statics&quot;)</span><br><span class="line">Container(rustsbi, &quot;rustsbi&quot;, &quot;bin&quot;, &quot;&quot;)</span><br><span class="line">Container(log, &quot;log&quot;, &quot;crate&quot;, &quot;日志库&quot;)</span><br><span class="line">Container(hart, &quot;hart&quot;, &quot;hardware thread&quot;, &quot;qemu模拟的硬件线程&quot;)</span><br><span class="line"></span><br><span class="line">Rel(os, lib, &quot;由__restore启动&quot;)</span><br><span class="line">Rel(lib, app, &quot;启动main()&quot;)</span><br><span class="line">Rel(app, console, &quot;调用println!()&quot;)</span><br><span class="line">Rel(console, lib, &quot;调用write()&quot;)</span><br><span class="line">Rel(lib, syscall, &quot;调用sys_write(), sys_exit()&quot;)</span><br><span class="line">Rel(syscall, hart, &quot;ecall&quot;)</span><br><span class="line">Rel(lang_item, console, &quot;当user panic时调用&quot;)</span><br><span class="line">Rel(lang_item, lib, &quot;当user panic时调用\n exit()&quot;)</span><br><span class="line"></span><br><span class="line">&#39; Rel(os, app, &quot;启动app&quot;)</span><br><span class="line">Rel(os, riscv, &quot;操作csr寄存器&quot;)</span><br><span class="line">Rel(os, lazy_static, &quot;静态变量初始化&quot;)</span><br><span class="line">Rel(os, hart, &quot;ecall&quot;)</span><br><span class="line">Rel(os, log, &quot;日志输出&quot;)</span><br><span class="line">&#39; Rel(app, hart, &quot;trap&quot;)</span><br><span class="line">Rel(hart, rustsbi, &quot;Trap处理&quot;)</span><br><span class="line">Rel(hart, os, &quot;Trap处理 by trap.S::__alltraps&quot;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">zenuml</span><br><span class="line"></span><br><span class="line">title 除第一单元的内容外os的初始化 忽略了log和heap</span><br><span class="line"></span><br><span class="line">main</span><br><span class="line">trap as &quot;trap&quot;</span><br><span class="line">loader as &quot;loader.rs&quot;</span><br><span class="line">riscv as &quot;riscv crate&quot;</span><br><span class="line"></span><br><span class="line">main.run() &#123;</span><br><span class="line">    </span><br><span class="line">main -&gt; main.clear_bss()</span><br><span class="line">trap.init() &#123;</span><br><span class="line">    riscv.&quot;stvec:write(__alltraps as usize, TrapMode::Direct)&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 将app一次性地依次加载到内存0x80400000处</span><br><span class="line">loader.init()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; enable timer interrupt in supervisor mode</span><br><span class="line">trap.enable_timer_interrupt() &#123;</span><br><span class="line">    riscv.&quot;sie::set_stimer()&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">timer.set_next_trigger() &#123;</span><br><span class="line">    get_time() &#123;</span><br><span class="line">        riscv.&quot;register::time::read()&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    sbi.set_timer()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task.run_first_task() &#123;</span><br><span class="line">    &quot;lazy_static初始化TASK_MANAGER&quot; &#123;</span><br><span class="line">        for (&quot;i, task&quot;) &#123;</span><br><span class="line">            &#x2F;&#x2F; set and get app info with entry and sp and save TrapContext in kernel stack</span><br><span class="line">            kernel_stack_top &#x3D; loader.init_app_cx(i) &#123;</span><br><span class="line">                &#x2F;&#x2F; 设置sstatus中的spp位为User，&lt;br&gt; 初始化cx&#123;x, status: status, sepc: entry&#125;，&lt;br&gt;并设置sp即cx.x[2]为user_stack_top</span><br><span class="line">                trap.&quot;context.TrapContext.app_init_context(        get_base_i(i), USER_STACK[i].get_sp(),)&quot; &#123;</span><br><span class="line">                    return trap_cx</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 将cx压入kernal_stack中，并返回kernal_stack_top即trap_cx_ptr</span><br><span class="line">                &quot;KERNEL_STACK[i].push_context(cx)&quot; &#123;</span><br><span class="line">                    return trap_cx_ptr</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; Create a new task context with a trap return addr and a kernel stack pointer</span><br><span class="line">            &quot;task.task_cx &#x3D; TaskContext::goto_restore(trap_cx_ptr)&quot;</span><br><span class="line">            &quot;task.task_status &#x3D; TaskStatus::Ready&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        return TASK_MANAGER</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 第一次使用TASK_MANAGER时，会初始化TASK_MANAGER</span><br><span class="line">    &quot;TASK_MANAGER.run_first_task()&quot; &#123;</span><br><span class="line">        &quot;task0.task_status &#x3D; TaskStatus::Running&quot;</span><br><span class="line">        &#x2F;&#x2F; 启动第一个应用不是在内核栈中 &lt;br&gt; 该栈sp会被丢弃，不会再返回了</span><br><span class="line">        &quot;__switch(&amp;mut _unused as *mut TaskContext, next_task_cx_ptr)&quot; &#123;</span><br><span class="line">            &#x2F;&#x2F; 注意在__switch中已将sp设为内核栈顶 &lt;br&gt; 启动第一个应用不是在内核栈中 &lt;br&gt; 该栈sp会被丢弃，不会再返回了</span><br><span class="line">            trap.&quot;trap.S::__restore&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">zenuml</span><br><span class="line">title 系统调用的过程</span><br><span class="line"></span><br><span class="line">user_syscall as &quot;user&#x2F;syscall.rs&quot;</span><br><span class="line">Hart</span><br><span class="line">traps as &quot;trap&#x2F;trap.S&quot;</span><br><span class="line">trap as &quot;trap&#x2F;mod.rs&quot;</span><br><span class="line">console as &quot;&#x2F;console.rs&quot;</span><br><span class="line">batch as &quot;batch.rs&quot;</span><br><span class="line">os_lang_items as &quot;os_lang_items.rs&quot;</span><br><span class="line">os_syscall as &quot;syscall&#x2F;mod.rs&quot;</span><br><span class="line">fs as &quot;syscall&#x2F;fs.rs&quot;</span><br><span class="line">process as &quot;syscall&#x2F;process.rs&quot;</span><br><span class="line">task as &quot;task&quot;</span><br><span class="line">timer as &quot;timer.rs&quot;</span><br><span class="line"></span><br><span class="line">user_syscall -&gt; Hart.ecall() &#123;</span><br><span class="line">    &#x2F;&#x2F; 设置sstatus.SPP为 CPU当前的特权级（U&#x2F;S）</span><br><span class="line">    &#x2F;&#x2F; 设置sepc,scause,stval</span><br><span class="line">    &quot;设置trap相关的csr寄存器&quot;</span><br><span class="line">    &#x2F;&#x2F; CPU 会跳转到stvec所设置的Trap 处理入口地址</span><br><span class="line">    &#x2F;&#x2F; 并将当前特权级设置为 S，然后从Trap 处理入口地址处开始执行</span><br><span class="line">    &#x2F;&#x2F; 该位置在os&#x2F;src&#x2F;main.rs调用os&#x2F;src&#x2F;trap&#x2F;mod.rs::init()时设置</span><br><span class="line">    &#x2F;&#x2F; 保存几乎所有通用寄存器以及sstatus和sepc</span><br><span class="line">    traps.__alltraps &#123;</span><br><span class="line">        trap.trap_hander(cx_ptr) &#123;</span><br><span class="line">            &#x2F;&#x2F; 根据 scause 进行匹配</span><br><span class="line">            if (&quot;Exception::UserEnvCall&quot;) &#123;</span><br><span class="line">                &quot;cx.sepc +&#x3D; 4&quot;</span><br><span class="line">                os_syscall.&quot;syscall(cx.x[17], [cx.x[10], cx.x[11], cx.x[12]])&quot; &#123;</span><br><span class="line">                    &#x2F;&#x2F; 根据 syscall_id 进行匹配</span><br><span class="line">                    if (SYSCALL_WRITE) &#123;</span><br><span class="line">                        fs.&quot;sys_write(args[0], args[1] as *const u8, args[2])&quot; &#123;</span><br><span class="line">                            console.print()</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else if (SYSCALL_EXIT) &#123;</span><br><span class="line">                        process.&quot;sys_exit(args[0] as i32)&quot; &#123;</span><br><span class="line">                            logging.&quot;trace!()&quot;</span><br><span class="line">                            task.exit_current_and_run_next() &#123;</span><br><span class="line">                                mark_current_suspended()</span><br><span class="line">                                run_next_task() &#123;</span><br><span class="line">                                    &#x2F;&#x2F; 从TASK_MANAGER中取出下一个任务</span><br><span class="line">                                    &#x2F;&#x2F; 将其状态设置为Running</span><br><span class="line">                                    &#x2F;&#x2F; 更新TASK_MANAGER中的当前任务为下一个任务</span><br><span class="line">                                    &#x2F;&#x2F; 通过__switch启动下一个任务</span><br><span class="line">                                    __switch(current_task_cx_ptr, next_task_cx_ptr) &#123;</span><br><span class="line">                                        if (&quot;要启动的app是初次启动&quot;) &#123;</span><br><span class="line">                                            &quot;保存current_app的Trap控制流&quot;</span><br><span class="line">                                            &#x2F;&#x2F; 其实是创建一个新的TrapContext&lt;br&gt;准备好在__restore中启动app的前置条件</span><br><span class="line">                                            &quot;恢复next_app的Trap控制流&quot;</span><br><span class="line">                                            &#x2F;&#x2F; 不能在他人的内核栈中运行，&lt;br&gt;应直接跳到__restore启动app</span><br><span class="line">                                            traps.__restore</span><br><span class="line">                                        &#125; else &#123;</span><br><span class="line">                                            &quot;保存current_app的Trap控制流&quot;</span><br><span class="line">                                            &#x2F;&#x2F; 仿佛是next_app正常trap然后返回</span><br><span class="line">                                            &#x2F;&#x2F; 在返回后，在进入__restore</span><br><span class="line">                                            &quot;恢复next_app的Trap控制流&quot;</span><br><span class="line">                                            return</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else if (SYSCALL_YIELD) &#123;</span><br><span class="line">                        sys_yield() &#123;</span><br><span class="line">                            logging.&quot;trace!()&quot;</span><br><span class="line">                            task.suspend_current_and_run_next() &#123;</span><br><span class="line">                                mark_current_suspended()</span><br><span class="line">                                run_next_task()</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else if (SYSCALL_GET_TIME) &#123;</span><br><span class="line">                        &quot;sys_get_time(args[0] as *mut TimeVal, args[1])&quot;,</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        core.&quot;panic!()&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (&quot;Exception::StoreFault | Exception::StorePageFault&quot;) &#123;</span><br><span class="line">                console.println()</span><br><span class="line">                task.exit_current_and_run_next() &#123;</span><br><span class="line">                    mark_current_suspended()</span><br><span class="line">                    run_next_task()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (&quot;Exception::IllegalInstruction&quot;) &#123;</span><br><span class="line">                console.println()</span><br><span class="line">                task.exit_current_and_run_next()</span><br><span class="line">            &#125; else if (&quot;Trap::Interrupt(Interrupt::SupervisorTimer)&quot;) &#123;</span><br><span class="line">                timer.set_next_trigger()</span><br><span class="line">                task.suspend_current_and_run_next() &#123;</span><br><span class="line">                    mark_current_suspended()</span><br><span class="line">                    run_next_task()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                core.panic() &#123;</span><br><span class="line">                    os_lang_items.panic() &#123;</span><br><span class="line">                        console.println()</span><br><span class="line">                        sbi.&quot;shutdown()&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return cx_ptr</span><br><span class="line">        &#125;</span><br><span class="line">        __restore()</span><br><span class="line">        sret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">zenuml</span><br><span class="line">title user</span><br><span class="line"></span><br><span class="line">app</span><br><span class="line">lib</span><br><span class="line">console</span><br><span class="line">lib</span><br><span class="line">syscall</span><br><span class="line">panic</span><br><span class="line"></span><br><span class="line">lib.run() &#123;</span><br><span class="line">    lib -&gt; lib.clear_bss()</span><br><span class="line">app.main() &#123;</span><br><span class="line">  console.println() &#123;</span><br><span class="line">    print() &#123;</span><br><span class="line">      ConsoleBuffer.write_fmt() &#123;</span><br><span class="line">        write_str() &#123;</span><br><span class="line">         lib.write() &#123;</span><br><span class="line">          syscall.sys_write() &#123;</span><br><span class="line">            syscall()</span><br><span class="line">          &#125;</span><br><span class="line">         &#125; </span><br><span class="line">        &#125;  </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lib -&gt; lib.exit() &#123;</span><br><span class="line">  syscall.sys_exit() &#123;</span><br><span class="line">    syscall()  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">opt &#123;</span><br><span class="line">    panic.panic() &#123;</span><br><span class="line">        console.println() &#123;</span><br><span class="line">            print() &#123;</span><br><span class="line">                ConsoleBuffer.write_fmt() &#123;</span><br><span class="line">                write_str() &#123;</span><br><span class="line">                lib.write() &#123;</span><br><span class="line">                    syscall.sys_write() &#123;</span><br><span class="line">                    syscall()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; </span><br><span class="line">                &#125;  </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        lib.exit(-1) &#123;</span><br><span class="line">            syscall.sys_exit(-1) &#123;</span><br><span class="line">                syscall()  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第四章"><a href="#第四章" class="headerlink" title="第四章"></a>第四章</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">package mm &#123;</span><br><span class="line"></span><br><span class="line">class address &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct PhysAddr &#123;</span><br><span class="line">    +0: usize</span><br><span class="line">    +floor() -&gt; PhysPageNum</span><br><span class="line">    +ceil() -&gt; PhysPageNum</span><br><span class="line">    +page_offset() -&gt; usize</span><br><span class="line">    +aligned() -&gt; bool</span><br><span class="line">    +get_mut&lt;T&gt;() -&gt; &amp;&#39;static mut T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct VirtAddr &#123;</span><br><span class="line">    +0: usize</span><br><span class="line">    +floor() -&gt; VirtPageNum</span><br><span class="line">    +ceil() -&gt; VirtPageNum</span><br><span class="line">    +page_offset() -&gt; usize</span><br><span class="line">    +aligned() -&gt; bool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct PhysPageNum &#123;</span><br><span class="line">    +0: usize</span><br><span class="line">    +get_pte_array() -&gt; &amp;&#39;static mut [PageTableEntry]</span><br><span class="line">    +get_bytes_array() -&gt; &amp;&#39;static mut [u8]</span><br><span class="line">    +get_mut&lt;T&gt;() -&gt; &amp;&#39;static mut T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct VirtPageNum &#123;</span><br><span class="line">    +0: usize</span><br><span class="line">    +indexes() -&gt; [usize; 3]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct SimpleRange&lt;T&gt; &#123;</span><br><span class="line">    l: T</span><br><span class="line">    r: T</span><br><span class="line">    +new(start: T, end: T) -&gt; Self</span><br><span class="line">    +get_start() -&gt; T</span><br><span class="line">    +get_end() -&gt; T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct SimpleRangeIterator&lt;T&gt; &#123;</span><br><span class="line">    current: T</span><br><span class="line">    end: T</span><br><span class="line">    +new(l: T, r: T) -&gt; Self</span><br><span class="line">    +next() -&gt; Option&lt;Self::Item&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class StepByOne &#123;</span><br><span class="line">    +step()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">address o-- PhysAddr : 定义</span><br><span class="line">address o-- VirtAddr : 定义</span><br><span class="line">address o-- PhysPageNum : 定义</span><br><span class="line">address o-- VirtPageNum : 定义</span><br><span class="line">address o-- SimpleRange : 定义</span><br><span class="line">address o-- SimpleRangeIterator : 定义</span><br><span class="line">address *-- StepByOne : 实现</span><br><span class="line"></span><br><span class="line">PhysAddr *-- PhysPageNum</span><br><span class="line">VirtAddr *-- VirtPageNum</span><br><span class="line">SimpleRange *-- SimpleRangeIterator : 迭代器</span><br><span class="line"></span><br><span class="line">class frame_allocator &#123;</span><br><span class="line">    init_frame_allocator()</span><br><span class="line">    frame_alloc() -&gt; Option&lt;FrameTracker&gt;</span><br><span class="line">    frame_dealloc(ppn: PhysPageNum)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct FrameTracker &#123;</span><br><span class="line">    +ppn: PhysPageNum</span><br><span class="line">    +new(ppn: PhysPageNum) -&gt; Self</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct StackFrameAllocator &#123;</span><br><span class="line">    current: usize</span><br><span class="line">    end: usize</span><br><span class="line">    recycled: Vec&lt;usize&gt;</span><br><span class="line">    +new() -&gt; Self</span><br><span class="line">    +init(l: PhysPageNum, r: PhysPageNum)</span><br><span class="line">    +alloc() -&gt; Option&lt;PhysPageNum&gt;</span><br><span class="line">    +dealloc(ppn: PhysPageNum)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class FrameAllocator &#123;</span><br><span class="line">    +new() -&gt; Self</span><br><span class="line">    +alloc() -&gt; Option&lt;PhysPageNum&gt;</span><br><span class="line">    +dealloc(ppn: PhysPageNum)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">frame_allocator o-- FrameTracker : 定义</span><br><span class="line">frame_allocator o-- StackFrameAllocator : 定义</span><br><span class="line">frame_allocator *-- FrameAllocator : 实现</span><br><span class="line"></span><br><span class="line">StackFrameAllocator *-- FrameAllocator : 实现</span><br><span class="line"></span><br><span class="line">class heap_allocator &#123;</span><br><span class="line">    init_heap()</span><br><span class="line">    heap_test()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">heap_allocator o-- LockedHeap : 使用</span><br><span class="line"></span><br><span class="line">class memory_set &#123;</span><br><span class="line">    kernel_stack_position(app_id: usize) -&gt; (usize, usize)</span><br><span class="line">    remap_test()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct MemorySet &#123;</span><br><span class="line">    page_table: PageTable</span><br><span class="line">    areas: Vec&lt;MapArea&gt;</span><br><span class="line">    +new_bare() -&gt; Self</span><br><span class="line">    +token() -&gt; usize</span><br><span class="line">    +insert_framed_area(...)</span><br><span class="line">    +push(...)</span><br><span class="line">    +map_trampoline()</span><br><span class="line">    +new_kernel() -&gt; Self</span><br><span class="line">    +from_elf(elf_data: &amp;[u8]) -&gt; (Self, usize, usize)</span><br><span class="line">    +activate()</span><br><span class="line">    +translate(vpn: VirtPageNum) -&gt; Option&lt;PageTableEntry&gt;</span><br><span class="line">    +shrink_to(...)</span><br><span class="line">    +append_to(...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct MapArea &#123;</span><br><span class="line">    vpn_range: VPNRange</span><br><span class="line">    data_frames: BTreeMap&lt;VirtPageNum, FrameTracker&gt;</span><br><span class="line">    map_type: MapType</span><br><span class="line">    map_perm: MapPermission</span><br><span class="line">    +new(...)</span><br><span class="line">    +map_one(...)</span><br><span class="line">    +unmap_one(...)</span><br><span class="line">    +map(page_table: &amp;mut PageTable)</span><br><span class="line">    +unmap(page_table: &amp;mut PageTable)</span><br><span class="line">    +shrink_to(...)</span><br><span class="line">    +append_to(...)</span><br><span class="line">    +copy_data(...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enum MapType &#123;</span><br><span class="line">    Identical</span><br><span class="line">    Framed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MapPermission &#123;</span><br><span class="line">    +R</span><br><span class="line">    +W</span><br><span class="line">    +X</span><br><span class="line">    +U</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">memory_set o-- MemorySet : 定义</span><br><span class="line">memory_set o-- MapArea : 定义</span><br><span class="line">memory_set o-- MapType : 定义</span><br><span class="line">memory_set o-- MapPermission : 定义</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class page_table &#123;</span><br><span class="line">    translated_byte_buffer(token: usize, ptr: *const u8, len: usize) -&gt; Vec&lt;&amp;&#39;static mut [u8]&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class PTEFlags &#123;</span><br><span class="line">    +V</span><br><span class="line">    +R</span><br><span class="line">    +W</span><br><span class="line">    +X</span><br><span class="line">    +U</span><br><span class="line">    +G</span><br><span class="line">    +A</span><br><span class="line">    +D</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct PageTableEntry &#123;</span><br><span class="line">    +bits: usize</span><br><span class="line">    +new(ppn: PhysPageNum, flags: PTEFlags) -&gt; Self</span><br><span class="line">    +empty() -&gt; Self</span><br><span class="line">    +ppn() -&gt; PhysPageNum</span><br><span class="line">    +flags() -&gt; PTEFlags</span><br><span class="line">    +is_valid() -&gt; bool</span><br><span class="line">    +readable() -&gt; bool</span><br><span class="line">    +writable() -&gt; bool</span><br><span class="line">    +executable() -&gt; bool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct PageTable &#123;</span><br><span class="line">    root_ppn: PhysPageNum</span><br><span class="line">    frames: Vec&lt;FrameTracker&gt;</span><br><span class="line">    +new() -&gt; Self</span><br><span class="line">    +from_token(satp: usize) -&gt; Self</span><br><span class="line">    +find_pte_create(...)</span><br><span class="line">    +find_pte(...)</span><br><span class="line">    +map(vpn: VirtPageNum, ppn: PhysPageNum, flags: PTEFlags)</span><br><span class="line">    +unmap(vpn: VirtPageNum)</span><br><span class="line">    +translate(vpn: VirtPageNum) -&gt; Option&lt;PageTableEntry&gt;</span><br><span class="line">    +token() -&gt; usize</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">page_table o-- PTEFlags : 定义</span><br><span class="line">page_table o-- PageTableEntry : 定义</span><br><span class="line">page_table o-- PageTable : 定义</span><br><span class="line"></span><br><span class="line">PageTable *-- PageTableEntry</span><br><span class="line">PageTableEntry *-- PTEFlags</span><br><span class="line">PageTable *-- FrameTracker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MemorySet *-- PageTable</span><br><span class="line">MemorySet *-- MapArea</span><br><span class="line">MapArea *-- VPNRange</span><br><span class="line">MapArea *-- FrameTracker</span><br><span class="line">MapArea *-- MapType</span><br><span class="line">MapArea *-- MapPermission</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">zenuml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">page_table</span><br><span class="line">address</span><br><span class="line">frame_allocator</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Find PageTableEntry by VirtPageNum, create a frame for a 4KB page table if not exist</span><br><span class="line">page_table.&quot;find_pte_create(&amp;mut self, vpn: VirtPageNum)&quot; &#123;</span><br><span class="line">    &#x2F;&#x2F; Get the indexes of the page table entry</span><br><span class="line">    address.&quot;VirtPageNum::indexes(&amp;self)&quot; &#123;</span><br><span class="line">        return &quot;idxs: [usize; 3]&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    for (&quot;(i, idx) in idxs&quot;) &#123;</span><br><span class="line">        &#x2F;&#x2F; Get the reference of page table(array of ptes)</span><br><span class="line">        address.&quot;PhysPageNum::get_pte_array(&amp;self)&quot; &#123;</span><br><span class="line">            return &quot;&amp;&#39;static mut [PageTableEntry]&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if(i &#x3D;&#x3D; 2) &#123;</span><br><span class="line">            return &quot;Some(pte)&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; The page pointered by page table entry is valid?</span><br><span class="line">        bool valid &#x3D; &quot;PageTableEntry::is_valid(&amp;self)&quot;</span><br><span class="line">        </span><br><span class="line">        if(!valid) &#123;</span><br><span class="line">        &#x2F;&#x2F; Allocate a physical page frame in FrameTracker style </span><br><span class="line">            frame_allocator.frame_alloc() &#123;</span><br><span class="line"></span><br><span class="line">                &quot;FRAME_ALLOCATOR.exclusive_access().alloc()&quot; &#123;</span><br><span class="line">                    return &quot;Option&lt;PhysPageNum&gt;&quot;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; Create a new FrameTracker &lt;br&gt;</span><br><span class="line">                &#x2F;&#x2F; clean page</span><br><span class="line">                &quot;Option&lt;PhysPageNum&gt;::map(FrameTracker::new)&quot; &#123;</span><br><span class="line">                    return &quot;Option&lt;FrameTracker&gt;&quot;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                return &quot;Option&lt;FrameTracker&gt;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            &quot;*pte &#x3D; PageTableEntry::new(frame.ppn, PTEFlags::V);&quot;</span><br><span class="line">                &quot;self.frames.push(frame);&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/2024/11/08/2024%E7%A7%8B%E5%86%AC%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-Jasonhonghh/" rel="prev" title="2024秋冬开源操作系统训练营第二阶段总结-Jasonhonghh">
      <i class="fa fa-chevron-left"></i> 2024秋冬开源操作系统训练营第二阶段总结-Jasonhonghh
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/2024/11/08/24aw-rcore-phease1and2-suspenss-summary/" rel="next" title="24aw rcore labs summary">
      24aw rcore labs summary <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rcore-os Group</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>


  















  

  

  

</body>
</html>
