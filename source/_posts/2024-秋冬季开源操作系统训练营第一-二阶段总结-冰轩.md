---
title: 2024 秋冬季开源操作系统训练营第一 & 二阶段总结 - 冰轩
date: 2024-11-10 16:19:54
tags:
    - author: BingXuanOwO
    - repo: https://github.com/LearningOS/2024a-rcore-BingXuanOwO
---

## 前言

这次加入训练营的前因来自于两位朋友曾断断续续提到了 rCore，以及这个与 rCore 有关的 OS 训练营。

关于 Rust，我曾抱着将信将疑的态度。在社交媒体上关于此的风评给我的感受来讲，就好像万物皆可被该语言重写，这个语言能解决一切编程问题。而包括这种偏见在内等原因，我却没有对 Rust 有太多了解。

而至于 OS，我曾因观看过蒋炎岩的 OS 课程而对 OS 略知一二，但却一拖再拖，因各种原因没有完整的学完全部课程以及做完 labs。

我想，是时候改变这一切了。我最终报名加入了进来。

<--! more -->

## PT1. 初次上手 Rust 与 Rustlings

在报名之后，接下来的第一个任务便是完成 Rustlings 全部 110 道题目，以此形成对 Rust 初步的认识。Rust 的基础语法适应起来很快，但是最重要的还是适应 Rust 最核心的 borrow，所有权等一系列与 RAII 相关的设计。虽然碍于 Rustlings 篇幅受限，我没能完整掌握这方面，不过这部分知识还是在 rCore 的实验中补回来了的。

最终，我成功完成了全部的 rustlings 题目，并晋级至重要的下一阶段——rCore。

## PT2. rCore 之旅

接下来要完成的，便是相对而言更为重要的 rCore。一路上磕磕绊绊不少，但还是完成了挑战。

首先是 Lab1，Lab1 的任务主要是理清 rCore 原有的代码结构。我在刚看到 rCore 的框架代码的时候，老实讲的确会感觉无从下手。不过，在我花上一段时间了解原本的代码结构，理解调度部分的实现后，就没感觉问题很大了。这中间有个小插曲--由于我一开始看错了题目，我一开始以为 syscall_times 部分记录的是每次 syscall 调用时对应进程运行的时间，但是后来发现其实是每种 syscall 调用的次数。

接下来是 Lab2。因为 Lab2 的框架代码已经提前实现了多种用于内存管理的 struct，我最开始的想法是直接在内存的 PTE 上做文章。但我后续发现，在不对框架原有分配部分不做出大变动的情况下，这种想法似乎并不可行。我好像又有点手足无措，不过思考过后，我最终想到遍历 `MemorySet` 中全部 `MapArea` 区间计算并调整区间的方案，总算实现了 map 和 unmap 的 syscall。

Lab2 中重写 `sys_get_time` 和 `sys_task_info` 的部分就相对容易些，我实现的方案是按照对应函数所需返回值的大小，对于每个可能包含该变量的虚拟页，反查用户空间对应的物理页，并从内核 0x10000 虚拟页处开始分配虚拟页表然后 map 到对应的物理页。Lab2 原本这部分的实现实际上每次 map 后都不会 unmap 掉， 而是在接下来继续 map 的时候从上一次分配的末尾处 map。但在后面的 Lab 中，由于分配量超出预期，从而会导致其尝试 map 已经在别处分配了的 PTE。到问题发现之后，我添加了 unmap 部分，并使分配都从 0x10000 开始，以此解决了问题。

随后便是 Lab3，相对而言其实还算简单，stride 部分只需要参照题目描述实现。而至于 spawn 部分，可以参照已实现的 fork 与 exec 部分，这样照葫芦画瓢也同样能较为轻松的实现出来。

而接下来的 Lab4，由于项目结构又一次进行了变化，引入了一个新的 easy-fs 库，从而又感到了和刚进行 Lab1 时，没法理解代码结构时的头疼。而在进行 Lab4 的过程中，因为不知为何导致的死锁，我又一次头疼不已，甚至一度想放弃。好在最后因为 Rust RAII 的特性，通过封装一层函数的方式，将某个我并不知情的引用自动 drop 掉，才最终解决了问题。

最后，到了 Lab5，rCore 阶段要结束了。虽然这次我并没有选择将检测死锁的部分独立拆分为单独的 crate，但这部分仍然先在裸机上开发，完成后再移植进内核。由于是直接在裸机上开发，整体调试起来也会方便很多。不过话虽如此，在刚开始的时候，由于我开始进行 Lab5 的时间早于这次线程相关课程的上课时间，且题目没有详尽地描写检测死锁的算法，以及对算法的不熟悉，导致我在这里卡住了很久没有进展。不过最后，我确定了题目给出的算法为 Dijkstra 的银行家算法，在不断的了解这个算法后，最终完成了 Lab5。

_至此，一锤定音。_

_尘埃，已然落定。_
