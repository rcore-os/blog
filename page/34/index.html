<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">
  
  <link rel="stylesheet" href="/blog/lib/animate-css/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rcore-os.github.io","root":"/blog/","scheme":"Muse","version":"8.0.0-rc.4","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="rcore-os Blog">
<meta property="og:url" content="http://rcore-os.github.io/blog/page/34/index.html">
<meta property="og:site_name" content="rcore-os Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="rcore-os Group">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://rcore-os.github.io/blog/page/34/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>rcore-os Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">rcore-os Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rcore-os Group</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">710</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">622</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content index posts-expand">
          
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/05/19/2024%E6%98%A5%E5%A4%8FrCore%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-ChoHee15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/05/19/2024%E6%98%A5%E5%A4%8FrCore%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-ChoHee15/" class="post-title-link" itemprop="url">2024春夏rCore训练营第二阶段总结-ChoHee15</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-19 00:02:18" itemprop="dateCreated datePublished" datetime="2024-05-19T00:02:18+00:00">2024-05-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-27 03:36:30" itemprop="dateModified" datetime="2025-05-27T03:36:30+00:00">2025-05-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="2024春夏rCore训练营第二阶段总结"><a href="#2024春夏rCore训练营第二阶段总结" class="headerlink" title="2024春夏rCore训练营第二阶段总结"></a>2024春夏rCore训练营第二阶段总结</h2><p>参加过2023秋冬，所以ch3-ch5参考了之前的报告。</p>
<p><a href="https://github.com/rcore-os/blog/blob/master/source/_posts/2023%E7%A7%8B%E5%86%ACrCore%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-ChoHee15.md" target="_blank" rel="noopener">2023秋冬报告</a></p>
<p>这里讲讲我之前未接触过的lab。</p>
<h3 id="Lab4-ch6"><a href="#Lab4-ch6" class="headerlink" title="Lab4-ch6"></a>Lab4-ch6</h3><p>对文件系统的了解比较浅，之前也从未以代码的形式接触过文件系统，因此花了不少功夫理解easy-fs的设计。再和群友简短交流后，最终胜利完成了。</p>
<h3 id="Lab5-ch8"><a href="#Lab5-ch8" class="headerlink" title="Lab5-ch8"></a>Lab5-ch8</h3><p>手册给出的算法类似银行家算法，但不太一样。</p>
<p>我感觉没有理解到位，尤其是我自己打了打草稿后，发现不太能理解负值的semaphore要如何如何在这种方法下表示；同时我觉得用这种方法动态检测死锁，好像需要满足一些条件，比如线程p了一定会在后面v之类的。</p>
<p>然后在如何构建算法的矩阵上我也走了弯路，我首先很呆的在线程创建、mutex/sem创建的syscall里添加自定义struct的方法，来动态维护资源矩阵。这使得代码很乱，且static的struct导致运行多个程序时会出问题，需要特殊处理。这导致后面维护和debug很复杂。最后我选择推导重来，在进程这一层添加功能，并在pcb的mutex/sem_list获取各资源的数目，从task获取线程信息。这样功能几乎就集中在了少数地方，比之前轻松很多。</p>
<p>另外，文档中没有提示ch8需要实现时间的syscall，这导致即使死锁检测的逻辑出错，测试也必然出错。初见必然要debug一轮，感觉这个就有点坑了。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>想必于上一期此次要求500分全写完，要求提高了。不过这两个lab由于其内容我接触不多所以感觉还挺有意思的。</p>
<p>然后就是之前也提过的跨章代码合并，还有测试问题。我后来想了想，这好像也没什么办法；跨章合并是由rcore的风格导致的，上下两章代码可能是冲突的，不太好随着章节渐进更新，我见过的一些lab可以做到直接fetch + merge进入下一章；然后用测试框架每次都要恢复文件的问题，麻烦当然是有点麻烦的，但也许受制于某些因素只能这么设计的，如果这个能改了的话就很舒服了。</p>
<p>总的来说训练营还是很不错的，也有在更新维护；我想我们很多学生都应该多一些实际的代码经历，训练营就是这样一个机会。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/05/18/Rust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/05/18/Rust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86/" class="post-title-link" itemprop="url">Rust语言初步以及Rustlings错题整理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-18 15:37:38" itemprop="dateCreated datePublished" datetime="2024-05-18T15:37:38+00:00">2024-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-27 03:36:30" itemprop="dateModified" datetime="2025-05-27T03:36:30+00:00">2025-05-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/2024%E6%98%A5%E5%A4%8F%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5/" itemprop="url" rel="index"><span itemprop="name">2024春夏季开源操作系统训练营</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="RUST语言学习和Rcore实验感想"><a href="#RUST语言学习和Rcore实验感想" class="headerlink" title="RUST语言学习和Rcore实验感想"></a>RUST语言学习和Rcore实验感想</h1><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>​    这篇博客可能长度有点长（<del>逃</del>），因为之前没get到要求，以为blog是从二阶段才开始要写hhhh，所以从来没写过就是了hhh~~</p>
<p>​    这篇blog的主要内容是将我在学习RUST期间所做的笔记做一个整理（主要是来自于RUST语言圣经的节选）以便于自己后续回顾，以及将RUSTLINGS习题集中一些值得标注的语法问题做了记录。</p>
<p>​    :cry:二阶段得好好写了hhhh</p>
<h2 id="RUST语言圣经笔记"><a href="#RUST语言圣经笔记" class="headerlink" title="RUST语言圣经笔记"></a>RUST语言圣经笔记</h2><h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><ol>
<li><p>数据类型</p>
<ul>
<li>数值类型: 有符号整数 (<code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code>, <code>isize</code>)、 无符号整数 (<code>u8</code>, <code>u16</code>, <code>u32</code>, <code>u64</code>, <code>usize</code>) 、浮点数 (<code>f32</code>, <code>f64</code>)、以及有理数、复数<ul>
<li>Nan表示未被定义的结果</li>
<li>debug模式检查整数溢出，release不会管</li>
<li>浮点数不支持判等(eq操作未实现)</li>
</ul>
</li>
<li>字符串：字符串字面量和字符串切片 <code>&amp;str</code></li>
<li>布尔类型： <code>true</code>和<code>false</code>，1个字节</li>
<li>字符类型: 表示单个 <strong>Unicode 字符</strong>，存储为 <strong>4 个字节</strong></li>
<li>单元类型: 即 <code>()</code> ，其唯一的值也是 <code>()</code></li>
</ul>
<p>一般来说不用显式声明，RUST编译器有变量推导</p>
<p>比较逆天的话就不行了……</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> guess = <span class="string">"42"</span>.parse().expect(<span class="string">"Not a number!"</span>);<span class="comment">//推导不了</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//确定类型的三种方式</span></span><br><span class="line"><span class="comment">// 编译器会进行自动推导，给予twenty i32的类型</span></span><br><span class="line"><span class="keyword">let</span> twenty = <span class="number">20</span>;</span><br><span class="line"><span class="comment">// 类型标注</span></span><br><span class="line"><span class="keyword">let</span> twenty_one: <span class="built_in">i32</span> = <span class="number">21</span>;</span><br><span class="line"><span class="comment">// 通过类型后缀的方式进行类型标注：22是i32类型</span></span><br><span class="line"><span class="keyword">let</span> twenty_two = <span class="number">22i32</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>序列</p>
<p>生成<strong>连续值</strong>，只允许用于数字和字符类型（编译器可在编译期确定类型和判空）</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>..=<span class="number">5</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>,i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">'a'</span>..=<span class="string">'z'</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>,i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>函数</p>


</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">add</span></span>(i: <span class="built_in">i32</span>, j: <span class="built_in">i32</span>) -&gt; <span class="built_in">i32</span> &#123;</span><br><span class="line">   i + j</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>特殊返回类型</p>
<ul>
<li><p>无返回值</p>
<ul>
<li>函数没有返回值，那么返回一个 <code>()</code></li>
<li>通过 <code>;</code> 结尾的语句返回一个 <code>()</code></li>
</ul>
</li>
<li><p>发散函数：永不返回</p>
<p>用<code>!</code>作为函数的返回类型</p>
</li>
</ul>
</li>
</ul>
<h3 id="所有权和借用"><a href="#所有权和借用" class="headerlink" title="所有权和借用"></a>所有权和借用</h3><ol>
<li><p>C和RUST的内存管理差别</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>* <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;          <span class="comment">// 变量a的作用域开始</span></span><br><span class="line">    a = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">char</span> *c = <span class="string">"xyz"</span>;   <span class="comment">// 变量c的作用域开始</span></span><br><span class="line">    <span class="keyword">return</span> &amp;a;</span><br><span class="line">&#125;                   <span class="comment">// 变量a和c的作用域结束</span></span><br><span class="line"><span class="comment">//a是常数，被放在栈里，函数返回时出栈，a被回收，&amp;a是悬空指针</span></span><br><span class="line"><span class="comment">//c是字符串常量，在常量区，整个程序结束之后才会回收常量区</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>所有权规则</p>
<ul>
<li><p>Rust 中每一个值都被一个变量所拥有，该变量被称为值的所有者</p>
</li>
<li><p>一个值同时只能被一个变量所拥有，或者说一个值只能拥有一个所有者</p>
</li>
<li><p>当所有者(变量)离开作用域范围时，这个值将被丢弃(drop)</p>
</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> x = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">let</span> y = x;</span><br><span class="line"><span class="comment">//浅拷贝，两个变量都依然有效</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line"><span class="keyword">let</span> s2 = s1;</span><br><span class="line"><span class="comment">//变量移动，默认是只copy指针，不会复制其实际内容</span></span><br><span class="line"><span class="comment">//s1失效，s2接管那片内存空间</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line"><span class="keyword">let</span> s2 = s1.clone();</span><br><span class="line"><span class="comment">//你真想赋值的时候复制其内容，用clone()方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> x: &amp;<span class="built_in">str</span> = <span class="string">"hello, world"</span>;</span><br><span class="line"><span class="keyword">let</span> y = x;</span><br><span class="line"><span class="comment">//浅拷贝，"hello, world"是字符串字面量</span></span><br></pre></td></tr></table></figure>

<p>Copy特征：一个旧的变量在被赋值给其他变量后仍然可用，也就是赋值的过程即是拷贝的过程。<strong>任何基本类型的组合可以 <code>Copy</code> ，不需要分配内存或某种形式资源的类型是可以 <code>Copy</code> 的</strong>。</p>
<ul>
<li>所有整数类型，比如 <code>u32</code></li>
<li>布尔类型，<code>bool</code>，它的值是 <code>true</code> 和 <code>false</code></li>
<li>所有浮点数类型，比如 <code>f64</code></li>
<li>字符类型，<code>char</code></li>
<li>元组，当且仅当其包含的类型也都是 <code>Copy</code> 的时候。比如，<code>(i32, i32)</code> 是 <code>Copy</code> 的，但 <code>(i32, String)</code> 就不是</li>
<li>不可变引用 <code>&amp;T</code> ，例如<a href="https://course.rs/basic/ownership/ownership.html#转移所有权" target="_blank" rel="noopener">转移所有权</a>中的最后一个例子，<strong>但是注意: 可变引用 <code>&amp;mut T</code> 是不可以 Copy的</strong></li>
</ul>
</li>
<li><p>函数传值和返回——所有权的不断变化</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s1 = gives_ownership();         <span class="comment">// gives_ownership 将返回值</span></span><br><span class="line">                                        <span class="comment">// 移给 s1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> s2 = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);     <span class="comment">// s2 进入作用域</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> s3 = takes_and_gives_back(s2);  <span class="comment">// s2 被移动到</span></span><br><span class="line">                                        <span class="comment">// takes_and_gives_back 中,</span></span><br><span class="line">                                        <span class="comment">// 它也将返回值移给 s3</span></span><br><span class="line">&#125; <span class="comment">// 这里, s3 移出作用域并被丢弃。s2 也移出作用域，但已被移走，</span></span><br><span class="line">  <span class="comment">// 所以什么也不会发生。s1 移出作用域并被丢弃</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">gives_ownership</span></span>() -&gt; <span class="built_in">String</span> &#123;             <span class="comment">// gives_ownership 将返回值移动给</span></span><br><span class="line">                                             <span class="comment">// 调用它的函数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> some_string = <span class="built_in">String</span>::from(<span class="string">"hello"</span>); <span class="comment">// some_string 进入作用域.</span></span><br><span class="line"></span><br><span class="line">    some_string                              <span class="comment">// 返回 some_string 并移出给调用的函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// takes_and_gives_back 将传入字符串并返回该值</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">takes_and_gives_back</span></span>(a_string: <span class="built_in">String</span>) -&gt; <span class="built_in">String</span> &#123; <span class="comment">// a_string 进入作用域</span></span><br><span class="line"></span><br><span class="line">    a_string  <span class="comment">// 返回 a_string 并移出给调用的函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>引用</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> len = calculate_length(&amp;s1);<span class="comment">//传入的是引用而不是所有权</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"The length of '&#123;&#125;' is &#123;&#125;."</span>, s1, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">calculate_length</span></span>(s: &amp;<span class="built_in">String</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">    s.len()<span class="comment">//拿到的是引用，因此函数结束的时候不会释放所有权</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">————————————————</span><br><span class="line"><span class="comment">//引用默认不可变（就是你不能动你借用的东西的值）</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> s = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);<span class="comment">//可变引用（可以修改借用的东西）</span></span><br><span class="line"></span><br><span class="line">    change(&amp;<span class="keyword">mut</span> s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">change</span></span>(some_string: &amp;<span class="keyword">mut</span> <span class="built_in">String</span>) &#123;</span><br><span class="line">    some_string.push_str(<span class="string">", world"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">————————————————</span><br><span class="line"><span class="comment">//在同一个作用域只可以存在一个可变引用（互斥锁懂我意思吧……）</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut</span> s = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> r1 = &amp;<span class="keyword">mut</span> s;</span><br><span class="line"><span class="keyword">let</span> r2 = &amp;<span class="keyword">mut</span> s;<span class="comment">//r1的作用域还没寄，你怎么也搞个可变</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">"&#123;&#125;, &#123;&#125;"</span>, r1, r2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">————————————————</span><br><span class="line"><span class="comment">//可变和不可变引用不能同时存在</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut</span> s = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> r1 = &amp;s; <span class="comment">// 没问题</span></span><br><span class="line"><span class="keyword">let</span> r2 = &amp;s; <span class="comment">// 没问题</span></span><br><span class="line"><span class="keyword">let</span> r3 = &amp;<span class="keyword">mut</span> s; <span class="comment">// 大问题</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">"&#123;&#125;, &#123;&#125;, and &#123;&#125;"</span>, r1, r2, r3);</span><br></pre></td></tr></table></figure>

<p>引用的作用域 <code>s</code> 从创建开始，一直持续到它最后一次使用的地方，这个跟变量的作用域有所不同，变量的作用域从创建持续到某一个花括号结束。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">   <span class="keyword">let</span> <span class="keyword">mut</span> s = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> r1 = &amp;s;</span><br><span class="line">    <span class="keyword">let</span> r2 = &amp;s;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125; and &#123;&#125;"</span>, r1, r2);</span><br><span class="line">    <span class="comment">// 新编译器中，r1,r2作用域在这里结束</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> r3 = &amp;<span class="keyword">mut</span> s;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, r3);</span><br><span class="line">&#125; <span class="comment">// 老编译器中，r1、r2、r3作用域在这里结束</span></span><br><span class="line">  <span class="comment">// 新编译器中，r3作用域在这里结束</span></span><br><span class="line"><span class="comment">//Non-Lexical Lifetimes(NLL)特性：用于寻找到某个引用在`&#125;`之前就不再被使用的位置</span></span><br></pre></td></tr></table></figure>

<p>悬垂引用在Rust是不会存在的，因为当你获取数据的引用后，编译器可以确保数据不会在引用结束前被释放，<strong>要想释放数据，必须先停止其引用的使用</strong>。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> reference_to_nothing = dangle();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">dangle</span></span>() -&gt; &amp;<span class="built_in">String</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> s = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line"></span><br><span class="line">    &amp;s<span class="comment">//悬垂引用，会报错</span></span><br><span class="line">    <span class="comment">//解决办法是直接返回s，也就是交出其所有权</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h3 id="复合类型"><a href="#复合类型" class="headerlink" title="复合类型"></a>复合类型</h3><h4 id="字符串和切片"><a href="#字符串和切片" class="headerlink" title="字符串和切片"></a>字符串和切片</h4><ol>
<li><p><strong>Rust 中的字符是 Unicode 类型，因此每个字符占据 4 个字节内存空间，但是在字符串中不一样，字符串是 UTF-8 编码，也就是字符串中的字符所占的字节数是变化的(1 - 4)</strong>。</p>
</li>
<li><p>为啥 <code>String</code> 可变，而字符串字面值 <code>str</code> 却不可以？</p>
<p>就字符串字面值来说，我们在编译时就知道其内容，最终字面值文本被直接硬编码进可执行文件中，这使得字符串字面值快速且高效，这主要得益于字符串字面值的不可变性。不幸的是，我们不能为了获得这种性能，而把每一个在编译时大小未知的文本都放进内存中（你也做不到！），因为有的字符串是在程序运行的过程中动态生成的。</p>
</li>
<li><p>String和&amp;str的转换</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从&amp;str生成String</span></span><br><span class="line"><span class="built_in">String</span>::from(<span class="string">"hello,world"</span>)</span><br><span class="line"><span class="string">"hello,world"</span>.to_string()</span><br><span class="line"></span><br><span class="line"><span class="comment">//String到&amp;str 取切片即可</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s = <span class="built_in">String</span>::from(<span class="string">"hello,world!"</span>);</span><br><span class="line">    say_hello(&amp;s);</span><br><span class="line">    say_hello(&amp;s[..]);</span><br><span class="line">    say_hello(s.as_str());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">say_hello</span></span>(s: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>,s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>字符串索引（Rust<strong>不支持</strong>）</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line"><span class="keyword">let</span> hello = <span class="built_in">String</span>::from(<span class="string">"中国人"</span>);</span><br><span class="line"><span class="keyword">let</span> h = s1[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">let</span> h = hello[<span class="number">0</span>];</span><br><span class="line"><span class="comment">//不同字符的编码长度是不一样的，英文是1byte，中文是3byte，对特定单元的索引不一定有意义</span></span><br></pre></td></tr></table></figure>

<p>还有一个原因导致了 Rust 不允许去索引字符串：因为索引操作，我们总是期望它的性能表现是 O(1)，然而对于 <code>String</code> 类型来说，无法保证这一点，因为 Rust 可能需要从 0 开始去遍历字符串来定位合法的字符。</p>
<p>字符串的区间切片Rust是<strong>支持</strong>的，但是必须谨慎</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> hello = <span class="string">"中国人"</span>;</span><br><span class="line"><span class="keyword">let</span> s = &amp;hello[<span class="number">0</span>..<span class="number">2</span>];</span><br></pre></td></tr></table></figure>
</li>
<li><p>常见字符串操作</p>
<ul>
<li><p>追加和插入</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//追加</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> s = <span class="built_in">String</span>::from(<span class="string">"Hello "</span>);<span class="comment">//mut！</span></span><br><span class="line"></span><br><span class="line">    s.push_str(<span class="string">"rust"</span>);<span class="comment">//追加字符串</span></span><br><span class="line"></span><br><span class="line">    s.push(<span class="string">'!'</span>);<span class="comment">//追加单字符</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//插入 insert需要插入位置和内容 位置越界会报错</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> s = <span class="built_in">String</span>::from(<span class="string">"Hello rust!"</span>);<span class="comment">//mut！</span></span><br><span class="line">    s.insert(<span class="number">5</span>, <span class="string">','</span>);</span><br><span class="line">    s.insert_str(<span class="number">6</span>, <span class="string">" I like"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>替换</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回一个新的字符串，而不是操作原来的字符串！！！</span></span><br><span class="line"><span class="comment">//replace  参数是：被替换内容，用来替换的内容</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> string_replace = <span class="built_in">String</span>::from(<span class="string">"I like rust. Learning rust is my favorite!"</span>);</span><br><span class="line">    <span class="keyword">let</span> new_string_replace = string_replace.replace(<span class="string">"rust"</span>, <span class="string">"RUST"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//replacen  和前面差不多，不过是替换n个匹配到的</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> string_replace = <span class="string">"I like rust. Learning rust is my favorite!"</span>;</span><br><span class="line">    <span class="keyword">let</span> new_string_replacen = string_replace.replacen(<span class="string">"rust"</span>, <span class="string">"RUST"</span>, <span class="number">1</span>);</span><br><span class="line">    dbg!(new_string_replacen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//方法是直接操作原来的字符串，不会返回新的字符串！！！</span></span><br><span class="line"><span class="comment">//replace_range  替换特定范围</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> string_replace_range = <span class="built_in">String</span>::from(<span class="string">"I like rust!"</span>);<span class="comment">//mut！！！</span></span><br><span class="line">    string_replace_range.replace_range(<span class="number">7</span>..<span class="number">8</span>, <span class="string">"R"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//直接操作原来的字符串  mut！！！</span></span><br><span class="line"><span class="comment">//pop  删除并返回最后一个字符 由于不确保存在，返回的是Option()类型 需要具体考察</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> string_pop = <span class="built_in">String</span>::from(<span class="string">"rust pop 中文!"</span>);</span><br><span class="line">    <span class="keyword">let</span> p1 = string_pop.pop();</span><br><span class="line">    <span class="keyword">let</span> p2 = string_pop.pop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//remove 删除指定位置的一个字符  注意给的索引要合法（表示字符的起始位置）</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> string_remove = <span class="built_in">String</span>::from(<span class="string">"测试remove方法"</span>);</span><br><span class="line">    <span class="built_in">println!</span>(</span><br><span class="line">        <span class="string">"string_remove 占 &#123;&#125; 个字节"</span>,</span><br><span class="line">        std::mem::size_of_val(string_remove.as_str())</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 删除第一个汉字</span></span><br><span class="line">    string_remove.remove(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 下面代码会发生错误</span></span><br><span class="line">    <span class="comment">// string_remove.remove(1);</span></span><br><span class="line">    <span class="comment">// 直接删除第二个汉字</span></span><br><span class="line">    <span class="comment">// string_remove.remove(3);</span></span><br><span class="line">    dbg!(string_remove);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//truncate 从当前位置直接删除到结尾 注意给的索引</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> string_truncate = <span class="built_in">String</span>::from(<span class="string">"测试truncate"</span>);</span><br><span class="line">    string_truncate.truncate(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//clear 清空</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> string_clear = <span class="built_in">String</span>::from(<span class="string">"string clear"</span>);</span><br><span class="line">    string_clear.clear();</span><br><span class="line">    dbg!(string_clear);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//+或+=   +右边的必须是切片引用类型</span></span><br><span class="line"><span class="comment">//返回一个新的字符串，所以变量声明可以不需要 mut 关键字修饰</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> string_append = <span class="built_in">String</span>::from(<span class="string">"hello "</span>);</span><br><span class="line">    <span class="keyword">let</span> string_rust = <span class="built_in">String</span>::from(<span class="string">"rust"</span>);</span><br><span class="line">    <span class="comment">// &amp;string_rust会自动解引用为&amp;str</span></span><br><span class="line">    <span class="keyword">let</span> result = string_append + &amp;string_rust;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> result = result + <span class="string">"!"</span>; <span class="comment">// `result + "!"` 中的 `result` 是不可变的</span></span><br><span class="line">    result += <span class="string">"!!!"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"连接字符串 + -&gt; &#123;&#125;"</span>, result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//format!() 格式化输出</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s1 = <span class="string">"hello"</span>;</span><br><span class="line">    <span class="keyword">let</span> s2 = <span class="built_in">String</span>::from(<span class="string">"rust"</span>);</span><br><span class="line">    <span class="keyword">let</span> s = <span class="built_in">format!</span>(<span class="string">"&#123;&#125; &#123;&#125;!"</span>, s1, s2);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ol>
<h4 id="元组"><a href="#元组" class="headerlink" title="元组"></a>元组</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//模式匹配解构元组</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> tup = (<span class="number">500</span>, <span class="number">6.4</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> (x, y, z) = tup;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"The value of y is: &#123;&#125;"</span>, y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用.访问元组</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x: (<span class="built_in">i32</span>, <span class="built_in">f64</span>, <span class="built_in">u8</span>) = (<span class="number">500</span>, <span class="number">6.4</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> five_hundred = x.<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> six_point_four = x.<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> one = x.<span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h4><ol>
<li><p>结构体语法</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">User</span></span> &#123;</span><br><span class="line">    active: <span class="built_in">bool</span>,</span><br><span class="line">    username: <span class="built_in">String</span>,</span><br><span class="line">    email: <span class="built_in">String</span>,</span><br><span class="line">    sign_in_count: <span class="built_in">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化  每个字段都要初始化</span></span><br><span class="line">    <span class="keyword">let</span> user1 = User &#123;</span><br><span class="line">        email: <span class="built_in">String</span>::from(<span class="string">"someone@example.com"</span>),</span><br><span class="line">        username: <span class="built_in">String</span>::from(<span class="string">"someusername123"</span>),</span><br><span class="line">        active: <span class="literal">true</span>,</span><br><span class="line">        sign_in_count: <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过.来访问结构体内部字段</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> user1 = User &#123;  <span class="comment">//要改的话还是要mut</span></span><br><span class="line">        email: <span class="built_in">String</span>::from(<span class="string">"someone@example.com"</span>),</span><br><span class="line">        username: <span class="built_in">String</span>::from(<span class="string">"someusername123"</span>),</span><br><span class="line">        active: <span class="literal">true</span>,</span><br><span class="line">        sign_in_count: <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    user1.email = <span class="built_in">String</span>::from(<span class="string">"anotheremail@example.com"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//当函数参数和结构体字段名称一样时，可以简写</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">build_user</span></span>(email: <span class="built_in">String</span>, username: <span class="built_in">String</span>) -&gt; User &#123;</span><br><span class="line">    User &#123;</span><br><span class="line">        email,</span><br><span class="line">        username,<span class="comment">//缩略的初始化</span></span><br><span class="line">        active: <span class="literal">true</span>,</span><br><span class="line">        sign_in_count: <span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新</span></span><br><span class="line">  <span class="keyword">let</span> user2 = User &#123;</span><br><span class="line">        email: <span class="built_in">String</span>::from(<span class="string">"another@example.com"</span>),</span><br><span class="line">        ..user1  <span class="comment">//未显式声明的字段都会从user1中获取   不过..user1只可以写在末尾</span></span><br><span class="line">    &#125;;<span class="comment">//也就是说你要赋值的写在前面</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//更新过程可能会有某些字段发生了所有权的转移，不会影响其他字段的访问</span></span><br><span class="line"><span class="keyword">let</span> user1 = User &#123;</span><br><span class="line">    email: <span class="built_in">String</span>::from(<span class="string">"someone@example.com"</span>),</span><br><span class="line">    username: <span class="built_in">String</span>::from(<span class="string">"someusername123"</span>),</span><br><span class="line">    active: <span class="literal">true</span>,</span><br><span class="line">    sign_in_count: <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> user2 = User &#123;</span><br><span class="line">    active: user1.active,</span><br><span class="line">    username: user1.username,</span><br><span class="line">    email: <span class="built_in">String</span>::from(<span class="string">"another@example.com"</span>),</span><br><span class="line">    sign_in_count: user1.sign_in_count,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, user1.active);</span><br><span class="line"><span class="comment">// 下面这行会报错</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">"&#123;:?&#125;"</span>, user1);</span><br></pre></td></tr></table></figure>
</li>
<li><p>元组结构体</p>
<p>为整个结构体提供名称，而字段不需要</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Color</span></span>(<span class="built_in">i32</span>, <span class="built_in">i32</span>, <span class="built_in">i32</span>);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Point</span></span>(<span class="built_in">i32</span>, <span class="built_in">i32</span>, <span class="built_in">i32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> black = Color(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">let</span> origin = Point(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>单元结构体：没有任何字段和属性的结构体</p>
</li>
</ol>
<h4 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h4><ol>
<li><p>任何数据类型都可以放到枚举中</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">PokerCard</span></span> &#123;</span><br><span class="line">    Clubs(<span class="built_in">u8</span>),</span><br><span class="line">    Spades(<span class="built_in">u8</span>),</span><br><span class="line">    Diamonds(<span class="built_in">char</span>),<span class="comment">//定义枚举成员时关联数据</span></span><br><span class="line">    Hearts(<span class="built_in">char</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">   <span class="keyword">let</span> c1 = PokerCard::Spades(<span class="number">5</span>);</span><br><span class="line">   <span class="keyword">let</span> c2 = PokerCard::Diamonds(<span class="string">'A'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>枚举和结构体的对比</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用枚举来定义这些消息</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Message</span></span> &#123;</span><br><span class="line">    Quit,</span><br><span class="line">    Move &#123; x: <span class="built_in">i32</span>, y: <span class="built_in">i32</span> &#125;,</span><br><span class="line">    Write(<span class="built_in">String</span>),</span><br><span class="line">    ChangeColor(<span class="built_in">i32</span>, <span class="built_in">i32</span>, <span class="built_in">i32</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> m1 = Message::Quit;</span><br><span class="line">    <span class="keyword">let</span> m2 = Message::Move&#123;x:<span class="number">1</span>,y:<span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">let</span> m3 = Message::ChangeColor(<span class="number">255</span>,<span class="number">255</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用结构体来定义这些消息</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QuitMessage</span></span>; <span class="comment">// 单元结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MoveMessage</span></span> &#123;</span><br><span class="line">    x: <span class="built_in">i32</span>,</span><br><span class="line">    y: <span class="built_in">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">WriteMessage</span></span>(<span class="built_in">String</span>); <span class="comment">// 元组结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ChangeColorMessage</span></span>(<span class="built_in">i32</span>, <span class="built_in">i32</span>, <span class="built_in">i32</span>); <span class="comment">// 元组结构体</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//由于每个结构体都有自己的类型，因此我们无法在需要同一类型的地方进行使用，例如某个函数它的功能是接受消息并进行发送，那么用枚举的方式，就可以接收不同的消息，但是用结构体，该函数无法接受 4 个不同的结构体作为参数。</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>取代NULL的方式——Option()枚举</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Option()枚举定义</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Option</span></span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="literal">Some</span>(T), <span class="comment">//T可以是任何类型</span></span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//示例</span></span><br><span class="line">——————————————</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> some_number = <span class="literal">Some</span>(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">let</span> some_string = <span class="literal">Some</span>(<span class="string">"a string"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> absent_number: <span class="built_in">Option</span>&lt;<span class="built_in">i32</span>&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="comment">//当有个None值时，你需要告诉编译器T的类型，因为编译器无法通过None来推断本来应该是什么</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Option()枚举的好处</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> x: <span class="built_in">i8</span> = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">let</span> y: <span class="built_in">Option</span>&lt;<span class="built_in">i8</span>&gt; = <span class="literal">Some</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sum = x + y;<span class="comment">//报错！Option(i8)和i8并不是同一种类型</span></span><br></pre></td></tr></table></figure>

<p>当在 Rust 中拥有一个像 <code>i8</code> 这样类型的值时，编译器确保它总是有一个有效的值，我们可以放心使用而无需做空值检查。只有当使用 <code>Option&lt;i8&gt;</code>（或者任何用到的类型）的时候才需要担心可能没有值，而编译器会确保我们在使用值之前处理了为空的情况。</p>
<p>换句话说，在对 <code>Option&lt;T&gt;</code> 进行 <code>T</code> 的运算之前必须将其转换为 <code>T</code>。通常这能帮助我们捕获到空值最常见的问题之一：期望某值不为空但实际上为空的情况。</p>
</li>
<li><p>match表达式可以用于处理枚举</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">plus_one</span></span>(x: <span class="built_in">Option</span>&lt;<span class="built_in">i32</span>&gt;) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">i32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">match</span> x &#123;</span><br><span class="line">        <span class="literal">None</span> =&gt; <span class="literal">None</span>,</span><br><span class="line">        <span class="literal">Some</span>(i) =&gt; <span class="literal">Some</span>(i + <span class="number">1</span>),</span><br><span class="line">    &#125;<span class="comment">//如果接收到Some(i)类型，将其中的变量绑定到i上，计算i+1，再将其用Some()包裹</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> five = <span class="literal">Some</span>(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">let</span> six = plus_one(five);</span><br><span class="line"><span class="keyword">let</span> none = plus_one(<span class="literal">None</span>);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h4><ol>
<li><p>创建</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RUST的数组是定长的，被存储在栈上</span></span><br><span class="line"><span class="comment">//变长的动态数组被存储在堆上</span></span><br><span class="line"><span class="comment">//数组的长度也是类型的一部分</span></span><br><span class="line"><span class="keyword">let</span> a: [<span class="built_in">i32</span>; <span class="number">5</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//声明多个重复值</span></span><br><span class="line"><span class="keyword">let</span> a = [<span class="number">3</span>; <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//非基础类型数组的创建</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//这样子写会报错，本质还是因为string不能浅拷贝</span></span><br><span class="line"><span class="keyword">let</span> array = [<span class="built_in">String</span>::from(<span class="string">"rust is good!"</span>); <span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//这样子写可以，但是很难看</span></span><br><span class="line"><span class="keyword">let</span> array = [<span class="built_in">String</span>::from(<span class="string">"rust is good!"</span>),<span class="built_in">String</span>::from(<span class="string">"rust is good!"</span>),<span class="built_in">String</span>::from(<span class="string">"rust is good!"</span>)];</span><br><span class="line"></span><br><span class="line"><span class="comment">//遇到非基本类型数组 调用std::array::from_fn</span></span><br><span class="line"><span class="keyword">let</span> array: [<span class="built_in">String</span>; <span class="number">8</span>] = std::array::from_fn(|_i| <span class="built_in">String</span>::from(<span class="string">"rust is good!"</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>支持索引访问，<strong>如果越界会崩溃</strong></p>
</li>
</ol>
<h3 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>..=<span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果想在循环中获取元素的索引，使用.iter()方法获得迭代器</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [<span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>];</span><br><span class="line">    <span class="comment">// `.iter()` 方法把 `a` 数组变成一个迭代器</span></span><br><span class="line">    <span class="keyword">for</span> (i, v) <span class="keyword">in</span> a.iter().enumerate() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"第&#123;&#125;个元素是&#123;&#125;"</span>, i + <span class="number">1</span>, v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>使用方法</th>
<th>等价使用方式</th>
<th>所有权</th>
</tr>
</thead>
<tbody><tr>
<td><code>for item in collection</code></td>
<td><code>for item in IntoIterator::into_iter(collection)</code></td>
<td>转移所有权</td>
</tr>
<tr>
<td><code>for item in &amp;collection</code></td>
<td><code>for item in collection.iter()</code></td>
<td>不可变借用</td>
</tr>
<tr>
<td><code>for item in &amp;mut collection</code></td>
<td><code>for item in collection.iter_mut()</code></td>
<td>可变借用</td>
</tr>
</tbody></table>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一种</span></span><br><span class="line"><span class="keyword">let</span> collection = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..collection.len() &#123;</span><br><span class="line">  <span class="keyword">let</span> item = collection[i];</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> collection &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//while循环</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> index &lt; <span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"the value is: &#123;&#125;"</span>, a[index]);</span><br><span class="line"></span><br><span class="line">        index = index + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="comment">//用while循环来实现和第一种for循环是一样的</span></span><br></pre></td></tr></table></figure>

<p>第一种方式是循环索引，然后通过索引下标去访问集合，第二种方式是直接循环集合中的元素，优劣如下：</p>
<ul>
<li><strong>性能</strong>：第一种使用方式中 <code>collection[index]</code> 的索引访问，会因为边界检查(Bounds Checking)导致运行时的性能损耗 —— Rust 会检查并确认 <code>index</code> 是否落在集合内，但是第二种直接迭代的方式就不会触发这种检查，因为编译器会在编译时就完成分析并证明这种访问是合法的</li>
<li><strong>安全</strong>：第一种方式里对 <code>collection</code> 的索引访问是非连续的，存在一定可能性在两次访问之间，<code>collection</code> 发生了变化，导致脏数据产生。而第二种直接迭代的方式是连续访问，因此不存在这种风险( 由于所有权限制，在访问过程中，数据并不会发生变化)。</li>
</ul>
<p>loop：简单的无限循环，需要搭配break跳出</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> result = <span class="keyword">loop</span> &#123;</span><br><span class="line">        counter += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> counter == <span class="number">10</span> &#123;</span><br><span class="line">            <span class="keyword">break</span> counter * <span class="number">2</span>;<span class="comment">//break可以单独使用直接跳出，也可以带一个值返回（类似return）</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"The result is &#123;&#125;"</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="模式匹配"><a href="#模式匹配" class="headerlink" title="模式匹配"></a>模式匹配</h3><h4 id="match和if-let"><a href="#match和if-let" class="headerlink" title="match和if let"></a>match和if let</h4><ol>
<li><p>匹配</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Coin</span></span> &#123;</span><br><span class="line">    Penny,</span><br><span class="line">    Nickel,</span><br><span class="line">    Dime,</span><br><span class="line">    Quarter,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">value_in_cents</span></span>(coin: Coin) -&gt; <span class="built_in">u8</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> coin &#123;</span><br><span class="line">        Coin::Penny =&gt;  &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"Lucky penny!"</span>);</span><br><span class="line">            <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        Coin::Nickel =&gt; <span class="number">5</span>,</span><br><span class="line">        Coin::Dime =&gt; <span class="number">10</span>,</span><br><span class="line">        Coin::Quarter =&gt; <span class="number">25</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//match匹配需要穷尽所有的可能，用_表示没有列出的其他可能性(如果没有穷尽可能性的话会报错)</span></span><br><span class="line"><span class="comment">//match的每一个分支都必须是一个表达式,且所有分支的表达式最终返回值的类型必须相同</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>模式绑定</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">UsState</span></span> &#123;</span><br><span class="line">    Alabama,</span><br><span class="line">    Alaska,</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Coin</span></span> &#123;</span><br><span class="line">    Penny,</span><br><span class="line">    Nickel,</span><br><span class="line">    Dime,</span><br><span class="line">    Quarter(UsState), <span class="comment">// 25美分硬币</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">value_in_cents</span></span>(coin: Coin) -&gt; <span class="built_in">u8</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> coin &#123;</span><br><span class="line">        Coin::Penny =&gt; <span class="number">1</span>,</span><br><span class="line">        Coin::Nickel =&gt; <span class="number">5</span>,</span><br><span class="line">        Coin::Dime =&gt; <span class="number">10</span>,</span><br><span class="line">        Coin::Quarter(state) =&gt; &#123;<span class="comment">//这里将枚举类别Coin中的UsState值绑定给state变量</span></span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"State quarter from &#123;:?&#125;!"</span>, state);</span><br><span class="line">            <span class="number">25</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>if let匹配</p>
<p>当我们只关注某个特定的值的匹配情况时，可以使用if let匹配代替match</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> v = <span class="literal">Some</span>(<span class="number">3u8</span>);</span><br><span class="line"><span class="keyword">match</span> v &#123;</span><br><span class="line">    <span class="literal">Some</span>(<span class="number">3</span>) =&gt; <span class="built_in">println!</span>(<span class="string">"three"</span>),</span><br><span class="line">    _ =&gt; (),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//if let匹配</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(<span class="number">3</span>) = v &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"three"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>matches!()宏</p>
<p>将表达式和模式进行匹配，返回True或者False</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">MyEnum</span></span> &#123;</span><br><span class="line">    Foo,</span><br><span class="line">    Bar</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> v = <span class="built_in">vec!</span>[MyEnum::Foo,MyEnum::Bar,MyEnum::Foo];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//对v进行过滤，只保留类型为MyEnum::Foo的元素</span></span><br><span class="line">v.iter().filter(|x| matches!(x, MyEnum::Foo));</span><br><span class="line"></span><br><span class="line"><span class="comment">//更多例子</span></span><br><span class="line"><span class="keyword">let</span> foo = <span class="string">'f'</span>;</span><br><span class="line"><span class="built_in">assert!</span>(matches!(foo, <span class="string">'A'</span>..=<span class="string">'Z'</span> | <span class="string">'a'</span>..=<span class="string">'z'</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> bar = <span class="literal">Some</span>(<span class="number">4</span>);</span><br><span class="line"><span class="built_in">assert!</span>(matches!(bar, <span class="literal">Some</span>(x) <span class="keyword">if</span> x &gt; <span class="number">2</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>match和if let匹配导致的变量遮蔽</p>
<p>​    尽量不要使用同名变量</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">   <span class="keyword">let</span> age = <span class="literal">Some</span>(<span class="number">30</span>);</span><br><span class="line">   <span class="built_in">println!</span>(<span class="string">"在匹配前，age是&#123;:?&#125;"</span>,age);</span><br><span class="line">   <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(age) = age &#123;</span><br><span class="line">       <span class="built_in">println!</span>(<span class="string">"匹配出来的age是&#123;&#125;"</span>,age);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">println!</span>(<span class="string">"在匹配后，age是&#123;:?&#125;"</span>,age);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">   <span class="keyword">let</span> age = <span class="literal">Some</span>(<span class="number">30</span>);</span><br><span class="line">   <span class="built_in">println!</span>(<span class="string">"在匹配前，age是&#123;:?&#125;"</span>,age);</span><br><span class="line">   <span class="keyword">match</span> age &#123;</span><br><span class="line">       <span class="literal">Some</span>(age) =&gt;  <span class="built_in">println!</span>(<span class="string">"匹配出来的age是&#123;&#125;"</span>,age),</span><br><span class="line">       _ =&gt; ()</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="built_in">println!</span>(<span class="string">"在匹配后，age是&#123;:?&#125;"</span>,age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="一些模式适用场景"><a href="#一些模式适用场景" class="headerlink" title="一些模式适用场景"></a>一些模式适用场景</h4><ol>
<li><p>while let 只要匹配就会一直循环下去</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vec是动态数组</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut</span> stack = <span class="built_in">Vec</span>::new();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向数组尾部插入元素</span></span><br><span class="line">stack.push(<span class="number">1</span>);</span><br><span class="line">stack.push(<span class="number">2</span>);</span><br><span class="line">stack.push(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// stack.pop从数组尾部弹出元素</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">let</span> <span class="literal">Some</span>(top) = stack.pop() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, top);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>let和if let</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="literal">Some</span>(x) = some_option_value;<span class="comment">//报错，有可能是None</span></span><br><span class="line"><span class="comment">//let，match，for都需要完全匹配(不可驳匹配)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(x) = some_option_value &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, x);</span><br><span class="line">&#125;<span class="comment">//通过，只要有值的情况，其余情况忽略(可驳模式匹配)</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="全模式列表"><a href="#全模式列表" class="headerlink" title="全模式列表"></a>全模式列表</h4><ol>
<li><p>用序列语法<code>..=</code>匹配区间内的值（还是只能用于数字和字符）</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> x = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> x &#123;</span><br><span class="line">    <span class="number">1</span>..=<span class="number">5</span> =&gt; <span class="built_in">println!</span>(<span class="string">"one through five"</span>),</span><br><span class="line">    _ =&gt; <span class="built_in">println!</span>(<span class="string">"something else"</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用模式忽略值</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//忽略函数变量</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">foo</span></span>(_: <span class="built_in">i32</span>, y: <span class="built_in">i32</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"This code only uses the y parameter: &#123;&#125;"</span>, y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    foo(<span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用<code>_</code>忽略值和用<code>_s</code>的区别</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> s = <span class="literal">Some</span>(<span class="built_in">String</span>::from(<span class="string">"Hello!"</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(_s) = s &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"found a string"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">"&#123;:?&#125;"</span>, s);<span class="comment">//会报错，因为s的所有权已经转移给_s了</span></span><br><span class="line"></span><br><span class="line">——————————————————————————</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> s = <span class="literal">Some</span>(<span class="built_in">String</span>::from(<span class="string">"Hello!"</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(_) = s &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"found a string"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">"&#123;:?&#125;"</span>, s);<span class="comment">//使用下划线本身是不会绑定值的</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>..</code>忽略多个值需要保证没有歧义</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> numbers = (<span class="number">2</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> numbers &#123;</span><br><span class="line">        (.., second, ..) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"Some numbers: &#123;&#125;"</span>, second)</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="comment">//报错，编译器无法理解second具体指哪个</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>匹配守卫——为匹配提供额外条件</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = <span class="literal">Some</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">let</span> y = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> x &#123;</span><br><span class="line">        <span class="literal">Some</span>(<span class="number">50</span>) =&gt; <span class="built_in">println!</span>(<span class="string">"Got 50"</span>),</span><br><span class="line">        <span class="literal">Some</span>(n) <span class="keyword">if</span> n == y =&gt; <span class="built_in">println!</span>(<span class="string">"Matched, n = &#123;&#125;"</span>, n),</span><br><span class="line">        <span class="comment">//通过匹配守卫，使得在匹配中也可以正常的使用外部变量，而不用担心变量遮蔽的问题</span></span><br><span class="line">        _ =&gt; <span class="built_in">println!</span>(<span class="string">"Default case, x = &#123;:?&#125;"</span>, x),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"at the end: x = &#123;:?&#125;, y = &#123;&#125;"</span>, x, y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">——————————————————</span><br><span class="line"><span class="comment">//匹配守卫的优先级：会作用于所有的匹配项</span></span><br><span class="line"><span class="keyword">let</span> x = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">let</span> y = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> x &#123;</span><br><span class="line">    <span class="number">4</span> | <span class="number">5</span> | <span class="number">6</span> <span class="keyword">if</span> y =&gt; <span class="built_in">println!</span>(<span class="string">"yes"</span>),</span><br><span class="line">    _ =&gt; <span class="built_in">println!</span>(<span class="string">"no"</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@绑定——提供在限定范围条件下，在分支代码内部使用变量的能力</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Message</span></span> &#123;</span><br><span class="line">    Hello &#123; id: <span class="built_in">i32</span> &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> msg = Message::Hello &#123; id: <span class="number">5</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> msg &#123;</span><br><span class="line">    Message::Hello &#123; id: id_variable @ <span class="number">3</span>..=<span class="number">7</span> &#125; =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Found an id in range: &#123;&#125;"</span>, id_variable)</span><br><span class="line">    &#125;,<span class="comment">//@变量绑定，限定范围且绑定变量</span></span><br><span class="line">    Message::Hello &#123; id: <span class="number">10</span>..=<span class="number">12</span> &#125; =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Found an id in another range"</span>)</span><br><span class="line">    &#125;,<span class="comment">//限定了范围，但是这样子只会匹配，而id这个量用不了</span></span><br><span class="line">    Message::Hello &#123; id &#125; =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Found some other id: &#123;&#125;"</span>, id)</span><br><span class="line">    &#125;,<span class="comment">//可以匹配并绑定到id上，但是这样子限制不了范围</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">————————————————</span><br><span class="line"><span class="comment">//绑定的同时对变量结构</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Point</span></span> &#123;</span><br><span class="line">    x: <span class="built_in">i32</span>,</span><br><span class="line">    y: <span class="built_in">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="comment">// 绑定新变量 `p`，同时对 `Point` 进行解构</span></span><br><span class="line">    <span class="keyword">let</span> p @ Point &#123;x: px, y: py &#125; = Point &#123;x: <span class="number">10</span>, y: <span class="number">23</span>&#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"x: &#123;&#125;, y: &#123;&#125;"</span>, px, py);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;:?&#125;"</span>, p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> point = Point &#123;x: <span class="number">10</span>, y: <span class="number">5</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> p @ Point &#123;x: <span class="number">10</span>, y&#125; = point &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"x is 10 and y is &#123;&#125; in &#123;:?&#125;"</span>, y, p);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"x was not 10 :("</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h3 id="方法Method"><a href="#方法Method" class="headerlink" title="方法Method"></a>方法Method</h3><ol>
<li><p>定义和初始化</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Circle</span></span> &#123;</span><br><span class="line">    x: <span class="built_in">f64</span>,</span><br><span class="line">    y: <span class="built_in">f64</span>,</span><br><span class="line">    radius: <span class="built_in">f64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Circle &#123;</span><br><span class="line">    <span class="comment">// new是Circle的关联函数，因为它的第一个参数不是self，且new并不是关键字</span></span><br><span class="line">    <span class="comment">// 这种方法往往用于初始化当前结构体的实例</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(x: <span class="built_in">f64</span>, y: <span class="built_in">f64</span>, radius: <span class="built_in">f64</span>) -&gt; Circle &#123;</span><br><span class="line">        Circle &#123;</span><br><span class="line">            x: x,</span><br><span class="line">            y: y,</span><br><span class="line">            radius: radius,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Circle的方法，&amp;self表示借用当前的Circle结构体</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">area</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">f64</span> &#123;</span><br><span class="line">        std::<span class="built_in">f64</span>::consts::PI * (<span class="keyword">self</span>.radius * <span class="keyword">self</span>.radius)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    这种定义在 <code>impl</code> 中且没有 <code>self</code> 的函数被称之为<strong>关联函数</strong>： 因为它没有 <code>self</code>，不能用 <code>f.read()</code> 的形式调用，因此它是一个函数而不是方法，它又在 <code>impl</code> 中，与结构体紧密关联，因此称为关联函数。</p>
<p>​    因为是函数，所以不能用 <code>.</code> 的方式来调用，我们需要用 <code>::</code> 来调用，例如 <code>let sq = Rectangle::new(3, 3);</code>。这个方法位于结构体的命名空间中：<code>::</code> 语法用于关联函数和模块创建的命名空间。</p>
<img src="/blog/.io//2024/05/18/Rust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86/method.png" class="D:\116\sigs\blog\source\_posts\Rust语言初步以及Rustlings错题整理">

<p>其他的语言往往将类型和方法一起定义，而Rust对这两者的定义是分开的。</p>
</li>
<li><p>self和被实例化类型的关系</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Rectangle</span></span> &#123;</span><br><span class="line">    width: <span class="built_in">u32</span>,</span><br><span class="line">    height: <span class="built_in">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Rectangle &#123;<span class="comment">//方法名称可以和结构体的名称相同</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">area</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.width * <span class="keyword">self</span>.height</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//self 表示 Rectangle 的所有权转移到该方法中，这种形式用的较少</span></span><br><span class="line">    <span class="comment">//&amp;self 表示该方法对 Rectangle 的不可变借用</span></span><br><span class="line">    <span class="comment">//&amp;mut self 表示可变借用</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> rect1 = Rectangle &#123; width: <span class="number">30</span>, height: <span class="number">50</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(</span><br><span class="line">        <span class="string">"The area of the rectangle is &#123;&#125; square pixels."</span>,</span><br><span class="line">        rect1.area()</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>方法和字段同名的好处</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Rectangle</span></span> &#123;</span><br><span class="line">    width: <span class="built_in">u32</span>,</span><br><span class="line">    height: <span class="built_in">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Rectangle &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(width: <span class="built_in">u32</span>, height: <span class="built_in">u32</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Rectangle &#123; width, height &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">width</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">u32</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.width;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> rect1 = Rectangle::new(<span class="number">30</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, rect1.width());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    方法和字段同名有助于我们实现访问器，我们可以将<code>width</code>和<code>height</code>设置为私有属性，而通过<code>pub</code>关键字将<code>Rectangle</code>结构体对应的<code>new</code>方法和<code>width</code>方法设置为公有方法，这样子用户可以通过<code>rect1.width()</code>方法访问到宽度的数据，却无法直接使用<code>rect1.width</code>来访问。</p>
</li>
<li><p>Rust中用自动引用/解引用机制代替了C/C++的-&gt;运算符</p>
<p>​    在 C/C++ 语言中，有两个不同的运算符来调用方法：<code>.</code> 直接在对象上调用方法，而 <code>-&gt;</code> 在一个对象的指针上调用方法，这时需要先解引用指针。换句话说，如果 <code>object</code> 是一个指针，那么 <code>object-&gt;something()</code> 和 <code>(*object).something()</code> 是一样的。</p>
<p>​    Rust 并没有一个与 <code>-&gt;</code> 等效的运算符；相反，Rust 有一个叫 <strong>自动引用和解引用</strong>的功能。方法调用是 Rust 中少数几个拥有这种行为的地方。</p>
<p>​    他是这样工作的：当使用 <code>object.something()</code> 调用方法时，Rust 会自动为 <code>object</code> 添加 <code>&amp;</code>、<code>&amp;mut</code> 或 <code>*</code> 以便使 <code>object</code> 与方法签名匹配。也就是说，这些代码是等价的：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p1.distance(&amp;p2);</span><br><span class="line">(&amp;p1).distance(&amp;p2);</span><br></pre></td></tr></table></figure>

<p>​    第一行看起来简洁的多。这种自动引用的行为之所以有效，是因为方法有一个明确的接收者———— <code>self</code> 的类型。在给出接收者和方法名的前提下，Rust 可以明确地计算出方法是仅仅读取（<code>&amp;self</code>），做出修改（<code>&amp;mut self</code>）或者是获取所有权（<code>self</code>）。事实上，Rust 对方法接收者的隐式借用让所有权在实践中更友好。</p>
</li>
</ol>
<h3 id="泛型和特征"><a href="#泛型和特征" class="headerlink" title="泛型和特征"></a>泛型和特征</h3><h4 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h4><ol>
<li><p>代替值的泛型，而不是针对类型的泛型</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这段代码会报错，因为不同长度的数组在Rust中是不同的类型</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">display_array</span></span>(arr: [<span class="built_in">i32</span>; <span class="number">3</span>]) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;:?&#125;"</span>, arr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> arr: [<span class="built_in">i32</span>; <span class="number">3</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    display_array(arr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> arr: [<span class="built_in">i32</span>; <span class="number">2</span>] = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">    display_array(arr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用切片的方式打印任意长度的数组，同时用泛型指代不同的类型</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">display_array</span></span>&lt;T: std::fmt::<span class="built_in">Debug</span>&gt;(arr: &amp;[T]) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;:?&#125;"</span>, arr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> arr: [<span class="built_in">i32</span>; <span class="number">3</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    display_array(&amp;arr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> arr: [<span class="built_in">i32</span>; <span class="number">2</span>] = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">    display_array(&amp;arr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//切片是一种引用，但是有的场景不允许我们使用引用，此时通过const泛型指代不同的长度</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">display_array</span></span>&lt;T: std::fmt::<span class="built_in">Debug</span>, <span class="keyword">const</span> N: <span class="built_in">usize</span>&gt;(arr: [T; N]) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;:?&#125;"</span>, arr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> arr: [<span class="built_in">i32</span>; <span class="number">3</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    display_array(arr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> arr: [<span class="built_in">i32</span>; <span class="number">2</span>] = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">    display_array(arr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>泛型的性能</p>
<p>编译器完成<strong>单态化</strong>的过程，增加了编译的繁琐程度，也让编译后的文件更大</p>
<p>会对每一个具体用到的类型都生成一份代码</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//程序编写</span></span><br><span class="line"><span class="keyword">let</span> integer = <span class="literal">Some</span>(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">let</span> float = <span class="literal">Some</span>(<span class="number">5.0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//编译后</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Option_i32</span></span> &#123;</span><br><span class="line">    <span class="literal">Some</span>(<span class="built_in">i32</span>),</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Option_f64</span></span> &#123;</span><br><span class="line">    <span class="literal">Some</span>(<span class="built_in">f64</span>),</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> integer = Option_i32::<span class="literal">Some</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">let</span> float = Option_f64::<span class="literal">Some</span>(<span class="number">5.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="特征"><a href="#特征" class="headerlink" title="特征"></a>特征</h4><p>​    一组可以被共享的行为，只要满足了特征，就可以做以下的行为。</p>
<ol>
<li><p>定义特征</p>
<p>​    只管定义，而往往不会提供具体的实现</p>
<p>​    谁满足这个特征，谁来实现具体的方法</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Summary</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">summarize</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">String</span>;<span class="comment">//以;结尾 只提供定义</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Summary</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">summarize</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">String</span> &#123; <span class="comment">//也可以给一个默认实现</span></span><br><span class="line">        <span class="built_in">String</span>::from(<span class="string">"(Read more...)"</span>)</span><br><span class="line">    &#125;<span class="comment">//可以调用，也可以重载</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    <strong>默认实现允许调用相同特征中的其他方法，哪怕这些方法没有默认实现。</strong>如此，特征可以提供很多有用的功能而只需要实现指定的一小部分内容。例如，我们可以定义 <code>Summary</code> 特征，使其具有一个需要实现的 <code>summarize_author</code> 方法，然后定义一个 <code>summarize</code> 方法，此方法的默认实现调用 <code>summarize_author</code> 方法：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Summary</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">summarize_author</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">String</span>;<span class="comment">//让实现Summary特征的类型具体实现吧</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">summarize</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">"(Read more from &#123;&#125;...)"</span>, <span class="keyword">self</span>.summarize_author())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现特征</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Summary</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">summarize</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">String</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Post</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> title: <span class="built_in">String</span>, <span class="comment">// 标题</span></span><br><span class="line">    <span class="keyword">pub</span> author: <span class="built_in">String</span>, <span class="comment">// 作者</span></span><br><span class="line">    <span class="keyword">pub</span> content: <span class="built_in">String</span>, <span class="comment">// 内容</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Summary <span class="keyword">for</span> Post &#123;<span class="comment">//为Post实现Summary特征</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">summarize</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">"文章&#123;&#125;, 作者是&#123;&#125;"</span>, <span class="keyword">self</span>.title, <span class="keyword">self</span>.author)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Weibo</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> username: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> content: <span class="built_in">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Summary <span class="keyword">for</span> Weibo &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">summarize</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">"&#123;&#125;发表了微博&#123;&#125;"</span>, <span class="keyword">self</span>.username, <span class="keyword">self</span>.content)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>孤儿规则——特征定义和实现的位置关系</p>
<p>​    关于特征实现与定义的位置，有一条非常重要的原则：<strong>如果你想要为类型</strong> <code>A</code> <strong>实现特征</strong> <code>T</code><strong>，那么</strong> <code>A</code> <strong>或者</strong> <code>T</code> <strong>至少有一个是在当前作用域中定义的！</strong> 例如我们可以为上面的 <code>Post</code> 类型实现标准库中的 <code>Display</code> 特征，这是因为 <code>Post</code> 类型定义在当前的作用域中。同时，我们也可以在当前包中为 <code>String</code> 类型实现 <code>Summary</code> 特征，因为 <code>Summary</code> 定义在当前作用域中。</p>
<p>​    但是你无法在当前作用域中，为 <code>String</code> 类型实现 <code>Display</code> 特征，因为它们俩都定义在标准库中，其定义所在的位置都不在当前作用域，跟你半毛钱关系都没有，看看就行了。</p>
</li>
<li><p>使用特征作为函数的参数</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">notify</span></span>(item: &amp;<span class="keyword">impl</span> Summary) &#123;<span class="comment">//实现了特征Summary的item参数</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Breaking news! &#123;&#125;"</span>, item.summarize());<span class="comment">//可以调用特征对应的方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>特征约束</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//接收两个实现了Summary特征的参数，但是不能保证这两个参数的类型相同</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">notify</span></span>(item1: &amp;<span class="keyword">impl</span> Summary, item2: &amp;<span class="keyword">impl</span> Summary) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用泛型T指代</span></span><br><span class="line"><span class="comment">//T:Summary要求其实现了特征Summary</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">notify</span></span>&lt;T: Summary&gt;(item1: &amp;T, item2: &amp;T) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//多重约束</span></span><br><span class="line"><span class="comment">//这里T被要求同时实现两个特征才行</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">notify</span></span>&lt;T: Summary + Display&gt;(item: &amp;T) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Where约束，主要是用于简化函数的签名，将特征约束写在别处</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">some_function</span></span>&lt;T, U&gt;(t: &amp;T, u: &amp;U) -&gt; <span class="built_in">i32</span></span><br><span class="line">    <span class="keyword">where</span> T: Display + <span class="built_in">Clone</span>,</span><br><span class="line">          U: <span class="built_in">Clone</span> + <span class="built_in">Debug</span></span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>函数返回值中的impl Trait</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">returns_summarizable</span></span>() -&gt; <span class="keyword">impl</span> Summary &#123;</span><br><span class="line">    <span class="comment">//返回一个实现了Summary特征的类型，具体是什么类型不知道</span></span><br><span class="line">    Weibo &#123;</span><br><span class="line">        username: <span class="built_in">String</span>::from(<span class="string">"sunface"</span>),</span><br><span class="line">        content: <span class="built_in">String</span>::from(</span><br><span class="line">            <span class="string">"m1 max太厉害了，电脑再也不会卡"</span>,</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    这种 <code>impl Trait</code> 形式的返回值，在一种场景下非常非常有用，那就是返回的真实类型非常复杂，你不知道该怎么声明时(毕竟 Rust 要求你必须标出所有的类型)，此时就可以用 <code>impl Trait</code> 的方式简单返回。</p>
</li>
<li><p>derive派生特征</p>
<p>​    在本书中，形如 <code>#[derive(Debug)]</code> 的代码已经出现了很多次，这种是一种特征派生语法，被 <code>derive</code> 标记的对象会自动实现对应的默认特征代码，继承相应的功能。</p>
<p>​    例如 <code>Debug</code> 特征，它有一套自动实现的默认代码，当你给一个结构体标记后，就可以使用 <code>println!(&quot;{:?}&quot;, s)</code> 的形式打印该结构体的对象。</p>
<p>​    再如 <code>Copy</code> 特征，它也有一套自动实现的默认代码，当标记到一个类型上时，可以让这个类型自动实现 <code>Copy</code> 特征，进而可以调用 <code>copy</code> 方法，进行自我复制。</p>
<p>​    总之，<code>derive</code> 派生出来的是 Rust 默认给我们提供的特征，在开发过程中极大的简化了自己手动实现相应特征的需求，当然，如果你有特殊的需求，还可以自己手动重载该实现。</p>
</li>
</ol>
<h4 id="特征对象"><a href="#特征对象" class="headerlink" title="特征对象"></a>特征对象</h4><p>​    指向了所有实现了某特征的对象，二者之间存在映射关系，可以通过特征对象找到该对象具体的实现方法。</p>
<ol>
<li><p>可以通过 <code>&amp;</code> 引用或者 <code>Box&lt;T&gt;</code> 智能指针的方式来创建特征对象</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Draw</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">draw</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">String</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Draw <span class="keyword">for</span> <span class="built_in">u8</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">draw</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">"u8: &#123;&#125;"</span>, *<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Draw <span class="keyword">for</span> <span class="built_in">f64</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">draw</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">"f64: &#123;&#125;"</span>, *<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 若 T 实现了 Draw 特征， 则调用该函数时传入的 Box&lt;T&gt; 可以被隐式转换成函数参数签名中的 Box&lt;dyn Draw&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">draw1</span></span>(x: <span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> Draw&gt;) &#123;</span><br><span class="line">    <span class="comment">// 由于实现了 Deref 特征，Box 智能指针会自动解引用为它所包裹的值，然后调用该值对应的类型上定义的 `draw` 方法</span></span><br><span class="line">    x.draw();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">draw2</span></span>(x: &amp;<span class="keyword">dyn</span> Draw) &#123;</span><br><span class="line">    x.draw();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = <span class="number">1.1f64</span>;</span><br><span class="line">    <span class="comment">// do_something(&amp;x);</span></span><br><span class="line">    <span class="keyword">let</span> y = <span class="number">8u8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// x 和 y 的类型 T 都实现了 `Draw` 特征，因为 Box&lt;T&gt; 可以在函数调用时隐式地被转换为特征对象 Box&lt;dyn Draw&gt; </span></span><br><span class="line">    <span class="comment">// 基于 x 的值创建一个 Box&lt;f64&gt; 类型的智能指针，指针指向的数据被放置在了堆上</span></span><br><span class="line">    draw1(<span class="built_in">Box</span>::new(x));</span><br><span class="line">    <span class="comment">// 基于 y 的值创建一个 Box&lt;u8&gt; 类型的智能指针</span></span><br><span class="line">    draw1(<span class="built_in">Box</span>::new(y));</span><br><span class="line">    draw2(&amp;x);</span><br><span class="line">    draw2(&amp;y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>draw1</code> 函数的参数是 <code>Box&lt;dyn Draw&gt;</code> 形式的特征对象，该特征对象是通过 <code>Box::new(x)</code> 的方式创建的</li>
<li><code>draw2</code> 函数的参数是 <code>&amp;dyn Draw</code> 形式的特征对象，该特征对象是通过 <code>&amp;x</code> 的方式创建的</li>
<li><code>dyn</code> 关键字只用在特征对象的类型声明上，在创建时无需使用 <code>dyn</code></li>
</ul>
<p>可以通过特征对象来代表具体的泛型。</p>
</li>
<li><p>使用泛型的实现和特征对象的对比</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Screen</span></span>&lt;T: Draw&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> components: <span class="built_in">Vec</span>&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Screen&lt;T&gt;</span><br><span class="line">    <span class="keyword">where</span> T: Draw &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> component <span class="keyword">in</span> <span class="keyword">self</span>.components.iter() &#123;</span><br><span class="line">            component.draw();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    上面的 <code>Screen</code> 的列表中，存储了类型为 <code>T</code> 的元素，然后在 <code>Screen</code> 中使用特征约束让 <code>T</code> 实现了 <code>Draw</code> 特征，进而可以调用 <code>draw</code> 方法。</p>
<p>​    但是这种写法限制了 <code>Screen</code> 实例的 <code>Vec&lt;T&gt;</code> 中的每个元素必须是 <code>Button</code> 类型或者全是 <code>SelectBox</code> 类型。如果只需要同质（相同类型）集合，更倾向于采用泛型+特征约束这种写法，因其实现更清晰，且性能更好(特征对象，需要在运行时从 <code>vtable</code> 动态查找需要调用的方法)。</p>
</li>
<li><p>特征对象的限制</p>
<p><strong>不是所有特征都能拥有特征对象，只有对象安全的特征才行。</strong>当一个特征的所有方法都有如下属性时，它的对象才是安全的：</p>
<ul>
<li>方法的返回类型不能是 <code>Self</code></li>
<li>方法没有任何泛型参数</li>
</ul>
<p>对象安全对于特征对象是必须的，因为一旦有了特征对象，就不再需要知道实现该特征的具体类型是什么了。如果特征方法返回了具体的 <code>Self</code> 类型，但是特征对象忘记了其真正的类型，那这个 <code>Self</code> 就非常尴尬，因为没人知道它是谁了。但是对于泛型类型参数来说，当使用特征时其会放入具体的类型参数：此具体类型变成了实现该特征的类型的一部分。而当使用特征对象时其具体类型被抹去了，故而无从得知放入泛型参数类型到底是什么。</p>
<p>标准库中的 <code>Clone</code> 特征就不符合对象安全的要求：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Clone</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">clone</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="keyword">Self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为它的其中一个方法，返回了 <code>Self</code> 类型，因此它是对象不安全的。</p>
</li>
<li><p>特征对象的动态分发</p>
<p>​    静态分发：编译器会为每一个泛型参数对应的具体类型生成一份代码</p>
<p>​    动态分发：直到运行时，才能确定需要调用什么方法。编译器无法知晓所有可能用于特征对象代码的类型，所以它也不知道应该调用哪个类型的哪个方法实现。</p>
<p><img src="/blog/.io//D:%5C116%5Csigs%5Cblog%5Csource_posts%5CRust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86.assets%5Cv2-b771fe4cfc6ebd63d9aff42840eb8e67_1440w.jpg" alt="img"></p>
<p>​    </p>
<ul>
<li><strong>特征对象大小不固定</strong>：这是因为，对于特征 <code>Draw</code>，类型 <code>Button</code> 可以实现特征 <code>Draw</code>，类型 <code>SelectBox</code> 也可以实现特征 <code>Draw</code>，因此特征没有固定大小</li>
<li>几乎总是使用特征对象的引用方式，如<code>&amp;dyn Draw</code>和<code>Box&lt;dyn Draw&gt;</code><ul>
<li>虽然特征对象没有固定大小，但它的引用类型的大小是固定的，它由两个指针组成（<code>ptr</code> 和 <code>vptr</code>），因此占用两个指针大小</li>
<li>一个指针 <code>ptr</code> 指向实现了特征 <code>Draw</code> 的具体类型的实例，也就是当作特征 <code>Draw</code> 来用的类型的实例，比如类型 <code>Button</code> 的实例、类型 <code>SelectBox</code> 的实例</li>
<li>另一个指针 <code>vptr</code> 指向一个虚表 <code>vtable</code>，<code>vtable</code> 中保存了类型 <code>Button</code> 或类型 <code>SelectBox</code> 的实例对于可以调用的实现于特征 <code>Draw</code> 的方法。当调用方法时，直接从 <code>vtable</code> 中找到方法并调用。之所以要使用一个 <code>vtable</code> 来保存各实例的方法，是因为实现了特征 <code>Draw</code> 的类型有多种，这些类型拥有的方法各不相同，当将这些类型的实例都当作特征 <code>Draw</code> 来使用时(此时，它们全都看作是特征 <code>Draw</code> 类型的实例)，有必要区分这些实例各自有哪些方法可调用</li>
</ul>
</li>
</ul>
<p>简而言之，当类型 <code>Button</code> 实现了特征 <code>Draw</code> 时，类型 <code>Button</code> 的实例对象 <code>btn</code> 可以当作特征 <code>Draw</code> 的特征对象类型来使用，<code>btn</code> 中保存了作为特征对象的数据指针（指向类型 <code>Button</code> 的实例数据）和行为指针（指向 <code>vtable</code>）。</p>
<p>一定要注意，此时的 <code>btn</code> 是 <code>Draw</code> 的特征对象的实例，而不再是具体类型 <code>Button</code> 的实例，而且 <code>btn</code> 的 <code>vtable</code> 只包含了实现自特征 <code>Draw</code> 的那些方法（比如 <code>draw</code>），因此 <code>btn</code> 只能调用实现于特征 <code>Draw</code> 的 <code>draw</code> 方法，而不能调用类型 <code>Button</code> 本身实现的方法和类型 <code>Button</code> 实现于其他特征的方法。<strong>也就是说，<code>btn</code> 是哪个特征对象的实例，它的 <code>vtable</code> 中就包含了该特征的方法。</strong></p>
</li>
</ol>
<h4 id="特征进阶内容"><a href="#特征进阶内容" class="headerlink" title="特征进阶内容"></a>特征进阶内容</h4><ol>
<li><p>关联类型</p>
<p>在特征定义的语句块中，声明一个自定义类型，这样就可以在特征中使用这个类型。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Iterator</span></span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Item</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;Self::Item&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ol>
<h2 id="Rustlings习题整理"><a href="#Rustlings习题整理" class="headerlink" title="Rustlings习题整理"></a>Rustlings习题整理</h2><h3 id="map-的用法"><a href="#map-的用法" class="headerlink" title="map()的用法"></a>map()的用法</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">vec_map</span></span>(v: &amp;<span class="built_in">Vec</span>&lt;<span class="built_in">i32</span>&gt;) -&gt; <span class="built_in">Vec</span>&lt;<span class="built_in">i32</span>&gt; &#123;</span><br><span class="line">    v.iter().map(|element| &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Do the same thing as above - but instead of mutating the</span></span><br><span class="line">        <span class="comment">// Vec, you can just return the new number!</span></span><br><span class="line">        *element * <span class="number">2</span></span><br><span class="line">    &#125;).collect()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//map方法由原来的迭代器生成一个新的迭代器，对旧迭代器的每一个方法都调用该闭包</span></span><br></pre></td></tr></table></figure>

<h3 id="字符串和切片操作"><a href="#字符串和切片操作" class="headerlink" title="字符串和切片操作"></a>字符串和切片操作</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">trim_me</span></span>(input: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Remove whitespace from both ends of a string!</span></span><br><span class="line">    input.trim().to_string()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">compose_me</span></span>(input: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Add " world!" to the string! There's multiple ways to do this!</span></span><br><span class="line">    input.to_string() + <span class="string">" world!"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">replace_me</span></span>(input: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Replace "cars" in the string with "balloons"!</span></span><br><span class="line">    input.replace(<span class="string">"cars"</span>,<span class="string">"balloons"</span>).to_string()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">trim_a_string</span></span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(trim_me(<span class="string">"Hello!     "</span>), <span class="string">"Hello!"</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(trim_me(<span class="string">"  What's up!"</span>), <span class="string">"What's up!"</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(trim_me(<span class="string">"   Hola!  "</span>), <span class="string">"Hola!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">compose_a_string</span></span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(compose_me(<span class="string">"Hello"</span>), <span class="string">"Hello world!"</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(compose_me(<span class="string">"Goodbye"</span>), <span class="string">"Goodbye world!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">replace_a_string</span></span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(replace_me(<span class="string">"I think cars are cool"</span>), <span class="string">"I think balloons are cool"</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(replace_me(<span class="string">"I love to look at cars"</span>), <span class="string">"I love to look at balloons"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="判断字符串和字符串切片的类型"><a href="#判断字符串和字符串切片的类型" class="headerlink" title="判断字符串和字符串切片的类型"></a>判断字符串和字符串切片的类型</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">string_slice</span></span>(arg: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">string</span></span>(arg: <span class="built_in">String</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    string_slice(<span class="string">"blue"</span>);</span><br><span class="line">    string(<span class="string">"red"</span>.to_string());</span><br><span class="line">    string(<span class="built_in">String</span>::from(<span class="string">"hi"</span>));</span><br><span class="line">    string(<span class="string">"rust is fun!"</span>.to_owned()); </span><br><span class="line">    <span class="comment">//to_owned()方法用于从借用的数据中创建一个具有所有权的副本</span></span><br><span class="line">    <span class="comment">//和clone方法的区别是如果传入的参数是引用类型的，可以通过复制获得其所有权</span></span><br><span class="line">    string_slice(<span class="string">"nice weather"</span>.into()); </span><br><span class="line">    string(<span class="built_in">format!</span>(<span class="string">"Interpolation &#123;&#125;"</span>, <span class="string">"Station"</span>));</span><br><span class="line">    string_slice(&amp;<span class="built_in">String</span>::from(<span class="string">"abc"</span>)[<span class="number">0</span>..<span class="number">1</span>]);</span><br><span class="line">    string_slice(<span class="string">"  hello there "</span>.trim());</span><br><span class="line">    string(<span class="string">"Happy Monday!"</span>.to_string().replace(<span class="string">"Mon"</span>, <span class="string">"Tues"</span>));</span><br><span class="line">    string(<span class="string">"mY sHiFt KeY iS sTiCkY"</span>.to_lowercase()); </span><br><span class="line">    <span class="comment">//to_lowercase()返回此字符串切片的小写等效项，类型为string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th></th>
<th>clone()</th>
<th>to_owned()</th>
</tr>
</thead>
<tbody><tr>
<td>T</td>
<td>T -&gt; T</td>
<td>T -&gt; T</td>
</tr>
<tr>
<td>&amp;T</td>
<td>&amp;T -&gt; &amp;T</td>
<td>&amp;T -&gt; T</td>
</tr>
</tbody></table>
<h3 id="模块use"><a href="#模块use" class="headerlink" title="模块use"></a>模块use</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> delicious_snacks &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Fix these use statements</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">use</span> self::fruits::PEAR <span class="keyword">as</span> fruit;<span class="comment">//修改为pub才对外可见</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">use</span> self::veggies::CUCUMBER <span class="keyword">as</span> veggie;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mod</span> fruits &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">const</span> PEAR: &amp;<span class="symbol">'static</span> <span class="built_in">str</span> = <span class="string">"Pear"</span>;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">const</span> APPLE: &amp;<span class="symbol">'static</span> <span class="built_in">str</span> = <span class="string">"Apple"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mod</span> veggies &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">const</span> CUCUMBER: &amp;<span class="symbol">'static</span> <span class="built_in">str</span> = <span class="string">"Cucumber"</span>;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">const</span> CARROT: &amp;<span class="symbol">'static</span> <span class="built_in">str</span> = <span class="string">"Carrot"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(</span><br><span class="line">        <span class="string">"favorite snacks: &#123;&#125; and &#123;&#125;"</span>,</span><br><span class="line">        delicious_snacks::fruit,</span><br><span class="line">        delicious_snacks::veggie</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="比赛统计"><a href="#比赛统计" class="headerlink" title="比赛统计"></a>比赛统计</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A structure to store the goal details of a team.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Team</span></span> &#123;</span><br><span class="line">    goals_scored: <span class="built_in">u8</span>,</span><br><span class="line">    goals_conceded: <span class="built_in">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">build_scores_table</span></span>(results: <span class="built_in">String</span>) -&gt; HashMap&lt;<span class="built_in">String</span>, Team&gt; &#123;</span><br><span class="line">    <span class="comment">// The name of the team is the key and its associated struct is the value.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> scores: HashMap&lt;<span class="built_in">String</span>, Team&gt; = HashMap::new();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> results.lines() &#123;</span><br><span class="line">        <span class="keyword">let</span> v: <span class="built_in">Vec</span>&lt;&amp;<span class="built_in">str</span>&gt; = r.split(<span class="string">','</span>).collect();</span><br><span class="line">        <span class="keyword">let</span> team_1_name = v[<span class="number">0</span>].to_string();</span><br><span class="line">        <span class="keyword">let</span> team_1_score: <span class="built_in">u8</span> = v[<span class="number">2</span>].parse().unwrap();</span><br><span class="line">        <span class="keyword">let</span> team_2_name = v[<span class="number">1</span>].to_string();</span><br><span class="line">        <span class="keyword">let</span> team_2_score: <span class="built_in">u8</span> = v[<span class="number">3</span>].parse().unwrap();</span><br><span class="line">        <span class="comment">//注意Team是没有实现可加性的，只可以按照Team内部的元素来操作</span></span><br><span class="line">        <span class="keyword">let</span> team1 = scores.entry(team_1_name).or_insert(Team&#123;</span><br><span class="line">            goals_scored:<span class="number">0</span>,</span><br><span class="line">            goals_conceded:<span class="number">0</span></span><br><span class="line">        &#125;);</span><br><span class="line">        team1.goals_scored += team_1_score;</span><br><span class="line">        team1.goals_conceded += team_2_score;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> team2 = scores.entry(team_2_name).or_insert(Team&#123;</span><br><span class="line">            goals_scored:<span class="number">0</span>,</span><br><span class="line">            goals_conceded:<span class="number">0</span></span><br><span class="line">        &#125;);</span><br><span class="line">        team2.goals_scored += team_2_score;</span><br><span class="line">        team2.goals_conceded += team_1_score;</span><br><span class="line">    &#125;</span><br><span class="line">    scores</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">get_results</span></span>() -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> results = <span class="string">""</span>.to_string()</span><br><span class="line">            + <span class="string">"England,France,4,2\n"</span></span><br><span class="line">            + <span class="string">"France,Italy,3,1\n"</span></span><br><span class="line">            + <span class="string">"Poland,Spain,2,0\n"</span></span><br><span class="line">            + <span class="string">"Germany,England,2,1\n"</span>;</span><br><span class="line">        results</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">build_scores</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> scores = build_scores_table(get_results());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> keys: <span class="built_in">Vec</span>&lt;&amp;<span class="built_in">String</span>&gt; = scores.keys().collect();</span><br><span class="line">        keys.sort();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(</span><br><span class="line">            keys,</span><br><span class="line">            <span class="built_in">vec!</span>[<span class="string">"England"</span>, <span class="string">"France"</span>, <span class="string">"Germany"</span>, <span class="string">"Italy"</span>, <span class="string">"Poland"</span>, <span class="string">"Spain"</span>]</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">validate_team_score_1</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> scores = build_scores_table(get_results());</span><br><span class="line">        <span class="keyword">let</span> team = scores.get(<span class="string">"England"</span>).unwrap();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(team.goals_scored, <span class="number">5</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(team.goals_conceded, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">validate_team_score_2</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> scores = build_scores_table(get_results());</span><br><span class="line">        <span class="keyword">let</span> team = scores.get(<span class="string">"Spain"</span>).unwrap();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(team.goals_scored, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(team.goals_conceded, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="quiz2"><a href="#quiz2" class="headerlink" title="quiz2"></a><strong>quiz2</strong></h3><p>首先要观察代码判断其类型，随后用match表达式匹配枚举类型，做出相应的处理</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Command</span></span> &#123;</span><br><span class="line">    Uppercase,</span><br><span class="line">    Trim,</span><br><span class="line">    Append(<span class="built_in">usize</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> my_module &#123;</span><br><span class="line">    <span class="keyword">use</span> super::Command;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Complete the function signature!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">transformer</span></span>(input: <span class="built_in">Vec</span>&lt;(<span class="built_in">String</span>,Command)&gt;) -&gt; <span class="built_in">Vec</span>&lt;<span class="built_in">String</span>&gt; &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Complete the output declaration!</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> output: <span class="built_in">Vec</span>&lt;<span class="built_in">String</span>&gt; = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">for</span> (string, command) <span class="keyword">in</span> input.iter() &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Complete the function body. You can do it!</span></span><br><span class="line">            <span class="keyword">let</span> applied_string:<span class="built_in">String</span> = <span class="keyword">match</span> command&#123;</span><br><span class="line">                Command::Uppercase =&gt; string.to_uppercase(),</span><br><span class="line">                Command::Trim =&gt; string.trim().to_string(),</span><br><span class="line">                Command::Append(n) =&gt; <span class="built_in">format!</span>(<span class="string">"&#123;&#125;&#123;&#125;"</span>,string,<span class="string">"bar"</span>.repeat(*n)),</span><br><span class="line">            &#125;;</span><br><span class="line">            output.push(applied_string);</span><br><span class="line">        &#125;</span><br><span class="line">        output</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> What do we need to import to have `transformer` in scope?</span></span><br><span class="line">    <span class="keyword">use</span> crate::my_module::transformer;</span><br><span class="line">    <span class="keyword">use</span> super::Command;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">it_works</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> output = transformer(<span class="built_in">vec!</span>[</span><br><span class="line">            (<span class="string">"hello"</span>.into(), Command::Uppercase),</span><br><span class="line">            (<span class="string">" all roads lead to rome! "</span>.into(), Command::Trim),</span><br><span class="line">            (<span class="string">"foo"</span>.into(), Command::Append(<span class="number">1</span>)),</span><br><span class="line">            (<span class="string">"bar"</span>.into(), Command::Append(<span class="number">5</span>)),</span><br><span class="line">        ]);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(output[<span class="number">0</span>], <span class="string">"HELLO"</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(output[<span class="number">1</span>], <span class="string">"all roads lead to rome!"</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(output[<span class="number">2</span>], <span class="string">"foobar"</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(output[<span class="number">3</span>], <span class="string">"barbarbarbarbarbar"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="从Option中取出值"><a href="#从Option中取出值" class="headerlink" title="从Option中取出值"></a>从Option中取出值</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果你确定Option中是有值的，可以使用unwrap()方法直接取出来</span></span><br><span class="line"><span class="keyword">let</span> my_option: <span class="built_in">Option</span>&lt;<span class="built_in">i32</span>&gt; = <span class="literal">Some</span>(<span class="number">5</span>); <span class="comment">// 一个Option&lt;i32&gt;类型的变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> value = my_option.unwrap();</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">"The value is: &#123;&#125;"</span>, value);</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果要处理可能有None的情况，可以使用unwrap_or(初始值)</span></span><br><span class="line"><span class="comment">//为None的情况设置一个初始值</span></span><br><span class="line"><span class="keyword">let</span> my_option: <span class="built_in">Option</span>&lt;<span class="built_in">i32</span>&gt; = <span class="literal">Some</span>(<span class="number">5</span>); <span class="comment">// 一个Option&lt;i32&gt;类型的变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> value = my_option.unwrap_or(<span class="number">0</span>); <span class="comment">// 如果my_option是None，则使用默认值0</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">"The value is: &#123;&#125;"</span>, value);</span><br></pre></td></tr></table></figure>

<h3 id="Option的类型问题"><a href="#Option的类型问题" class="headerlink" title="Option的类型问题"></a>Option的类型问题</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> range = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut</span> optional_integers: <span class="built_in">Vec</span>&lt;<span class="built_in">Option</span>&lt;<span class="built_in">i8</span>&gt;&gt; = <span class="built_in">vec!</span>[<span class="literal">None</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>..(range + <span class="number">1</span>) &#123;</span><br><span class="line">    optional_integers.push(<span class="literal">Some</span>(i));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut</span> cursor = range;</span><br><span class="line"></span><br><span class="line"><span class="comment">//pop()函数会包着一层Some()在外面</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">let</span> <span class="literal">Some</span>(<span class="literal">Some</span>(integer)) = optional_integers.pop() &#123;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(integer, cursor);</span><br><span class="line">    cursor -= <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="所有权的问题"><a href="#所有权的问题" class="headerlink" title="所有权的问题"></a>所有权的问题</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Point</span></span> &#123;</span><br><span class="line">    x: <span class="built_in">i32</span>,</span><br><span class="line">    y: <span class="built_in">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> y: <span class="built_in">Option</span>&lt;Point&gt; = <span class="literal">Some</span>(Point &#123; x: <span class="number">100</span>, y: <span class="number">200</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> y &#123;</span><br><span class="line">        <span class="literal">Some</span>(<span class="keyword">ref</span> p) =&gt; <span class="built_in">println!</span>(<span class="string">"Co-ordinates are &#123;&#125;,&#123;&#125; "</span>, p.x, p.y),</span><br><span class="line">        <span class="comment">//加ref是为了防止所有权的转移</span></span><br><span class="line">        _ =&gt; <span class="built_in">panic!</span>(<span class="string">"no match!"</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    y; <span class="comment">// Fix without deleting this line.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="表达式"><a href="#表达式" class="headerlink" title="? 表达式"></a>? 表达式</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> ParsePosNonzeroError &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from_creation</span></span>(err: CreationError) -&gt; ParsePosNonzeroError &#123;</span><br><span class="line">        ParsePosNonzeroError::Creation(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> add another error conversion function here.</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from_parseint</span></span>(err: ParseIntError) -&gt; ParsePosNonzeroError&#123;</span><br><span class="line">        ParsePosNonzeroError::ParseInt(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">parse_pos_nonzero</span></span>(s: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">Result</span>&lt;PositiveNonzeroInteger, ParsePosNonzeroError&gt; &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> change this to return an appropriate error instead of panicking</span></span><br><span class="line">    <span class="comment">// when `parse()` returns an error.</span></span><br><span class="line">    <span class="keyword">let</span> x: <span class="built_in">i64</span> = s.parse().map_err(ParsePosNonzeroError::from_parseint)?;</span><br><span class="line">    PositiveNonzeroInteger::new(x).map_err(ParsePosNonzeroError::from_creation)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="为动态数组Vector实现特征"><a href="#为动态数组Vector实现特征" class="headerlink" title="为动态数组Vector实现特征"></a>为动态数组Vector实现特征</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">AppendBar</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">append_bar</span></span>(<span class="keyword">self</span>) -&gt; <span class="keyword">Self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Implement trait `AppendBar` for a vector of strings.</span></span><br><span class="line"><span class="keyword">impl</span> AppendBar <span class="keyword">for</span> <span class="built_in">Vec</span>&lt;<span class="built_in">String</span>&gt;&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">append_bar</span></span>(<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="keyword">Self</span>&#123; <span class="comment">//声明可变mut</span></span><br><span class="line">        <span class="keyword">self</span>.push(<span class="string">"Bar"</span>.to_string());</span><br><span class="line">        <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">is_vec_pop_eq_bar</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> foo = <span class="built_in">vec!</span>[<span class="built_in">String</span>::from(<span class="string">"Foo"</span>)].append_bar();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(foo.pop().unwrap(), <span class="built_in">String</span>::from(<span class="string">"Bar"</span>));</span><br><span class="line">        <span class="built_in">assert_eq!</span>(foo.pop().unwrap(), <span class="built_in">String</span>::from(<span class="string">"Foo"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="特征约束代替类型"><a href="#特征约束代替类型" class="headerlink" title="特征约束代替类型"></a>特征约束代替类型</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Licensed</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">licensing_info</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">        <span class="string">"some information"</span>.to_string()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SomeSoftware</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">OtherSoftware</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Licensed <span class="keyword">for</span> SomeSoftware &#123;&#125;</span><br><span class="line"><span class="keyword">impl</span> Licensed <span class="keyword">for</span> OtherSoftware &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// YOU MAY ONLY CHANGE THE NEXT LINE</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">compare_license_types</span></span>(software:<span class="keyword">impl</span> Licensed, software_two:<span class="keyword">impl</span> Licensed) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    software.licensing_info() == software_two.licensing_info()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//下面有SomeSoftware和OtherSoftware两种类型</span></span><br><span class="line"><span class="comment">//用impl Licensed可以指代他们</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">compare_license_information</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> some_software = SomeSoftware &#123;&#125;;</span><br><span class="line">        <span class="keyword">let</span> other_software = OtherSoftware &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert!</span>(compare_license_types(some_software, other_software));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">compare_license_information_backwards</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> some_software = SomeSoftware &#123;&#125;;</span><br><span class="line">        <span class="keyword">let</span> other_software = OtherSoftware &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert!</span>(compare_license_types(other_software, some_software));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="should-panic"><a href="#should-panic" class="headerlink" title="#[should_panic]"></a>#[should_panic]</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Rectangle</span></span> &#123;</span><br><span class="line">    width: <span class="built_in">i32</span>,</span><br><span class="line">    height: <span class="built_in">i32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Rectangle &#123;</span><br><span class="line">    <span class="comment">// Only change the test functions themselves</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(width: <span class="built_in">i32</span>, height: <span class="built_in">i32</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> width &lt;= <span class="number">0</span> || height &lt;= <span class="number">0</span> &#123;</span><br><span class="line">            <span class="built_in">panic!</span>(<span class="string">"Rectangle width and height cannot be negative!"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        Rectangle &#123;width, height&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">correct_width_and_height</span></span>() &#123;</span><br><span class="line">        <span class="comment">// This test should check if the rectangle is the size that we pass into its constructor</span></span><br><span class="line">        <span class="keyword">let</span> rect = Rectangle::new(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(rect.width, <span class="number">10</span>); <span class="comment">// check width</span></span><br><span class="line">        <span class="built_in">assert_eq!</span>(rect.height, <span class="number">20</span>); <span class="comment">// check height</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="meta">#[should_panic]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">negative_width</span></span>() &#123;</span><br><span class="line">        <span class="comment">// This test should check if program panics when we try to create rectangle with negative width</span></span><br><span class="line">        <span class="keyword">let</span> _rect = Rectangle::new(-<span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="meta">#[should_panic]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">negative_height</span></span>() &#123;</span><br><span class="line">        <span class="comment">// This test should check if program panics when we try to create rectangle with negative height</span></span><br><span class="line">        <span class="keyword">let</span> _rect = Rectangle::new(<span class="number">10</span>, -<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="迭代器方法"><a href="#迭代器方法" class="headerlink" title="迭代器方法"></a>迭代器方法</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">capitalize_first</span></span>(input: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> c = input.chars();</span><br><span class="line">    <span class="keyword">match</span> c.next() &#123;</span><br><span class="line">        <span class="literal">None</span> =&gt; <span class="built_in">String</span>::new(),</span><br><span class="line">        <span class="literal">Some</span>(first) =&gt; first.to_uppercase().to_string() + c.as_str(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 2.</span></span><br><span class="line"><span class="comment">// Apply the `capitalize_first` function to a slice of string slices.</span></span><br><span class="line"><span class="comment">// Return a vector of strings.</span></span><br><span class="line"><span class="comment">// ["hello", "world"] -&gt; ["Hello", "World"]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">capitalize_words_vector</span></span>(words: &amp;[&amp;<span class="built_in">str</span>]) -&gt; <span class="built_in">Vec</span>&lt;<span class="built_in">String</span>&gt; &#123;</span><br><span class="line">    words.iter().map(</span><br><span class="line">        |&amp;word| &#123;</span><br><span class="line">            capitalize_first(word)</span><br><span class="line">        &#125;</span><br><span class="line">    ).collect()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 3.</span></span><br><span class="line"><span class="comment">// Apply the `capitalize_first` function again to a slice of string slices.</span></span><br><span class="line"><span class="comment">// Return a single string.</span></span><br><span class="line"><span class="comment">// ["hello", " ", "world"] -&gt; "Hello World"</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">capitalize_words_string</span></span>(words: &amp;[&amp;<span class="built_in">str</span>]) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">    words.iter().map(</span><br><span class="line">        |&amp;word| &#123;</span><br><span class="line">            capitalize_first(word)</span><br><span class="line">        &#125;</span><br><span class="line">    ).collect()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">test_success</span></span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(capitalize_first(<span class="string">"hello"</span>), <span class="string">"Hello"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">test_empty</span></span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(capitalize_first(<span class="string">""</span>), <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">test_iterate_string_vec</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> words = <span class="built_in">vec!</span>[<span class="string">"hello"</span>, <span class="string">"world"</span>];</span><br><span class="line">        <span class="built_in">assert_eq!</span>(capitalize_words_vector(&amp;words), [<span class="string">"Hello"</span>, <span class="string">"World"</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">test_iterate_into_string</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> words = <span class="built_in">vec!</span>[<span class="string">"hello"</span>, <span class="string">" "</span>, <span class="string">"world"</span>];</span><br><span class="line">        <span class="built_in">assert_eq!</span>(capitalize_words_string(&amp;words), <span class="string">"Hello World"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="宏"><a href="#宏" class="headerlink" title="宏"></a>宏</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//宏的定义要在使用之前</span></span><br><span class="line"><span class="built_in">macro_rules!</span> my_macro &#123;</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Check out my macro!"</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    my_macro!();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用分号区分不同的模式</span></span><br><span class="line"><span class="meta">#[rustfmt::skip]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> my_macro &#123;</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Check out my macro!"</span>);</span><br><span class="line">    &#125;; <span class="comment">//使用分号来区分不同的模式</span></span><br><span class="line">    ($val:expr) =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Look at this other macro: &#123;&#125;"</span>, $val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    my_macro!();</span><br><span class="line">    my_macro!(<span class="number">7777</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Rcore实验感想"><a href="#Rcore实验感想" class="headerlink" title="Rcore实验感想"></a>Rcore实验感想</h2><h3 id="写在前面-1"><a href="#写在前面-1" class="headerlink" title="写在前面"></a>写在前面</h3><p>由于实验要求不能够贴代码，因此本报告重点就是日记这种了……</p>
<p>会简单的讲一下过程</p>
<h3 id="Lab3"><a href="#Lab3" class="headerlink" title="Lab3"></a>Lab3</h3><p>看了一下自己写的东西……玛德我原本也贴了不少代码</p>
<p>行吧……那就放些记录性的东西</p>
<p>……</p>
<p>报错挺多的，反正就照着编译器一个一个来吧……</p>
<p>类型错误……</p>
<img src="/blog/.io//116\sigs\blog\source\_posts\Rust语言初步以及Rustlings错题整理.assets\image-20240428141340827.png" alt="image-20240428141340827" style="zoom:67%;">

<p>missing documentations for functions</p>
<p>不写注释也不行 <del>笑</del></p>
<img src="/blog/.io//116\sigs\blog\source\_posts\Rust语言初步以及Rustlings错题整理.assets\image-20240428142025031.png" alt="image-20240428142025031">





<h3 id="Lab4"><a href="#Lab4" class="headerlink" title="Lab4"></a>Lab4</h3><h4 id="重写sys-get-time和sys-task-info"><a href="#重写sys-get-time和sys-task-info" class="headerlink" title="重写sys_get_time和sys_task_info"></a>重写sys_get_time和sys_task_info</h4><p>先看看原本的sys_get_time是如何实现的？</p>
<p>对指针<code>*ts</code>所指向的内存空间赋值时间信息，在引入虚存之前应用空间和内核空间之间不存在隔离，二者都可以直接访问到<code>*ts</code>所在位置。在引入虚存之后，每个应用以及内核本身都有独立的地址空间，没办法访问了。</p>
<p>因此我们需要想办法，使得OS能够访问到应用所在的位置，需要完成二者地址的翻译。</p>
<p>……</p>
<p>和mmap那个题目一样，sys_get_time以及sys_task_info也是需要在当前任务下才行</p>
<p>为什么突然写回来了呢……（因为在线CI测了sys_get_time还有sys_task_info 发现自己写的根本就不对</p>
<p>我知道哪里不行了 我的实现没问题 搞得我还重写了一次</p>
<p>每次执行系统调用的时候忘记调用<code>add_syscall_num</code></p>
<h4 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h4><p><code>insert_frame_area</code>函数是比较值得参考的一个函数</p>
<p>不仅仅是函数实现的功能类似，用法也很值得学习</p>
<p>……</p>
<p>随后就是漫长的调试……</p>
<p>这里注意到特殊的一行</p>
<p><code>[kernel] PageFault in application, bad addr = {:#x}, bad instruction = {:#x}, kernel killed it.</code></p>
<p>先找到这行输出是哪里来的，发现在<code>Trap_handler</code>方法里面</p>
<p>然后再考虑，发现其实我的程序连<code>mmap0</code>都没正常跑完</p>
<p>但是正确分配了页面，要不然就不会有<code>start_va:0x10000000~end_va:0x10001000 map_perm:0x16</code>输出</p>
<p>这里的<code>0x16</code>完全没问题（之前看成10进制了）</p>
<p><code>0001 0110</code> 代表<code>U</code>,<code>W</code>,<code>R</code>被置位 而测试用例<code>mmap0</code>给的是<code>3</code> 也就是<code>011</code> 也是对应<code>W</code>,<code>R</code></p>
<p><img src="/blog/.io//D:%5C116%5Csigs%5Cblog%5Csource_posts%5CRust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86.assets%5Cimage-20240518222104567.png" alt="image-20240518222104567"></p>
<p>妈的 我知道怎么搞了 之所以会不断出现<code>The Page you wanted has been alloced to others</code>的报错信息是因为之前在<code>sys_mmap</code>方法中对MemorySet中<code>mmap()</code>的调用是这样子的</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取内核实例 取得所有权完成分配(这样不对 你并没有找到实际你要分配的位置) 实际上你是给内核多次分配了 所以才这样子报错</span></span><br><span class="line"><span class="keyword">let</span> num = KERNEL_SPACE.exclusive_access().mmap(start, len, port);</span><br><span class="line"><span class="comment">//之所以这样子写主要还是因为参考了前面insert_frame_area的用法 没有具体考虑他使用的上下文</span></span><br></pre></td></tr></table></figure>

<p>事实上应该找到当前运行的任务，只有当前运行的任务是知道自己的地址空间信息的，具体在<code>TCB</code>里面有一项<code>memory_set</code> </p>
<p>这里也走了点弯路 一开始我的想法是在<code>TaskControlBlock</code>中实现一个<code>get_current_tasks_area</code>（类似于之前<code>get_tasks_start_time</code>一样拿到时间）拿到<code>memory_set</code>的所有权或者引用之后，在<code>sys_mmap()</code>里面再用得到的<code>memory_set</code>来调用（我个人感觉主要还是仿照了前面代码的思路，就非要拿到一个类似于<code>KERNEL_SPACE</code>的地址空间，事实上没必要）</p>
<p>……</p>
<p>实现了<code>mmap</code>之后<code>munmap</code>就比较简单了</p>
<p>这里写一个点 关于<code>munmap</code>的最后一个测试用例</p>
<p>下面给一个比较滑头的办法 检查一下是不是页对齐就行（start硬编码写死了 所以其实你怎么写都差不多</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YOUR JOB: Implement munmap.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">sys_munmap</span></span>(start: <span class="built_in">usize</span>, len: <span class="built_in">usize</span>) -&gt; <span class="built_in">isize</span> &#123;</span><br><span class="line">    trace!(<span class="string">"kernel: sys_munmap NOT IMPLEMENTED YET!"</span>);</span><br><span class="line">    <span class="keyword">if</span> start % PAGE_SIZE != <span class="number">0</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> num = munmap_current_task(start, len);</span><br><span class="line">    num</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按理说应该是实现一个检测解除映射范围和现有的映射区域是否完全一致的方法</p>
<p>明天再想吧……先看看能不能过在线CI</p>
<p>懂了 在线CI看不到报错 我就说为什么lab4的测例全过了assert断言还是不行</p>
<p><img src="/blog/.io//D:%5C116%5Csigs%5Cblog%5Csource_posts%5CRust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86.assets%5Cimage-20240505014117148.png" alt="image-20240505014117148"></p>
<p>这里可以看到比较详细的信息</p>
<p>这里记录一下回退的点 本地执行CI之后需要删除一些未跟踪的文件</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clean -f  删除未跟踪的文件（不包括目录）</span><br><span class="line">git clean -fd 删除未跟踪的文件和目录</span><br></pre></td></tr></table></figure>



<p><img src="/blog/.io//D:%5C116%5Csigs%5Cblog%5Csource_posts%5CRust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86.assets%5Cimage-20240505171002449.png" alt="image-20240505171002449"></p>
<p>解决了 太sb了</p>
<h3 id="Lab5"><a href="#Lab5" class="headerlink" title="Lab5"></a>Lab5</h3><h4 id="之前的测例实现过程"><a href="#之前的测例实现过程" class="headerlink" title="之前的测例实现过程"></a>之前的测例实现过程</h4><p>经典内容……</p>
<p>注意一个点 在Lab5里面把TaskManager拆分成了TaskManager和processor两个数据结构</p>
<p>不过他们对进程信息的获取还是通过TaskControlBlock</p>
<p>关于初始化信息补全</p>
<p>忘记记录了……之前的测例实现基本就是cv，注意放到正确的数据结构里面重新实现一次就行</p>
<p>遇到一个新问题</p>
<p><img src="/blog/.io//D:%5C116%5Csigs%5Cblog%5Csource_posts%5CRust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86.assets%5Cimage-20240506003949090.png" alt="image-20240506003949090"></p>
<p><img src="/blog/.io//D:%5C116%5Csigs%5Cblog%5Csource_posts%5CRust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86.assets%5Cimage-20240506004011708.png" alt="image-20240506004011708"></p>
<p>这个<code>Write</code>系统调用莫名其妙多出这么多次数</p>
<p>我决定在增加系统调用的方法中加一行调试，打印一下系统调用编号</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 添加系统调用</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">add_current_syscall_times</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>,syscall_id:<span class="built_in">usize</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> current_inner = <span class="keyword">self</span>.current.as_mut().unwrap().inner_exclusive_access();</span><br><span class="line">    current_inner.syscall_times[syscall_id] += <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125; + 1\n"</span>,syscall_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/.io//D:%5C116%5Csigs%5Cblog%5Csource_posts%5CRust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86.assets%5Cimage-20240506010214962.png" alt="image-20240506010214962"></p>
<p>出现了奇怪的输出</p>
<p>每次键入一个字符 对应着<code>read</code> <code>waitpid</code> <code>yield</code> <code>write</code>系统调用都+1了</p>
<p>虽然输出流打断了我的输入流 但是功能应该还是正常的 只是我没有键入回车键 所以用户程序没有被正常执行起来</p>
<p>应该是前面的实现有问题（</p>
<p>在父进程通过<code>fork()</code>系统调用创建子进程的时候，子进程不应该继承父进程的系统调用次数和开始时间</p>
<p>系统调用次数应该直接初始化为0才对（重新算</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start_time:get_time_us() / <span class="number">1000</span>,</span><br><span class="line">syscall_times:[<span class="number">0</span>;MAX_SYSCALL_NUM]</span><br></pre></td></tr></table></figure>

<p>ok 这里可以过了</p>
<p>现在又有新问题了 还是<code>ch3_taskinfo</code>的测例</p>
<p><img src="/blog/.io//D:%5C116%5Csigs%5Cblog%5Csource_posts%5CRust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86.assets%5Cimage-20240506011435160.png" alt="image-20240506011435160"></p>
<p>好像还是过不了 但是断言错误的次数确实是减少了……</p>
<p>好像是用<code>println!()</code>打印调试信息的问题，如果去掉的话<code>Write</code>系统调用的次数就不会增加</p>
<p><img src="/blog/.io//D:%5C116%5Csigs%5Cblog%5Csource_posts%5CRust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86.assets%5Cimage-20240506013300058.png" alt="image-20240506013300058"></p>
<p>还真是 回头看了一下<code>console.rs</code>里面对<code>println!()</code>的实现 很明显是基于<code>Write</code>的</p>
<p>不然平白无故你的OS怎么能打印东西的……把这事情给忘记了    <del>笑</del></p>
<p>先一次性把时间信息都打印下来吧 后面就不看了</p>
<p><img src="/blog/.io//D:%5C116%5Csigs%5Cblog%5Csource_posts%5CRust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86.assets%5Cimage-20240506013635316.png" alt="image-20240506013635316"></p>
<p>我切换分支到<code>ch4</code>重新跑一下这个用例 <code>t1=43</code> <code>t2=544</code> <code>t3=544</code> <code>info.time=501</code>是没有问题的 </p>
<p>睡了 明天再说</p>
<p>……睡觉的时候突然想到Lab5的<code>run_tasks()</code>方法应该是没有修改 所以没有把时间信息记录下来</p>
<p>没错 就是在此处补一个记录时间的功能就ok了</p>
<h4 id="Spawn系统调用实现"><a href="#Spawn系统调用实现" class="headerlink" title="Spawn系统调用实现"></a>Spawn系统调用实现</h4><p>一遍过 感觉还是比较简单的…… 主要就是<code>fork()</code> <code>new()</code> 还有<code>exec()</code>的仿写</p>
<p>注意对parent字段特殊处理</p>
<p><code>spawn</code>出来的进程的父进程应该为当前运行的进程</p>
<h4 id="Stride调度"><a href="#Stride调度" class="headerlink" title="Stride调度"></a>Stride调度</h4><p>首先是在TCB里面增加进程优先级的字段<code>priority</code>和步长调度的参考数据<code>stride</code></p>
<p>其实是对初始化信息的补全</p>
<p>一开始我是看到的<code>processor.rs</code>的<code>run_tasks()</code>模块，里面有一个<code>fetch_tasks()</code>的过程，取得目前应该运行的任务。但是<code>fetch_tasks()</code>是局限在<code>Task Manager</code>内部，缺少<code>Processor</code>结构，也就是当下的任务状态拿不到（就是有一种可能性是当下正在运行的进程<code>stride</code>还是最小）</p>
<p>然后继续看源码 </p>
<p>感觉这几个函数之间的关系有点懵</p>
<p>……</p>
<p>后面感觉还是得在<code>add</code>位置实现，也就是<code>fetch</code>还是从队头把进程取出来，但是在<code>add</code>增加进程的时候维护所有进程的<code>stride</code>顺序</p>
<h3 id="Lab6"><a href="#Lab6" class="headerlink" title="Lab6"></a>Lab6</h3><h4 id="之前的测例"><a href="#之前的测例" class="headerlink" title="之前的测例"></a>之前的测例</h4><p>首先就是要通过之前的测例 <code>sys_spawn</code>和之前会有一些区别</p>
<p>主要就是获得程序数据的方式有差异</p>
<h4 id="本实验测试点"><a href="#本实验测试点" class="headerlink" title="本实验测试点"></a>本实验测试点</h4><p><img src="/blog/.io//D:%5C116%5Csigs%5Cblog%5Csource_posts%5CRust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86.assets%5Cimage-20240510225304112.png" alt="image-20240510225304112"></p>
<p>差最后一个</p>
<p>？？？</p>
<p>byd什么勾八</p>
<p>怎么实验还不能复现的 本地跑差一个点 在线ci全过了是吧</p>
<p><img src="/blog/.io//D:%5C116%5Csigs%5Cblog%5Csource_posts%5CRust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86.assets%5Cimage-20240510225444383.png" alt="image-20240510225444383"></p>
<h3 id="Lab8"><a href="#Lab8" class="headerlink" title="Lab8"></a>Lab8</h3><p>如果启用死锁检测功能的话，主要的检测就是在上锁相关的操作检测是否合法</p>
<p>这里有个困惑的点，就是一开始没搞懂<code>资源</code>到底是什么</p>
<p>其实就是各类的<code>lock</code>……能够得到锁 就代表得到了某个特定的资源</p>
<p>初始化是一门玄学……</p>
<p>需要自己设置好两个常量<code>MAX_THREADS</code>和<code>MAX_RESOURES</code>的数量，代表当前可以获得的资源</p>
<p>……</p>
<h4 id="一些问题"><a href="#一些问题" class="headerlink" title="一些问题"></a>一些问题</h4><p><img src="/blog/.io//D:%5C116%5Csigs%5Cblog%5Csource_posts%5CRust%E8%AF%AD%E8%A8%80%E5%88%9D%E6%AD%A5%E4%BB%A5%E5%8F%8ARustlings%E9%94%99%E9%A2%98%E6%95%B4%E7%90%86.assets%5Cimage-20240516200029337.png" alt="image-20240516200029337"></p>
<p>就卡在这里了，也不知道怎么回事</p>
<p>gpt问了一下</p>
<p>……死锁了 我就说为什么寄了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/05/18/2024%E5%B9%B4%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93-%E5%8D%93%E5%A0%82%E8%B6%8A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/05/18/2024%E5%B9%B4%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93-%E5%8D%93%E5%A0%82%E8%B6%8A/" class="post-title-link" itemprop="url">2024年开源操作系统训练营第一第二阶段学习总结-卓堂越</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-18 15:22:54" itemprop="dateCreated datePublished" datetime="2024-05-18T15:22:54+00:00">2024-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-27 03:36:30" itemprop="dateModified" datetime="2025-05-27T03:36:30+00:00">2025-05-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/2024%E6%98%A5%E5%A4%8F%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5/" itemprop="url" rel="index"><span itemprop="name">2024春夏季开源操作系统训练营</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="2024年开源操作系统训练营第一阶段学习总结-卓堂越"><a href="#2024年开源操作系统训练营第一阶段学习总结-卓堂越" class="headerlink" title="2024年开源操作系统训练营第一阶段学习总结-卓堂越"></a>2024年开源操作系统训练营第一阶段学习总结-卓堂越</h1><p>首先，我要衷心感谢所有给予我帮助助教导师。每次我有困惑的时候他们的专业知识和耐心指导帮我解决一系列棘手的问题。通过这个平台可以很好的交到对这方面感兴趣的朋友，在群里跟朋友们讨论让我可以更好地理解和应用 Rust 语法。此外，也离不开Rust 社区分享的宝贵的学习资料。同时课堂上分享的The Rust Reference 不失为一本经典巨作给我前期的语法学习提供很有力的帮助。<br>在开始开发操作系统之前，先熟悉 Rust 语言的基础知识，包括语法、类型系统、所有权和生命周期等概念为首要目标。选择Rust是因为他的安全性和性能使其成为编写操作系统的理想选择。在正式做练习之前花了很多时间在环境配置上面，之前学过的harmony os 都是他们给的镜像直接导入，第一次在上面搭建问了很多导师问题，他们都耐心的回答我，让我在这方面更有兴趣。比如在当推送本地更改时，如果远程仓库已经有了更新，可能会出现合并冲突，需要手动解决这些冲突。通过这些学习能更好的完成后面几个阶段的学习。<br>和其他语言对比在生命周期这个方面Rust 强制使用生命周期来检查引用的有效性，以避免悬空引用和数据竞争。生命周期注解使得 Rust 的借用系统变得更加严格和安全。C++ 中也有生命周期的概念，但它通常通过使用智能指针、RAII（资源获取即初始化）等技术。相比rust在这方面更不容易出错。而且在所有权上面Rust 引入了所有权和借用的概念，这是与 C++ 最明显的区别之一。在 Rust 中，每个值都有一个所有者，并且在任何时候只能有一个可变借用或任意数量的不可变借用。这确保了在编译时不会出现数据竞争。在以前学过的 C++ 中，没有类似的所有权和借用系统，开发人员需要手动管理内存和资源，这可能导致内存泄漏、悬空指针和其他常见的错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">fn main() &#123;</span><br><span class="line">    let result;</span><br><span class="line">    &#123;</span><br><span class="line">        let x &#x3D; 5;</span><br><span class="line">        result &#x3D; compute(&amp;x);</span><br><span class="line">    &#125;</span><br><span class="line">    println!(&quot;Result: &#123;&#125;&quot;, result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn compute&lt;&#39;a&gt;(value: &amp;&#39;a i32) -&gt; &amp;&#39;a i32 &#123;</span><br><span class="line">    value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有一个 main 函数，它调用了一个 compute 函数来计算一个整数的引用，并将结果赋值给 result 变量。然后我们尝试在 main 函数中打印 result 的值。然而，compute 函数返回了一个指向局部变量 x 的引用，而 x 的生命周期只在包含它的代码块内有效。由于 x 在 compute 函数返回后就会被销毁，所以返回的引用将指向无效的内存，导致悬垂引用错误。后期我发现需要通过修改函数签名来指定一个更长的生命周期，或者避免返回对局部变量的引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">fn main() &#123;</span><br><span class="line">    let result;</span><br><span class="line">    &#123;</span><br><span class="line">        let x &#x3D; 5;</span><br><span class="line">        result &#x3D; compute(x);</span><br><span class="line">    &#125;</span><br><span class="line">    println!(&quot;Result: &#123;&#125;&quot;, result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn compute(value: i32) -&gt; i32 &#123;</span><br><span class="line">    value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面代码的修改这样就避免了使用引用并返回了整数值本身，从而避免了悬垂引用错误。</p>
<h1 id="第二部分学习总结"><a href="#第二部分学习总结" class="headerlink" title="第二部分学习总结"></a>第二部分学习总结</h1><p>实验是按照rCore-Tutorial-Book-v3来完成的<br>环境搭建我是用了VMware 安装虚拟机在文档提供的直接使用</p>
<h2 id="lab1"><a href="#lab1" class="headerlink" title="lab1"></a>lab1</h2><p>这个任务主要是为了获取任务信息，通过引入新的系统调用 sys_task_info，操作系统增强了对任务的监控和管理能力。现在，系统管理员可以根据任务 ID 查询到任务的详细信息，包括当前任务的状态、已经执行的系统调用及其调用次数，以及任务的总运行时长。这个功能使得系统能够更加细致地了解任务的运行情况，有助于优化系统资源的分配，提高系统的整体性能和稳定性。同时，对于开发人员来说，这也提供了一个更好的调试工具，可以更方便地跟踪和分析任务的行为，帮助定位和解决潜在的问题。</p>
<h2 id="lab2"><a href="#lab2" class="headerlink" title="lab2"></a>lab2</h2><p>sys_get_time 函数的重写，我们重新设计了获取系统时间的逻辑，使其能够适应新的系统架构。这样，我们成功恢复了获取系统时间的功能，确保系统在引入新特性的同时不影响原有功能的正常运行。sys_mmap 和 sys_munmap 系统调用的实现，则为系统增加了动态内存管理的功能。通过 sys_mmap 系统调用，我们可以在虚存中映射一段指定长度的物理内存，为进程提供所需的内存空间。而 sys_munmap 则提供了取消内存映射的功能，帮助释放不再需要的内存空间，有效管理系统资源。</p>
<h2 id="lab3"><a href="#lab3" class="headerlink" title="lab3"></a>lab3</h2><p>实现了一个完全 DIY 的系统调用 sys_spawn，用以创建一个新进程。与传统的 fork 和 execve 组合不同，sys_spawn 系统调用直接创建一个新的子进程，并使其执行指定的目标程序。这种方式更加直接，省去了复制父进程地址空间的步骤，从而提高了效率。在实现 sys_spawn 系统调用的过程中，我们需要处理一些可能的错误情况，比如无效的文件名或者系统资源不足导致的错误。通过正确处理这些错误，我们可以保证系统的稳定性和可靠性。通过这次实践作业，我们深入理解了进程创建的原理和实现方式，加深了对操作系统内核的理解。同时，也提高了我们对系统调用的理解和实现能力。</p>
<h2 id="lab4"><a href="#lab4" class="headerlink" title="lab4"></a>lab4</h2><p>在本次实践中，我们要用到三个系统调用：sys_linkat、sys_unlinkat 和 sys_stat，分别用于创建硬链接、取消链接以及查询文件状态。通过这些系统调用，我们可以实现文件系统中文件的硬链接操作，并获取文件的状态信息，从而提高文件管理的便利性和灵活性。</p>
<h2 id="lab5"><a href="#lab5" class="headerlink" title="lab5"></a>lab5</h2><p>本次实验旨在实现一个新的系统调用 <code>sys_eventfd2</code>，用于在 Linux 系统中创建 eventfd，其功能是创建一个带有计数器的文件描述符，用于进程间事件通知。通过参数解析和错误处理，我们成功实现了该系统调用，并能够根据传入的参数创建相应的 eventfd，从而为进程间通信提供了一种有效的机制。</p>
<p>这次实验为我们提供了一个很好的机会，加深了对操作系统的理解，并提高了我们的系统编程能力。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5Blog-%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5-%E7%BD%97%E5%81%A5%E5%B3%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5Blog-%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5-%E7%BD%97%E5%81%A5%E5%B3%B0/" class="post-title-link" itemprop="url">2024春夏季开源操作系统训练营Blog-第二阶段-罗健峰</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-17 23:46:47" itemprop="dateCreated datePublished" datetime="2024-05-17T23:46:47+00:00">2024-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-27 03:36:30" itemprop="dateModified" datetime="2025-05-27T03:36:30+00:00">2025-05-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/report/" itemprop="url" rel="index"><span itemprop="name">report</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="2024春夏季开源操作系统训练营Blog-第二阶段-罗健峰"><a href="#2024春夏季开源操作系统训练营Blog-第二阶段-罗健峰" class="headerlink" title="2024春夏季开源操作系统训练营Blog-第二阶段-罗健峰"></a>2024春夏季开源操作系统训练营Blog-第二阶段-罗健峰</h1><h2 id="开头"><a href="#开头" class="headerlink" title="开头"></a>开头</h2><p>对于操作系统这门课上，我是比较薄弱的，就目前在写此总结之余，想起来我还是感觉有些吃力，主要的困点和难点在于我在训练营开始学习之前，学习过操作系统但没有这么深入，仅仅停留在简单的进程、线程和一些简单的调度算法，再一个就是我本身的学习和工作都在应用层，CPU指令集、硬件这一块的理解还是不太深入。但总体来讲我还是比较高兴自己能够坚持下来，回首一看，真是不容易，要补的，要学习的还是非常多。我接下来的打算就是反复细致的再回首，好好吃透rcore，在rcore的基础上想实现一些其他的功能，同时迎接第三阶段的学习。</p>
<p>好了，回归正题，我将以各章所遇到的情况分别总结。</p>
<h2 id="第一章"><a href="#第一章" class="headerlink" title="第一章"></a>第一章</h2><p>第一章的代码树比较简单，主要的内容还是让同学们对操作系统有个大致的启动流程。</p>
<ol>
<li>用<code>qemu</code>来模拟基于<code>risc-v</code>指令集的裸机环境。</li>
<li>将<code>qemu</code>的启动地址设置为rustsbi的地址来引导操作系统的入口函数。同时接触到第一次risc-v汇编语言（entry.asm）。</li>
<li>剥离rust基于特定操作系统的用户标准库。</li>
<li>一些OS的基础库（日志、标准输出、sbi、异常处理、内存布局等等）</li>
</ol>
<p>最后运行裸机环境下的os，输出hello world!,此时的os其实不叫os，可能更像是一个库函数。整个计算机的资源都为它一个程序服务。</p>
<p>第一章还是比较简单，没有遇到太大的问题。</p>
<h2 id="第二章-批处理系统"><a href="#第二章-批处理系统" class="headerlink" title="第二章 批处理系统"></a>第二章 批处理系统</h2><p>第二章的主要内容是risc-v指令集的特权级机制。</p>
<p>由于第一章是运行单个程序、更多的是一个函数库的使用。</p>
<p>第二章在基于特权级机制下，我们将多个程序一起打包在一起，在第一个程序执行完后，就会自动的执行下一个程序，<strong>但要注意的是目前执行的程序都不是全部加载到内存里面的，而是在我们约定好的一个具体的物理地址上</strong>，同时特权级机制保障了程序在运行过程中发生错误时，能够触发异常陷入trap进而从用户态转入到内核态去执行和处理异常，进而保证程序错误不会影响接下来的程序运行。</p>
<p>第二章也比较好理解和简单。</p>
<h2 id="第三章-多道程序与分时任务"><a href="#第三章-多道程序与分时任务" class="headerlink" title="第三章 多道程序与分时任务"></a>第三章 多道程序与分时任务</h2><p>第三章在第二章的基础上，从一个一个加载到固定内存地址去执行，到一次性全部加载到内存里执行，减少任务切换的开销，同时可以并发的执行多个用户程序。</p>
<p>最重要的是实现了yield系统调用来主动放弃处理器的执行权，</p>
<p>进而可以让OS来调度一个任务的执行还是强制打断，其中打断需要保存上下文，在下一个时间片时恢复原先程序的上下文状态，采用时间片轮转算法调度用户程序。</p>
<p>同时引申出了其他的调度算法，也是一个比较值得研究的地方。后面有时间了还是想看看windows和linux内核的调度算法，学习学习。</p>
<h2 id="第四章-地址空间"><a href="#第四章-地址空间" class="headerlink" title="第四章 地址空间"></a>第四章 地址空间</h2><p>由于前面的OS，应用程序都是运行在真实的物理内存上的，任务多了，给应用程序员带来了很大的麻烦，他们在写程序的时候得仔细考虑一下应用该在哪个内存区间内执行，不会影响其他程序和自身程序的运行，再一个就是操作系统有义务来管理程序的运行，和减少上层应用程序员的心智负担，让他们不需要考虑程序的具体运行和内存的分布。</p>
<p>所以说我们引入了一个新的抽象层，地址空间。</p>
<p>实现地址空间不单单是os来做的，在risc-v指令集的硬件设计上也有实现，主要的参与者是MMU，其中<code>stap</code>寄存器是来开启risc-v指令集的分页机制的</p>
<p>通过设置<code>stap</code>寄存器来开启，目前OS实现的是SV39分页机制。</p>
<p>基于SV39的分页机制，就可以通过 va -&gt; vpn -&gt; ppn -&gt; pa的关系，从虚拟地址转换到物理地址。</p>
<p>其中os维护了这一映射关系，在代码中的体现是<code>PageTable</code>和相关的工具函数。</p>
<blockquote>
<p>注：<br>运行时，内核要运行在内核的自己的地址空间中，同时它还得需要知道具体的物理内存地址，能读取到应用中的数据。我们引入了跳板机制。</p>
</blockquote>
<p>在每一个程序的最高位地址空间中都注入了跳板，以达到操作系统能读取到应用程序的方便，同时补上risc-v寄存器不够存储上下文的情况。</p>
<h2 id="第五章-进程及进程管理"><a href="#第五章-进程及进程管理" class="headerlink" title="第五章 进程及进程管理"></a>第五章 进程及进程管理</h2><p>在第四章地址空间的基础上，我们把前面所谓的任务，升级为进程，其实本质上来讲就是进程。</p>
<p>我们对任务建立新的抽象：进程</p>
<p>引入进程相关的状态。</p>
<p>我们引入了进程相关的内容，整个项目的进程管理是一颗树，同时实现了一些进程相关的系统调用，<code>fork</code>、<code>exec</code>、<code>waitpid</code> 等。</p>
<p>这颗进程管理树，是通过用户初始化进程展开的，这个进程是被内置在我们操作系统中的，其他的进程皆可以通过<code>fork + exec</code> 创建和执行。</p>
<p>同时实现了新的stride调度算法，同时设置相关的进程优先级。</p>
<p>这一章的内容是比较多的，当时我在学习的时候还是废了老大劲了，目前准备在写完总结之后再仔细研究研究，准备换个新的进程调度算法。</p>
<h2 id="第六章-文件系统与I-O重定向"><a href="#第六章-文件系统与I-O重定向" class="headerlink" title="第六章 文件系统与I/O重定向"></a>第六章 文件系统与I/O重定向</h2><p>这一章，我还没太细致的研究，但总体来讲主要是要明白文件系统的管理方式，其中目录和文件的区分。</p>
<p>easy-fs的磁盘布局</p>
<p>sb | bitmap | diskInode | 数据块位图 | 数据块区域 DataBlock</p>
<h2 id="第七章-进程间通讯"><a href="#第七章-进程间通讯" class="headerlink" title="第七章 进程间通讯"></a>第七章 进程间通讯</h2><ol>
<li>主要是进程与管道。</li>
<li>一些进程之间的通讯方式，通过管道</li>
</ol>
<p>后面的想法是通过消息队列来实现进程之间的通讯，目前有一些语言的同步方式就是使用的消息队列。</p>
<h2 id="第八章-并发"><a href="#第八章-并发" class="headerlink" title="第八章 并发"></a>第八章 并发</h2><p>没有和前面的系统前向兼容，主要是为os实现锁机制和检测死锁，以及如何恢复，解开锁。</p>
<p>一些死锁算法。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>还是非常感谢开源操作系统社区这个平台，文档V3和2024s写的非常好和细致，在整个阅读下来非常舒服，同时也学到了很多的新东西。RAII的设计模式有了更加深刻的体会，也学会了qemu、gdb、make等工具的使用，加深了对rust语言的学习。</p>
<p>最后，非常感谢！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/05/17/2024%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-by-xhyf77/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/05/17/2024%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-by-xhyf77/" class="post-title-link" itemprop="url">2024春第二阶段总结报告 by:xhyf77</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-17 15:17:48" itemprop="dateCreated datePublished" datetime="2024-05-17T15:17:48+00:00">2024-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-27 03:36:30" itemprop="dateModified" datetime="2025-05-27T03:36:30+00:00">2025-05-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/report/" itemprop="url" rel="index"><span itemprop="name">report</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="第二阶段总结"><a href="#第二阶段总结" class="headerlink" title="第二阶段总结"></a>第二阶段总结</h3><p>在第二阶段的学习过程中，是我对进程的概念有了更加深刻的认识，之前对进程和线程的认知还是比较模糊，且之前没有看过多线程的源码，一直不太能理解进程和线程的本质区别，而这次经过rCore的学习，让我从源码级别真正触碰到了进程和线程，让我对这个概念的理解更加深刻。同时在学习过程中也加强了我的调试能力，特别是对gdb的使用，还记得做lab4的时候因为一个bug调试了几天，虽然最后也没能调试出来换了别的方案实现，但是还是让我受益匪浅。同时我对RAII的这种设计模式也有了更加深刻的体会，我以前也用c写过x86的内核，但这次用rust来写内核给我的体验是完全不一样的，这种RAII的设计模式让我感觉我在用写开发项目的方式来写操作系统，比用c写要方便许多。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/05/17/2024%E6%98%A5%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-lovelyTao/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/05/17/2024%E6%98%A5%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-lovelyTao/" class="post-title-link" itemprop="url">2024春季开源操作系统训练营第二阶段总结-lovelyTao</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-17 12:36:57" itemprop="dateCreated datePublished" datetime="2024-05-17T12:36:57+00:00">2024-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-27 03:36:30" itemprop="dateModified" datetime="2025-05-27T03:36:30+00:00">2025-05-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/reports/" itemprop="url" rel="index"><span itemprop="name">reports</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>5.1放假结束后才有时间开始做，两个礼拜的时间每天只要没有事情，就是肝lab，虽然学习过程感觉很艰辛，但是每次看到lab测试全部通过就会感到很兴奋。</p>
<p>这是第一次学习rust并用rust实现需求，很多写法思路都是照着rcore代码实现的，感觉从里面学到了很多，对RAII的思想了解的更加深刻了，体会到了它的魅力</p>
<p>在做lab的过程中，逐渐学习如何对代码结构进行优化，虽然现在代码写的还是一坨，但是有努力在学习好的想法。希望能在未来的学习中进一步规范自己的代码规范，进一步学习如何写出优雅的代码。</p>
<p>lab5是最让人感觉没头绪的实验，但是我选择了先实现能实现的，在实践过程中我发现这样的方法能让我更容易克服困难，但是在完成后我发现问题，这样往往会导致一些结构上的设计不够完美。所以最好的选择估计是完成后，在对整体进行优化，重构所写的功能。</p>
<p>在参加项目之前，我还没有感受到阅读源码的魅力，在学习过程中，在读代码的过程中发现能让我对知识有更好的理解，有时候光看手册，会觉得非常的枯燥，很那理解，当结合编译器对代码一个个进行跳转查看的时候，我发现理解起来好了很多。阅读代码也能让我学习更多好的代码桂发，写出一些比较好的代码。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/05/17/2024S%20%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E6%80%BB%E7%BB%93-%E9%99%88%E5%98%89%E9%91%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/05/17/2024S%20%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E6%80%BB%E7%BB%93-%E9%99%88%E5%98%89%E9%91%AB/" class="post-title-link" itemprop="url">2024S 开源操作系统训练营总结-陈嘉鑫</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-17 11:56:58" itemprop="dateCreated datePublished" datetime="2024-05-17T11:56:58+00:00">2024-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-27 03:36:30" itemprop="dateModified" datetime="2025-05-27T03:36:30+00:00">2025-05-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/2024%E6%98%A5%E5%A4%8F%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5/" itemprop="url" rel="index"><span itemprop="name">2024春夏季开源操作系统训练营</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="一阶段"><a href="#一阶段" class="headerlink" title="一阶段"></a>一阶段</h1><h2 id="起源"><a href="#起源" class="headerlink" title="起源"></a>起源</h2><p>之前几次训练营我没赶上, 这次过年后就关注了.</p>
<h2 id="Rust"><a href="#Rust" class="headerlink" title="Rust"></a>Rust</h2><p>目前实习工作是用 rust 的算懂一点, 不过马上离职了.<br>一阶段的写链表还是有意思的哈哈哈</p>
<h1 id="二阶段"><a href="#二阶段" class="headerlink" title="二阶段"></a>二阶段</h1><h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><p>老哥们在二阶段刚刚开始的时候通宵冲榜太猛了.<br>个人感觉 lab4 的复杂度是最高的, 主要是在 block cache 这一块, 如果是萌新确实理解起来难度比较大.<br>20 年的时候我做过 xv6-riscv 的实验, COW, lazy fork 之类的实验都被放在了选做题部分, 但是选做我都是不做的.<br>rCore对我帮助最大的是从零开始怎么写一个 kernel, 而 xv6 是在一个 kernel 上加 feature .<br>希望之后 rCore 能够加入其他的架构, 我感觉 riscv 是可以自学的, 比如从 61c 开始, 但是x86真得有老师指导, 实模式,保护模式,长模式, apic, aipc, multiboot, 人已经晕了.<br>还希望有个微内核版本.  </p>
<p>感谢清华大学, 感谢 rCore 社区</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/" class="post-title-link" itemprop="url">2024春夏季OS训练营:如何快速搭建基于docker和vscode的开发和调试环境-xuejianxinokok.md</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-17 09:23:01" itemprop="dateCreated datePublished" datetime="2024-05-17T09:23:01+00:00">2024-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-27 03:36:30" itemprop="dateModified" datetime="2025-05-27T03:36:30+00:00">2025-05-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>一阶段学习参考</p>
<ul>
<li><p><a href="https://juejin.cn/post/7358742048134365221" target="_blank" rel="noopener">转:Learn Rust the Dangerous Way-系列文章翻译-总述 - 掘金</a>，这系列文章总结了rust改写c语言 ，非常经典</p>
</li>
<li><p><a href="https://juejin.cn/post/7359110982227640374" target="_blank" rel="noopener">*如何在rust 中实现 带有循环引用的数据结构 - 掘金</a></p>
</li>
</ul>
<hr>
<p>在学习os开发的时候如何使我们能够愉快的开始学习，而不在配置环境折腾的时间太长，以下是我的实践。</p>
<p>我的系统是windows11,上边安装了dockerdesktop.</p>
<h2 id="1-docker-容器"><a href="#1-docker-容器" class="headerlink" title="1. docker 容器"></a>1. docker 容器</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 检出源码</span></span><br><span class="line"></span><br><span class="line">git clone git://github.com/rcore-os/rCore-Tutorial-v3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到源码目录，我把源码检出到 本机以下目录</span></span><br><span class="line"></span><br><span class="line">cd  D:\work20220906\gitee\rusttest\rCore-Tutorial-v3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 制作 docker 镜像</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里我们把镜像的名称设置为rcore</span></span><br><span class="line">docker build -t rcore  --target build .</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行docker dev container</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 为了能够在容器内看到源码，需要把包含源码的目录 隐射到容器内部</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 我为了方便 把源码的上层目录隐射到了容器内部 /mnt</span></span><br><span class="line">docker run --name os1 --hostname os1  -v D:/work20220906/gitee/rusttest/:/mnt -w /mnt  -d rcore  sleep infinity </span><br><span class="line"><span class="meta">#</span><span class="bash"> docker  rm -f os1 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在cmd 中， 进入容器ssh </span></span><br><span class="line">docker exec -it os1 /bin/bash </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试运行</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到目录</span></span><br><span class="line">cd /mnt/rCore-Tutorial-v3/os</span><br><span class="line">运行</span><br><span class="line">make run</span><br></pre></td></tr></table></figure>

<p>docker 镜像</p>
<img src="/blog/.io//2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/2024-05-17-09-40-49-image.png" class title="2024-05-17-09-40-49-image">

<p>开发容器</p>
<img src="/blog/.io//2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/2024-05-17-09-41-14-image.png" class title="2024-05-17-09-41-14-image">

<h2 id="2-dev-container-开发环境"><a href="#2-dev-container-开发环境" class="headerlink" title="2. dev container 开发环境"></a>2. dev container 开发环境</h2><h3 id="2-1-安装vscode-及其插件"><a href="#2-1-安装vscode-及其插件" class="headerlink" title="2.1 安装vscode 及其插件"></a>2.1 安装vscode 及其插件</h3><p>为了支持docker dev container 需要安装以下插件</p>
<img src="/blog/.io//2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/2024-05-17-09-42-12-image.png" class title="2024-05-17-09-42-12-image">

<p>点击以下红色标识位置连接到dev container</p>
<img src="/blog/.io//2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/2024-05-17-09-46-03-image.png" class title="2024-05-17-09-46-03-image.png">

<p>然后打开/mnt/ 目录下的项目文件夹</p>
<img src="/blog/.io//2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/2024-05-17-09-47-48-image.png" class title="2024-05-17-09-47-48-image.png">

<h2 id="2-2-安装调试插件"><a href="#2-2-安装调试插件" class="headerlink" title="2.2 安装调试插件"></a>2.2 安装调试插件</h2><img src="/blog/.io//2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/2024-05-17-09-49-01-image.png" class title="2024-05-17-09-49-01-image.png">

<h2 id="3-在vscode-中支持远程调试"><a href="#3-在vscode-中支持远程调试" class="headerlink" title="3. 在vscode 中支持远程调试"></a>3. 在vscode 中支持远程调试</h2><h3 id="3-1-在容器os1-内编译-gdb"><a href="#3-1-在容器os1-内编译-gdb" class="headerlink" title="3.1 在容器os1 内编译 gdb"></a>3.1 在容器os1 内编译 gdb</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">```shell</span><br><span class="line"><span class="meta">#</span><span class="bash">1. 进入docker </span></span><br><span class="line">docker exec -it os1 /bin/bash</span><br><span class="line"><span class="meta">#</span><span class="bash">2. 安装终端复用工具</span></span><br><span class="line">apt install tmux</span><br><span class="line">apt-get install libncurses5-dev texinfo libreadline-dev</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在 configure  发现少了2个库，补上</span></span><br><span class="line">apt-get install libgmp-dev libmpfr-dev</span><br><span class="line"><span class="meta">#</span><span class="bash"> 缺少python-dev，没有也可</span></span><br><span class="line">apt install python3.8-dev</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 好像docker 环境已经预装了python3.8</span></span><br><span class="line"><span class="meta">#</span><span class="bash">apt-get install python3</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">which</span> python3 </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">ll $(<span class="built_in">which</span> python3)  </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 建立符号连接 到/usr/bin/python</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ln -s  /usr/bin/python3.8*  /usr/bin/python</span></span><br><span class="line"><span class="meta">#</span><span class="bash">root@os1:/usr/bin<span class="comment"># which python</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">/usr/bin/python</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">whereis python3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">python3 --version</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Python 3.8.10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">4. 下载gdb</span></span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/gnu/gdb/gdb-14.2.tar.xz</span><br><span class="line"><span class="meta">#</span><span class="bash">解压</span></span><br><span class="line">tar -xvf gdb-14.2.tar.xz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入目录</span></span><br><span class="line">cd gdb-</span><br><span class="line">14.2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看当前目录 <span class="built_in">pwd</span></span></span><br><span class="line">/mnt/gdb-14.2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建编译目录</span></span><br><span class="line">mkdir build-riscv64</span><br><span class="line"></span><br><span class="line">cd build-riscv64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">5. 配置编译选项，可以不配置with-python</span></span><br><span class="line">../configure --prefix=/mnt/gdb-14.2/build-riscv64 --with-python=/usr/bin/python3 --target=riscv64-unknown-elf --enable-tui=yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6.编译</span></span><br><span class="line">make -j$(nproc)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 7.安装</span></span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 8. 编译好的 GDB 存放在 build-riscv64/bin/ 目录下，你可以只保留这个目录，然后添加这个目录到环境变量。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 确认 GDB 可以运行</span></span><br><span class="line">./bin/riscv64-unknown-elf-gdb --version</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@os1:/mnt/gdb-14.2/build-riscv64# ./bin/riscv64-unknown-elf-gdb --version</span><br><span class="line">GNU gdb (GDB) 14.2</span><br><span class="line">Copyright (C) 2023 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line">root@os1:/mnt/gdb-14.2/build-riscv64# ll ./bin/</span><br><span class="line">total 238428</span><br><span class="line">drwxr-xr-x 1 root root      4096 May 13 03:10 ./</span><br><span class="line">drwxr-xr-x 1 root root      4096 May 13 03:10 ../</span><br><span class="line">-rwxr-xr-x 1 root root 232530576 May 13 03:10 riscv64-unknown-elf-gdb*</span><br><span class="line">-rwxr-xr-x 1 root root      4627 May 13 03:10 riscv64-unknown-elf-gdb-add-index*</span><br><span class="line">-rwxr-xr-x 1 root root  11605272 May 13 03:10 riscv64-unknown-elf-run*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们直接拷贝到/usr/<span class="built_in">local</span>/bin 目录，这样直接可以全局使用</span></span><br><span class="line">ll /usr/local/bin</span><br><span class="line"></span><br><span class="line">cp /mnt/gdb-14.2/build-riscv64/bin/*  /usr/local/bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 9. 安装 gdb-dashboard：仅仅是下载一个 python 文件到 ~/.gdbinit 来做 gdb 的启动拓展</span></span><br><span class="line">wget -P ~ https://github.com/cyrus-and/gdb-dashboard/raw/master/.gdbinit</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以下是 gdbinit 文件的存放目录</span></span><br><span class="line">root@os1:~# pwd</span><br><span class="line">/root</span><br><span class="line">root@os1:~# ll -la</span><br><span class="line">-rw-r--r-- 1 root root 93928 May 13 03:15 .gdbinit</span><br></pre></td></tr></table></figure>

<h3 id="3-2-使编译的os文件支持调试信息"><a href="#3-2-使编译的os文件支持调试信息" class="headerlink" title="3.2 使编译的os文件支持调试信息"></a>3.2 使编译的os文件支持调试信息</h3><p><strong>以rcore  ch3 为例</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">1. os/Makefile 文件中 修改和添加以下内容</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MODE := release  保证是debug编译 会保留符号信息</span></span><br><span class="line">MODE := debug</span><br><span class="line"><span class="meta">#</span><span class="bash"> 包装gdb 命令否则rustc源码无法对应</span></span><br><span class="line">GDB_PATH := riscv64-unknown-elf-gdb</span><br><span class="line">gdb := RUST_GDB=$(GDB_PATH) rust-gdb</span><br><span class="line"></span><br><span class="line">debug: build</span><br><span class="line">    @tmux new-session -d \</span><br><span class="line">        "qemu-system-riscv64 -machine virt -nographic -bios $(BOOTLOADER) -device loader,file=$(KERNEL_BIN),addr=$(KERNEL_ENTRY_PA) -s -S" &amp;&amp; \</span><br><span class="line">        tmux split-window -h "$(gdb) -ex 'file $(KERNEL_ELF)' -ex 'set arch riscv:rv64' -ex 'target remote localhost:1234'" &amp;&amp; \</span><br><span class="line">        tmux -2 attach-session -d</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">2. user/Makefile</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MODE := release  保证编译debug</span></span><br><span class="line">MODE := debug</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">3. user/build.py</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">mode = os.getenv(<span class="string">"MODE"</span>, default = <span class="string">"release"</span>)</span></span><br><span class="line">mode = os.getenv("MODE", default = "debug")</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4.user/src/linker.ld 文件中</span></span><br><span class="line">/DISCARD/ : &#123;</span><br><span class="line">        *(.eh_frame)</span><br><span class="line">      /*  *(.debug*) */  注释掉这行，不删除调试信息</span><br></pre></td></tr></table></figure>

<p>用以下命令确定os文件支持调试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">root@os1:/mnt/2024s-rcore-xuejianxinokok/os/target/riscv64gc-unknown-none-elf/debug# file os</span><br><span class="line">os: ELF 64-bit LSB executable, UCB RISC-V, version 1 (SYSV), </span><br><span class="line">statically linked, </span><br><span class="line"></span><br><span class="line">with debug_info, not stripped   &lt;&lt;&lt;&lt;&lt;&lt;&lt; 注意是这行</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 或者直接读取section 信息，发现有debug_info  这些section</span></span><br><span class="line">root@os1:/mnt/2024s-rcore-xuejianxinokok/os/target/riscv64gc-unknown-none-elf/debug# readelf -SW os</span><br><span class="line">There are 18 section headers, starting at offset 0x2952a8:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 0]                   NULL            0000000000000000 000000 000000 00      0   0  0</span><br><span class="line">  [ 1] .text             PROGBITS        0000000080200000 001000 00a340 00  AX  0   0  4</span><br><span class="line">  [ 2] .rodata           PROGBITS        000000008020b000 00c000 0334ab 00  AM  0   0 4096</span><br><span class="line">  [ 3] .data             PROGBITS        000000008023f000 040000 028920 00  WA  0   0  8</span><br><span class="line">  [ 4] .bss              NOBITS          0000000080268000 068920 038660 00  WA  0   0  8</span><br><span class="line">  [ 5] .debug_abbrev     PROGBITS        0000000000000000 068920 006a82 00      0   0  1</span><br><span class="line">  [ 6] .debug_info       PROGBITS        0000000000000000 06f3a2 073718 00      0   0  1</span><br><span class="line">  [ 7] .debug_aranges    PROGBITS        0000000000000000 0e2aba 0061b0 00      0   0  1</span><br><span class="line">  [ 8] .debug_str        PROGBITS        0000000000000000 0e8c6a 08d4ab 01  MS  0   0  1</span><br><span class="line">  [ 9] .comment          PROGBITS        0000000000000000 176115 000048 01  MS  0   0  1</span><br><span class="line">  [10] .riscv.attributes RISCV_ATTRIBUTES 0000000000000000 17615d 00003e 00      0   0  1</span><br><span class="line">  [11] .debug_frame      PROGBITS        0000000000000000 1761a0 007f08 00      0   0  8</span><br><span class="line">  [12] .debug_line       PROGBITS        0000000000000000 17e0a8 040627 00      0   0  1</span><br><span class="line">  [13] .debug_ranges     PROGBITS        0000000000000000 1be6cf 033b00 00      0   0  1</span><br><span class="line">  [14] .debug_loc        PROGBITS        0000000000000000 1f21cf 000b72 00      0   0  1</span><br><span class="line">  [15] .symtab           SYMTAB          0000000000000000 1f2d48 096048 18     17 25465  8</span><br><span class="line">  [16] .shstrtab         STRTAB          0000000000000000 288d90 0000b5 00      0   0  1</span><br><span class="line">  [17] .strtab           STRTAB          0000000000000000 288e45 00c462 00      0   0  1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  p (processor specific)</span><br></pre></td></tr></table></figure>

<p>这时我们就可以在 容器内的命令行进行调试了，但这样还是不太方便</p>
<p>进入gbd 后</p>
<p><strong>先回车后</strong> ,然后再输入 <code>b rust_main</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b rust_main </span><br><span class="line">Breakpoint 1 at 0x8020618a: file src&#x2F;main.rs, line 98.</span><br></pre></td></tr></table></figure>

<p>再输入 c</p>
<img src="/blog/.io//2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/2024-05-14-14-13-18-image.png" class title="2024-05-14-14-13-18-image.png">

<img src="/blog/.io//2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/2024-05-14-14-20-57-image.png" class title="2024-05-14-14-20-57-image.png">

<h3 id="3-3-配置vscode-调试"><a href="#3-3-配置vscode-调试" class="headerlink" title="3.3 配置vscode 调试"></a>3.3 配置vscode 调试</h3><p>虽然我们就可以在命令行进行调试了，但这样还是不太方便，我们接着配置vscode中的调试</p>
<p>按F5 启动调试添加 .vscode/launch.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">    <span class="attr">"configurations"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"gdb Remote Launch"</span>,</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"cppdbg"</span>,</span><br><span class="line">            <span class="attr">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">            <span class="attr">"program"</span>: <span class="string">"$&#123;workspaceRoot&#125;/os/target/riscv64gc-unknown-none-elf/debug/os"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [],</span><br><span class="line">            <span class="attr">"stopAtEntry"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"environment"</span>: [],</span><br><span class="line">            <span class="attr">"externalConsole"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"MIMode"</span>: <span class="string">"gdb"</span>,</span><br><span class="line">            <span class="attr">"miDebuggerPath"</span>: <span class="string">"riscv64-unknown-elf-gdb"</span>,</span><br><span class="line">            <span class="attr">"miDebuggerServerAddress"</span>: <span class="string">"localhost:1234"</span>,</span><br><span class="line">            <span class="attr">"miDebuggerArgs"</span>: <span class="string">"gdb"</span>,</span><br><span class="line"></span><br><span class="line">            <span class="attr">"setupCommands"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">"text"</span>: <span class="string">"set arch riscv:rv64"</span>,</span><br><span class="line">                  <span class="attr">"ignoreFailures"</span>: <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"description"</span>: <span class="string">"Enable pretty-printing for gdb"</span>,</span><br><span class="line">                    <span class="attr">"text"</span>: <span class="string">"-enable-pretty-printing"</span>,</span><br><span class="line">                    <span class="attr">"ignoreFailures"</span>: <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"cwd"</span>: <span class="string">"$&#123;workspaceFolder&#125;"</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在另一个终端窗口启动 make gdbserver</strong></p>
<p>在vscode 启动调试</p>
<p><img src="/blog/.io//2024-05-15-13-49-42-image.png" alt></p>
<img src="/blog/.io//2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/2024-05-15-13-49-42-image.png" class title="2024-05-15-13-49-42-image.png">

<img src="/blog/.io//2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/2024-05-15-13-59-17-image.png" class title="2024-05-15-13-59-17-image.png">

<img src="/blog/.io//2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/2024-05-15-14-00-13-image.png" class title="2024-05-15-14-00-13-image.png">

<img src="/blog/.io//2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3OS%E8%AE%AD%E7%BB%83%E8%90%A5-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8Edocker%E5%92%8Cvscode%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83-xuejianxinokok-md/2024-05-15-14-02-58-image.png" class title="2024-05-15-14-02-58-image">

<p>为了每次按F5 时能够自动打开gbdserver</p>
<p>需要在 .vscode/launch.json配置一个preLaunchTask</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">    <span class="attr">"configurations"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"gdb Remote Launch"</span>,</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"cppdbg"</span>,</span><br><span class="line">            <span class="attr">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">            <span class="attr">"program"</span>: <span class="string">"$&#123;workspaceRoot&#125;/os/target/riscv64gc-unknown-none-elf/debug/os"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [],</span><br><span class="line">            <span class="comment">// 在入口处停止</span></span><br><span class="line">            <span class="attr">"stopAtEntry"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"environment"</span>: [],</span><br><span class="line">            <span class="attr">"externalConsole"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="comment">// 调试会话开始前执行的任务，一般为编译程序。与tasks.json的label相对应</span></span><br><span class="line">            <span class="comment">// 参考 https://blog.csdn.net/BlizCp/article/details/111054747</span></span><br><span class="line">            <span class="attr">"preLaunchTask"</span>: <span class="string">"startGdbserverTask"</span>,</span><br><span class="line">            <span class="attr">"MIMode"</span>: <span class="string">"gdb"</span>,</span><br><span class="line">            <span class="comment">//调试器路径，Windows下后缀不能省略，Linux下则去掉</span></span><br><span class="line">            <span class="attr">"miDebuggerPath"</span>: <span class="string">"riscv64-unknown-elf-gdb"</span>,</span><br><span class="line">            <span class="attr">"miDebuggerServerAddress"</span>: <span class="string">"localhost:1234"</span>,</span><br><span class="line">            <span class="attr">"miDebuggerArgs"</span>: <span class="string">"gdb"</span>,</span><br><span class="line"></span><br><span class="line">            <span class="attr">"setupCommands"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">"text"</span>: <span class="string">"set arch riscv:rv64"</span>,</span><br><span class="line">                  <span class="attr">"ignoreFailures"</span>: <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"description"</span>: <span class="string">"Enable pretty-printing for gdb"</span>,</span><br><span class="line">                    <span class="attr">"text"</span>: <span class="string">"-enable-pretty-printing"</span>,</span><br><span class="line">                    <span class="attr">"ignoreFailures"</span>: <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"cwd"</span>: <span class="string">"$&#123;workspaceFolder&#125;"</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在.vscode/tasks.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"2.0.0"</span>,</span><br><span class="line">    <span class="attr">"tasks"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"shell"</span>,</span><br><span class="line">            <span class="attr">"label"</span>: <span class="string">"startGdbserverTask"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"nohup"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"make"</span>,</span><br><span class="line">                <span class="string">"gdbserver"</span>,</span><br><span class="line">                <span class="string">"-w"</span>,</span><br><span class="line"></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"options"</span>: &#123;</span><br><span class="line">                <span class="attr">"cwd"</span>: <span class="string">"$&#123;workspaceRoot&#125;/os"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"hide"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了能使 gdbserver在后台运行，os/Makefile,在命令结尾-s -S 后边添加了 <code>&amp;</code> ,否则阻塞client启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdbserver: build</span><br><span class="line">    @qemu-system-riscv64 -machine virt -nographic -bios $(BOOTLOADER) -device loader,file=$(KERNEL_BIN),addr=$(KERNEL_ENTRY_PA) -s -S &amp;</span><br></pre></td></tr></table></figure>

<p>有时候gdbserver 没有被杀死导致启动不了,需要找到进程然后手动kill</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@os1:/mnt/2024s-rcore-xuejianxinokok/os# lsof -i:1234</span><br><span class="line">COMMAND    PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME</span><br><span class="line">qemu-syst 5049 root    9u  IPv4 8134403      0t0  TCP *:1234 (LISTEN)</span><br><span class="line">qemu-syst 5049 root   10u  IPv6 8134404      0t0  TCP *:1234 (LISTEN)</span><br></pre></td></tr></table></figure>

<p>这样就可以愉快的调试了。</p>
<p>路漫漫…</p>
<p>感谢训练营的老师们！！！</p>
<hr>
<h2 id="4-参考文档："><a href="#4-参考文档：" class="headerlink" title="4.参考文档："></a>4.参考文档：</h2><ul>
<li><p><a href="https://zjp-cn.github.io/posts/rcore-gdb/" target="_blank" rel="noopener">【笔记】rCore (RISC-V)：GDB 使用记录 | 苦瓜小仔</a></p>
</li>
<li><p><a href="https://rcore-os.cn/rCore-Tutorial-deploy/docs/pre-lab/gdb.html" target="_blank" rel="noopener">rcore GDB 调试方法* · GitBook</a></p>
</li>
<li><p><a href="https://blog.csdn.net/shipeng1022/article/details/134397319" target="_blank" rel="noopener">主要参考:文档vscode + gdb +gdbserver 远程调试Pg源码_vscode gdbserver-CSDN博客</a></p>
</li>
<li><p><a href="https://blog.csdn.net/BlizCp/article/details/111054747" target="_blank" rel="noopener">VSCode配置luanch和task_配置 prelaunchtask 阻塞-CSDN博客</a></p>
</li>
<li><p><a href="https://rcore-os.cn/rCore-Tutorial-Book-v3/appendix-b/index.html" target="_blank" rel="noopener">附录 B：常见工具的使用方法 - rCore-Tutorial-Book-v3 3.6.0-alpha.1 文档</a></p>
</li>
<li><p><a href="https://blog.csdn.net/u014552102/article/details/122793256" target="_blank" rel="noopener">VsCode + gdb + gdbserver远程调试C++程序_vscode gdbserver-CSDN博客</a></p>
</li>
<li><p><a href="https://code.visualstudio.com/docs/editor/debugging" target="_blank" rel="noopener">Debugging in Visual Studio Code</a></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-%E9%83%91%E6%98%B1%E5%8F%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/05/17/2024%E6%98%A5%E5%A4%8F%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-%E9%83%91%E6%98%B1%E5%8F%AF/" class="post-title-link" itemprop="url">2024春夏季开源操作系统训练营第二阶段总结报告-郑昱可</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-17 08:27:17" itemprop="dateCreated datePublished" datetime="2024-05-17T08:27:17+00:00">2024-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-27 03:36:30" itemprop="dateModified" datetime="2025-05-27T03:36:30+00:00">2025-05-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/report/" itemprop="url" rel="index"><span itemprop="name">report</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="本阶段的收获"><a href="#本阶段的收获" class="headerlink" title="本阶段的收获"></a>本阶段的收获</h1><p>经过半月多的赶ddl（，加上老师群友们的无私帮助，我成功的完成了第二阶段的任务。</p>
<p>不仅对Rust的掌握程度更深了，并且对操作系统中很多概念有了实际上的理解。</p>
<p>包括且不限于：</p>
<ul>
<li>特权态的切换</li>
<li>地址表，页表的管理</li>
<li>进程和线程的区别</li>
<li>执行流切换和恢复</li>
<li>线程调度</li>
</ul>
<p>同时，这些知识很大程度上帮助我消除了对裸机编程的恐惧。对计算机底层的运行方式有了清楚的认知。</p>
<h2 id="一个尝试-Rust-in-ch32v003"><a href="#一个尝试-Rust-in-ch32v003" class="headerlink" title="一个尝试-Rust in ch32v003"></a>一个尝试-Rust in ch32v003</h2><p>在前几天结束第二阶段的作业后，我是打算了摸几天鱼，正好看到桌边吃灰的ch32v003单片机。</p>
<blockquote>
<p>ch32v003是一块携带了riscv指令集芯片的单片机，我手头上这块，实现了riscv标准中的mai,以及f。<br>美中不足的是，它只有S态和M态，并没有实现U态。</p>
</blockquote>
<p>于是我萌生出想法——为什么不试试将Rust代码运行在这上面呢。</p>
<h3 id="ch32-hal"><a href="#ch32-hal" class="headerlink" title="ch32-hal"></a>ch32-hal</h3><p>Rust在嵌入式方面的库，在2024年的今天已经较为完善了。在createio中查找一番后，我看到了ch32-hal，以及与其配套的qingke-rt</p>
<p>ch32-hal将ch32系列的单片机的外设进行了rust封装，使得在代码中能方便的进行调用和更改</p>
<p>如修改SYSTICK的ctlr位，只需要以下代码</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYSTICK.ctlr().modify(|w| w.set_ste(<span class="literal">false</span>));</span><br></pre></td></tr></table></figure>

<p>qingke-rt则包含了运行时相关的内容，可以在main函数前添加#[qingke_rt::entry]，使得该函数称为编译后程序的入口函数</p>
<p>并且qingke-rt也可以通过类似的方法定义中断处理函数。类似的工作，我们在rcore实验中是通过内联汇编手动修改相关寄存器实现的。</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>以下附上一个点灯代码</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[qingke_rt::entry]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() -&gt; ! &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> config = hal::Config::default();</span><br><span class="line">    config.rcc = hal::rcc::Config::SYSCLK_FREQ_48MHZ_HSE;</span><br><span class="line">    <span class="keyword">let</span> p = hal::init(config);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> delay = Delay;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> led = Output::new(p.PC2, Level::Low, <span class="built_in">Default</span>::default());</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        led.toggle();</span><br><span class="line"></span><br><span class="line">        delay.delay_ms(<span class="number">500</span>);</span><br><span class="line">        <span class="keyword">let</span> val = hal::pac::SYSTICK.cnt().read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="理论和实践"><a href="#理论和实践" class="headerlink" title="理论和实践"></a>理论和实践</h2><p>之前在学习体系结构的知识时，书本上只有几张图来描述代码执行流的切换，于我而言并不直观。甚至很长一段时间我是当做文科的内容来学的。</p>
<p>经过了本次实验后，令我印象最深的是__switch函数，通过寄存器内容的切换，便可切换到另一个执行流上。</p>
<p>而执行流，在某一时刻无非是:</p>
<ul>
<li>pc指针的位置</li>
<li>栈指针的位置</li>
<li>若干存储在当前寄存器中的变量</li>
</ul>
<p>而对执行流，进一步抽象成包含若干线程的进程。</p>
<p>对若干的进程进行管理，并为进程提供服务，就是操作系统。</p>
<h2 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h2><p>在此之前，我对ntfs之类的文件系统没有一点了解。在这次实验中，了解了一个简单文件系统的实现，并且通过easyfs实现了一些功能。</p>
<p>同时，简单了解到了对于硬件驱动的编写，以及将不同的硬件驱动，抽象成相同的软件内模型。在软件内进行多层抽象，每层抽象负责简单的几件事情。</p>
<p>这样能够方便错误判断，多层抽象的思想我最先从网络原理中了解。easyfs的实现方式，进一步的说明多层抽象在计算机软件编写中，可以称得上是最佳实践了。</p>
<h2 id="进程-amp-线程"><a href="#进程-amp-线程" class="headerlink" title="进程&amp;线程"></a>进程&amp;线程</h2><p>不去亲自阅读操作系统源码，是很难对进程和线程有明确的理解的。</p>
<p>甚至很长一段时间，我对进程和线程并没有区分。而在OS内部，进程可以拥有多个线程，线程之间共享内存空间。</p>
<p>对于这点的了解，不仅是系统编程领域，对我普通的软件编程也大有裨益。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/05/17/2024%E6%98%A5%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-%E9%99%88%E9%9F%B5%E6%B6%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/05/17/2024%E6%98%A5%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-%E9%99%88%E9%9F%B5%E6%B6%B5/" class="post-title-link" itemprop="url">2024春季开源操作系统训练营第二阶段总结-陈韵涵</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-17 00:00:00" itemprop="dateCreated datePublished" datetime="2024-05-17T00:00:00+00:00">2024-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-27 03:36:30" itemprop="dateModified" datetime="2025-05-27T03:36:30+00:00">2025-05-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/report/" itemprop="url" rel="index"><span itemprop="name">report</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="第1-2章"><a href="#第1-2章" class="headerlink" title="第1~2章"></a>第1~2章</h1><p>总的来说这两张花的时间是比较久的，因为完全没有学过操作系统，对概念上的理解用了一些时间，真的跟着代码学习的时候，不知道这些代码之间的联系，不知道用户程序和操作系统是怎么联系起来的。</p>
<p>因此总结了一个大概流程：</p>
<p>build.py编译user里面的用户应用程序：</p>
<p><img src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fba0aca6b-3b67-48e5-ac4d-8a0498157baa%2Fce4013a7-036b-4f96-ad8a-d1df978627bd%2FUntitled.png?table=block&id=6708e532-2ebf-47da-8e2a-43eae2e27118&spaceId=ba0aca6b-3b67-48e5-ac4d-8a0498157baa&width=2000&userId=4604a8da-3e33-4cbd-b5b3-bda19d665487&cache=v2" alt="img"></p>
<p>启动qemu和rustsbi，编译os</p>
<p><img src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fba0aca6b-3b67-48e5-ac4d-8a0498157baa%2F5a2d1e07-da11-4184-b467-bbd18be7ce30%2FUntitled.png?table=block&id=177a16ce-556f-4b45-9890-5b6edd590b4c&spaceId=ba0aca6b-3b67-48e5-ac4d-8a0498157baa&width=2000&userId=4604a8da-3e33-4cbd-b5b3-bda19d665487&cache=v2" alt="img"></p>
<p><a href="http://xn--build-s06jr40t.rs" target="_blank" rel="noopener">执行build.rs</a>，将bin文件插入到link_app.S，生成link_app.S</p>
<p>链接</p>
<p><a href="http://main.xn--rsbatch-eb1ux83c.rs" target="_blank" rel="noopener">main.rs运行batch.rs</a>，开始批处理</p>
<p>batch.rs首先初始化一个实例：APP_MANAGER: UPSafeCell<AppManager></AppManager></p>
<p>从link_app.S里面找到_num_app符号，找到每个app的地址存进app_start数组，然后将其打印出来</p>
<p>然后依次执行应用程序，其中应用程序出现错误或者开始下一个应用程序时，需要有用户态到内核态的切换。需要用到Trap.S</p>
<p><img src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fba0aca6b-3b67-48e5-ac4d-8a0498157baa%2Fda654f61-99ec-4b02-8e83-a51d7800dbc4%2FUntitled.png?table=block&id=fe934e8e-bbb7-4476-a852-dfa3851f794d&spaceId=ba0aca6b-3b67-48e5-ac4d-8a0498157baa&width=2000&userId=4604a8da-3e33-4cbd-b5b3-bda19d665487&cache=v2" alt="img"></p>
<p>开始批处理</p>
<p><img src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fba0aca6b-3b67-48e5-ac4d-8a0498157baa%2F9eeae072-eabb-4c7a-99ee-ba555b47cf16%2FUntitled.png?table=block&id=c93ad5b8-d780-4e61-b926-2d5981b09740&spaceId=ba0aca6b-3b67-48e5-ac4d-8a0498157baa&width=2000&userId=4604a8da-3e33-4cbd-b5b3-bda19d665487&cache=v2" alt="img"></p>
<p>保存Trap上下文，之后进入trap_handler，正常情况下会返回并继续执行下一个应用程序</p>
<p><img src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fba0aca6b-3b67-48e5-ac4d-8a0498157baa%2F5d217db3-2514-4954-bcef-a322819058d3%2FUntitled.png?table=block&id=a6081a8e-7120-4d1a-993d-ff8b8d9c0398&spaceId=ba0aca6b-3b67-48e5-ac4d-8a0498157baa&width=2000&userId=4604a8da-3e33-4cbd-b5b3-bda19d665487&cache=v2" alt="img"></p>
<p>这个函数不会返回，会一直将加载应用程序并把当前的应用程序的上下文压入内核栈，sret后就会自动执行下一个应用程序，直到完成</p>
<h1 id="第3章"><a href="#第3章" class="headerlink" title="第3章"></a>第3章</h1><p>主要是学习分时操作系统，概念上还是比较好理解的</p>
<h1 id="第4章"><a href="#第4章" class="headerlink" title="第4章"></a>第4章</h1><p>学习了地址空间，一开始对于这几个概念比较混淆：</p>
<ul>
<li>虚拟地址</li>
<li>虚拟页号</li>
<li>物理地址</li>
<li>物理页号</li>
<li>地址空间</li>
</ul>
<p>后来根据这个图搞懂了</p>
<p><img src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fba0aca6b-3b67-48e5-ac4d-8a0498157baa%2F44bcf144-9c5b-4ba6-9a4e-d579b27f874c%2FUntitled.png?table=block&id=34b9f1a5-ba7f-47db-aa7e-c3abfd31c7f0&spaceId=ba0aca6b-3b67-48e5-ac4d-8a0498157baa&width=2000&userId=4604a8da-3e33-4cbd-b5b3-bda19d665487&cache=v2" alt="img"></p>
<ul>
<li><p>虚拟地址指的是在地址空间里面，数据的地址</p>
</li>
<li><p>虚拟页号指的是虚拟地址字段里面的一个字段，这个字段可以在物理页表上查到一个物理页号，最终通过多级页表，查找到这个虚拟地址对应的物理地址，从而真正在主存读写数据</p>
</li>
<li><p>每个应用的地址空间可以被分成若干个（虚拟） 页面 (Page) ，而可用的物理内存也同样可以被分成若干个（物理） 页帧 (Frame) ，虚拟页面和物理页帧的大小相同</p>
</li>
<li><p>地址空间：一系列有关联的逻辑段：</p>
<p><strong>地址空间</strong>是一系列有关联的逻辑段，这种关联一般是指这些逻辑段属于一个运行的程序（目前把一个运行的程序称为任务，后续会称为进程）。 用来表明正在运行的应用所在执行环境中的可访问内存空间，在这个内存空间中，包含了<strong>一系列的不一定连续的逻辑段</strong>。 这样我们就有任务的地址空间、内核的地址空间等说法了</p>
<p>也就是说，地址空间的逻辑段不一定连续，这就对应了编程题，如果要写的内容太大导致分页，应该直接将内容也分页塞入到其物理地址里面去</p>
</li>
</ul>
<h1 id="第5章"><a href="#第5章" class="headerlink" title="第5章"></a>第5章</h1><p>需要记的就是进程是怎么调度的，switch函数的作用</p>
<p>就是最初，先创建一个idle进程，然后将switch的参数设置为idle进程和第一个程序，使得第一个程序可以执行</p>
<p>然后就调用 task 子模块提供的 suspend_current_and_run_next 函数可以暂停当前任务，并切换到下一个任务</p>
<p>这一章完成后，一个应用程序可以主动交出CPU的使用权，这样一来，它需要等待某个资源的时候，CPU就可以去执行其他程序了</p>
<h1 id="第6章"><a href="#第6章" class="headerlink" title="第6章"></a>第6章</h1><p>这一章的概念也看得我很晕</p>
<p>主要是：</p>
<ul>
<li>索引节点和文件有什么关系？</li>
<li>目录和索引节点又有什么关系？</li>
<li>一级索引存在哪里？二级索引指向哪里？</li>
<li>inode和DiskInode是如何映射起来的？</li>
</ul>
<p>因此画了这个示意图：</p>
<p><img src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fba0aca6b-3b67-48e5-ac4d-8a0498157baa%2Fac41c707-8033-4264-a2e7-dc7f81bb8cd9%2F7cbdd5ee-8c18-4cbf-9619-95fb3a5c34dd.png?table=block&id=4859c3ff-a516-4d00-a22a-7a4ce709b080&spaceId=ba0aca6b-3b67-48e5-ac4d-8a0498157baa&width=2000&userId=4604a8da-3e33-4cbd-b5b3-bda19d665487&cache=v2" alt="img"></p>
<p>对于lab，感觉比较难的是理解几个inode之间的关系，比如通过文件名如何查找其对应的inode_id？</p>
<h1 id="第7-8章"><a href="#第7-8章" class="headerlink" title="第7~8章"></a>第7~8章</h1><p>终于要结束了</p>
<p>第8章的概念比较好理解，对我来说比较难的是理解lab里面死锁检测算法的含义</p>
<p>一开始写的时候只考虑了能否解开一个锁，总感觉哪里不对。后来发现，其实要考虑能否解开所有的锁，因为解锁的顺序是要考虑的，如果只考虑能否解开一个锁，那么这个解锁顺序可能无法实现。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/33/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/33/">33</a><span class="page-number current">34</span><a class="page-number" href="/blog/page/35/">35</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/71/">71</a><a class="extend next" rel="next" href="/blog/page/35/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rcore-os Group</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>


  















  

  

  

</body>
</html>
