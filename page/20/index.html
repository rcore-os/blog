<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">
  
  <link rel="stylesheet" href="/blog/lib/animate-css/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rcore-os.github.io","root":"/blog/","scheme":"Muse","version":"8.0.0-rc.4","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="rcore-os Blog">
<meta property="og:url" content="http://rcore-os.github.io/blog/page/20/index.html">
<meta property="og:site_name" content="rcore-os Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="rcore-os Group">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://rcore-os.github.io/blog/page/20/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>rcore-os Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">rcore-os Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rcore-os Group</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">729</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">69</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">633</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content index posts-expand">
          
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/12/01/2024A-OS-III-Summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/12/01/2024A-OS-III-Summary/" class="post-title-link" itemprop="url">2024A-OS-II-Summary</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-01 12:34:26" itemprop="dateCreated datePublished" datetime="2024-12-01T12:34:26+00:00">2024-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-07 03:53:36" itemprop="dateModified" datetime="2025-07-07T03:53:36+00:00">2025-07-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="操作系统秋季训练营第三阶段学习总结博客"><a href="#操作系统秋季训练营第三阶段学习总结博客" class="headerlink" title="操作系统秋季训练营第三阶段学习总结博客"></a>操作系统秋季训练营第三阶段学习总结博客</h1><p>大家好，我是参加这次操作系统秋季训练营的一名学员。最近我们刚刚结束了第三阶段的学习，这个阶段主要围绕组件化内核设计与实践展开，包括了从Unikernel到宏内核的过渡，以及Hypervisor扩展等内容。<br>虽然由于时间关系我没能亲自动手完成所有的实验，但通过PPT和一些额外的挑战任务，我还是学到了不少东西。下面我就来分享一下这段时间的学习体会。</p>
<h2 id="一、课程概述"><a href="#一、课程概述" class="headerlink" title="一、课程概述"></a>一、课程概述</h2><h3 id="组件化内核的概念与意义"><a href="#组件化内核的概念与意义" class="headerlink" title="组件化内核的概念与意义"></a>组件化内核的概念与意义</h3><blockquote>
<p>“If you don’t need it, you don’t pay for it”</p>
</blockquote>
<p>组件化内核是这次训练营的核心思想，它强调的是将内核的功能分解成一系列独立的组件，这些组件可以灵活地组合起来形成不同规模和功能的内核。这种构建方式不仅提高了开发效率，还降低了维护难度，使得团队成员能够更有效地协作。<br>相比传统的内核设计，组件化方法允许开发者根据具体需求定制内核，从而更好地满足应用场景的需求。</p>
<h3 id="主流内核模式对比"><a href="#主流内核模式对比" class="headerlink" title="主流内核模式对比"></a>主流内核模式对比</h3><p>在训练营中，我们讨论了几种主流的内核模式，比如Unikernel和宏内核等。Unikernel是一种非常轻量级的内核形式，它将应用程序和内核紧密结合在一起，<br>共享同一地址空间，并且运行在同一个特权级别上。这使得Unikernel非常适合于需要高性能和低资源消耗的应用场景。而宏内核则提供了更加丰富的功能，支持多用户态进程，<br>每个进程都有自己的地址空间，这增强了系统的安全性和稳定性。但是，宏内核也因此变得更加复杂，对资源的需求也更高。</p>
<h2 id="二、学习内容回顾"><a href="#二、学习内容回顾" class="headerlink" title="二、学习内容回顾"></a>二、学习内容回顾</h2><h3 id="Unikernel模式"><a href="#Unikernel模式" class="headerlink" title="Unikernel模式"></a>Unikernel模式</h3><p>第一周我们从最基础的Unikernel模式开始，逐步了解了如何通过增加或替换组件来构建出一个简单的内核。<br>在Unikernel模式的学习过程中，我们深入探讨了如何从最基础的层面构建一个极简的操作系统环境，该环境仅包含应用程序运行所必需的核心组件。<br>与传统Unix内核相比，Unikernel以其高度定制化和轻量化的特点脱颖而出，通过将操作系统功能直接编译进应用代码中，实现了更小的内存占用、<br>更快的启动时间和更高的安全性。</p>
<h3 id="宏内核扩展"><a href="#宏内核扩展" class="headerlink" title="宏内核扩展"></a>宏内核扩展</h3><p>第二周的内容转向了宏内核的设计，这是从Unikernel到更加复杂的操作系统的桥梁。<br>在M.1 UserPrivilege实验中，我们探索了如何让应用程序在较低的用户特权级别下运行，同时保持内核的安全性。这一转变意味着我们需要管理更多的地址空间，<br>并处理由此带来的复杂性问题。通过这样的练习，我对Unix操作系统中的用户空间与内核空间分离有了更深的理解——这种方式虽然增加了系统设计的难度，<br>但却极大地提高了系统的灵活性和安全性。</p>
<h3 id="Hypervisor扩展"><a href="#Hypervisor扩展" class="headerlink" title="Hypervisor扩展"></a>Hypervisor扩展</h3><p>最后一周专注于Hypervisor技术，这也是当前云计算领域的一个热点话题。<br>通过对H.1 VirtualMode等实验的学习，我了解到Hypervisor是如何模拟出多个虚拟机环境，让它们各自拥有独立的操作系统和硬件资源。<br>与KVM相比，本课程中的Hypervisor实现以简化模型为tradeoff，通过直接绑定vCPU、忽略多任务并发以及省略复杂的设备模拟等方式，降低了实现复杂度，<br>但牺牲了一定的灵活性和性能效率。</p>
<h2 id="三、字节分配器设计挑战"><a href="#三、字节分配器设计挑战" class="headerlink" title="三、字节分配器设计挑战"></a>三、字节分配器设计挑战</h2><p>尽管大部分时间都在理论学习上度过，我还是尝试着完成了11.15发布的字节分配器设计挑战。虽然最终并没有完全按照题目要求找到一种理想的字节分配算法实现，<br>却意外发现了测试用例中存在的一个小漏洞。这对我来说也是一个不小的收获，至少证明了自己具备一定的调试能力和批判性思维Xb。<br>此外，这个过程也加深了我对内存管理机制的理解，尤其是对于像TLSF这样复杂的分配策略有了初步的认识。<br><img src="2024A-OS-III-Summary/img.png" alt="img.png"></p>
<h2 id="四、个人感悟"><a href="#四、个人感悟" class="headerlink" title="四、个人感悟"></a>四、个人感悟</h2><p>整个训练营期间，我深刻体会到组件化设计给操作系统开发带来的巨大便利。<br>它可以让我们专注于特定领域的功能实现，而不必担心与其他部分的耦合度太高。然而，这也要求开发者具备较强的整体规划能力，否则很容易导致系统结构混乱。<br>相比之下，传统Unix风格的操作系统就在某些方面可能显得不够灵活，唉唉，历史包袱。</p>
<p>总之，这次训练营给了我一次宝贵的机会去深入了解现代操作系统的设计理念和技术细节。<br>虽然还有很多知识需要进一步消化吸收，但我相信这段经历将对我未来的职业发展产生积极影响。<br>希望以后还能有机会参与更多类似的活动，继续充实自己的技术栈！</p>
<h2 id="五、最后"><a href="#五、最后" class="headerlink" title="五、最后"></a>五、最后</h2><p>十分感谢所有的讲师和同学的付出，让我有机会接触到如此优秀的技术，也给我带来了非常丰富的学习资源。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/12/01/%E5%A7%9C%E9%B9%8F%E7%BB%84%E4%BB%B6%E5%8C%96%E5%86%85%E6%A0%B8%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/12/01/%E5%A7%9C%E9%B9%8F%E7%BB%84%E4%BB%B6%E5%8C%96%E5%86%85%E6%A0%B8%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/" class="post-title-link" itemprop="url">姜鹏组件化内核实验报告</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-01 12:11:24" itemprop="dateCreated datePublished" datetime="2024-12-01T12:11:24+00:00">2024-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-07 03:53:36" itemprop="dateModified" datetime="2025-07-07T03:53:36+00:00">2025-07-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="week-1"><a href="#week-1" class="headerlink" title="week 1"></a>week 1</h1><h2 id="print-with-color"><a href="#print-with-color" class="headerlink" title="print_with_color"></a>print_with_color</h2><p>思路：直接修改 axstd 里面的 println!宏，在输出的内容之前加上ansi的控制字符串</p>
<figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">commit 29c8b52df3644c27ea1f2cb26191e7a45c2c40a4 (HEAD -&gt; exercise)</span><br><span class="line">Author: PandaJiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line">Date:   Wed Nov 13 22:15:34 2024 +0800</span><br><span class="line"></span><br><span class="line">    with color</span><br><span class="line">    </span><br><span class="line">    Signed-off-by: PandaJiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line"></span><br><span class="line">diff --git a/arceos/ulib/axstd/src/macros.rs b/arceos/ulib/axstd/src/macros.rs</span><br><span class="line">index c7cd653..760739b 100644</span><br><span class="line"><span class="comment">--- a/arceos/ulib/axstd/src/macros.rs</span></span><br><span class="line"><span class="comment">+++ b/arceos/ulib/axstd/src/macros.rs</span></span><br><span class="line">@@ -18,6 +18,6 @@ macro_rules! print &#123;</span><br><span class="line"> macro_rules! println &#123;</span><br><span class="line">     () =&gt; &#123; $crate::print!("\n") &#125;;</span><br><span class="line">     ($($arg:tt)*) =&gt; &#123;</span><br><span class="line"><span class="deletion">-        $crate::io::__print_impl(format_args!("&#123;&#125;\n", format_args!($($arg)*)));</span></span><br><span class="line"><span class="addition">+        $crate::io::__print_impl(format_args!("\x1b[31m&#123;&#125;\x1b[0m\n", format_args!($($arg)*)));</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="support-hashmap"><a href="#support-hashmap" class="headerlink" title="support hashmap"></a>support hashmap</h2><p>思路：axstd 中新增collections模块，将 alloc::collections 中的容器导入。此外，注意到std::collection::hashmap是在hashbrown作为base进行使用。尝试与std做一样的事情，发现可以直接将hashbrown模块引入作为hashmap使用，randomState就采用了默认的。</p>
<figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">commit c2cab71c6640a9c9f984144f2e12f701cf347f31</span><br><span class="line">Author: PandaJiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line">Date:   Wed Nov 13 22:21:01 2024 +0800</span><br><span class="line"></span><br><span class="line">    support hash</span><br><span class="line">    </span><br><span class="line">    Signed-off-by: PandaJiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line"></span><br><span class="line">diff --git a/arceos/ulib/axstd/Cargo.toml b/arceos/ulib/axstd/Cargo.toml</span><br><span class="line">index c2322c5..d3a3fe8 100644</span><br><span class="line"><span class="comment">--- a/arceos/ulib/axstd/Cargo.toml</span></span><br><span class="line"><span class="comment">+++ b/arceos/ulib/axstd/Cargo.toml</span></span><br><span class="line">@@ -80,3 +80,4 @@ arceos_api = &#123; workspace = true &#125;</span><br><span class="line"> axio = "0.1"</span><br><span class="line"> axerrno = "0.1"</span><br><span class="line"> kspin = "0.1"</span><br><span class="line"><span class="addition">+hashbrown = "0.15"</span></span><br><span class="line">\ No newline at end of file</span><br><span class="line">diff --git a/arceos/ulib/axstd/src/collections/mod.rs b/arceos/ulib/axstd/src/collections/mod.rs</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000..6978165</span><br><span class="line"><span class="comment">--- /dev/null</span></span><br><span class="line"><span class="comment">+++ b/arceos/ulib/axstd/src/collections/mod.rs</span></span><br><span class="line"><span class="meta">@@ -0,0 +1,6 @@</span></span><br><span class="line"><span class="addition">+// collections</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+extern  crate alloc;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+pub use alloc::collections::*;</span></span><br><span class="line"><span class="addition">+pub use  hashbrown::*;</span></span><br><span class="line">\ No newline at end of file</span><br><span class="line">diff --git a/arceos/ulib/axstd/src/lib.rs b/arceos/ulib/axstd/src/lib.rs</span><br><span class="line">index 5ab0517..49784bb 100644</span><br><span class="line"><span class="comment">--- a/arceos/ulib/axstd/src/lib.rs</span></span><br><span class="line"><span class="comment">+++ b/arceos/ulib/axstd/src/lib.rs</span></span><br><span class="line">@@ -55,7 +55,7 @@ extern crate alloc;</span><br><span class="line"> </span><br><span class="line"> #[cfg(feature = "alloc")]</span><br><span class="line"> #[doc(no_inline)]</span><br><span class="line"><span class="deletion">-pub use alloc::&#123;boxed, collections, format, string, vec&#125;;</span></span><br><span class="line"><span class="addition">+pub use alloc::&#123;boxed, format, string, vec&#125;;</span></span><br><span class="line"> </span><br><span class="line"> #[doc(no_inline)]</span><br><span class="line"> pub use core::&#123;arch, cell, cmp, hint, marker, mem, ops, ptr, slice, str&#125;;</span><br><span class="line">@@ -70,6 +70,7 @@ pub mod process;</span><br><span class="line"> pub mod sync;</span><br><span class="line"> pub mod thread;</span><br><span class="line"> pub mod time;</span><br><span class="line"><span class="addition">+pub mod collections;</span></span><br><span class="line"> </span><br><span class="line"> #[cfg(feature = "fs")]</span><br><span class="line"> pub mod fs;</span><br></pre></td></tr></table></figure>

<h2 id="bump-内存分配算法"><a href="#bump-内存分配算法" class="headerlink" title="bump 内存分配算法"></a>bump 内存分配算法</h2><ul>
<li><p>分配bytes</p>
<p>实现较为简单，用b_pos记录当前内存bytes分配到的地方。 唯一需要注意的是</p>
<ol>
<li>要根据aligment返回起始地址。并将分配计数+1</li>
<li>要检查 b_pos + size是否到达了 p_pos，是的话说明内存已经被耗尽。</li>
</ol>
</li>
<li><p>分配pages<br>实现也较为简单，用p_pos记录当前pages分配的地方。需要注意的是</p>
<ol>
<li>p_pos是递减的，返回的地址会越来越小</li>
<li>要检查p_pos - size是否到达了b_pos，是的话说明内存已经被耗尽。</li>
</ol>
</li>
<li><p>释放bytes</p>
<ul>
<li>引用计数减1，然后检查是否为0即可，为0的话就将b——pos重置。</li>
</ul>
</li>
</ul>
<h2 id="mv和rename操作"><a href="#mv和rename操作" class="headerlink" title="mv和rename操作"></a>mv和rename操作</h2><ul>
<li><p>mv</p>
<p>分解为 create + del 两个动作，在新的地址上写入原文件，然后删除原文件</p>
</li>
<li><p>rename</p>
<p>  文件系统有相关api，直接调用即可。</p>
</li>
</ul>
<figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">commit adabd01bad84c50a172a5a43af4d7cb77d75c4d7</span><br><span class="line">Author: Panda Jiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line">Date:   Mon Nov 18 08:00:23 2024 +0000</span><br><span class="line"></span><br><span class="line">    mv and rename</span><br><span class="line">    </span><br><span class="line">    Signed-off-by: Panda Jiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line"></span><br><span class="line">diff --git a/arceos/examples/shell/src/cmd.rs b/arceos/examples/shell/src/cmd.rs</span><br><span class="line">index 23f087f..f81723c 100644</span><br><span class="line"><span class="comment">--- a/arceos/examples/shell/src/cmd.rs</span></span><br><span class="line"><span class="comment">+++ b/arceos/examples/shell/src/cmd.rs</span></span><br><span class="line"><span class="meta">@@ -1,5 +1,6 @@</span></span><br><span class="line"> use std::fs::&#123;self, File, FileType&#125;;</span><br><span class="line"> use std::io::&#123;self, prelude::*&#125;;</span><br><span class="line"><span class="addition">+use std::string::ToString;</span></span><br><span class="line"> use std::&#123;string::String, vec::Vec&#125;;</span><br><span class="line"> </span><br><span class="line"> #[cfg(all(not(feature = "axstd"), unix))]</span><br><span class="line">@@ -27,6 +28,8 @@ const CMD_TABLE: &amp;[(&amp;str, CmdHandler)] = &amp;[</span><br><span class="line">     ("pwd", do_pwd),</span><br><span class="line">     ("rm", do_rm),</span><br><span class="line">     ("uname", do_uname),</span><br><span class="line"><span class="addition">+    ("rename", do_rename),</span></span><br><span class="line"><span class="addition">+    ("mv", do_mv),</span></span><br><span class="line"> ];</span><br><span class="line"> </span><br><span class="line"> fn file_type_to_char(ty: FileType) -&gt; char &#123;</span><br><span class="line">@@ -195,6 +198,84 @@ fn do_mkdir(args: &amp;str) &#123;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+fn do_rename(args: &amp;str) &#123;</span></span><br><span class="line"><span class="addition">+    let mut arg_v = args.split(" ");</span></span><br><span class="line"><span class="addition">+    let  old_name = arg_v.next();</span></span><br><span class="line"><span class="addition">+    let  new_name = arg_v.next();</span></span><br><span class="line"><span class="addition">+    if old_name.is_none() || new_name.is_none() || arg_v.next().is_some() &#123;</span></span><br><span class="line"><span class="addition">+        println!("rename: invalid args");</span></span><br><span class="line"><span class="addition">+        println!("usage: rename $old_name $new_name");</span></span><br><span class="line"><span class="addition">+        return;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    let old_name_s = old_name.unwrap();</span></span><br><span class="line"><span class="addition">+    let new_name_s = new_name.unwrap();</span></span><br><span class="line"><span class="addition">+    println!("try to rename &#123;old_name_s&#125; to &#123;new_name_s&#125;");</span></span><br><span class="line"><span class="addition">+    if let Err(e) =  fs::rename(old_name_s, new_name_s) &#123;</span></span><br><span class="line"><span class="addition">+        print_err!("rename", format_args!("cannot rename '&#123;old_name_s&#125;' to '&#123;new_name_s&#125;'"), e);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    return;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+fn do_mv(args: &amp;str) &#123;</span></span><br><span class="line"><span class="addition">+    let mut arg_v = args.split(" ");</span></span><br><span class="line"><span class="addition">+    let  old_file_path = arg_v.next();</span></span><br><span class="line"><span class="addition">+    let  new_file_path = arg_v.next();</span></span><br><span class="line"><span class="addition">+    if old_file_path.is_none() || new_file_path.is_none() || arg_v.next().is_some() &#123;</span></span><br><span class="line"><span class="addition">+        println!("mv: invalid args");</span></span><br><span class="line"><span class="addition">+        println!("usage: mv $old_file_path $new_path_path");</span></span><br><span class="line"><span class="addition">+        return;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    fn rm_one(path: &amp;str, rm_dir: bool) -&gt; io::Result&lt;()&gt; &#123;</span></span><br><span class="line"><span class="addition">+        if rm_dir &amp;&amp; fs::metadata(path)?.is_dir() &#123;</span></span><br><span class="line"><span class="addition">+            fs::remove_dir(path)</span></span><br><span class="line"><span class="addition">+        &#125; else &#123;</span></span><br><span class="line"><span class="addition">+            fs::remove_file(path)</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    fn write_file(fname: &amp;str, bufs: &amp;Vec&lt;Vec&lt;u8&gt;&gt;) -&gt; io::Result&lt;()&gt; &#123;</span></span><br><span class="line"><span class="addition">+        let mut file = File::create(fname)?;</span></span><br><span class="line"><span class="addition">+        for buf in bufs &#123;</span></span><br><span class="line"><span class="addition">+            file.write_all(&amp;buf[..])?;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+        Ok(())</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    fn read_file(fname: &amp;str, all_data: &amp;mut Vec&lt;Vec&lt;u8&gt;&gt;) -&gt; io::Result&lt;()&gt; &#123;</span></span><br><span class="line"><span class="addition">+        let mut file = File::open(fname)?;</span></span><br><span class="line"><span class="addition">+        loop &#123;</span></span><br><span class="line"><span class="addition">+            let mut buf=vec![0u8;1024];</span></span><br><span class="line"><span class="addition">+            let n = file.read(&amp;mut buf)?;</span></span><br><span class="line"><span class="addition">+            if n &gt; 0 &#123;</span></span><br><span class="line"><span class="addition">+                all_data.push(buf);</span></span><br><span class="line"><span class="addition">+            &#125; else &#123;</span></span><br><span class="line"><span class="addition">+                return Ok(());</span></span><br><span class="line"><span class="addition">+            &#125;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    let old_path = old_file_path.unwrap();</span></span><br><span class="line"><span class="addition">+    let last_separator_pos = old_path.rfind(|c| c == '/' || c == '\\');</span></span><br><span class="line"><span class="addition">+    // 提取文件名</span></span><br><span class="line"><span class="addition">+    let filename = match last_separator_pos &#123;</span></span><br><span class="line"><span class="addition">+        Some(pos) =&gt; &amp;old_path[pos + 1..],</span></span><br><span class="line"><span class="addition">+        None =&gt; old_path,</span></span><br><span class="line"><span class="addition">+    &#125;;</span></span><br><span class="line"><span class="addition">+    let mut new_path = new_file_path.unwrap().to_string();</span></span><br><span class="line"><span class="addition">+    new_path.push('/');</span></span><br><span class="line"><span class="addition">+    new_path.push_str(filename);</span></span><br><span class="line"><span class="addition">+    let mut data:Vec&lt;Vec&lt;u8&gt;&gt; = Vec::new();</span></span><br><span class="line"><span class="addition">+    if let Err(e) = read_file(old_path, &amp;mut data) &#123;</span></span><br><span class="line"><span class="addition">+        print_err!("mv", format_args!("cannot read '&#123;old_path&#125;'"), e);</span></span><br><span class="line"><span class="addition">+        return;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    if let Err(e) = write_file(&amp;new_path, &amp;data) &#123;</span></span><br><span class="line"><span class="addition">+        print_err!("mv", format_args!("cannot open '&#123;new_path&#125;'"), e);</span></span><br><span class="line"><span class="addition">+        return;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    if let Err(e) = rm_one(old_path, false) &#123;</span></span><br><span class="line"><span class="addition">+        print_err!("mv", format_args!("cannot rm '&#123;old_path&#125;'"), e);</span></span><br><span class="line"><span class="addition">+        return;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> fn do_rm(args: &amp;str) &#123;</span><br><span class="line">     if args.is_empty() &#123;</span><br><span class="line">         print_err!("rm", "missing operand");</span><br></pre></td></tr></table></figure>

<h1 id="week2"><a href="#week2" class="headerlink" title="week2"></a>week2</h1><h2 id="pagefault-缺页处理"><a href="#pagefault-缺页处理" class="headerlink" title="pagefault 缺页处理"></a>pagefault 缺页处理</h2><p>populate参数为false时，uspace模块只会为将该块虚拟内存地址记录下来，实际的访问会导致 pagefault， 在该handler中处理这一错误</p>
<figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">commit c0ed66e6fd0ad5af24f7ae6b2e683c43df03228a</span><br><span class="line">Author: PandaJiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line">Date:   Wed Nov 20 22:19:20 2024 +0800</span><br><span class="line"></span><br><span class="line">    add page fault func</span><br><span class="line">    </span><br><span class="line">    Signed-off-by: PandaJiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line"></span><br><span class="line">diff --git a/arceos/payload/fileops_c/fileops b/arceos/payload/fileops_c/fileops</span><br><span class="line">new file mode 100755</span><br><span class="line">index 0000000..a457c8c</span><br><span class="line">Binary files /dev/null and b/arceos/payload/fileops_c/fileops differ</span><br><span class="line">diff --git a/arceos/payload/hello_c/hello b/arceos/payload/hello_c/hello</span><br><span class="line">new file mode 100755</span><br><span class="line">index 0000000..a44f4c6</span><br><span class="line">Binary files /dev/null and b/arceos/payload/hello_c/hello differ</span><br><span class="line">diff --git a/arceos/payload/origin/Makefile b/arceos/payload/origin/Makefile</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000..15ba26d</span><br><span class="line"><span class="comment">--- /dev/null</span></span><br><span class="line"><span class="comment">+++ b/arceos/payload/origin/Makefile</span></span><br><span class="line"><span class="meta">@@ -0,0 +1,18 @@</span></span><br><span class="line"><span class="addition">+TARGET := origin</span></span><br><span class="line"><span class="addition">+TARGET_ELF := ../../target/riscv64gc-unknown-none-elf/release/$(TARGET)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+all: $(TARGET) FORCE</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+$(TARGET): $(TARGET_ELF)</span></span><br><span class="line"><span class="addition">+	@rust-objcopy --binary-architecture=riscv64 --strip-all -O binary $&lt; $@</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+$(TARGET_ELF): src/main.rs</span></span><br><span class="line"><span class="addition">+	@cargo build -p origin --target riscv64gc-unknown-none-elf --release</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+clean:</span></span><br><span class="line"><span class="addition">+	@rm -rf ./$(TARGET)</span></span><br><span class="line"><span class="addition">+	@cargo clean -p origin --target riscv64gc-unknown-none-elf --release</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+FORCE:</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+.PHONY: FORCE</span></span><br><span class="line">diff --git a/arceos/payload/origin/origin b/arceos/payload/origin/origin</span><br><span class="line">new file mode 100755</span><br><span class="line">index 0000000..da2037d</span><br><span class="line">Binary files /dev/null and b/arceos/payload/origin/origin differ</span><br><span class="line">diff --git a/arceos/tour/m_1_0/src/main.rs b/arceos/tour/m_1_0/src/main.rs</span><br><span class="line">index 89ef91d..f8c6077 100644</span><br><span class="line"><span class="comment">--- a/arceos/tour/m_1_0/src/main.rs</span></span><br><span class="line"><span class="comment">+++ b/arceos/tour/m_1_0/src/main.rs</span></span><br><span class="line">@@ -12,6 +12,8 @@ mod task;</span><br><span class="line"> mod syscall;</span><br><span class="line"> mod loader;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+use std::println;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> use axstd::io;</span><br><span class="line"> use axhal::paging::MappingFlags;</span><br><span class="line"> use axhal::arch::UspaceContext;</span><br><span class="line">@@ -19,12 +21,27 @@ use axhal::mem::VirtAddr;</span><br><span class="line"> use axsync::Mutex;</span><br><span class="line"> use alloc::sync::Arc;</span><br><span class="line"> use axmm::AddrSpace;</span><br><span class="line"><span class="addition">+use axtask::TaskExtRef;</span></span><br><span class="line"> use loader::load_user_app;</span><br><span class="line"><span class="addition">+use axhal::trap::&#123;register_trap_handler, PAGE_FAULT&#125;;</span></span><br><span class="line"> </span><br><span class="line"> const USER_STACK_SIZE: usize = 0x10000;</span><br><span class="line"> const KERNEL_STACK_SIZE: usize = 0x40000; // 256 KiB</span><br><span class="line"> const APP_ENTRY: usize = 0x1000;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+#[register_trap_handler(PAGE_FAULT)]</span></span><br><span class="line"><span class="addition">+fn page_fault(vaddr: VirtAddr, access_flags: MappingFlags, is_user: bool) -&gt; bool &#123;</span></span><br><span class="line"><span class="addition">+    if !is_user &#123;</span></span><br><span class="line"><span class="addition">+        panic!("page fault from kernel!!!");</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    println!("handler user page fault");</span></span><br><span class="line"><span class="addition">+    axtask::current()</span></span><br><span class="line"><span class="addition">+    .task_ext()</span></span><br><span class="line"><span class="addition">+    .aspace</span></span><br><span class="line"><span class="addition">+    .lock()</span></span><br><span class="line"><span class="addition">+    .handle_page_fault(vaddr, access_flags)</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> #[cfg_attr(feature = "axstd", no_mangle)]</span><br><span class="line"> fn main() &#123;</span><br><span class="line">     // A new address space for user app.</span><br><span class="line">@@ -36,7 +53,7 @@ fn main() &#123;</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">     // Init user stack.</span><br><span class="line"><span class="deletion">-    let ustack_top = init_user_stack(&amp;mut uspace, true).unwrap();</span></span><br><span class="line"><span class="addition">+    let ustack_top = init_user_stack(&amp;mut uspace, false).unwrap();</span></span><br><span class="line">     ax_println!("New user address space: &#123;:#x?&#125;", uspace);</span><br><span class="line"> </span><br><span class="line">     // Let's kick off the user process.</span><br></pre></td></tr></table></figure>

<h2 id="mmap-syscall"><a href="#mmap-syscall" class="headerlink" title="mmap syscall"></a>mmap syscall</h2><p>与page fault处理类似，有相应api可以调用</p>
<figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">commit daef0f232f4ae709afe1ef19974afa29b4594c95</span><br><span class="line">Author: Panda Jiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line">Date:   Thu Nov 21 09:22:08 2024 +0000</span><br><span class="line"></span><br><span class="line">    mmap</span><br><span class="line">    </span><br><span class="line">    Signed-off-by: Panda Jiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line"></span><br><span class="line">diff --git a/arceos/exercises/sys_map/src/syscall.rs b/arceos/exercises/sys_map/src/syscall.rs</span><br><span class="line">index 83b98d5..ac6624d 100644</span><br><span class="line"><span class="comment">--- a/arceos/exercises/sys_map/src/syscall.rs</span></span><br><span class="line"><span class="comment">+++ b/arceos/exercises/sys_map/src/syscall.rs</span></span><br><span class="line"><span class="meta">@@ -1,13 +1,16 @@</span></span><br><span class="line"> #![allow(dead_code)]</span><br><span class="line"> </span><br><span class="line"> use core::ffi::&#123;c_void, c_char, c_int&#125;;</span><br><span class="line"><span class="addition">+use core::usize;</span></span><br><span class="line"> use axhal::arch::TrapFrame;</span><br><span class="line"> use axhal::trap::&#123;register_trap_handler, SYSCALL&#125;;</span><br><span class="line"> use axerrno::LinuxError;</span><br><span class="line"><span class="addition">+use axmm::&#123;USER_ASPACE_BASE, USER_ASPACE_SIZE&#125;;</span></span><br><span class="line"> use axtask::current;</span><br><span class="line"> use axtask::TaskExtRef;</span><br><span class="line"> use axhal::paging::MappingFlags;</span><br><span class="line"><span class="deletion">-use arceos_posix_api as api;</span></span><br><span class="line"><span class="addition">+use arceos_posix_api::&#123;self as api, get_file_like&#125;;</span></span><br><span class="line"><span class="addition">+use memory_addr::&#123;MemoryAddr, VirtAddr, VirtAddrRange&#125;;</span></span><br><span class="line"> </span><br><span class="line"> const SYS_IOCTL: usize = 29;</span><br><span class="line"> const SYS_OPENAT: usize = 56;</span><br><span class="line">@@ -140,7 +143,53 @@ fn sys_mmap(</span><br><span class="line">     fd: i32,</span><br><span class="line">     _offset: isize,</span><br><span class="line"> ) -&gt; isize &#123;</span><br><span class="line"><span class="deletion">-    unimplemented!("no sys_mmap!");</span></span><br><span class="line"><span class="addition">+    let file = get_file_like(fd);</span></span><br><span class="line"><span class="addition">+    if file.is_err() &#123;</span></span><br><span class="line"><span class="addition">+        return 0;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    let file = file.unwrap();</span></span><br><span class="line"><span class="addition">+    let ss = file.stat();</span></span><br><span class="line"><span class="addition">+    if ss.is_err() &#123;</span></span><br><span class="line"><span class="addition">+        return  0;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    let size = ss.unwrap().st_size as usize;</span></span><br><span class="line"><span class="addition">+    if length &gt; size &#123;</span></span><br><span class="line"><span class="addition">+        debug!("incoming length is too long!!");</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    let prot_f = MmapProt::from_bits(prot);</span></span><br><span class="line"><span class="addition">+    if prot_f.is_none() &#123;</span></span><br><span class="line"><span class="addition">+        return  0;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    let mpflag:MappingFlags = prot_f.unwrap().into();</span></span><br><span class="line"><span class="addition">+    let mut buf = alloc::vec![0u8; size];</span></span><br><span class="line"><span class="addition">+    if let Err(_) = file.read(&amp;mut buf) &#123;</span></span><br><span class="line"><span class="addition">+        return  0;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    let c = current();</span></span><br><span class="line"><span class="addition">+    let mut uspace = c</span></span><br><span class="line"><span class="addition">+        .task_ext()</span></span><br><span class="line"><span class="addition">+        .aspace</span></span><br><span class="line"><span class="addition">+        .lock();</span></span><br><span class="line"><span class="addition">+    let mut vaddr = VirtAddr::from(addr as usize);</span></span><br><span class="line"><span class="addition">+    if let Some(va) = uspace.find_free_area(vaddr, length.align_up_4k(), VirtAddrRange::from_start_size(USER_ASPACE_BASE.into(), USER_ASPACE_SIZE.into())) &#123;</span></span><br><span class="line"><span class="addition">+        debug!("old vaddr &#123;:?&#125;", vaddr);</span></span><br><span class="line"><span class="addition">+        vaddr = va;</span></span><br><span class="line"><span class="addition">+        debug!("new vaddr &#123;:?&#125;", vaddr);</span></span><br><span class="line"><span class="addition">+    &#125; else &#123;</span></span><br><span class="line"><span class="addition">+        ax_println!("can't find free vaddr");</span></span><br><span class="line"><span class="addition">+        return 0;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    if let Err(e) =  uspace.map_alloc(vaddr, length.align_up_4k(), mpflag, true) &#123;</span></span><br><span class="line"><span class="addition">+        ax_println!("error while mmap, &#123;:?&#125;", e);</span></span><br><span class="line"><span class="addition">+        return 0;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    if let Ok(_) = uspace.write(vaddr, &amp;buf) &#123;</span></span><br><span class="line"><span class="addition">+        let ret:usize = vaddr.into();</span></span><br><span class="line"><span class="addition">+        ret as isize</span></span><br><span class="line"><span class="addition">+    &#125; else &#123;</span></span><br><span class="line"><span class="addition">+        0</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> fn sys_openat(dfd: c_int, fname: *const c_char, flags: c_int, mode: api::ctypes::mode_t) -&gt; isize &#123;</span><br><span class="line">diff --git a/arceos/modules/axhal/src/trap.rs b/arceos/modules/axhal/src/trap.rs</span><br><span class="line">index a38f7e5..5fa9499 100644</span><br><span class="line"><span class="comment">--- a/arceos/modules/axhal/src/trap.rs</span></span><br><span class="line"><span class="comment">+++ b/arceos/modules/axhal/src/trap.rs</span></span><br><span class="line">@@ -41,5 +41,6 @@ macro_rules! handle_trap &#123;</span><br><span class="line"> /// Call the external syscall handler.</span><br><span class="line"> #[cfg(feature = "uspace")]</span><br><span class="line"> pub(crate) fn handle_syscall(tf: &amp;TrapFrame, syscall_num: usize) -&gt; isize &#123;</span><br><span class="line"><span class="addition">+    debug!("handle syscall in axhal");</span></span><br><span class="line">     SYSCALL[0](tf, syscall_num)</span><br><span class="line"> &#125;</span><br><span class="line">diff --git a/arceos/modules/axmm/src/lib.rs b/arceos/modules/axmm/src/lib.rs</span><br><span class="line">index ed23c71..e0ace44 100644</span><br><span class="line"><span class="comment">--- a/arceos/modules/axmm/src/lib.rs</span></span><br><span class="line"><span class="comment">+++ b/arceos/modules/axmm/src/lib.rs</span></span><br><span class="line">@@ -19,8 +19,8 @@ use lazyinit::LazyInit;</span><br><span class="line"> use memory_addr::&#123;va, PhysAddr, VirtAddr&#125;;</span><br><span class="line"> use memory_set::MappingError;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-const USER_ASPACE_BASE: usize = 0x0000;</span></span><br><span class="line"><span class="deletion">-const USER_ASPACE_SIZE: usize = 0x40_0000_0000;</span></span><br><span class="line"><span class="addition">+pub const USER_ASPACE_BASE: usize = 0x0000;</span></span><br><span class="line"><span class="addition">+pub const USER_ASPACE_SIZE: usize = 0x40_0000_0000;</span></span><br><span class="line"> </span><br><span class="line"> static KERNEL_ASPACE: LazyInit&lt;SpinNoIrq&lt;AddrSpace&gt;&gt; = LazyInit::new();</span><br></pre></td></tr></table></figure>

<h1 id="week-3"><a href="#week-3" class="headerlink" title="week 3"></a>week 3</h1><h2 id="simple-hv"><a href="#simple-hv" class="headerlink" title="simple hv"></a>simple hv</h2><p>这个题是面对用例编程,分析下面的程序</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">"C"</span> <span class="function"><span class="keyword">fn</span> <span class="title">_start</span></span>() -&gt; ! &#123;</span><br><span class="line">    core::arch::asm!(</span><br><span class="line">        <span class="string">"csrr a1, mhartid"</span>,  <span class="comment">// 获取mhardid的值，按照最后</span></span><br><span class="line">        <span class="string">"ld a0, 64(zero)"</span>, <span class="comment">// 访问0x40处的值</span></span><br><span class="line">        <span class="string">"li a7, 8"</span>,</span><br><span class="line">        <span class="string">"ecall"</span>, <span class="comment">// shutdown</span></span><br><span class="line">        options(noreturn)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结合下面的代码，知道是需要我们将GUEST的a0设置为0x6688, a1设置为0x1234。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">vmexit_handler</span></span>(ctx: &amp;<span class="keyword">mut</span> VmCpuRegisters) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">...</span><br><span class="line">                        <span class="built_in">assert_eq!</span>(a0, <span class="number">0x6688</span>);</span><br><span class="line">                        <span class="built_in">assert_eq!</span>(a1, <span class="number">0x1234</span>);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终实现如下：</p>
<figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">commit 325d23818ae08961b4cf8e8d500b90f04dbd98d3</span><br><span class="line">Author: PandaJiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line">Date:   Tue Nov 26 23:31:54 2024 +0800</span><br><span class="line"></span><br><span class="line">    simple hv</span><br><span class="line">    </span><br><span class="line">    Signed-off-by: PandaJiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line"></span><br><span class="line">diff --git a/arceos/exercises/simple_hv/src/main.rs b/arceos/exercises/simple_hv/src/main.rs</span><br><span class="line">index 788ad8e..5809a64 100644</span><br><span class="line"><span class="comment">--- a/arceos/exercises/simple_hv/src/main.rs</span></span><br><span class="line"><span class="comment">+++ b/arceos/exercises/simple_hv/src/main.rs</span></span><br><span class="line"><span class="meta">@@ -3,29 +3,29 @@</span></span><br><span class="line"> #![feature(asm_const)]</span><br><span class="line"> #![feature(riscv_ext_intrinsics)]</span><br><span class="line"> </span><br><span class="line"><span class="addition">+extern crate alloc;</span></span><br><span class="line"> #[cfg(feature = "axstd")]</span><br><span class="line"> extern crate axstd as std;</span><br><span class="line"><span class="deletion">-extern crate alloc;</span></span><br><span class="line"> #[macro_use]</span><br><span class="line"> extern crate axlog;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-mod task;</span></span><br><span class="line"><span class="deletion">-mod vcpu;</span></span><br><span class="line"><span class="deletion">-mod regs;</span></span><br><span class="line"> mod csrs;</span><br><span class="line"><span class="deletion">-mod sbi;</span></span><br><span class="line"> mod loader;</span><br><span class="line"><span class="addition">+mod regs;</span></span><br><span class="line"><span class="addition">+mod sbi;</span></span><br><span class="line"><span class="addition">+mod task;</span></span><br><span class="line"><span class="addition">+mod vcpu;</span></span><br><span class="line"> </span><br><span class="line"><span class="deletion">-use vcpu::VmCpuRegisters;</span></span><br><span class="line"><span class="deletion">-use riscv::register::&#123;scause, sstatus, stval&#125;;</span></span><br><span class="line"><span class="addition">+use crate::regs::GprIndex::&#123;A0, A1&#125;;</span></span><br><span class="line"><span class="addition">+use axhal::mem::PhysAddr;</span></span><br><span class="line"> use csrs::defs::hstatus;</span><br><span class="line"><span class="deletion">-use tock_registers::LocalRegisterCopy;</span></span><br><span class="line"> use csrs::&#123;RiscvCsrTrait, CSR&#125;;</span><br><span class="line"><span class="deletion">-use vcpu::_run_guest;</span></span><br><span class="line"><span class="deletion">-use sbi::SbiMessage;</span></span><br><span class="line"> use loader::load_vm_image;</span><br><span class="line"><span class="deletion">-use axhal::mem::PhysAddr;</span></span><br><span class="line"><span class="deletion">-use crate::regs::GprIndex::&#123;A0, A1&#125;;</span></span><br><span class="line"><span class="addition">+use riscv::register::&#123;scause, sstatus, stval&#125;;</span></span><br><span class="line"><span class="addition">+use sbi::SbiMessage;</span></span><br><span class="line"><span class="addition">+use tock_registers::LocalRegisterCopy;</span></span><br><span class="line"><span class="addition">+use vcpu::VmCpuRegisters;</span></span><br><span class="line"><span class="addition">+use vcpu::_run_guest;</span></span><br><span class="line"> </span><br><span class="line"> const VM_ENTRY: usize = 0x8020_0000;</span><br><span class="line"> </span><br><span class="line">@@ -50,8 +50,7 @@ fn main() &#123;</span><br><span class="line">     prepare_vm_pgtable(ept_root);</span><br><span class="line"> </span><br><span class="line">     // Kick off vm and wait for it to exit.</span><br><span class="line"><span class="deletion">-    while !run_guest(&amp;mut ctx) &#123;</span></span><br><span class="line"><span class="deletion">-    &#125;</span></span><br><span class="line"><span class="addition">+    while !run_guest(&amp;mut ctx) &#123;&#125;</span></span><br><span class="line"> </span><br><span class="line">     panic!("Hypervisor ok!");</span><br><span class="line"> &#125;</span><br><span class="line">@@ -68,10 +67,11 @@ fn prepare_vm_pgtable(ept_root: PhysAddr) &#123;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> fn run_guest(ctx: &amp;mut VmCpuRegisters) -&gt; bool &#123;</span><br><span class="line"><span class="addition">+    // ax_println!("re-run guest");</span></span><br><span class="line">     unsafe &#123;</span><br><span class="line">         _run_guest(ctx);</span><br><span class="line">     &#125;</span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="addition">+    // ax_println!("vm_exit");</span></span><br><span class="line">     vmexit_handler(ctx)</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">@@ -94,25 +94,34 @@ fn vmexit_handler(ctx: &amp;mut VmCpuRegisters) -&gt; bool &#123;</span><br><span class="line">                         assert_eq!(a1, 0x1234);</span><br><span class="line">                         ax_println!("Shutdown vm normally!");</span><br><span class="line">                         return true;</span><br><span class="line"><span class="deletion">-                    &#125;,</span></span><br><span class="line"><span class="addition">+                    &#125;</span></span><br><span class="line">                     _ =&gt; todo!(),</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; else &#123;</span><br><span class="line">                 panic!("bad sbi message! ");</span><br><span class="line">             &#125;</span><br><span class="line"><span class="deletion">-        &#125;,</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line">         Trap::Exception(Exception::IllegalInstruction) =&gt; &#123;</span><br><span class="line"><span class="deletion">-            panic!("Bad instruction: &#123;:#x&#125; sepc: &#123;:#x&#125;",</span></span><br><span class="line"><span class="deletion">-                stval::read(),</span></span><br><span class="line"><span class="deletion">-                ctx.guest_regs.sepc</span></span><br><span class="line"><span class="deletion">-            );</span></span><br><span class="line"><span class="deletion">-        &#125;,</span></span><br><span class="line"><span class="addition">+            // ax_println!(</span></span><br><span class="line"><span class="addition">+            //     "Bad instruction: &#123;:#x&#125; sepc: &#123;:#x&#125;",</span></span><br><span class="line"><span class="addition">+            //     stval::read(),</span></span><br><span class="line"><span class="addition">+            //     ctx.guest_regs.sepc</span></span><br><span class="line"><span class="addition">+            // );</span></span><br><span class="line"><span class="addition">+            ctx.guest_regs.gprs.set_reg(A1, 0x1234);</span></span><br><span class="line"><span class="addition">+            ctx.guest_regs.sepc += 4;</span></span><br><span class="line"><span class="addition">+            // ax_println!("next instruction &#123;:#x&#125;", ctx.guest_regs.sepc);</span></span><br><span class="line"><span class="addition">+            return false;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line">         Trap::Exception(Exception::LoadGuestPageFault) =&gt; &#123;</span><br><span class="line"><span class="deletion">-            panic!("LoadGuestPageFault: stval&#123;:#x&#125; sepc: &#123;:#x&#125;",</span></span><br><span class="line"><span class="deletion">-                stval::read(),</span></span><br><span class="line"><span class="deletion">-                ctx.guest_regs.sepc</span></span><br><span class="line"><span class="deletion">-            );</span></span><br><span class="line"><span class="deletion">-        &#125;,</span></span><br><span class="line"><span class="addition">+            // panic!(</span></span><br><span class="line"><span class="addition">+            //     "LoadGuestPageFault: stval&#123;:#x&#125; sepc: &#123;:#x&#125;",</span></span><br><span class="line"><span class="addition">+            //     stval::read(),</span></span><br><span class="line"><span class="addition">+            //     ctx.guest_regs.sepc</span></span><br><span class="line"><span class="addition">+            // );</span></span><br><span class="line"><span class="addition">+            ctx.guest_regs.gprs.set_reg(A0, 0x6688);</span></span><br><span class="line"><span class="addition">+            ctx.guest_regs.sepc += 4;</span></span><br><span class="line"><span class="addition">+            return false;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line">         _ =&gt; &#123;</span><br><span class="line">             panic!(</span><br><span class="line">                 "Unhandled trap: &#123;:?&#125;, sepc: &#123;:#x&#125;, stval: &#123;:#x&#125;",</span><br><span class="line">@@ -127,9 +136,8 @@ fn vmexit_handler(ctx: &amp;mut VmCpuRegisters) -&gt; bool &#123;</span><br><span class="line"> </span><br><span class="line"> fn prepare_guest_context(ctx: &amp;mut VmCpuRegisters) &#123;</span><br><span class="line">     // Set hstatus</span><br><span class="line"><span class="deletion">-    let mut hstatus = LocalRegisterCopy::&lt;usize, hstatus::Register&gt;::new(</span></span><br><span class="line"><span class="deletion">-        riscv::register::hstatus::read().bits(),</span></span><br><span class="line"><span class="deletion">-    );</span></span><br><span class="line"><span class="addition">+    let mut hstatus =</span></span><br><span class="line"><span class="addition">+        LocalRegisterCopy::&lt;usize, hstatus::Register&gt;::new(riscv::register::hstatus::read().bits());</span></span><br><span class="line">     // Set Guest bit in order to return to guest mode.</span><br><span class="line">     hstatus.modify(hstatus::spv::Guest);</span><br><span class="line">     // Set SPVP bit in order to accessing VS-mode memory from HS-mode.</span><br></pre></td></tr></table></figure>

<h2 id="hv-pflash"><a href="#hv-pflash" class="headerlink" title="hv_pflash"></a>hv_pflash</h2><p>思路: 用upload img脚本将pflash传到 disk.img 中，然后在处理异常地址时读取该文件，将该文件的内容映射到 pflash 所在的地址即可。</p>
<figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">commit d3959ba050e8d4fcbd764415b0bac71be5a2013b</span><br><span class="line">Author: Panda Jiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line">Date:   Fri Nov 29 07:43:01 2024 +0000</span><br><span class="line"></span><br><span class="line">    read pflash.img ok</span><br><span class="line">    </span><br><span class="line">    Signed-off-by: Panda Jiang &lt;3160104094@zju.edu.cn&gt;</span><br><span class="line"></span><br><span class="line">diff --git a/arceos/tour/h_2_0/src/main.rs b/arceos/tour/h_2_0/src/main.rs</span><br><span class="line">index 0ae2f0e..d7b6d6a 100644</span><br><span class="line"><span class="comment">--- a/arceos/tour/h_2_0/src/main.rs</span></span><br><span class="line"><span class="comment">+++ b/arceos/tour/h_2_0/src/main.rs</span></span><br><span class="line">@@ -6,14 +6,14 @@ extern crate log;</span><br><span class="line"> #[macro_use]</span><br><span class="line"> extern crate alloc;</span><br><span class="line"> extern crate axstd as std;</span><br><span class="line"><span class="addition">+use alloc::string::String;</span></span><br><span class="line"> use alloc::string::ToString;</span><br><span class="line"><span class="deletion">-use riscv_vcpu::AxVCpuExitReason;</span></span><br><span class="line"> use axerrno::&#123;ax_err_type, AxResult&#125;;</span><br><span class="line"> use memory_addr::VirtAddr;</span><br><span class="line"><span class="deletion">-use alloc::string::String;</span></span><br><span class="line"><span class="deletion">-use std::fs::File;</span></span><br><span class="line"><span class="deletion">-use riscv_vcpu::RISCVVCpu;</span></span><br><span class="line"><span class="addition">+use riscv_vcpu::AxVCpuExitReason;</span></span><br><span class="line"> use riscv_vcpu::AxVCpuExitReason::NestedPageFault;</span><br><span class="line"><span class="addition">+use riscv_vcpu::RISCVVCpu;</span></span><br><span class="line"><span class="addition">+use std::fs::File;</span></span><br><span class="line"> </span><br><span class="line"> const VM_ASPACE_BASE: usize = 0x0;</span><br><span class="line"> const VM_ASPACE_SIZE: usize = 0x7fff_ffff_f000;</span><br><span class="line">@@ -21,8 +21,8 @@ const PHY_MEM_START: usize = 0x8000_0000;</span><br><span class="line"> const PHY_MEM_SIZE: usize = 0x100_0000;</span><br><span class="line"> const KERNEL_BASE: usize = 0x8020_0000;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-use axmm::AddrSpace;</span></span><br><span class="line"> use axhal::paging::MappingFlags;</span><br><span class="line"><span class="addition">+use axmm::AddrSpace;</span></span><br><span class="line"> </span><br><span class="line"> #[no_mangle]</span><br><span class="line"> fn main() &#123;</span><br><span class="line">@@ -36,40 +36,47 @@ fn main() &#123;</span><br><span class="line"> </span><br><span class="line">     // Physical memory region. Full access flags.</span><br><span class="line">     let mapping_flags = MappingFlags::from_bits(0xf).unwrap();</span><br><span class="line"><span class="deletion">-    aspace.map_alloc(PHY_MEM_START.into(), PHY_MEM_SIZE, mapping_flags, true).unwrap();</span></span><br><span class="line"><span class="addition">+    aspace</span></span><br><span class="line"><span class="addition">+        .map_alloc(PHY_MEM_START.into(), PHY_MEM_SIZE, mapping_flags, true)</span></span><br><span class="line"><span class="addition">+        .unwrap();</span></span><br><span class="line"> </span><br><span class="line">     // Load corresponding images for VM.</span><br><span class="line">     info!("VM created success, loading images...");</span><br><span class="line">     let image_fname = "/sbin/u_3_0_riscv64-qemu-virt.bin";</span><br><span class="line"><span class="deletion">-    load_vm_image(image_fname.to_string(), KERNEL_BASE.into(), &amp;aspace).expect("Failed to load VM images");</span></span><br><span class="line"><span class="addition">+    load_vm_image(image_fname.to_string(), KERNEL_BASE.into(), &amp;aspace)</span></span><br><span class="line"><span class="addition">+        .expect("Failed to load VM images");</span></span><br><span class="line"> </span><br><span class="line">     // Create VCpus.</span><br><span class="line">     let mut arch_vcpu = RISCVVCpu::init();</span><br><span class="line"> </span><br><span class="line">     // Setup VCpus.</span><br><span class="line"><span class="deletion">-    info!("bsp_entry: &#123;:#x&#125;; ept: &#123;:#x&#125;", KERNEL_BASE, aspace.page_table_root());</span></span><br><span class="line"><span class="addition">+    info!(</span></span><br><span class="line"><span class="addition">+        "bsp_entry: &#123;:#x&#125;; ept: &#123;:#x&#125;",</span></span><br><span class="line"><span class="addition">+        KERNEL_BASE,</span></span><br><span class="line"><span class="addition">+        aspace.page_table_root()</span></span><br><span class="line"><span class="addition">+    );</span></span><br><span class="line">     arch_vcpu.set_entry(KERNEL_BASE.into()).unwrap();</span><br><span class="line">     arch_vcpu.set_ept_root(aspace.page_table_root()).unwrap();</span><br><span class="line"> </span><br><span class="line">     loop &#123;</span><br><span class="line">         match vcpu_run(&amp;mut arch_vcpu) &#123;</span><br><span class="line">             Ok(exit_reason) =&gt; match exit_reason &#123;</span><br><span class="line"><span class="deletion">-                AxVCpuExitReason::Nothing =&gt; &#123;&#125;,</span></span><br><span class="line"><span class="deletion">-                NestedPageFault&#123;addr, access_flags&#125; =&gt; &#123;</span></span><br><span class="line"><span class="addition">+                AxVCpuExitReason::Nothing =&gt; &#123;&#125;</span></span><br><span class="line"><span class="addition">+                NestedPageFault &#123; addr, access_flags &#125; =&gt; &#123;</span></span><br><span class="line">                     debug!("addr &#123;:#x&#125; access &#123;:#x&#125;", addr, access_flags);</span><br><span class="line">                     assert_eq!(addr, 0x2200_0000.into(), "Now we ONLY handle pflash#2.");</span><br><span class="line"><span class="deletion">-                    let mapping_flags = MappingFlags::from_bits(0xf).unwrap();</span></span><br><span class="line"><span class="deletion">-                    // Passthrough-Mode</span></span><br><span class="line"><span class="deletion">-                    let _ = aspace.map_linear(addr, addr.as_usize().into(), 4096, mapping_flags);</span></span><br><span class="line"><span class="addition">+                    // let mapping_flags = MappingFlags::from_bits(0xf).unwrap();</span></span><br><span class="line"><span class="addition">+                    // // Passthrough-Mode</span></span><br><span class="line"><span class="addition">+                    // let _ = aspace.map_linear(addr, addr.as_usize().into(), 4096, mapping_flags);</span></span><br><span class="line"> </span><br><span class="line">                     /*</span><br><span class="line">                     // Emulator-Mode</span><br><span class="line">                     // Pretend to load file to fill buffer.</span><br><span class="line"><span class="deletion">-                    let buf = "pfld";</span></span><br><span class="line"><span class="addition">+                     */</span></span><br><span class="line"><span class="addition">+                    // let buf = "pfld";</span></span><br><span class="line">                     aspace.map_alloc(addr, 4096, mapping_flags, true);</span><br><span class="line"><span class="deletion">-                    aspace.write(addr, buf.as_bytes());</span></span><br><span class="line"><span class="deletion">-                    */</span></span><br><span class="line"><span class="deletion">-                &#125;,</span></span><br><span class="line"><span class="addition">+                    load_file("/sbin/pflash.img", addr, &amp;aspace).unwrap()</span></span><br><span class="line"><span class="addition">+                &#125;</span></span><br><span class="line">                 _ =&gt; &#123;</span><br><span class="line">                     panic!("Unhandled VM-Exit: &#123;:?&#125;", exit_reason);</span><br><span class="line">                 &#125;</span><br><span class="line">@@ -81,6 +88,24 @@ fn main() &#123;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+fn load_file(file_path: &amp;str, image_file_load_addr: VirtAddr, aspace: &amp;AddrSpace) -&gt; AxResult &#123;</span></span><br><span class="line"><span class="addition">+    use std::io::&#123;BufReader, Read&#125;;</span></span><br><span class="line"><span class="addition">+    let (ffile, size) = open_image_file(file_path)?;</span></span><br><span class="line"><span class="addition">+    let mut file = BufReader::new(ffile);</span></span><br><span class="line"><span class="addition">+    let load_region = aspace</span></span><br><span class="line"><span class="addition">+        .translated_byte_buffer(image_file_load_addr, 4096)</span></span><br><span class="line"><span class="addition">+        .expect("failed to translate kernel image load address");</span></span><br><span class="line"><span class="addition">+    for buffer in load_region &#123;</span></span><br><span class="line"><span class="addition">+        file.read_exact(buffer).map_err(|err| &#123;</span></span><br><span class="line"><span class="addition">+            ax_err_type!(</span></span><br><span class="line"><span class="addition">+                Io,</span></span><br><span class="line"><span class="addition">+                format!("Failed in reading from file &#123;&#125;, err &#123;:?&#125;", file_path, err)</span></span><br><span class="line"><span class="addition">+            )</span></span><br><span class="line"><span class="addition">+        &#125;)?</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    Ok(())</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> fn load_vm_image(image_path: String, image_load_gpa: VirtAddr, aspace: &amp;AddrSpace) -&gt; AxResult &#123;</span><br><span class="line">     use std::io::&#123;BufReader, Read&#125;;</span><br><span class="line">     let (image_file, image_size) = open_image_file(image_path.as_str())?;</span><br><span class="line">@@ -103,7 +128,7 @@ fn load_vm_image(image_path: String, image_load_gpa: VirtAddr, aspace: &amp;AddrSpac</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> fn vcpu_run(arch_vcpu: &amp;mut RISCVVCpu) -&gt; AxResult&lt;AxVCpuExitReason&gt; &#123;</span><br><span class="line"><span class="deletion">-    use axhal::arch::&#123;local_irq_save_and_disable, local_irq_restore&#125;;</span></span><br><span class="line"><span class="addition">+    use axhal::arch::&#123;local_irq_restore, local_irq_save_and_disable&#125;;</span></span><br><span class="line">     let flags = local_irq_save_and_disable();</span><br><span class="line">     let ret = arch_vcpu.run();</span><br><span class="line">     local_irq_restore(flags);</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/12/01/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-%E5%AD%99%E6%B5%B7%E5%8D%8E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/12/01/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-%E5%AD%99%E6%B5%B7%E5%8D%8E/" class="post-title-link" itemprop="url">2024秋冬季开源操作系统训练营第三阶段总结报告-孙海华</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-01 12:10:50" itemprop="dateCreated datePublished" datetime="2024-12-01T12:10:50+00:00">2024-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-07 03:53:36" itemprop="dateModified" datetime="2025-07-07T03:53:36+00:00">2025-07-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>很高兴能够进入第三阶段，本来想着好好跟进一下，但是很遗憾与考试科目以及组里的项目冲突里，仅仅完成了前三次课程的实验，后面大体了解了一下宏内核与Hypervisor</p>
</blockquote>
<h1 id="第一次课-HelloWorld"><a href="#第一次课-HelloWorld" class="headerlink" title="第一次课 HelloWorld"></a>第一次课 HelloWorld</h1><p><img src="/home/shh/coding/blog/source/_posts/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-%E5%AD%99%E6%B5%B7%E5%8D%8E/image-20241111222207439.png" alt="image-20241111222207439"></p>
<p>什么是组件化操作系统？ 上面是课件里很形象的一张图。在裸机程序中，Bootloader阶段后，需要初始化寄存器、栈指针等。之后初始化串口驱动，并在此基础上打印HelloWorld，这是一套连贯的操作流程。在层次化中，可以分为Hal层和runtime层，Hal层对于对应一些基本的初始化，runtime层对应的是驱动的初始化，为上层的应用提供运行时环境。如果迭代为组件化结构，那么优势就很明显了，在hal层可以抽象出不同架构的初始化，runtime层分为了不同组件，在构建不同的裸机应用时，可以有选择的使用相关的组件，有利于系统的裁剪和定制化。</p>
<p>一个简单的helloword程序使用的组件大致如图所示</p>
<p><img src="/home/shh/coding/blog/source/_posts/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-%E5%AD%99%E6%B5%B7%E5%8D%8E/image-20241111223112760.png" alt="image-20241111223112760"></p>
<h2 id="课后练习"><a href="#课后练习" class="headerlink" title="课后练习"></a>课后练习</h2><p>为了实现带颜色的输出，一个最简单的实现是在输出字符串前后加入相应的转义字符。</p>
<p>修改axstd组件中println的实现即可</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> println &#123;</span><br><span class="line">    () =&gt; &#123; $crate::<span class="built_in">print!</span>(<span class="string">"\n"</span>) &#125;;</span><br><span class="line">    ($($arg:tt)*) =&gt; &#123;</span><br><span class="line">        $crate::io::__print_impl(<span class="built_in">format_args!</span>(<span class="string">"\x1b[34m&#123;&#125;\x1b[0m\n"</span>, <span class="built_in">format_args!</span>($($arg)*)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/home/shh/coding/blog/source/_posts/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-%E5%AD%99%E6%B5%B7%E5%8D%8E/image-20241111223334733.png" alt="image-20241111223334733">、</p>
<p>或者修改axhal中putchar的实现，在打印每一个字符时都加入相应的转义字符</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">putchar</span></span>(c: <span class="built_in">u8</span>) &#123;</span><br><span class="line">    <span class="meta">#[allow(deprecated)]</span></span><br><span class="line">    sbi_rt::legacy::console_putchar(<span class="string">'\x1b'</span> <span class="keyword">as</span> <span class="built_in">usize</span>);</span><br><span class="line">    sbi_rt::legacy::console_putchar(<span class="string">'['</span> <span class="keyword">as</span> <span class="built_in">usize</span>);</span><br><span class="line">    sbi_rt::legacy::console_putchar(<span class="string">'3'</span> <span class="keyword">as</span> <span class="built_in">usize</span>);</span><br><span class="line">    sbi_rt::legacy::console_putchar(<span class="string">'4'</span> <span class="keyword">as</span> <span class="built_in">usize</span>);</span><br><span class="line">    sbi_rt::legacy::console_putchar(<span class="string">'m'</span> <span class="keyword">as</span> <span class="built_in">usize</span>);</span><br><span class="line">    sbi_rt::legacy::console_putchar(c <span class="keyword">as</span> <span class="built_in">usize</span>);</span><br><span class="line">    sbi_rt::legacy::console_putchar(<span class="string">'\x1b'</span> <span class="keyword">as</span> <span class="built_in">usize</span>);</span><br><span class="line">    sbi_rt::legacy::console_putchar(<span class="string">'['</span> <span class="keyword">as</span> <span class="built_in">usize</span>);</span><br><span class="line">    sbi_rt::legacy::console_putchar(<span class="string">'0'</span> <span class="keyword">as</span> <span class="built_in">usize</span>);</span><br><span class="line">    sbi_rt::legacy::console_putchar(<span class="string">'m'</span> <span class="keyword">as</span> <span class="built_in">usize</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/home/shh/coding/blog/source/_posts/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-%E5%AD%99%E6%B5%B7%E5%8D%8E/image-20241111224510977.png" alt="image-20241111224510977"></p>
<h1 id="第二次课-Collections"><a href="#第二次课-Collections" class="headerlink" title="第二次课 Collections"></a>第二次课 Collections</h1><p>引入了新的组件axalloc，以便于实现动态的内存分配。</p>
<h2 id="课后练习-1"><a href="#课后练习-1" class="headerlink" title="课后练习"></a>课后练习</h2><p>支持HashMap</p>
<p>使用hashbrown作为HashMap实现</p>
<p><img src="/home/shh/coding/blog/source/_posts/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-%E5%AD%99%E6%B5%B7%E5%8D%8E/image-20241115210910430.png" alt="image-20241115210910430"></p>
<h1 id="第三次课"><a href="#第三次课" class="headerlink" title="第三次课"></a>第三次课</h1><h2 id="课后练习-2"><a href="#课后练习-2" class="headerlink" title="课后练习"></a>课后练习</h2><p><img src="/home/shh/coding/blog/source/_posts/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-%E5%AD%99%E6%B5%B7%E5%8D%8E/image-20241115211654916.png" alt="image-20241115211654916"></p>
<p>实现一个简单的bump内存分配算法，比较简单，维护相应的trait即可。Page不考虑回收，回收Bytes的时候记录剩余的Bytes计数，在count为0的时候将byte_pos归零。</p>
<p><img src="/home/shh/coding/blog/source/_posts/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A-%E5%AD%99%E6%B5%B7%E5%8D%8E/image-20241115212923154.png" alt="image-20241115212923154"></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">EarlyAllocator</span></span>&lt;<span class="keyword">const</span> PAGE_SIZE: <span class="built_in">usize</span>&gt; &#123;</span><br><span class="line">    start: <span class="built_in">usize</span>,</span><br><span class="line">    b_pos: <span class="built_in">usize</span>,</span><br><span class="line">    p_pos: <span class="built_in">usize</span>,</span><br><span class="line">    end: <span class="built_in">usize</span>,</span><br><span class="line">    count: <span class="built_in">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="keyword">const</span> PAGE_SIZE: <span class="built_in">usize</span>&gt; EarlyAllocator&lt;PAGE_SIZE&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            start: <span class="number">0</span>,</span><br><span class="line">            b_pos: <span class="number">0</span>,</span><br><span class="line">            p_pos: <span class="number">0</span>,</span><br><span class="line">            end: <span class="number">0</span>,</span><br><span class="line">            count: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="keyword">const</span> PAGE_SIZE: <span class="built_in">usize</span>&gt; BaseAllocator <span class="keyword">for</span> EarlyAllocator&lt;PAGE_SIZE&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">init</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, start: <span class="built_in">usize</span>, size: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.start = start;</span><br><span class="line">        <span class="keyword">self</span>.end = start + size;</span><br><span class="line">        <span class="keyword">self</span>.b_pos = start;</span><br><span class="line">        <span class="keyword">self</span>.p_pos = <span class="keyword">self</span>.end;</span><br><span class="line">        <span class="keyword">self</span>.count = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">add_memory</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _start: <span class="built_in">usize</span>, _size: <span class="built_in">usize</span>) -&gt; AllocResult &#123;</span><br><span class="line">        <span class="literal">Err</span>(AllocError::NoMemory)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="keyword">const</span> PAGE_SIZE: <span class="built_in">usize</span>&gt; ByteAllocator <span class="keyword">for</span> EarlyAllocator&lt;PAGE_SIZE&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">alloc</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, layout: Layout) -&gt; AllocResult&lt;NonNull&lt;<span class="built_in">u8</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> size = layout.size();</span><br><span class="line">        <span class="keyword">let</span> align = layout.align();</span><br><span class="line">        <span class="keyword">let</span> align_mask = align - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">let</span> new_pos = (<span class="keyword">self</span>.b_pos + align_mask) &amp; !align_mask;</span><br><span class="line">        <span class="keyword">if</span> new_pos + size &gt; <span class="keyword">self</span>.p_pos &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(AllocError::NoMemory);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.b_pos = new_pos + size;</span><br><span class="line">        <span class="keyword">self</span>.count += <span class="number">1</span>;</span><br><span class="line">        <span class="literal">Ok</span>(NonNull::new(new_pos <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">u8</span>).unwrap())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">dealloc</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _ptr: NonNull&lt;<span class="built_in">u8</span>&gt;, _layout: Layout) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.count &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.count -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.count == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.b_pos = <span class="keyword">self</span>.start;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">total_bytes</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.end - <span class="keyword">self</span>.start</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">available_bytes</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.p_pos - <span class="keyword">self</span>.b_pos</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">used_bytes</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.b_pos - <span class="keyword">self</span>.start</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="keyword">const</span> PAGE_SIZE: <span class="built_in">usize</span>&gt; PageAllocator <span class="keyword">for</span> EarlyAllocator&lt;PAGE_SIZE&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> PAGE_SIZE: <span class="built_in">usize</span> = PAGE_SIZE;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">alloc_pages</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, num_pages: <span class="built_in">usize</span>, align_pow2: <span class="built_in">usize</span>) -&gt; AllocResult&lt;<span class="built_in">usize</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> align_pow2 % Self::PAGE_SIZE != <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(AllocError::InvalidParam);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> align_pow2 = align_pow2 / Self::PAGE_SIZE;</span><br><span class="line">        <span class="keyword">if</span> !align_pow2.is_power_of_two() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(AllocError::InvalidParam);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> p_pos = <span class="keyword">self</span>.p_pos - num_pages * Self::PAGE_SIZE;</span><br><span class="line">        <span class="keyword">if</span> p_pos &lt; <span class="keyword">self</span>.b_pos &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(AllocError::NoMemory);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.p_pos -= num_pages * Self::PAGE_SIZE;</span><br><span class="line">        <span class="literal">Ok</span>(<span class="keyword">self</span>.p_pos)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">dealloc_pages</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _pos: <span class="built_in">usize</span>, _num_pages: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="comment">// Do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">total_pages</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        (<span class="keyword">self</span>.end - <span class="keyword">self</span>.start) / Self::PAGE_SIZE</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">used_pages</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        (<span class="keyword">self</span>.end - <span class="keyword">self</span>.p_pos) / Self::PAGE_SIZE</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">available_pages</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.p_pos / Self::PAGE_SIZE</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="感悟"><a href="#感悟" class="headerlink" title="感悟"></a>感悟</h1><p>第三节阶段的代码相对于第二阶段清晰了不少，很后悔没有持续跟进下去，其实本人一直想学习的是基于协程异步机制的操作系统/驱动这一部分，不知道为什么没有相应的前置课程，希望第四阶段能够坚持下去，学习一下协程、异步机制以及操作系统的一些新实践。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/12/01/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93shj/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/12/01/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93shj/" class="post-title-link" itemprop="url">2024秋冬季开源操作系统训练营第三阶段总结-shj</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-01 11:11:11" itemprop="dateCreated datePublished" datetime="2024-12-01T11:11:11+00:00">2024-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-07 03:53:36" itemprop="dateModified" datetime="2025-07-07T03:53:36+00:00">2025-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">2024秋冬季开源操作系统训练营第三阶段总结</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Submit-Blog"><a href="#Submit-Blog" class="headerlink" title="Submit Blog"></a>Submit Blog</h2><p><code>rcore-blog</code> 这个 repo 已经挺大的了，网不好的 clone 下来还挺费时间的。</p>
<p>实际上可以直接在 Github 上写东西提 PR 不需要本地 clone 下来，Github 网站本身就提供了这样的功能。</p>
<p>打开 <a href="https://github.com/rcore-os/blog" target="_blank" rel="noopener"><code>rcore-blog</code></a> 项目主页，在绿色按钮 <code>Code</code> 左边有个 <code>Add file</code> 的按钮，可以直接用 <code>Create new file</code> 写所需要的 Blog 或者用 <code>Upload files</code> 直接上传写好的 md 文件。</p>
<p>需要注意的点是要切到 <code>rcore-blog/source/_posts</code> 这个目录下，不然文件的位置不对。</p>
<p>虽然直接在网站上写，文件里的内容还是要注意一下加上 Blog 需要的分类/标签/作者信息等，这些东西随便打开一个 md 文件复制一下就行。</p>
<p>缺点是数学公式支持和插入本地图片可能麻烦点。</p>
<p>注意一下 Commit changes 里上面是 Commit message, 下面只是辅助描述，一般只用改上面就行。</p>
<h2 id="print-with-color"><a href="#print-with-color" class="headerlink" title="print_with_color"></a>print_with_color</h2><p>引用了我很喜欢的一个库 <code>ansi_rgb</code>, 秒了。</p>
<h2 id="hashmap"><a href="#hashmap" class="headerlink" title="hashmap"></a>hashmap</h2><p>在 axstd 里开个 <code>mod collections</code>, 再引入 <code>hashbrown</code>, 秒了，</p>
<h2 id="alt-alloc"><a href="#alt-alloc" class="headerlink" title="alt_alloc"></a>alt_alloc</h2><p>测试里实际上没有用到 Page alloc 的接口，写完 Byte alloc 就通过了。</p>
<h2 id="rename-and-mv-in-shell"><a href="#rename-and-mv-in-shell" class="headerlink" title="rename and mv in shell"></a>rename and mv in shell</h2><p>有意思的来了，实际上 <code>fs::ax_rename</code> 没有很好的处理 ‘./‘ 和 ‘/‘ 这些前缀后缀。</p>
<p>我认为在 shell 的逻辑里处理文件访问文件名是一个错误的抽象，因此我写的时候决定不在 shell 代码里处理路径问题。</p>
<p>观察到 ls 命令可以处理前缀后缀，一路跳转后决定在 <code>modules/axfs/src/fs/fatfs.rs</code> 中 <code>DirWrapper::rename()</code> 中进行处理，刚好旁边就有 <code>remove</code> 方法可以参考。</p>
<h2 id="lab1"><a href="#lab1" class="headerlink" title="lab1"></a>lab1</h2><p>觉得没意思就没写，看群里大佬们玩挺花的，我自己想能不能玩点 hack, 最后确认到 main 地址是可以获取的，main 的 text 内存是可读可写的。</p>
<p>也就意味着可以整花活来跳转到自定义的 <code>main</code> 函数当中去，但是想到这样就要做 platform 的适配，感觉工作量并不小，就没整。</p>
<h2 id="set-populating-to-false"><a href="#set-populating-to-false" class="headerlink" title="set populating to false"></a>set populating to false</h2><p>从 <code>AddrSpace</code> 为入口开始找参考的辅助函数，发现直接就有 <code>handle_page_fault</code> 可以用，一调用就过了，看看 m2 的参考才知道 <code>user</code> flag 的作用。</p>
<h2 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h2><p>这个练习用到的 api 挺多，需要找找 <code>find_free_area</code>, <code>api::fs</code>, <code>LinuxError</code>, <code>AxError</code>.</p>
<p>因为 rust 没有 goto, 所以错误处理需要包一层 <code>fn() -&gt; Result</code>, 这样才能用 <code>?</code> 来减少代码量。</p>
<p><code>?</code> 只能在 <code>Result</code> 和 <code>Option</code> 上用就已经很强大了，如果 <a href="https://rust-lang.github.io/rfcs/3058-try-trait-v2.html" target="_blank" rel="noopener"><code>try_trait_v2</code></a> 稳定了都不用包一层 fn 了，不敢想象有多爽。</p>
<h1 id="simple-hypervisor"><a href="#simple-hypervisor" class="headerlink" title="simple hypervisor"></a>simple hypervisor</h1><p>这个练习不错，有一定难度。</p>
<p>首先处理 <code>csrr a1, mhartid</code> 这条指令。</p>
<p>尝试了下直接用 <code>asm!(&quot;csrr {rd}, mhartid&quot;, out(reg) rd)</code> 进行代理，不过如我所料的是 hypervisor 也没有 M 权限，所以不能这样弄。</p>
<p>但是可以注意到 <code>mhartid</code> 的语义是 cpu id, 所以可以直接用 <code>axhal::cpu::this_cpu_id()</code> 的值就行。</p>
<p>不过事实上根据语义应当返回的值是 vcpu id, 也就是 hypervisor 让 Guest 看到的 cpu_id, 但是我懒得添加相关的逻辑了。</p>
<p>把值写到上下文的 <code>a1</code> 寄存器之后需要把 <code>spec</code> 也加上指令长度。</p>
<p>然后处理缺页，注意到 <code>src/task.rs</code> 里有 <code>TaskExt</code> 的定义，并且压根没用上，可以知道大概需要用上。</p>
<p>但是我偷懒没去用，而是直接改了 <code>vmexit_handler</code> 和 <code>run_guest</code> 的接口，加一个 <code>uspace</code> 参数，这样就能在 <code>vmexit_handler</code> 里修改页表了。</p>
<p>对于一个内核来说，所有内存地址都是可以访问的，所以直接用 <code>uspace.map_alloc()</code> 就行了，权限可以全加上。</p>
<p>一个很有意思的点是 hypervisor 寻址用的是 <code>satp</code>, Guest 机器寻址用的是 <code>hgatp</code>. 所以写入用 <code>uspace.write</code> 来进行。</p>
<h2 id="Emulator-mode-device"><a href="#Emulator-mode-device" class="headerlink" title="Emulator mode device"></a>Emulator mode device</h2><p>直接把注释去掉就能通，所以改起来挺简单的。把 <code>populate</code> flag 置为 false 会导致 <code>Supervisor Page Fault</code> 错误。</p>
<p>刚好文件里就直接给出了一个 <code>load_vm_image</code> 辅助函数，直接拿来用把参数改改就完成了。<code>size</code> 可以通过 <code>fs::metadata</code> 来获取。</p>
<p>之前提到过 aspace 目前不支持 File 类型的 Backend, 不然就可以把 <code>populate</code> 置为 false 了，会快上不少。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/12/01/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-hbuxiaofei/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-hbuxiaofei/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/12/01/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-hbuxiaofei/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-hbuxiaofei/" class="post-title-link" itemprop="url">2024秋冬季开源操作系统训练营第三阶段总结-hbuxiaofei</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-01 11:02:18" itemprop="dateCreated datePublished" datetime="2024-12-01T11:02:18+00:00">2024-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-07 03:53:36" itemprop="dateModified" datetime="2025-07-07T03:53:36+00:00">2025-07-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="print-with-color-支持带颜色的打印输出。"><a href="#print-with-color-支持带颜色的打印输出。" class="headerlink" title="[print_with_color]: 支持带颜色的打印输出。"></a><code>[print_with_color]</code>: 支持带颜色的打印输出。</h2><ul>
<li>要求：</li>
</ul>
<blockquote>
<ol>
<li>修改一个组件的实现</li>
<li>执行<code>make run A=exercises/print_with_color</code></li>
</ol>
</blockquote>
<ul>
<li><p>预期：字符串输出带颜色。（具体颜色不做要求）</p>
</li>
<li><p>提示：在不同层次的组件上修改，影响的输出范围不同。例如，修改<code>axstd</code>可能只影响<code>println!</code>的输出；修改<code>axhal</code>则可能一并影响ArceOS启动信息的颜色。</p>
</li>
</ul>
<ul>
<li>本次修改主要集中在 <code>println!</code> 宏中，修改后的代码如下：<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">macro_rules!</span> println &#123;</span><br><span class="line">     () =&gt; &#123; $crate::<span class="built_in">print!</span>(<span class="string">"\n"</span>) &#125;;</span><br><span class="line">     ($($arg:tt)*) =&gt; &#123;</span><br><span class="line">-        $crate::io::__print_impl(<span class="built_in">format_args!</span>(<span class="string">"&#123;&#125;\n"</span>, <span class="built_in">format_args!</span>($($arg)*)));</span><br><span class="line">+        <span class="comment">// $crate::io::__print_impl(format_args!("&#123;&#125;\n", format_args!($($arg)*)));</span></span><br><span class="line">+        $crate::io::__print_impl(<span class="built_in">format_args!</span>(<span class="string">"\u&#123;1B&#125;[&#123;&#125;m&#123;&#125;\u&#123;1B&#125;[m\n"</span>, <span class="number">32</span>, <span class="built_in">format_args!</span>($($arg)*)));</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="support-hashmap-支持HashMap类型。"><a href="#support-hashmap-支持HashMap类型。" class="headerlink" title="[support_hashmap]: 支持HashMap类型。"></a><code>[support_hashmap]</code>: 支持HashMap类型。</h2><ul>
<li>预备：执行<code>make run A=exercises/support_hashmap</code></li>
</ul>
<ul>
<li><p>要求：</p>
<blockquote>
<ol>
<li>在axstd等组件中，支持<code>collections::HashMap</code></li>
<li>再次执行<code>make run A=exercises/support_hashmap</code></li>
</ol>
</blockquote>
</li>
<li><p>提示：</p>
<blockquote>
<ol>
<li>报错的std其实是axstd，测试用例main.rs中有”extern crate axstd as std;”</li>
<li>在axhal中给出了一个随机数产生函数random()，可以基于它为HashMap提高随机数支持。</li>
</ol>
</blockquote>
</li>
</ul>
<ul>
<li>实现思路</li>
</ul>
<p>HashMap 使用一个 <code>Vec&lt;Option&lt;(K, V)&gt;&gt;</code> 来存储键值对，每个桶（即 <code>Option&lt;(K, V)&gt;</code>）存储一个键值对，空桶为 None<br><code>custom_hash</code> 函数用于生成键的哈希值，这里采用简单的字节移位和异或方式，返回一个 u64 类型的哈希值<br><code>iter</code> 方法返回一个自定义的迭代器 <code>HashMapIterator</code>，该迭代器遍历哈希表中的所有已存储的键值对<br>通过线性探测法处理哈希冲突，即当发生冲突时，依次检查下一个桶直到找到空桶或找到匹配的键。</p>
<ul>
<li>测试结果<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">       d8888                            .d88888b.   .d8888b.</span><br><span class="line">      d88888                           d88P" "Y88b d88P  Y88b</span><br><span class="line">     d88P888                           888     888 Y88b.</span><br><span class="line">    d88P 888 888d888  .d8888b  .d88b.  888     888  "Y888b.</span><br><span class="line">   d88P  888 888P"   d88P"    d8P  Y8b 888     888     "Y88b.</span><br><span class="line">  d88P   888 888     888      88888888 888     888       "888</span><br><span class="line"> d8888888888 888     Y88b.    Y8b.     Y88b. .d88P Y88b  d88P</span><br><span class="line">d88P     888 888      "Y8888P  "Y8888   "Y88888P"   "Y8888P"</span><br><span class="line"></span><br><span class="line">arch = riscv64</span><br><span class="line">platform = riscv64-qemu-virt</span><br><span class="line">target = riscv64gc-unknown-none-elf</span><br><span class="line">smp = 1</span><br><span class="line">build_mode = release</span><br><span class="line">log_level = warn</span><br><span class="line"></span><br><span class="line">Running memory tests...</span><br><span class="line">test_hashmap() OK!</span><br><span class="line">Memory tests run OK!</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>其他实验由于忙于项目，暂时未做，后面有时间再补上其他的实验。</p>
<p>之前总结的一个starry的实现流程也记录这里，方便以后实验查阅：<br><a href="starry-boot.jpeg">Starry启动流程</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/12/01/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-%E5%BC%A0%E5%AE%87%E9%A9%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/12/01/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-%E5%BC%A0%E5%AE%87%E9%A9%B0/" class="post-title-link" itemprop="url">2024秋冬季训练营第三阶段总结-张宇驰</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-01 10:17:57" itemprop="dateCreated datePublished" datetime="2024-12-01T10:17:57+00:00">2024-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-07 03:53:36" itemprop="dateModified" datetime="2025-07-07T03:53:36+00:00">2025-07-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="组件化内核的意义与概念"><a href="#组件化内核的意义与概念" class="headerlink" title="组件化内核的意义与概念"></a>组件化内核的意义与概念</h1><p><strong>基于组件</strong>构造内核的方法，去构造<strong>不同场景</strong>的<strong>各种模式</strong>内核。组件之间单向依赖。</p>
<p>与传统设计思路的差异：</p>
<ol>
<li>面向场景和应用需求构建内核</li>
<li>以统一视角看待各种模式、不同规模的内核</li>
</ol>
<p>组件化内核相对传统构建方式的优势：</p>
<ol>
<li>提高内核开发效率</li>
<li>降低内核维护难度</li>
<li>开展基于组件的功能复用和开发协作</li>
</ol>
<p>内核模式：1)App和Kernel均处于S Mode.2)相互可见.3)编译形成一个Image.4)是App也是Kernel<br>可以通过组件增量的方式，实现扩展到宏内核与Hypervisor模式。</p>
<h1 id="Unikernel"><a href="#Unikernel" class="headerlink" title="Unikernel"></a>Unikernel</h1><h2 id="学习心得"><a href="#学习心得" class="headerlink" title="学习心得"></a>学习心得</h2><p>Unikernel令我最惊讶的就是模块化的OS构建方式并通过组件增量的方式组成不同内核模式的OS.</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><ol>
<li>应用与内核处于同一特权级（均为内核态），共享地址空间。Unikernel既是内核又是应用，二者合为一体</li>
<li>优点: 应用与内核之间没有隔离和切换，简单高效</li>
<li>缺点: 同样因为没有隔离和切换，所以安全性较低</li>
</ol>
<p>Unikernel框架与构成框架的核心组件是怎么来的？经历的阶段如下：</p>
<p>(1) 直接开发一个裸机应用来满足输出Hello的简单需求<br>(2) 需求增加，发现可按照通用性和Arch相关实现分层复用<br>(3) 引入组件化，降低耦合性、提升复用性定制性灵活性。</p>
<h2 id="应用的开发"><a href="#应用的开发" class="headerlink" title="应用的开发"></a>应用的开发</h2><p>面向应用：基于features选择必要组件的最小集合。</p>
<ol>
<li>学习了如何加载和执行外部应用程序</li>
<li>实现了内核与应用程序的通信机制</li>
<li>掌握了地址空间分离和切换的技术要点</li>
</ol>
<h2 id="课后练习"><a href="#课后练习" class="headerlink" title="课后练习"></a>课后练习</h2><h3 id="练习一"><a href="#练习一" class="headerlink" title="练习一"></a>练习一</h3><p>在打印宏的定义处，使用ANSI控制颜色即可，我使用的是：<code>\x1B[34m</code>和<code>\x1B[0m</code></p>
<h3 id="练习二"><a href="#练习二" class="headerlink" title="练习二"></a>练习二</h3><p>我做了两版，一版就是直接引入hashbrown，这是最简单的方法，不过对于alloc和hashbrown中的有一个方法存在的冲突，我没有做处理，默认是让alloc的方法覆盖了hashbrown的。另一个版本是CV了std的实现，然后一点一点的修理，但是我还是觉得第一个更优雅一点。</p>
<h3 id="练习三"><a href="#练习三" class="headerlink" title="练习三"></a>练习三</h3><p>我在EarlyAllocator中添加了start, end, b_pos, p_pos, count属性。然后将每一个Trait需要实现的函数实现出来。我发现PageAllocator中的部分函数并没有被使用，有些函数是直接打了unimplement()!的，但是一样能通过测试。</p>
<h3 id="练习四"><a href="#练习四" class="headerlink" title="练习四"></a>练习四</h3><p>参数的检查可以直接参考官方函数的实现。<br>rename直接调用API fs::rename就可以。mv通过判断第二个参数dst是否是一个目录，如果是的话，吧文件src读入buf,然后在对应的路径写，最后删除原来的文件。</p>
<h1 id="Monolithic"><a href="#Monolithic" class="headerlink" title="Monolithic"></a>Monolithic</h1><h2 id="学习心得-1"><a href="#学习心得-1" class="headerlink" title="学习心得"></a>学习心得</h2><p>宏内核在如今的市场上还是占有大量的比率，而Linux也为我们证明了，宏内核加上一些合理的缓解措施，并不意味着会比其他模式差。所以，学习宏内核是很多有意义的。</p>
<h2 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h2><p>基于组件化方法构建宏内核模式。</p>
<ol>
<li>Unikernel到宏内核：<br>以构建最小化的宏内核为目标，说明：<br>宏内核特点、与Unikernel的差异分析、框架和组件构成、具体实现示例。</li>
<li>地址空间管理和支持Linux应用：<br>1）用户地址空间映射、缺页加载机制；<br>2）支持运行最简单的Linux的原始应用</li>
</ol>
<p>Unikernel模式的应用和内核：<br>(1）处于同一特权级 - 内核特权级<br>(2) 共享同一地址空间 - 相互可见<br>(3) 编译形成一个Image，一体运行<br>(4) Unikernel既是应用又是内核，二者合体</p>
<h2 id="课后练习-1"><a href="#课后练习-1" class="headerlink" title="课后练习"></a>课后练习</h2><h3 id="练习五"><a href="#练习五" class="headerlink" title="练习五"></a>练习五</h3><p>使用register_trap_handler来标记对PAGE_FAULT的处理，然后实现处理函数：<code>handle_page_fualt()</code><br>处理的实现是通过axtask的接口去实现的，得到task的ext，将aspace上锁后，调用handle_page_fualt同名函数，最后直接打印了对应的输出，然后返回一个正确处理。如果同名函数没有正确执行，那么就直接返回false.</p>
<h3 id="练习六"><a href="#练习六" class="headerlink" title="练习六"></a>练习六</h3><p>从当前的aspace中调用find_free_area，得到length的addr_src，然后进行4K对齐，同时，对length进行对齐得到size。</p>
<p>prot和flags通过调用MmapProt::from_bits_truncate(prot), MmapFlags::from_bits_truncate(flags)得到，需要的mappingFlags就from(prot)即可。</p>
<p>调用aspace的map_alloc方法。</p>
<p>之后处理一下MmapFlags::MAP_ANONYMOUS。如果有这个flags，直接返回就好</p>
<p>如果没有MmapFlags::MAP_ANONYMOUS。则通过get_file_like得到我们所需的文件，并将其读取进入buf，然后写入aspace。</p>
<h1 id="Hypervisor"><a href="#Hypervisor" class="headerlink" title="Hypervisor"></a>Hypervisor</h1><h2 id="学习心得-2"><a href="#学习心得-2" class="headerlink" title="学习心得"></a>学习心得</h2><p>HyperVisor，即所谓的虚拟机管理程序，从代码实现来看，和宏内核思想差不多，都是一个高特权级的“内核”为低特权级的“应用”创建独属于它的“虚拟空间”，为它准备对应的资源，然后切换特权级去执行该“应用”。当“应用”发生“中断”的时候，就trap回“内核”处理。GuestOS，就像是一个特殊的应用。</p>
<h2 id="特点-2"><a href="#特点-2" class="headerlink" title="特点"></a>特点</h2><p>HyperVisor，即所谓的虚拟机管理程序，从代码实现来看，和宏内核思想差不多，都是一个高特权级的“内核”为低特权级的“应用”创建独属于它的“虚拟空间”，为它准备对应的资源，然后切换特权级去执行该“应用”。当“应用”发生“中断”的时候，就trap回“内核”处理。GuestOS，就像是一个特殊的应用。</p>
<p>基于一台物理计算机建立一些OS的就是虚拟机，我们这里用的是I形虚拟机，也就是不存在宿主机，直接在硬件平台运行的。<br>虚拟机的特点包括：同质、高校、资源受控。为了实现虚拟化，支持了以下层次的对象VM、vCPU、vMem、vDevice、vUtilities。</p>
<h2 id="课后题"><a href="#课后题" class="headerlink" title="课后题"></a>课后题</h2><h3 id="练习七"><a href="#练习七" class="headerlink" title="练习七"></a>练习七</h3><p>这里处理Trap的时候，需要更改掉panic，然后在这道题中，要求A0、A1为0x1234和0x6688，只需要在处理这些Trap的时候，将对应的寄存器进行修改就可以</p>
<hr>
<p>笔记：<a href="https://github.com/inchinaxiaofeng/Blog-arceos" target="_blank" rel="noopener">https://github.com/inchinaxiaofeng/Blog-arceos</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/12/01/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-sts/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/12/01/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-sts/" class="post-title-link" itemprop="url">2024秋冬季开源操作系统训练营第三阶段总结报告-sts</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-01 00:00:00" itemprop="dateCreated datePublished" datetime="2024-12-01T00:00:00+00:00">2024-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-07 03:53:36" itemprop="dateModified" datetime="2025-07-07T03:53:36+00:00">2025-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/oscamp-2024fall-arceos-unikernel/" itemprop="url" rel="index"><span itemprop="name">oscamp 2024fall arceos unikernel</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>进入第三阶段当然很高兴，但时间上实在太紧，我一开始的心态是按看懂源代码中的每一步来走的，但目前只是看完了所有相关的 makefile，以及看了部分 PPT 中强调部分的源代码。实验的话也是完成了第一周的内容以及 Hypervisor 的实验一。</p>
</blockquote>
<h2 id="arceos流程小结"><a href="#arceos流程小结" class="headerlink" title="arceos流程小结"></a>arceos流程小结</h2><p>总体执行流程：axhal的boot.rs中先引导，用于初始化内核栈，设置初始的页表，这里映射了两个 1G 的大页，分别是低地址恒等映射以及高地址的一个映射。随后要调用 axruntime 的 rust_main 来进一步完善运行时，这里会涉及到 axfeat 里面用到的 feature 条件编译并初始化一些东西，比如启用了 paging 这个 feature 就会重新映射页表这样。调用 rust_main 的时候加了一个偏移，偏移的大小其实就是高地址映射的偏移这样。随后 axruntime 做好运行时之后，调用 main 函数。随后调用结束函数，结束整个流程。</p>
<h2 id="课后练习1：支持带颜色的打印输出。"><a href="#课后练习1：支持带颜色的打印输出。" class="headerlink" title="课后练习1：支持带颜色的打印输出。"></a>课后练习1：支持带颜色的打印输出。</h2><p>具体实现：修改axhal中putchar的实现，在打印每一个字符时都加入相应的转义字符。</p>
<p>关于转义字符的具体解析的话：颜色定义的部分可以参考 <a href="https://www.man7.org/linux/man-pages/man4/console_codes.4.html" target="_blank" rel="noopener">console_codes(4) — Linux manual page</a> 的 <code>ECMA-48 Select Graphic Rendition</code> 部分。在 makefile 中的 <code>run_cmd</code> 函数用于辅助输出同时会以颜色输出命令，参数 1 控制颜色为白色，参数 2 控制为灰色，随后执行命令。</p>
<p>颜色控制部分关键如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">param      result</span><br><span class="line">0          reset all attributes to their defaults</span><br><span class="line">1          set bold</span><br><span class="line">2          set half-bright (simulated with color on a color display)</span><br><span class="line">3          set italic (since Linux 2.6.22; simulated with color on a color display)</span><br><span class="line">4          set underscore (simulated with color on a color display) (the colors</span><br><span class="line">			used to simulate dim or underline are set using ESC ] ...)</span><br><span class="line">5          set blink</span><br><span class="line">7          set reverse video</span><br><span class="line">10         reset selected mapping, display control flag, and toggle meta flag</span><br><span class="line">			(ECMA-48 says &quot;primary font&quot;).</span><br><span class="line">11         select null mapping, set display control flag, reset toggle meta flag</span><br><span class="line">			(ECMA-48 says &quot;first alternate font&quot;).</span><br><span class="line">12         select null mapping, set display control flag, set toggle meta flag</span><br><span class="line">			(ECMA-48 says &quot;second alternate font&quot;).  The toggle meta flag causes the</span><br><span class="line">			high bit of a byte to be toggled before the mapping table translation is</span><br><span class="line">			done.</span><br><span class="line">21         set underline; before Linux 4.17, this value set normal intensity (as is</span><br><span class="line">			done in many other terminals)</span><br><span class="line">22         set normal intensity</span><br><span class="line">23         italic off (since Linux 2.6.22)</span><br><span class="line">24         underline off</span><br><span class="line">25         blink off</span><br><span class="line">27         reverse video off</span><br><span class="line">30         set black foreground</span><br><span class="line">31         set red foreground</span><br><span class="line">32         set green foreground</span><br><span class="line">33         set brown foreground</span><br><span class="line">34         set blue foreground</span><br><span class="line">35         set magenta foreground</span><br><span class="line">36         set cyan foreground</span><br><span class="line">37         set white foreground</span><br><span class="line">38         256&#x2F;24-bit foreground color follows, shoehorned into 16 basic colors</span><br><span class="line">			(before Linux 3.16: set underscore on, set default foreground color)</span><br><span class="line">39         set default foreground color (before Linux 3.16: set underscore off, set</span><br><span class="line">			default foreground color)</span><br><span class="line">40         set black background</span><br><span class="line">41         set red background</span><br><span class="line">42         set green background</span><br><span class="line">43         set brown background</span><br><span class="line">44         set blue background</span><br><span class="line">45         set magenta background</span><br><span class="line">46         set cyan background</span><br><span class="line">47         set white background</span><br><span class="line">48         256&#x2F;24-bit background color follows, shoehorned into 8 basic colors</span><br><span class="line">49         set default background color</span><br><span class="line">90..97     set foreground to bright versions of 30..37</span><br><span class="line">100..107   set background, same as 40..47 (bright not supported)</span><br><span class="line"></span><br><span class="line">Commands 38 and 48 require further arguments:</span><br><span class="line">;5;x       256 color: values 0..15 are IBGR (black,  red,  green,</span><br><span class="line">			...  white),  16..231  a  6x6x6 color cube, 232..255 a</span><br><span class="line">			grayscale ramp</span><br><span class="line">;2;r;g;b   24-bit color, r&#x2F;g&#x2F;b components are in the range 0..255</span><br></pre></td></tr></table></figure>

<p> <code>ECMA-48  SGR</code> 序列以 <code>ESC[ parameters m</code> 的格式控制显示的属性。parameters 用分号隔开，<code>\033[92;1m</code> 为例，033 为八进制，表示 ESC，92 和 1分别是 param，参考上文的 <code>ECMA-48 Select Graphic Rendition</code> 92 表示绿色明亮前景色。1 表示加粗，0 表示重置属性。</p>
<h2 id="课后练习2：支持-HashMap"><a href="#课后练习2：支持-HashMap" class="headerlink" title="课后练习2：支持 HashMap"></a>课后练习2：支持 HashMap</h2><p>ax_api 作为下层 module 的抽象，随后 axstd 作为我们自己定义的标准库供用户程序调用。</p>
<p>我的想法其实也是直接看 std 的 HashMap 怎么实现，然后改一改，做到最小的满足测试案例中的那些操作。然后慢慢改一改，后面看到官方也用了 hashbrown 作为实现，然后我就改了改，把随机数用到 hashbrown 这边大概。然后就好了。</p>
<h2 id="课后练习3：实现-alt-alloc"><a href="#课后练习3：实现-alt-alloc" class="headerlink" title="课后练习3：实现 alt_alloc"></a>课后练习3：实现 alt_alloc</h2><p>这个分配器应当是用作早期boot之后系统初始化阶段的内存分配器，所以实现上相对简单，每次分配都向后增长。dealloc的时候尝试减掉已经alloc的空间大小，如果为0，那就重新开始从头分配这样。</p>
<h2 id="挑战题目：实现特定分配算法"><a href="#挑战题目：实现特定分配算法" class="headerlink" title="挑战题目：实现特定分配算法"></a>挑战题目：实现特定分配算法</h2><p>这个算法的话，还是要感谢万能的群友，我一开始想的也是在TLSF基础上改一改这样。后面发现有取巧的地方，主要也是循环一直进行，奇数项的内容永不释放，所以就取巧了，会记录每次奇数次申请的空间，下次申请如果比上次的小，那就返回该地址。如果比上次大，那就重新申请，释放上次的内容这样。</p>
<p>达到的轮次是65536应该是，也是一个非常 unsigned int 的值。</p>
<p>思路详细描述：由于每次申请的空间大小会加1，相比上一次。例如，delta 为1，申请的空间依次是32 + 1， 32 * 2 + 1， 。delta 为 2，申请的空间依次是32 +2， 32*2 +2，。所以，第一次循环会反复替换掉分配器中的记录。</p>
<p>但是，从第二次开始，每次当 index 为 13 的时候，会替换上一次的内容。因为上一次的 13 比这次的 13 申请的空间小 1。但是呢，14 不是最后一次循环吗，因为 14 是偶数所以不管。奇数就很神奇，每次都是到 index 为 13 的时候重新申请一次空间。其余时候，其实大家返回的地址都是一样的。嘿嘿。而且，每次替换的时候都会把上次的给释放了，哎，就很神奇。</p>
<p>首先主体部分使用特定内存分配器 tlsf。包括申请，释放等操作。</p>
<p>其次，定制 alloc 函数。用 indicator 记录此时调用 alloc_pass 函数的 delta值。用 index 记录 alloc_pass 函数中的循环次数。</p>
<p>alloc 的时候需要谨慎计算，2的多少次方啊，当index = 14 的时候，重置为 0，然后indiactor需要加 1 啊，之类的。</p>
<p>这里要注意一点，源码里，分配器有个special变量，为bool类型。这里用它的主要原因在于有个很神奇的点：当indiactor为32， index = 1的时候，items需要申请 0x60 的空间，而恰好，下次申请向量空间也是 0x60 的大小。就，重复了。嗯。所以，作为单独判断条件，然后重置，第一次出现先不管，然后继续。然后，bug解决。</p>
<h2 id="Hypervisor课后练习1"><a href="#Hypervisor课后练习1" class="headerlink" title="Hypervisor课后练习1"></a>Hypervisor课后练习1</h2><p>hypervisior流程分析：这里初始化阶段我们的hyper会布置好一个现场类似我们在宏内核中设置好sstatus寄存器那样，随后通过sret到GUEST中执行，GUEST中遇到无法处理的情况又会陷入Hypervisior中，通过对不同类型的陷入执行不同的代码，处理好用户的错误设置寄存器等操作，随后返回GUEST继续执行。</p>
<p>这里的第一个实验比较简单：只需要在处理错误函数中设置寄存器的值，然后设置sepc += 4，让GUEST去执行出错指令的下一条指令即可。</p>
<h2 id="Hypervisior课后练习2"><a href="#Hypervisior课后练习2" class="headerlink" title="Hypervisior课后练习2"></a>Hypervisior课后练习2</h2><p>这里会涉及到虚拟化里的地址二阶段映射。主要流程：GUEST中的虚拟地址先通过 VSATP 翻译，通过 GVA 到 GPA，然后通过 HGATP 把GPA翻译到 HPA 这样。</p>
<p>课后练习尚未完成，嗯。</p>
<h2 id="Hypervisior课后练习3"><a href="#Hypervisior课后练习3" class="headerlink" title="Hypervisior课后练习3"></a>Hypervisior课后练习3</h2><p>这里涉及 GUEST 的中断。主要涉及时钟中断，一种实现方式是当 GUEST 配置 RTC 的时候会陷入 Hyper，由 Hyper 来设置时钟，当时钟触发的时候，Hyper 会触发 GUEST 的时钟中断位这样。Hyper在设置完之后应该是会关中断的，待下次GUEST设置中断的时候再打开，这样保持一致。</p>
<p>课后练习尚未完成，嗯。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这里总结的话，三阶段实在不完美，时间上太赶了，然后各种东西都想弄明白细节，这样就很来不及。原本还准备看RISCV的指令集虚拟化扩展这样，也只看了一小部分，内容上其实不算多，但要补的内容比较多，就比较费劲。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/11/30/2024-%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/11/30/2024-%E7%A7%8B%E5%86%AC%E5%AD%A3%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">2024秋冬季开源操作系统训练营第三阶段总结-wingrew</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-30 22:16:27" itemprop="dateCreated datePublished" datetime="2024-11-30T22:16:27+00:00">2024-11-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-07 03:53:36" itemprop="dateModified" datetime="2025-07-07T03:53:36+00:00">2025-07-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本阶段实验由于处于学校考试密集时间，因此没有完全跟课。主要认真学习了Hypervisor虚拟化的内容，也是我项目实习阶段最想要实践的内容。<br>基本理清Hypervisor运行原理和过程，课后作业完成了一部分。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/11/30/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-Zoneshiyi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/11/30/2024%E7%A7%8B%E5%86%AC%E5%AD%A3%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-Zoneshiyi/" class="post-title-link" itemprop="url">2024秋冬季训练营第三阶段总结-Zoneshiyi</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-30 19:45:08" itemprop="dateCreated datePublished" datetime="2024-11-30T19:45:08+00:00">2024-11-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-07 03:53:36" itemprop="dateModified" datetime="2025-07-07T03:53:36+00:00">2025-07-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ArceOS"><a href="#ArceOS" class="headerlink" title="ArceOS"></a>ArceOS</h1><h2 id="2024-11-09"><a href="#2024-11-09" class="headerlink" title="2024.11.09"></a>2024.11.09</h2><h3 id="Rust-相关"><a href="#Rust-相关" class="headerlink" title="Rust 相关"></a>Rust 相关</h3><h4 id="关键字sym"><a href="#关键字sym" class="headerlink" title="关键字sym"></a>关键字sym</h4><p>在Rust中，<code>sym</code> 关键字用于引用函数或符号名称，通常出现在 <code>asm!</code> 宏的内联汇编代码中。sym 允许在汇编代码中引用Rust中的函数或全局变量，以便编译器能正确地将这些引用转换为相应的内存地址或符号。</p>
<h4 id="原始字符串"><a href="#原始字符串" class="headerlink" title="原始字符串"></a>原始字符串</h4><p>在Rust中，字符串前<code>r#&quot;str&quot;</code>表示原始字符串字面量（raw string literal）。使用r前缀的字符串可以避免转义字符的干扰，直接包含特殊字符，如反斜杠<code>\</code>或双引号<code>&quot;</code>。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> json = <span class="string">r#"&#123;"name": "John", "age": 30&#125;"#</span>;</span><br></pre></td></tr></table></figure>

<h4 id="option-env-宏"><a href="#option-env-宏" class="headerlink" title="option_env!宏"></a>option_env!宏</h4><p>在Rust中，<code>option_env!</code> 宏用于在<strong>编译时</strong>获取环境变量的值，并将其作为 <code>Option&lt;&amp;&#39;static str&gt;</code> 返回。</p>
<h4 id="Rust条件编译"><a href="#Rust条件编译" class="headerlink" title="Rust条件编译"></a>Rust条件编译</h4><p>Rust 中的条件编译允许根据特定条件编译或排除某些代码片段。作用范围通常为其紧邻的代码块或声明项。对于较大的代码片段或模块内容，可以将 <code>#[cfg(...)]</code> 等属性放在模块或块的开头，实现更大范围的条件编译。</p>
<ul>
<li><code>#[cfg(...)]</code> 属性</li>
<li><code>#[cfg_attr(...)]</code> 属性<br>有条件地应用属性。适合在某些条件下添加其他属性。</li>
<li><code>cfg!</code> 宏<br>用于在<strong>运行时</strong>检查条件编译状态，并返回布尔值。</li>
</ul>
<h2 id="2024-11-10"><a href="#2024-11-10" class="headerlink" title="2024.11.10"></a>2024.11.10</h2><h3 id="ArceOS-部分目录结构"><a href="#ArceOS-部分目录结构" class="headerlink" title="ArceOS 部分目录结构"></a>ArceOS 部分目录结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── api&#x2F;                        &#x2F;&#x2F; 用户调用系统的接口</span><br><span class="line">├── modules&#x2F;                    &#x2F;&#x2F; 操作系统模块</span><br><span class="line">├── platforms&#x2F;                  &#x2F;&#x2F; 硬件平台相关配置</span><br><span class="line">└── ulib&#x2F;                       &#x2F;&#x2F; 用户lib</span><br></pre></td></tr></table></figure>

<h3 id="ArceOS-Makefile"><a href="#ArceOS-Makefile" class="headerlink" title="ArceOS Makefile"></a>ArceOS Makefile</h3><p>如果设置了PLATFORM变量，会覆盖ARCH变量。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./Makefile</span></span><br><span class="line">PFLASH ?= y</span><br><span class="line">PFLASH_IMG ?= pflash.img  <span class="comment"># 并行闪存（Parallel Flash）</span></span><br><span class="line">DISK_IMG ?= disk.img  <span class="comment"># FAT32文件系统，/mnt/sbin是./target/riscv64gc-unknown-none-elf/release/origin</span></span><br></pre></td></tr></table></figure>

<p>主要编译过程见<code>./scripts/make/build.mk</code></p>
<h3 id="QEMU相关"><a href="#QEMU相关" class="headerlink" title="QEMU相关"></a>QEMU相关</h3><p><code>qemu-system-riscv64 -m 128M -smp 1 -machine virt -bios default -kernel tour/u_1_0/u_1_0_riscv64-qemu-virt.bin -drive if=pflash,file=/home/zone/Code/Rust/oscamp/arceos/pflash.img,format=raw,unit=1 -nographic -D qemu.log -d in_asm,int,mmu,pcall,cpu_reset,guest_errors</code></p>
<ul>
<li><code>-m 128M</code>：分配128MB的内存给虚拟机。</li>
<li><code>-smp 1</code>：指定虚拟机使用1个CPU。</li>
<li><code>-machine virt</code>：指定使用虚拟化的机器类型。</li>
<li><code>-bios default</code>：使用默认的BIOS。</li>
<li><code>-kernel tour/u_1_0/u_1_0_riscv64-qemu-virt.bin</code>：指定要加载的内核镜像文件。</li>
<li><code>-drive if=pflash,file=/home/zone/Code/Rust/oscamp/arceos/pflash.img,format=raw,unit=1</code>：指定一个闪存驱动器，使用原始格式的镜像文件 </li>
<li><code>-nographic</code>：禁用图形输出，使用纯文本模式。</li>
<li><code>-D qemu.log</code>：将QEMU的日志输出到qemu.log</li>
<li><code>-d in_asm,int,mmu,pcall,cpu_reset,guest_errors</code>：启用详细的调试信息，包括指令、中断、内存管理单元、过程调用、CPU重置和来宾错误。</li>
</ul>
<h3 id="Rust相关"><a href="#Rust相关" class="headerlink" title="Rust相关"></a>Rust相关</h3><h4 id="build-rs"><a href="#build-rs" class="headerlink" title="build.rs"></a><code>build.rs</code></h4><p>用于编译第三方的非Rust代码，只需在根目录下添加一个build.rs文件，Cargo会优先编译和执行该构建脚本，然后再构建整个项目。</p>
<h4 id="Workspace"><a href="#Workspace" class="headerlink" title="Workspace"></a>Workspace</h4><p>一个工作空间是由多个 package 组成的集合，它们共享同一个 Cargo.lock 文件、输出目录和一些设置(例如 profiles : 编译器设置和优化)。组成工作空间的 packages 被称之为工作空间的成员。</p>
<p>工作空间有两种类型：</p>
<ul>
<li>root package。若一个 package 的 Cargo.toml 包含了 <code>[package]</code> 的同时又包含了 <code>[workspace]</code> 部分，则该 package 被称为工作空间的根 package。</li>
<li>虚拟清单（virtual manifest）。若一个 Cargo.toml 有 <code>[workspace]</code> 但是没有 <code>[package]</code> 部分，则它是虚拟清单类型的工作空间。</li>
</ul>
<p>特性：</p>
<ul>
<li>所有package共享同一个位于根目录的Cargo.lock</li>
<li>所有package共享同一个输出目录，默认是位于根目录下的target目录</li>
<li>只有根目录的Cargo.toml才能包含 <code>[patch]</code>, <code>[replace]</code> 和 <code>[profile.*]</code>，而成员的 Cargo.toml 中的相应部分将被自动忽略</li>
</ul>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">resolver</span> = <span class="string">"2"</span></span><br><span class="line"><span class="attr">members</span> = [</span><br><span class="line">    <span class="string">"modules/axalloc"</span>,</span><br><span class="line">    <span class="string">"modules/axconfig"</span>,</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="2024-11-11"><a href="#2024-11-11" class="headerlink" title="2024.11.11"></a>2024.11.11</h2><h3 id="ArceOS在riscv64-qemu-virt中的部分启动流程"><a href="#ArceOS在riscv64-qemu-virt中的部分启动流程" class="headerlink" title="ArceOS在riscv64-qemu-virt中的部分启动流程"></a>ArceOS在riscv64-qemu-virt中的部分启动流程</h3><ul>
<li>下层的SBI初始化完成后将跳转到<code>modules/axhal/src/platform/qemu_virt_riscv/boot.rs::_start()</code><ul>
<li>设置boot_stack</li>
<li>设置初始page_table</li>
<li>开启SV39分页，清除地址映射缓存</li>
<li>sp += phys_virt_offset</li>
</ul>
</li>
<li>跳转到<code>modules/axhal/src/platform/qemu_virt_riscv/mod.rs::rust_entry()</code><ul>
<li>清零bss段</li>
<li>设置CPU_ID和IS_BSP</li>
<li>设置trap向量表</li>
<li>设置系统启动时间</li>
</ul>
</li>
<li>跳转到<code>modules/axruntime/src/lib.rs::rust_main()</code><ul>
<li>enable Logging</li>
<li>初始化全局堆内存分配器</li>
<li>冲映射kernel各个段的地址空间</li>
<li>platform相关的初始化</li>
<li>初始化调度器</li>
<li>设备与驱动初始化</li>
<li>如果有启动其他CPU</li>
<li>初始化中断</li>
<li>等待所有CPU启动</li>
<li>执行用户程序</li>
<li>清理然后退出</li>
</ul>
</li>
</ul>
<h3 id="axalloc"><a href="#axalloc" class="headerlink" title="axalloc"></a>axalloc</h3><p><strong>接口</strong></p>
<ul>
<li>Rust Trait <code>#[global_allocator]</code>:<code>static GLOBAL_ALLOCATOR: GlobalAllocator</code><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">GlobalAllocator</span></span> &#123;</span><br><span class="line">  balloc: SpinNoIrq&lt;DefaultByteAllocator&gt;,</span><br><span class="line">  palloc: SpinNoIrq&lt;BitmapPageAllocator&lt;PAGE_SIZE&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 必须为GlobalAllocator实现GlobalAlloc Trait</span></span><br><span class="line"><span class="comment">// 全部内存先交给palloc管理</span></span><br><span class="line"><span class="comment">// 然后给balloc预先分配一小块内存作为堆空间</span></span><br><span class="line"><span class="comment">// 当调用balloc.alloc遇到堆空间不够用时，向palloc请求更多的内存</span></span><br></pre></td></tr></table></figure>
GlobalAllocator提供<code>alloc_pages(&amp;self, num_pages: usize, align_pow2: usize)</code>和<code>dealloc_pages(&amp;self, pos: usize, num_pages: usize)</code>函数用于页的分配和回收</li>
<li>供外部调用的函数：<ul>
<li><code>global_allocator() -&gt; &amp;&#39;static GlobalAllocator</code></li>
<li><code>global_init(start_vaddr: usize, size: usize)</code></li>
<li><code>global_add_memory(start_vaddr: usize, size: usize) -&gt; AllocResult</code></li>
</ul>
</li>
</ul>
<p><strong>算法</strong></p>
<ol>
<li><p>TLSF (Two-Level Segregated Fit)<br>通过将内存块分成多个大小类别（segregated fit）来实现快速分配。TLSF 的主要特点包括：<br>快速分配和释放：分配和释放操作的时间复杂度接近 O(1)。<br>低碎片率：通过精细的大小类别划分，减少内存碎片。<br>适用于实时系统：由于其高效性和确定性，TLSF 常用于实时系统。</p>
</li>
<li><p>Slab Allocator<br>通过预先分配一组称为“slab”的内存块来管理对象。Slab 分配器的主要特点包括：<br>高效的对象分配：适用于频繁分配和释放固定大小对象的场景。<br>减少碎片：通过预先分配和重用内存块，减少内存碎片。<br>缓存对象：可以缓存已分配的对象，减少分配和释放的开销。</p>
</li>
<li><p>Buddy Allocator<br>通过将内存块递归地分割成两部分来管理内存。Buddy 分配器的主要特点包括：<br>快速分配和释放：分配和释放操作的时间复杂度为 O(log n)。<br>合并相邻块：当两个相邻的内存块都空闲时，可以合并成一个更大的块，减少碎片。<br>适用于大块内存分配：适合需要分配和释放大块内存的场景。</p>
</li>
<li><p>BitmapPage Allocator<br>每个内存块对应一个位，位的状态表示该块是否已分配。BitmapPage 分配器的主要特点包括：<br>简单实现：位图结构简单，易于实现和管理。<br>快速查找：通过位图可以快速查找空闲块。<br>适用于小块内存分配：适合需要频繁分配和释放小块内存的场景。</p>
</li>
</ol>
<h2 id="2024-11-12"><a href="#2024-11-12" class="headerlink" title="2024.11.12"></a>2024.11.12</h2><h3 id="Rust-相关-1"><a href="#Rust-相关-1" class="headerlink" title="Rust 相关"></a>Rust 相关</h3><h4 id="内属性和外属性"><a href="#内属性和外属性" class="headerlink" title="内属性和外属性"></a>内属性和外属性</h4><p>在 Rust 中，内属性（inner attribute）和外属性（outer attribute）用于不同的上下文，它们的放置顺序需要符合特定的规则。</p>
<ul>
<li>外属性（outer attribute）用在<strong>项的外部</strong>（如函数、模块、结构体等），以 <code>#[attribute]</code> 的形式表示。</li>
<li>内属性（inner attribute）用在<strong>代码块的内部</strong>，通常用于全局的配置和文件级别的作用，以 <code>#![attribute]</code> 的形式表示。</li>
</ul>
<p>Rust 不允许在某些位置先使用外属性再使用内属性。具体来说，内属性必须在模块或文件的最开头，并且需要放在任何外属性之前。</p>
<h2 id="2024-11-13"><a href="#2024-11-13" class="headerlink" title="2024.11.13"></a>2024.11.13</h2><h3 id="axstd"><a href="#axstd" class="headerlink" title="axstd"></a>axstd</h3><h4 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h4><p>HashMap：数组+链表（+红黑树）。链表（或加上红黑树）针对出现hash冲突的情况</p>
<p>要在axstd里实现基础的HashMap功能，最简单的方法是在lib.rs里加上<code>pub use hashbrown::hash_map::HashMap as HashMap</code></p>
<p>或者仿照std添加collections模块，目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ulib&#x2F;axstd&#x2F;src</span><br><span class="line">│</span><br><span class="line">└── collections</span><br><span class="line">     ├── hash</span><br><span class="line">     │   ├── map.rs</span><br><span class="line">     │   └── mod.rs</span><br><span class="line">     └── mod.rs</span><br></pre></td></tr></table></figure>

<p>部分代码如下，主要是在RadomState的new函数中调用底层模块提供的生产随机数接口来设置keys：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> hashbrown::hash_map::HashMap <span class="keyword">as</span> base_hashmap;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">RandomState</span></span> &#123;</span><br><span class="line">    k0: <span class="built_in">u64</span>,</span><br><span class="line">    k1: <span class="built_in">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> RandomState &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> random_u128 = arceos_api::misc::random();</span><br><span class="line">        RandomState &#123;</span><br><span class="line">            k0: random_u128 <span class="keyword">as</span> <span class="built_in">u64</span>,</span><br><span class="line">            k1: (random_u128 &gt;&gt; <span class="number">64</span>) <span class="keyword">as</span> <span class="built_in">u64</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> BuildHasher <span class="keyword">for</span> RandomState &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Hasher</span></span> = DefaultHasher;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">build_hasher</span></span>(&amp;<span class="keyword">self</span>) -&gt; DefaultHasher &#123;</span><br><span class="line">        DefaultHasher(SipHasher::new_with_keys(<span class="keyword">self</span>.k0, <span class="keyword">self</span>.k1))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#[allow(deprecated)]</span></span><br><span class="line"><span class="meta">#[derive(Clone, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">DefaultHasher</span></span>(SipHasher);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Hasher <span class="keyword">for</span> DefaultHasher &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">HashMap</span></span>&lt;K, V, S = RandomState&gt; = base_hashmap&lt;K, V, S&gt;;</span><br></pre></td></tr></table></figure>

<h2 id="2024-11-14"><a href="#2024-11-14" class="headerlink" title="2024.11.14"></a>2024.11.14</h2><h3 id="QEMU相关-1"><a href="#QEMU相关-1" class="headerlink" title="QEMU相关"></a>QEMU相关</h3><h4 id="PFlash"><a href="#PFlash" class="headerlink" title="PFlash"></a>PFlash</h4><p>QEMU的PFlash模拟闪存磁盘，启动时自动从文件加载内容到固定的MMIO区域，<strong>对读操作不需要驱动</strong>，可以直接访问。写操作仍需要驱动。</p>
<h3 id="rust-analyzer"><a href="#rust-analyzer" class="headerlink" title="rust-analyzer"></a>rust-analyzer</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .vscode/settings.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 避免不必要的检查</span></span><br><span class="line">  <span class="attr">"rust-analyzer.check.allTargets"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">// 检查程序时传递给cargo的features</span></span><br><span class="line">  <span class="attr">"rust-analyzer.cargo.features"</span>: [<span class="string">"axstd"</span>],</span><br><span class="line">  <span class="attr">"rust-analyzer.cargo.target"</span>: <span class="string">"riscv64gc-unknown-none-elf"</span>,</span><br><span class="line">  <span class="attr">"rust-analyzer.cargo.targetDir"</span>: <span class="string">"/path/to/oscamp/arceos/target"</span>,</span><br><span class="line">  <span class="comment">// "rust-analyzer.cargo.extraArgs": [</span></span><br><span class="line">  <span class="comment">//     "--target=riscv64gc-unknown-none-elf",</span></span><br><span class="line">  <span class="comment">//     "--features=axstd"</span></span><br><span class="line">  <span class="comment">// ],</span></span><br><span class="line">  <span class="comment">// "rust-analyzer.cargo.extraEnv": &#123;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2024-11-17"><a href="#2024-11-17" class="headerlink" title="2024.11.17"></a>2024.11.17</h2><h3 id="unwrap-调用的问题"><a href="#unwrap-调用的问题" class="headerlink" title="unwrap()调用的问题"></a>unwrap()调用的问题</h3><p>每次调用 unwrap() 都会返回一个新的实例，而不是同一个实例。因此通过unwrap修改数值无法生效。<br>可以通过<code>if let Some(ref mut T)</code>获取可变引用来修改。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Copy, Clone, Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span></span> &#123;</span><br><span class="line">    a: <span class="built_in">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> a = <span class="literal">Some</span>(A &#123; a: <span class="number">0</span> &#125;);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, a.unwrap().a);</span><br><span class="line">    <span class="comment">//0 </span></span><br><span class="line">    a.unwrap().a = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, a.unwrap().a);</span><br><span class="line">    <span class="comment">// 0</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(<span class="keyword">ref</span> <span class="keyword">mut</span> tmp) = a &#123;</span><br><span class="line">        tmp.a = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, a.unwrap().a);</span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2024-11-18"><a href="#2024-11-18" class="headerlink" title="2024.11.18"></a>2024.11.18</h2><h3 id="lab1"><a href="#lab1" class="headerlink" title="lab1"></a>lab1</h3><h3 id="Heap区域划分"><a href="#Heap区域划分" class="headerlink" title="Heap区域划分"></a>Heap区域划分</h3><p>通过分析lab1的测试样例代码可知alloc行为可以抽象为以下三种：</p>
<ol>
<li>固定大小且不回收的Vec，这些Vec的位置和大小在分配完成后就不再变化。</li>
<li>固定大小但会回收的Vec，且回收顺序与分配顺序相反。</li>
<li>可变大小的Vec，这些Vec主要用来临时存储前两中Vec的地址<br>这一类Vec在任意时刻的数量不超过4个，且长度相对较段，因此选择在Heap区域的开头为其预留固定大小的空间（例如4KB）。</li>
</ol>
<p>针对第一种类型，从前向后分配，针对第二种类型，从后向前分配。</p>
<h3 id="特殊处理"><a href="#特殊处理" class="headerlink" title="特殊处理"></a>特殊处理</h3><p>为了简化实现，在系统将所有Heap空间分配给LabByteAllocator管理之前，LabByteAllocator的alloc函数都会返回分配失败。</p>
<p>除此之外，为了能够让Heap空间能够全部分配给LabByteAllocator而没有浪费，需要对LabByteAllocator的<code>total_bytes()</code>函数进行特殊处理，而不是返回实际的总字节数。</p>
<p>在axalloc中，当遇到分配器分配失败时，会将分配器的<code>total_bytes()</code>方法的返回值作为扩展的空间大小。假设Heap空间的结束地址是HEAP_END，当前分配器管理空间的结束地址是END，<code>让total_bytes()</code>返回<code>(HEAP_END-END)/2</code>就能尽可能将HEAP空间分配给LabByteAllocator。</p>
<h2 id="2024-11-24"><a href="#2024-11-24" class="headerlink" title="2024.11.24"></a>2024.11.24</h2><h3 id="Rust相关-1"><a href="#Rust相关-1" class="headerlink" title="Rust相关"></a>Rust相关</h3><p><strong>rust-analyzer</strong></p>
<p>在编译时makefile会有一些预处理行为，例如设置环境变量、添加cargo参数等等。为了保持rust-analyzer分析代码时的环境与实际编译时尽量保持一致，需要添加相应的配置。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"rust-analyzer.check.overrideCommand"</span>: [</span><br><span class="line">        <span class="string">"cargo"</span>,</span><br><span class="line">        <span class="comment">// 改变当前目录、</span></span><br><span class="line">        <span class="string">"-C"</span>,</span><br><span class="line">        <span class="string">"/path/to/oscamp/arceos/tour/u_7_0"</span>,</span><br><span class="line">        <span class="string">"check"</span>,</span><br><span class="line">        <span class="comment">//添加unstable flag</span></span><br><span class="line">        <span class="string">"-Z"</span>,</span><br><span class="line">        <span class="string">"unstable-options"</span>,</span><br><span class="line">        <span class="string">"--workspace"</span>,</span><br><span class="line">        <span class="string">"--message-format=json-diagnostic-rendered-ansi"</span>,</span><br><span class="line">        <span class="string">"--manifest-path"</span>,</span><br><span class="line">        <span class="string">"/path/to/oscamp/arceos/tour/u_7_0/Cargo.toml"</span>,</span><br><span class="line">        <span class="string">"--keep-going"</span>,</span><br><span class="line">        <span class="string">"--release"</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">// 添加需要的features</span></span><br><span class="line">    <span class="attr">"rust-analyzer.cargo.features"</span>: [</span><br><span class="line">        <span class="string">"axstd/irq"</span>,</span><br><span class="line">        <span class="comment">// "axstd/rtc",</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"rust-analyzer.cargo.target"</span>: <span class="string">"riscv64gc-unknown-none-elf"</span>,</span><br><span class="line">    <span class="attr">"rust-analyzer.cargo.targetDir"</span>: <span class="string">"/path/to/oscamp/arceos/target"</span>,</span><br><span class="line">    <span class="attr">"rust-analyzer.cargo.extraEnv"</span>: &#123;</span><br><span class="line">        <span class="attr">"AX_PLATFORM"</span>: <span class="string">"riscv64-qemu-virt"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RISC-V相关"><a href="#RISC-V相关" class="headerlink" title="RISC-V相关"></a>RISC-V相关</h3><h4 id="异常Exception和中断Interrupt"><a href="#异常Exception和中断Interrupt" class="headerlink" title="异常Exception和中断Interrupt"></a>异常Exception和中断Interrupt</h4><p>在 RISC-V 架构语境下，异常和中断都是一种Trap，但他们被触发的原因不同。</p>
<ul>
<li>异常与当前CPU的指令执行是同步的，异常被触发的原因一定能追溯到某条指令的执行，会在执行下一条指令前先进入异常处理流程。</li>
<li>中断则异步与当前正在执行的指令，也就是说中断来自于哪个外设以及中断如何触发完全与处理器正在执行的当前指令无关。相比于异常，中断与特权级的联系更加紧密。<br>RISC-V 的中断可以分成三类：<ul>
<li>软件中断 (Software Interrupt)：由软件控制发出的中断</li>
<li>时钟中断 (Timer Interrupt)：由时钟电路发出的中断</li>
<li>外部中断 (External Interrupt)：由外设发出的中断</li>
</ul>
</li>
</ul>
<p>arceos在<code>axhal::arch::riscv::trap::riscv_trap_handler()</code>中指定了异常的处理函数，然后通过全局静态变量<code>IRQ: [fn(usize) -&gt; bool]</code>注册中断处理函数。<code>axhal::irq::handler_irq</code>用于分发IRQ对应的中断到实际的处理函数。<br><code>axhal::irq::register_handler</code>用于初始化注册中断处理函数。</p>
<h3 id="ArceOS相关"><a href="#ArceOS相关" class="headerlink" title="ArceOS相关"></a>ArceOS相关</h3><h4 id="初始任务"><a href="#初始任务" class="headerlink" title="初始任务"></a>初始任务</h4><p>在初始化阶段创建了三个任务：</p>
<ul>
<li>idle：持续调用<code>yield_now()</code>函数的死循环</li>
<li>main：init进程</li>
<li>gc：回收所有退出的任务和相应的资源</li>
</ul>
<h2 id="2024-11-26"><a href="#2024-11-26" class="headerlink" title="2024.11.26"></a>2024.11.26</h2><h3 id="ArceOS相关-1"><a href="#ArceOS相关-1" class="headerlink" title="ArceOS相关"></a>ArceOS相关</h3><h4 id="axtask"><a href="#axtask" class="headerlink" title="axtask"></a>axtask</h4><p><strong>接口</strong></p>
<ul>
<li>spawn</li>
<li>yield_now:Current task gives up the CPU time voluntarily, and switches to another ready task.</li>
<li>sleep</li>
<li>exit</li>
</ul>
<h4 id="axdriver"><a href="#axdriver" class="headerlink" title="axdriver"></a>axdriver</h4><p><strong>for_each_drivers!</strong></p>
<p>这个宏的作用主要是为每一种设备类型（virtio-net、ramdisk等）添加统一的处理代码，类似于for循环遍历所有的设备类型。</p>
<p><strong>PCIe ECAM</strong></p>
<p>PCI协议定义了256bytes配置空间，PCIe将配置空间扩展到了4KB。</p>
<p>PCI Express配置模型支持两种配置空间访问机制：</p>
<ul>
<li>PCI-compatible Configuration Access Mechanism</li>
<li>PCI Express Enhanced Configuration Access Mechanism<br>CAM模式是PCI协议定义的访问方式，而ECAM则是PCIe协议定义的访问方式。</li>
</ul>
<p>一般来说，系统地址空间会预留256MB（256bus * 32dev * 8func * 4k）空间给ECAM机制使用，当然如果系统比较差，不支持那么多bus号，也可以预留小一点。</p>
<p>Function是PCI设备中的独立子模块，一个设备可以包含多个功能，每个功能可以执行不同的任务。例如：一个PCI网卡可能同时具有以太网控制器（Function 0）和无线网卡（Function 1）两种功能。</p>
<h4 id="axfs"><a href="#axfs" class="headerlink" title="axfs"></a>axfs</h4><p><strong>lookup</strong></p>
<p>在当前的<code>axfs::fs::fatfs::lookup</code>实现中，会对传入的path参数先调用open_file，如果返回Err则再调用open_dir，因此如何path传入的是一个文件夹路径，会在err信息中看到<code>Is a directory</code>报错。</p>
<h3 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h3><p><strong>对编译器和CPU实施的重排指令行为进行控制</strong></p>
<ul>
<li>C++ memory_order_relaxed/Rust Ordering::Relaxed：无fencing作用，cpu和编译器可以重排指令</li>
<li>C++ memory_order_release/Rust Ordering::Release：前面的访存指令不能排到这条指令之后</li>
<li>C++ memory_order_acquire/Rust Ordering::Acquire：后面的访存指令不能排到这条指令之前</li>
<li>C++ memory_order_acq_rel/Rust Ordering::AcqRel：acquire+release</li>
<li>C++ memory_order_seq_cst/Rust Ordering::SeqCst：AcqRel+所有使用SeqCst的指令严格有序</li>
<li>C++ memory_order_acquire：</li>
</ul>
<h2 id="2024-11-28"><a href="#2024-11-28" class="headerlink" title="2024.11.28"></a>2024.11.28</h2><h3 id="ArceOS相关-2"><a href="#ArceOS相关-2" class="headerlink" title="ArceOS相关"></a>ArceOS相关</h3><p><strong>VFS</strong></p>
<p>VFS定义文件系统的接口层，为操作系统提供统一的接口操作不同的文件系统。</p>
<p>文件系统节点的操作流程：</p>
<ul>
<li>获取Root目录节点：<code>VfsOps::root_dir()</code></li>
<li>解析路径，逐级通过lookup方法找到对应节点：<code>VfsNodeOps::lookup()</code></li>
<li>对目标节点进行操作：<code>VfsNodeOps::op_xxx()</code></li>
</ul>
<p><strong>Linux常用的文件系统</strong></p>
<ul>
<li>ProcFS：用于提供进程信息的接口</li>
<li>SysFS：用于向用户暴露设备信息，主要用于替代传统的devfs</li>
<li>DevFS：目前主要是为了兼容性而存在</li>
</ul>
<p>以上三种文件系统都是ramfs的实例，在运行时构建。</p>
<h2 id="2024-11-30"><a href="#2024-11-30" class="headerlink" title="2024.11.30"></a>2024.11.30</h2><h3 id="Rust相关-2"><a href="#Rust相关-2" class="headerlink" title="Rust相关"></a>Rust相关</h3><p><strong>声明宏与过程宏</strong></p>
<ul>
<li>声明宏匹配对应模式然后以另一部分代码替换当前代码</li>
<li>过程宏更像函数，接收一段Rust代码，产生另一些代码作为输出。过程宏的参数为TokenSteam类型，返回值也是TokenSteam类型。</li>
</ul>
<p><code>handle_trap!</code>声明宏会根据<code>#[def_trap_handler]</code>声明的变量，查找对应<code>#[register_trap_handler(...)]</code>注册的处理函数。</p>
<h3 id="axmm"><a href="#axmm" class="headerlink" title="axmm"></a>axmm</h3><p>宏内核地址空间管理相关对象的层次构成：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每个task都有一个地址空间</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">AddrSpace</span></span> &#123;</span><br><span class="line">    va_range: VirtAddrRange,</span><br><span class="line">    areas: MemorySet&lt;Backend&gt;,</span><br><span class="line">    pt: PageTable,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对BTreeMap的简单封装，用于管理MemoryArea</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">MemorySet</span></span>&lt;B: MappingBackend&gt; &#123;</span><br><span class="line">    areas: BTreeMap&lt;B::Addr, MemoryArea&lt;B&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对应一段连续的虚拟内存区域，关联一个负责实现具体映射行为的Backend</span></span><br><span class="line"><span class="comment">// Backend决定map、unmap、protect的行为，目前有Linear和Alloc两种，Linear对应的物理页帧必须连续</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">MemoryArea</span></span>&lt;B: MappingBackend&gt; &#123;</span><br><span class="line">    va_range: AddrRange&lt;B::Addr&gt;,</span><br><span class="line">    flags: B::Flags,</span><br><span class="line">    backend: B,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>Hypervisor</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2024/11/29/2024%E7%A7%8B%E5%86%AC%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-chy669086/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/11/29/2024%E7%A7%8B%E5%86%AC%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A5%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-chy669086/" class="post-title-link" itemprop="url">2024秋冬开源操作系统训练营第三阶段总结-chy669086</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-29 20:08:07" itemprop="dateCreated datePublished" datetime="2024-11-29T20:08:07+00:00">2024-11-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-07 03:53:36" itemprop="dateModified" datetime="2025-07-07T03:53:36+00:00">2025-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A/" itemprop="url" rel="index"><span itemprop="name">第三阶段总结报告</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>也是很高兴能进入三阶段学习。三阶段让我对操作系统的理解更进一步，通过课后的作业，我也学到了不少知识。</p>
<h2 id="个人收获"><a href="#个人收获" class="headerlink" title="个人收获"></a>个人收获</h2><ul>
<li>学会了操作系统对设备的挂载</li>
<li>了解了 unikernel 到宏内核的转化</li>
<li>对操作系统内存分配的了解更进一步</li>
<li>通过查漏补缺对上一阶段掌握不熟的知识进行了复习</li>
</ul>
<p>通过阅读 arceos 的源代码和课后练习，我的程序编写能力也得到了锻炼，让我对操作系统有了全新的认识。</p>
<h2 id="未来展望"><a href="#未来展望" class="headerlink" title="未来展望"></a>未来展望</h2><p>通过这个阶段的学习，我有以下打算：</p>
<ul>
<li>四阶段希望进行宏内核的学习</li>
<li>在寒假时间自己实现一个轻量级的 unikernel 内核，并通过组件化的形式将他变成宏内核</li>
</ul>
<p>最后，感谢老师的悉心教导，也感谢平台提供的学习机会，让我有了深入学习操作系统的机会。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/19/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/blog/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/73/">73</a><a class="extend next" rel="next" href="/blog/page/21/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rcore-os Group</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>


  















  

  

  

</body>
</html>
