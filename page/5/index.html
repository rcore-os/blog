<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">
  
  <link rel="stylesheet" href="/blog/lib/animate-css/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rcore-os.github.io","root":"/blog/","scheme":"Muse","version":"8.0.0-rc.4","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="rcore-os Blog">
<meta property="og:url" content="http://rcore-os.github.io/blog/page/5/index.html">
<meta property="og:site_name" content="rcore-os Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="rcore-os Group">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://rcore-os.github.io/blog/page/5/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>rcore-os Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">rcore-os Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rcore-os Group</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">601</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">546</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content index posts-expand">
          
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2025/04/27/Chap7-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/04/27/Chap7-2/" class="post-title-link" itemprop="url">rcore-handnote-7-2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-27 09:40:28" itemprop="dateCreated datePublished" datetime="2025-04-27T09:40:28+00:00">2025-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-06 07:13:15" itemprop="dateModified" datetime="2025-05-06T07:13:15+00:00">2025-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/handnote/" itemprop="url" rel="index"><span itemprop="name">handnote</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Chapter-7-2"><a href="#Chapter-7-2" class="headerlink" title="Chapter 7-2"></a>Chapter 7-2</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>If a process want to notify other process with event semantics, such one-side mechanism called <strong>Signal</strong>, one process received specific event will pause and implement corresponding operation to handle the notification.</p>
<p>For example, a program could receive the stop event sended by <code>Ctrl+C</code>, and stop itself.</p>
<p>The abstraction of handling of signal:</p>
<ul>
<li>ignore: do own thing and ignore signal</li>
<li>trap: call corresponding operation of the received signal</li>
<li>stop: stop itself</li>
</ul>
<p>Now, beside this raw idea, we want to classify such abstraction with specified data.</p>
<hr>
<h3 id="Signal-Data"><a href="#Signal-Data" class="headerlink" title="Signal Data"></a>Signal Data</h3><p>First, we define raw info for each possible event.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/src/lib.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> SIGDEF: <span class="built_in">i32</span> = <span class="number">0</span>; <span class="comment">// Default signal handling</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> SIGHUP: <span class="built_in">i32</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> SIGINT: <span class="built_in">i32</span> = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> SIGQUIT: <span class="built_in">i32</span> = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> SIGILL: <span class="built_in">i32</span> = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> SIGTRAP: <span class="built_in">i32</span> = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> SIGABRT: <span class="built_in">i32</span> = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> SIGBUS: <span class="built_in">i32</span> = <span class="number">7</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> SIGFPE: <span class="built_in">i32</span> = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> SIGKILL: <span class="built_in">i32</span> = <span class="number">9</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>So, what if a process want to omit the signal, what should this process do? We will introduce <strong>Mask</strong> in bit design, which means higher number contains lower number, indicating higher priority.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/src/lib.rs</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">bitflags!</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">SignalFlags</span></span>: <span class="built_in">i32</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> SIGDEF = <span class="number">1</span>; <span class="comment">// Default signal handling</span></span><br><span class="line">        <span class="keyword">const</span> SIGHUP = <span class="number">1</span> &lt;&lt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">const</span> SIGINT = <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">const</span> SIGQUIT = <span class="number">1</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">const</span> SIGILL = <span class="number">1</span> &lt;&lt; <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">const</span> SIGTRAP = <span class="number">1</span> &lt;&lt; <span class="number">5</span>;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">const</span> SIGSYS = <span class="number">1</span> &lt;&lt; <span class="number">31</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In a task block, it should record its current mask and current signal priority and each action corresponding to each flags, so we need a fixed array contains ptrs and its priority. After that, we need to record current flag it should implement.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/src/lib.rs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// Action for a signal</span></span><br><span class="line"><span class="meta">#[repr(C, align(16))]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone, Copy)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">SignalAction</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> handler: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">pub</span> mask: SignalFlags,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// os/src/task/signal.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> MAX_SIG: <span class="built_in">usize</span> = <span class="number">31</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// os/src/task/action.rs</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">SignalActions</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> table: [SignalAction; MAX_SIG + <span class="number">1</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// os/src/task/task.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">TaskControlBlockInner</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">pub</span> handling_sig: <span class="built_in">isize</span>,</span><br><span class="line">	<span class="comment">// priority allowed</span></span><br><span class="line">	<span class="keyword">pub</span> signals: SignalFlags,</span><br><span class="line">	<span class="comment">// priority forbidden</span></span><br><span class="line">    <span class="keyword">pub</span> signal_mask: SignalFlags,</span><br><span class="line">    <span class="keyword">pub</span> signal_actions: SignalActions,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then our task know which signal should be implemented, which should be omitted.</p>
<hr>
<h3 id="Signal-Handle"><a href="#Signal-Handle" class="headerlink" title="Signal Handle"></a>Signal Handle</h3><p>Recall that, each process should receive signal and trap into possible level, some may be in S-level, some may be in U-level. And some of them may be illegal or atrocious that we should <code>stop</code> or <code>frozen</code> to wait. If so, we should backup our <code>trap_ctx</code>, because handler contains different environement.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/task/task.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">TaskControlBlockInner</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">pub</span> killed: <span class="built_in">bool</span>,</span><br><span class="line">    <span class="keyword">pub</span> frozen: <span class="built_in">bool</span>,</span><br><span class="line">    <span class="keyword">pub</span> handling_sig: <span class="built_in">isize</span>,</span><br><span class="line">    <span class="keyword">pub</span> trap_ctx_backup: <span class="built_in">Option</span>&lt;TrapContext&gt;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// os/src/task/mod.rs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Some signals are severe and handled by kernel.</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">call_kernel_signal_handler</span></span>(signal: SignalFlags) &#123;</span><br><span class="line">    <span class="keyword">let</span> task = current_task().unwrap();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> task_inner = task.inner_exclusive_access();</span><br><span class="line">    <span class="keyword">match</span> signal &#123;</span><br><span class="line">        SignalFlags::SIGSTOP =&gt; &#123;</span><br><span class="line">            task_inner.frozen = <span class="literal">true</span>;</span><br><span class="line">            task_inner.signals ^= SignalFlags::SIGSTOP;</span><br><span class="line">        &#125;</span><br><span class="line">        SignalFlags::SIGCONT =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> task_inner.signals.contains(SignalFlags::SIGCONT) &#123;</span><br><span class="line">                task_inner.signals ^= SignalFlags::SIGCONT;</span><br><span class="line">                task_inner.frozen = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        _ =&gt; &#123;</span><br><span class="line">            <span class="comment">// println!(</span></span><br><span class="line">            <span class="comment">//     "[K] call_kernel_signal_handler:: current task sigflag &#123;:?&#125;",</span></span><br><span class="line">            <span class="comment">//     task_inner.signals</span></span><br><span class="line">            <span class="comment">// );</span></span><br><span class="line">            task_inner.killed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Some signals are normal and handled by user.</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">call_user_signal_handler</span></span>(sig: <span class="built_in">usize</span>, signal: SignalFlags) &#123;</span><br><span class="line">    <span class="keyword">let</span> task = current_task().unwrap();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> task_inner = task.inner_exclusive_access();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> handler = task_inner.signal_actions.table[sig].handler;</span><br><span class="line">    <span class="keyword">if</span> handler != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// register signal into task</span></span><br><span class="line">        task_inner.handling_sig = sig <span class="keyword">as</span> <span class="built_in">isize</span>;</span><br><span class="line">        task_inner.signals ^= signal;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// backup</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> trap_ctx = task_inner.get_trap_cx();</span><br><span class="line">        task_inner.trap_ctx_backup = <span class="literal">Some</span>(*trap_ctx);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// modify current trap for our event handler</span></span><br><span class="line">        trap_ctx.sepc = handler;</span><br><span class="line">        trap_ctx.x[<span class="number">10</span>] = sig;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// default action</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"[K] task/call_user_signal_handler: default action: ignore it or kill process"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Based on this, we could check our pending signal based on priority of <code>signals</code>, <code>signal_mask</code> of task and <code>signal_mask</code> of signal itself of table.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/task/mod.rs</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">check_pending_signals</span></span>() &#123;</span><br><span class="line">    <span class="keyword">for</span> sig <span class="keyword">in</span> <span class="number">0</span>..(MAX_SIG + <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> task = current_task().unwrap();</span><br><span class="line">        <span class="keyword">let</span> task_inner = task.inner_exclusive_access();</span><br><span class="line">        <span class="keyword">let</span> signal = SignalFlags::from_bits(<span class="number">1</span> &lt;&lt; sig).unwrap();</span><br><span class="line">        <span class="keyword">if</span> task_inner.signals.contains(signal) &amp;&amp; (!task_inner.signal_mask.contains(signal)) &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> masked = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">let</span> handling_sig = task_inner.handling_sig;</span><br><span class="line">            <span class="keyword">if</span> handling_sig == -<span class="number">1</span> &#123;</span><br><span class="line">                masked = <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> handling_sig = handling_sig <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">                <span class="keyword">if</span> !task_inner.signal_actions.table[handling_sig]</span><br><span class="line">                    .mask</span><br><span class="line">                    .contains(signal)</span><br><span class="line">                &#123;</span><br><span class="line">                    masked = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> !masked &#123;</span><br><span class="line">                <span class="built_in">drop</span>(task_inner);</span><br><span class="line">                <span class="built_in">drop</span>(task);</span><br><span class="line">                <span class="keyword">if</span> signal == SignalFlags::SIGKILL</span><br><span class="line">                    || signal == SignalFlags::SIGSTOP</span><br><span class="line">                    || signal == SignalFlags::SIGCONT</span><br><span class="line">                    || signal == SignalFlags::SIGDEF</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// signal is a kernel signal</span></span><br><span class="line">                    call_kernel_signal_handler(signal);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// signal is a user signal</span></span><br><span class="line">                    call_user_signal_handler(sig, signal);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then record a loop function to handle repeatedly while changing the state of task.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/task/mod.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">handle_signals</span></span>() &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        check_pending_signals();</span><br><span class="line">        <span class="keyword">let</span> (frozen, killed) = &#123;</span><br><span class="line">            <span class="keyword">let</span> task = current_task().unwrap();</span><br><span class="line">            <span class="keyword">let</span> task_inner = task.inner_exclusive_access();</span><br><span class="line">            (task_inner.frozen, task_inner.killed)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> !frozen || killed &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        suspend_current_and_run_next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="System-Operation"><a href="#System-Operation" class="headerlink" title="System Operation"></a>System Operation</h3><p>Finally, we will design <code>sys</code> operations to construct interface.</p>
<ul>
<li>procmask: set mask of current process</li>
<li>sigaction: set handler of a signal of current process and move original handler to our input <code>old_action</code> ptr.</li>
<li>kill: current process send signal to the other</li>
<li>sigreturn: clear current signal and back to original trap state</li>
</ul>
<p>We will construct it one by one.</p>
<p><code>procmask</code> is simple, we just set it directly and return original one.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/process.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">sys_sigprocmask</span></span>(mask: <span class="built_in">u32</span>) -&gt; <span class="built_in">isize</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(task) = current_task() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inner = task.inner_exclusive_access();</span><br><span class="line">        <span class="keyword">let</span> old_mask = inner.signal_mask;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(flag) = SignalFlags::from_bits(mask) &#123;</span><br><span class="line">            inner.signal_mask = flag;</span><br><span class="line">            old_mask.bits() <span class="keyword">as</span> <span class="built_in">isize</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            -<span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sigaction</code> is a bit harder but still easy, however, notice that the ptr may be null.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/syscall/process.rs</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">check_sigaction_error</span></span>(signal: SignalFlags, action: <span class="built_in">usize</span>, old_action: <span class="built_in">usize</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> action == <span class="number">0</span></span><br><span class="line">        || old_action == <span class="number">0</span></span><br><span class="line">        || signal == SignalFlags::SIGKILL</span><br><span class="line">        || signal == SignalFlags::SIGSTOP</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">sys_sigaction</span></span>(</span><br><span class="line">    signum: <span class="built_in">i32</span>,</span><br><span class="line">    action: *<span class="keyword">const</span> SignalAction,</span><br><span class="line">    old_action: *<span class="keyword">mut</span> SignalAction,</span><br><span class="line">) -&gt; <span class="built_in">isize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> token = current_user_token();</span><br><span class="line">    <span class="keyword">let</span> task = current_task().unwrap();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> inner = task.inner_exclusive_access();</span><br><span class="line">    <span class="keyword">if</span> signum <span class="keyword">as</span> <span class="built_in">usize</span> &gt; MAX_SIG &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(flag) = SignalFlags::from_bits(<span class="number">1</span> &lt;&lt; signum) &#123;</span><br><span class="line">        <span class="keyword">if</span> check_sigaction_error(flag, action <span class="keyword">as</span> <span class="built_in">usize</span>, old_action <span class="keyword">as</span> <span class="built_in">usize</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> prev_action = inner.signal_actions.table[signum <span class="keyword">as</span> <span class="built_in">usize</span>];</span><br><span class="line">        *translated_refmut(token, old_action) = prev_action;</span><br><span class="line">        inner.signal_actions.table[signum <span class="keyword">as</span> <span class="built_in">usize</span>] = *translated_ref(token, action);</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>kill</code> is simple, we will extract the task from <code>pid</code>, and insert flag to it if thereâ€™s no flag has been set.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/syscall/process.rs</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">check_sigaction_error</span></span>(signal: SignalFlags, action: <span class="built_in">usize</span>, old_action: <span class="built_in">usize</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> action == <span class="number">0</span></span><br><span class="line">        || old_action == <span class="number">0</span></span><br><span class="line">        || signal == SignalFlags::SIGKILL</span><br><span class="line">        || signal == SignalFlags::SIGSTOP</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">sys_sigaction</span></span>(</span><br><span class="line">    signum: <span class="built_in">i32</span>,</span><br><span class="line">    action: *<span class="keyword">const</span> SignalAction,</span><br><span class="line">    old_action: *<span class="keyword">mut</span> SignalAction,</span><br><span class="line">) -&gt; <span class="built_in">isize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> token = current_user_token();</span><br><span class="line">    <span class="keyword">let</span> task = current_task().unwrap();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> inner = task.inner_exclusive_access();</span><br><span class="line">    <span class="keyword">if</span> signum <span class="keyword">as</span> <span class="built_in">usize</span> &gt; MAX_SIG &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(flag) = SignalFlags::from_bits(<span class="number">1</span> &lt;&lt; signum) &#123;</span><br><span class="line">        <span class="keyword">if</span> check_sigaction_error(flag, action <span class="keyword">as</span> <span class="built_in">usize</span>, old_action <span class="keyword">as</span> <span class="built_in">usize</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> prev_action = inner.signal_actions.table[signum <span class="keyword">as</span> <span class="built_in">usize</span>];</span><br><span class="line">        *translated_refmut(token, old_action) = prev_action;</span><br><span class="line">        inner.signal_actions.table[signum <span class="keyword">as</span> <span class="built_in">usize</span>] = *translated_ref(token, action);</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sigreturn</code> is simple, because we only need to restore our backup one.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/syscall/process.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">sys_sigreturn</span></span>() -&gt; <span class="built_in">isize</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(task) = current_task() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> inner = task.inner_exclusive_access();</span><br><span class="line">        inner.handling_sig = -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// restore the trap context</span></span><br><span class="line">        <span class="keyword">let</span> trap_ctx = inner.get_trap_cx();</span><br><span class="line">        *trap_ctx = inner.trap_ctx_backup.unwrap();</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Phew! We finish our <strong>Signal</strong> mechanism!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2025/04/27/Chap8-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/04/27/Chap8-1/" class="post-title-link" itemprop="url">rcore-handnote-8-1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-27 09:40:28" itemprop="dateCreated datePublished" datetime="2025-04-27T09:40:28+00:00">2025-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-06 07:13:15" itemprop="dateModified" datetime="2025-05-06T07:13:15+00:00">2025-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/handnote/" itemprop="url" rel="index"><span itemprop="name">handnote</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Chapter-8-1"><a href="#Chapter-8-1" class="headerlink" title="Chapter 8-1"></a>Chapter 8-1</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>As the growth of OS, dispatch resource could be divided to smaller piece for more efficient operations. Now, process canâ€™t satisfied our demand, we want some programs could be implemented in parallel. Then, we introduce <strong>Thread</strong>.</p>
<p>Therefore, process will be the container of threads, each threads contain its <code>id</code>, <code>state</code>, current instruction ptr, registers, stack. However, it will share data(which means same memory and addr) in the same process. So, we will develop a accompany exclusion mechanism for parallel operations by each threads.</p>
<h3 id="Design-Data"><a href="#Design-Data" class="headerlink" title="Design Data"></a>Design Data</h3><p>Now, clarify our resource dispatch for one thread:</p>
<p>Immutable:</p>
<ul>
<li>kernel stack</li>
</ul>
<p>Mutable:</p>
<ul>
<li>thread id</li>
<li>user stack</li>
<li>trap context</li>
<li>trap status</li>
<li>exit code</li>
</ul>
<p>Every tasks is a thread unit and contained in one process, so now, process is really a process rather a task, it can owns many tasks.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/task/process.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ProcessControlBlock</span></span> &#123;</span><br><span class="line">    <span class="comment">// immutable</span></span><br><span class="line">    <span class="keyword">pub</span> pid: PidHandle,</span><br><span class="line">    <span class="comment">// mutable</span></span><br><span class="line">    inner: UPSafeCell&lt;ProcessControlBlockInner&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ProcessControlBlockInner</span></span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">pub</span> task_res_allocator: RecycleAllocator,</span><br><span class="line">    <span class="keyword">pub</span> tasks: <span class="built_in">Vec</span>&lt;<span class="built_in">Option</span>&lt;Arc&lt;TaskControlBlock&gt;&gt;&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Notice, we should separate user stack and kernel stack, we shouldnâ€™t allocate user stack and kernel stack by same logic. Kernel stack is immutable, we only need its top place for trap context.</p>
<p><img src="/blog/.io//assets/Lab8-1.png" alt></p>
<p>Because every thread use the same memory set, so each user stack and its trampoline would be allocated by its thread id. We encapsulate these to <code>TaskUserRes</code> data.</p>
<p>We can see many structure need a id allocation, we could design a general id allocator.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/task/id.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">RecycleAllocator</span></span> &#123;</span><br><span class="line">    current: <span class="built_in">usize</span>,</span><br><span class="line">    recycled: <span class="built_in">Vec</span>&lt;<span class="built_in">usize</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> RecycleAllocator &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        RecycleAllocator &#123;</span><br><span class="line">            current: <span class="number">0</span>,</span><br><span class="line">            recycled: <span class="built_in">Vec</span>::new(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">alloc</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(id) = <span class="keyword">self</span>.recycled.pop() &#123;</span><br><span class="line">            id</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.current += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">self</span>.current - <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">dealloc</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, id: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="built_in">assert!</span>(id &lt; <span class="keyword">self</span>.current);</span><br><span class="line">        <span class="built_in">assert!</span>(</span><br><span class="line">            !<span class="keyword">self</span>.recycled.iter().any(|i| *i == id),</span><br><span class="line">            <span class="string">"id &#123;&#125; has been deallocated!"</span>,</span><br><span class="line">            id</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">self</span>.recycled.push(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Kernel-Stack-Allocation"><a href="#Kernel-Stack-Allocation" class="headerlink" title="Kernel Stack Allocation"></a>Kernel Stack Allocation</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/task/id.rs</span></span><br><span class="line"></span><br><span class="line">lazy_static! &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">ref</span> KSTACK_ALLOCATOR: UPSafeCell&lt;RecycleAllocator&gt; =</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; UPSafeCell::new(RecycleAllocator::new()) &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">KernelStack</span></span>(<span class="keyword">pub</span> <span class="built_in">usize</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Return (bottom, top) of a kernel stack in kernel space.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">kernel_stack_position</span></span>(kstack_id: <span class="built_in">usize</span>) -&gt; (<span class="built_in">usize</span>, <span class="built_in">usize</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> top = TRAMPOLINE - kstack_id * (KERNEL_STACK_SIZE + PAGE_SIZE);</span><br><span class="line">    <span class="keyword">let</span> bottom = top - KERNEL_STACK_SIZE;</span><br><span class="line">    (bottom, top)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">kstack_alloc</span></span>() -&gt; KernelStack &#123;</span><br><span class="line">    <span class="keyword">let</span> kstack_id = KSTACK_ALLOCATOR.exclusive_access().alloc();</span><br><span class="line">    <span class="keyword">let</span> (kstack_bottom, kstack_top) = kernel_stack_position(kstack_id);</span><br><span class="line">    KERNEL_SPACE.exclusive_access().insert_framed_area(</span><br><span class="line">        kstack_bottom.into(),</span><br><span class="line">        kstack_top.into(),</span><br><span class="line">        MapPermission::R | MapPermission::W,</span><br><span class="line">    );</span><br><span class="line">    KernelStack(kstack_id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">Drop</span> <span class="keyword">for</span> KernelStack &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">drop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> (kernel_stack_bottom, _) = kernel_stack_position(<span class="keyword">self</span>.<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">let</span> kernel_stack_bottom_va: VirtAddr = kernel_stack_bottom.into();</span><br><span class="line">        KERNEL_SPACE</span><br><span class="line">            .exclusive_access()</span><br><span class="line">            .remove_area_with_start_vpn(kernel_stack_bottom_va.into());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We will do the same for user stack:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/config.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> TRAMPOLINE: <span class="built_in">usize</span> = <span class="built_in">usize</span>::MAX - PAGE_SIZE + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> TRAP_CONTEXT_BASE: <span class="built_in">usize</span> = TRAMPOLINE - PAGE_SIZE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// os/src/task/id.rs</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">trap_cx_bottom_from_tid</span></span>(tid: <span class="built_in">usize</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">    TRAP_CONTEXT_BASE - tid * PAGE_SIZE</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">ustack_bottom_from_tid</span></span>(ustack_base: <span class="built_in">usize</span>, tid: <span class="built_in">usize</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">    ustack_base + tid * (PAGE_SIZE + USER_STACK_SIZE)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then, <code>TaskUserRes</code> could be allocated with trap and user stack.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// impl TaskUserRes</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">alloc_user_res</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">	<span class="keyword">let</span> process = <span class="keyword">self</span>.process.upgrade().unwrap();</span><br><span class="line">	<span class="keyword">let</span> <span class="keyword">mut</span> process_inner = process.inner_exclusive_access();</span><br><span class="line">	<span class="comment">// alloc user stack</span></span><br><span class="line">	<span class="keyword">let</span> ustack_bottom = ustack_bottom_from_tid(<span class="keyword">self</span>.ustack_base, <span class="keyword">self</span>.tid);</span><br><span class="line">	<span class="keyword">let</span> ustack_top = ustack_bottom + USER_STACK_SIZE;</span><br><span class="line">	process_inner.memory_set.insert_framed_area(</span><br><span class="line">		ustack_bottom.into(),</span><br><span class="line">		ustack_top.into(),</span><br><span class="line">		MapPermission::R | MapPermission::W | MapPermission::U,</span><br><span class="line">	);</span><br><span class="line">	<span class="comment">// alloc trap_cx</span></span><br><span class="line">	<span class="keyword">let</span> trap_cx_bottom = trap_cx_bottom_from_tid(<span class="keyword">self</span>.tid);</span><br><span class="line">	<span class="keyword">let</span> trap_cx_top = trap_cx_bottom + PAGE_SIZE;</span><br><span class="line">	process_inner.memory_set.insert_framed_area(</span><br><span class="line">		trap_cx_bottom.into(),</span><br><span class="line">		trap_cx_top.into(),</span><br><span class="line">		MapPermission::R | MapPermission::W,</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now, combine all things together:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/task/task.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">TaskControlBlock</span></span> &#123;</span><br><span class="line">    <span class="comment">// immutable</span></span><br><span class="line">    <span class="keyword">pub</span> process: Weak&lt;ProcessControlBlock&gt;,</span><br><span class="line">    <span class="keyword">pub</span> kstack: KernelStack,</span><br><span class="line">    <span class="comment">// mutable</span></span><br><span class="line">    inner: UPSafeCell&lt;TaskControlBlockInner&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">TaskControlBlockInner</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> res: <span class="built_in">Option</span>&lt;TaskUserRes&gt;,</span><br><span class="line">    <span class="keyword">pub</span> trap_cx_ppn: PhysPageNum,</span><br><span class="line">    <span class="keyword">pub</span> task_cx: TaskContext,</span><br><span class="line">    <span class="keyword">pub</span> task_status: TaskStatus,</span><br><span class="line">    <span class="keyword">pub</span> exit_code: <span class="built_in">Option</span>&lt;<span class="built_in">i32</span>&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Design-Data-Operation"><a href="#Design-Data-Operation" class="headerlink" title="Design Data Operation"></a>Design Data Operation</h3><p>We still get one task in operation rather process, because itâ€™s the smallest instance unit. However, we need some interface to control process id.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">add_task</span></span>(task: Arc&lt;TaskControlBlock&gt;);</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">remove_task</span></span>(task: Arc&lt;TaskControlBlock&gt;);</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">fetch_task</span></span>() -&gt; <span class="built_in">Option</span>&lt;Arc&lt;TaskControlBlock&gt;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">pid2process</span></span>(pid: <span class="built_in">usize</span>) -&gt; <span class="built_in">Option</span>&lt;Arc&lt;ProcessControlBlock&gt;&gt;;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">insert_into_pid2process</span></span>(pid: <span class="built_in">usize</span>, process: Arc&lt;ProcessControlBlock&gt;);</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">remove_from_pid2process</span></span>(pid: <span class="built_in">usize</span>);</span><br></pre></td></tr></table></figure>

<p>Actually, many thing is same, for example:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/task/process.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> ProcessControlBlock &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(elf_data: &amp;[<span class="built_in">u8</span>]) -&gt; Arc&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">let</span> pid_handle = pid_alloc();</span><br><span class="line">        <span class="keyword">let</span> process = ...;</span><br><span class="line">        <span class="keyword">let</span> task = Arc::new(TaskControlBlock::new(</span><br><span class="line">            Arc::clone(&amp;process),</span><br><span class="line">            ustack_base,</span><br><span class="line">            <span class="literal">true</span>,</span><br><span class="line">        ));</span><br><span class="line">		<span class="comment">// initiation of task...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> process_inner = process.inner_exclusive_access();</span><br><span class="line">        process_inner.tasks.push(<span class="literal">Some</span>(Arc::clone(&amp;task)));</span><br><span class="line">        <span class="built_in">drop</span>(process_inner);</span><br><span class="line">        insert_into_pid2process(process.getpid(), Arc::clone(&amp;process));</span><br><span class="line">        <span class="comment">// add main thread to scheduler</span></span><br><span class="line">        add_task(task);</span><br><span class="line">        process</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If we <code>fork</code> a process, we only extract the first task which is itself, so no others will be copied.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">fork</span></span>(<span class="keyword">self</span>: &amp;Arc&lt;<span class="keyword">Self</span>&gt;) -&gt; Arc&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">	<span class="keyword">let</span> child = ...;</span><br><span class="line">	parent.children.push(Arc::clone(&amp;child));</span><br><span class="line">	<span class="keyword">let</span> task = Arc::new(TaskControlBlock::new(</span><br><span class="line">		Arc::clone(&amp;child),</span><br><span class="line">		parent</span><br><span class="line">			.get_task(<span class="number">0</span>)</span><br><span class="line">			.inner_exclusive_access()</span><br><span class="line">			.res</span><br><span class="line">			.as_ref()</span><br><span class="line">			.unwrap()</span><br><span class="line">			.ustack_base(),</span><br><span class="line">		<span class="comment">// here we do not allocate trap_cx or ustack again</span></span><br><span class="line">		<span class="comment">// but mention that we allocate a new kstack here</span></span><br><span class="line">		<span class="literal">false</span>,</span><br><span class="line">	));</span><br><span class="line">	<span class="keyword">let</span> <span class="keyword">mut</span> child_inner = child.inner_exclusive_access();</span><br><span class="line">	child_inner.tasks.push(<span class="literal">Some</span>(Arc::clone(&amp;task)));</span><br><span class="line">	<span class="built_in">drop</span>(child_inner);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Design-System-Operation"><a href="#Design-System-Operation" class="headerlink" title="Design System Operation"></a>Design System Operation</h3><p>If we want to create a thread, as a naive designer, we only need the function entry addr, and arguments, yes! Thatâ€™s it!</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/syscall/thread.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">sys_thread_create</span></span>(entry: <span class="built_in">usize</span>, arg: <span class="built_in">usize</span>) -&gt; <span class="built_in">isize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> task = current_task().unwrap();</span><br><span class="line">    <span class="keyword">let</span> process = task.process.upgrade().unwrap();</span><br><span class="line">    <span class="comment">// create a new thread</span></span><br><span class="line">    <span class="keyword">let</span> new_task = Arc::new(TaskControlBlock::new(</span><br><span class="line">        Arc::clone(&amp;process),</span><br><span class="line">        task.inner_exclusive_access().res.as_ref().unwrap().ustack_base,</span><br><span class="line">        <span class="literal">true</span>,</span><br><span class="line">    ));</span><br><span class="line">    <span class="comment">// add new task to scheduler</span></span><br><span class="line">    add_task(Arc::clone(&amp;new_task));</span><br><span class="line">    <span class="keyword">let</span> new_task_inner = new_task.inner_exclusive_access();</span><br><span class="line">    <span class="keyword">let</span> new_task_res = new_task_inner.res.as_ref().unwrap();</span><br><span class="line">    <span class="keyword">let</span> new_task_tid = new_task_res.tid;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> process_inner = process.inner_exclusive_access();</span><br><span class="line">    <span class="comment">// add new thread to current process</span></span><br><span class="line">    <span class="keyword">let</span> tasks = &amp;<span class="keyword">mut</span> process_inner.tasks;</span><br><span class="line">    <span class="keyword">while</span> tasks.len() &lt; new_task_tid + <span class="number">1</span> &#123;</span><br><span class="line">        tasks.push(<span class="literal">None</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    tasks[new_task_tid] = <span class="literal">Some</span>(Arc::clone(&amp;new_task));</span><br><span class="line">    <span class="keyword">let</span> new_task_trap_cx = new_task_inner.get_trap_cx();</span><br><span class="line">    *new_task_trap_cx = TrapContext::app_init_context(</span><br><span class="line">        entry,</span><br><span class="line">        new_task_res.ustack_top(),</span><br><span class="line">        kernel_token(),</span><br><span class="line">        new_task.kstack.get_top(),</span><br><span class="line">        trap_handler <span class="keyword">as</span> <span class="built_in">usize</span>,</span><br><span class="line">    );</span><br><span class="line">    (*new_task_trap_cx).x[<span class="number">10</span>] = arg;</span><br><span class="line">    new_task_tid <span class="keyword">as</span> <span class="built_in">isize</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now, <code>sys_exit</code> will receive a <code>exit_code</code> and recycle its resource. Notice, if <code>tid == 0</code>, the thread of process itself will make other sub threads moved to <code>init</code> process.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pub fn exit_current_and_run_next(exit_code: i32) &#123;</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="keyword">mut</span> initproc_inner = INITPROC.inner_exclusive_access();</span><br><span class="line">	<span class="keyword">for</span> child <span class="keyword">in</span> process_inner.children.iter() &#123;</span><br><span class="line">		child.inner_exclusive_access().parent = <span class="literal">Some</span>(Arc::downgrade(&amp;INITPROC));</span><br><span class="line">		initproc_inner.children.push(child.clone());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut</span> recycle_res = <span class="built_in">Vec</span>::&lt;TaskUserRes&gt;::new();</span><br><span class="line"><span class="keyword">for</span> task <span class="keyword">in</span> process_inner.tasks.iter().filter(|t| t.is_some()) &#123;</span><br><span class="line">	<span class="keyword">let</span> task = task.as_ref().unwrap();</span><br><span class="line">	remove_inactive_task(Arc::clone(&amp;task));</span><br><span class="line">	<span class="keyword">let</span> <span class="keyword">mut</span> task_inner = task.inner_exclusive_access();</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(res) = task_inner.res.take() &#123;</span><br><span class="line">		recycle_res.push(res);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sys_waittid</code> will check thread state and recycle if could, return <code>-2</code> if it has not exited. Why need it? Because <code>sys_exit</code> canâ€™t recycle itself unless the thread of process, other thread can call <code>waittid</code> to remove it from tasks queue, then it will be cleared by rust!</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/syscall/thread.rs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// thread does not exist, return -1</span></span><br><span class="line"><span class="comment">/// thread has not exited yet, return -2</span></span><br><span class="line"><span class="comment">/// otherwise, return thread's exit code</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">sys_waittid</span></span>(tid: <span class="built_in">usize</span>) -&gt; <span class="built_in">i32</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> task = current_task().unwrap();</span><br><span class="line">    <span class="keyword">let</span> process = task.process.upgrade().unwrap();</span><br><span class="line">    <span class="keyword">let</span> task_inner = task.inner_exclusive_access();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> process_inner = process.inner_exclusive_access();</span><br><span class="line">    <span class="comment">// a thread cannot wait for itself</span></span><br><span class="line">    <span class="keyword">if</span> task_inner.res.as_ref().unwrap().tid == tid &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> exit_code: <span class="built_in">Option</span>&lt;<span class="built_in">i32</span>&gt; = <span class="literal">None</span>;</span><br><span class="line">    <span class="keyword">let</span> waited_task = process_inner.tasks[tid].as_ref();</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(waited_task) = waited_task &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(waited_exit_code) = waited_task.inner_exclusive_access().exit_code &#123;</span><br><span class="line">            exit_code = <span class="literal">Some</span>(waited_exit_code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// waited thread does not exist</span></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(exit_code) = exit_code &#123;</span><br><span class="line">        <span class="comment">// dealloc the exited thread</span></span><br><span class="line">        process_inner.tasks[tid] = <span class="literal">None</span>;</span><br><span class="line">        exit_code</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// waited thread has not exited</span></span><br><span class="line">        -<span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2025/04/27/Chap8-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/04/27/Chap8-2/" class="post-title-link" itemprop="url">rcore-handnote-8-2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-27 09:40:28" itemprop="dateCreated datePublished" datetime="2025-04-27T09:40:28+00:00">2025-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-06 07:13:15" itemprop="dateModified" datetime="2025-05-06T07:13:15+00:00">2025-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/handnote/" itemprop="url" rel="index"><span itemprop="name">handnote</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Chapter-8-2"><a href="#Chapter-8-2" class="headerlink" title="Chapter 8-2"></a>Chapter 8-2</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>We will develop exclusion mechanism previously mentioned.</p>
<p>Beside construction, we need to abstract possible situation of data sharing. A usual native thought is a thread want to modify one thing but due to thread switch, the data is already modified and we get wrong result. So based on this, we want a operation to be <strong>Atomic</strong>, which means the operation excluding others. Now we can alleviate this restriction and generalize this.</p>
<h3 id><a href="#" class="headerlink" title></a></h3><p>Generalization:</p>
<ul>
<li>Allow multiple but finite thread can join one atomic operation.</li>
<li>Allow condition of atomic operation.</li>
</ul>
<p>Before such generalization, we want a way to represent atomic operation. We call the content of this operation <strong>Critical Section</strong>, and multiple threads operations in indeterminate time sequence <strong>Race Condition</strong>. So the basic problem of data sharing push us to identify multiple different operations by different threads, we canâ€™t restrict data because the problem is on modification by threads, we need to <strong>Lock</strong> operations!</p>
<p>So, it thereâ€™s a lock sharing by threads, each threads can declare <strong>Lock it!</strong>, and no other threads can access this thread again.</p>
<p>Now, back to our generalization. If this lock has a bound of access number, many can access until reaching a bound. Thatâ€™s also a reasonable design, we call this <strong>Semaphore</strong>; If this lock has a signal which one thread can send it to others to allow others to access it, Thatâ€™s also a reasonable design, we call this <strong>Condition Variable</strong>.</p>
<p>If the real minimal sharing thing is <strong>Lock</strong> rather than data, we can discard so called data problem, and focus on lock itself, each threads can do anything in this lock and excluding others.</p>
<h3 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h3><p>No matter which kinds of lock, this is shared among threads.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ProcessControlBlock</span></span> &#123;</span><br><span class="line">    <span class="comment">// immutable</span></span><br><span class="line">    <span class="keyword">pub</span> pid: PidHandle,</span><br><span class="line">    <span class="comment">// mutable</span></span><br><span class="line">    inner: UPSafeCell&lt;ProcessControlBlockInner&gt;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ProcessControlBlockInner</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">pub</span> lock_list: <span class="built_in">Vec</span>&lt;<span class="built_in">Option</span>&lt;Arc&lt;Lock&gt;&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Lock</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> inner: UPSafeCell&lt;LockInner&gt;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">LockInner</span></span> &#123;</span><br><span class="line">	<span class="keyword">pub</span> data: ...</span><br><span class="line">    <span class="keyword">pub</span> wait_queue: VecDeque&lt;Arc&lt;TaskControlBlock&gt;&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In such design, one lock can push one thread to  <code>wait_queue</code> to stop it, and pop front to start it. <code>data</code> is a generalization for various locks.</p>
<p>Then, in one process, it owns many locks used in various conditions, one can easily take it as a generalization of many data(actually nothing related to real data) we want to share.</p>
<h3 id="Basic-Lock"><a href="#Basic-Lock" class="headerlink" title="Basic Lock"></a>Basic Lock</h3><p>Now, we want to construct a basic lock allowing simple <code>lock</code>, <code>unlock</code> operation.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Mutex</span></span>: <span class="built_in">Sync</span> + <span class="built_in">Send</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">lock</span></span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">unlock</span></span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Usually, thereâ€™s U-level, M-level, S-level implementation. First, we gonna try first one easily, knowing the heuristic design of M-level, and extend basic thought to S-level.</p>
<hr>
<h4 id="U-level"><a href="#U-level" class="headerlink" title="U-level"></a>U-level</h4><p>A naive approach is to declare a global boolean indicating block state. <code>lock</code> will wait if the boolean is true and try to set it to true, and <code>unlock</code> will set it to false to release.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> mutex :<span class="built_in">i32</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">lock</span></span>(mutex: <span class="built_in">i32</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (mutex);</span><br><span class="line">    mutex = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">unlock</span></span>(mutex: <span class="built_in">i32</span>)&#123;</span><br><span class="line">    mutex = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, thatâ€™s wrong! We canâ€™t construct lock by things we want to lock! Threads can jump in any instructions and break it! Thatâ€™s means we canâ€™t do it in U-level? We should ponder further in real situation, imagine two threads modify one thing in nearly same time, if we could set two global state in a operation that excluding each other(for example, one state set to 1 and another state set to 0), then only one operation can really be implemented and we can check this condition, allow it to get the lock.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> flag : [<span class="built_in">i32</span>;<span class="number">2</span>] = [<span class="number">0</span>,<span class="number">0</span>]; <span class="comment">// å“ªä¸ªçº¿ç¨‹æƒ³æ‹¿åˆ°é”ï¼Ÿ</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> turn : <span class="built_in">i32</span> = <span class="number">0</span>;         <span class="comment">// æŽ’å·ï¼šè½®åˆ°å“ªä¸ªçº¿ç¨‹? (çº¿ç¨‹ 0 or 1?)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">lock</span></span>() &#123;</span><br><span class="line">    flag[<span class="keyword">self</span>] = <span class="number">1</span>;             <span class="comment">// è®¾ç½®è‡ªå·±æƒ³å–é” self: çº¿ç¨‹ ID</span></span><br><span class="line">    turn = <span class="number">1</span> - <span class="keyword">self</span>;            <span class="comment">// è®¾ç½®å¦å¤–ä¸€ä¸ªçº¿ç¨‹å…ˆæŽ’å·</span></span><br><span class="line">    <span class="keyword">while</span> ((flag[<span class="number">1</span>-<span class="keyword">self</span>] == <span class="number">1</span>) &amp;&amp; (turn == <span class="number">1</span> - <span class="keyword">self</span>)); <span class="comment">// å¿™ç­‰</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">unlock</span></span>() &#123;</span><br><span class="line">    flag[<span class="keyword">self</span>] = <span class="number">0</span>;             <span class="comment">// è®¾ç½®è‡ªå·±æ”¾å¼ƒé”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now analyze the code, we find that no matter which flag is 1, or both 1, indicating certain thread want to get lock, <code>turn</code> will be a excluding state to <code>flag</code>, which means if another thread modify <code>turn</code> in same time, the turn can only be in one of the state and only one thread can get the lock.</p>
<hr>
<h4 id="M-level"><a href="#M-level" class="headerlink" title="M-level"></a>M-level</h4><p>Is there any predefined operation in instructions that is atomic? Then we can use it as a lock. The answer is <strong>Yes</strong>, in RISC-V, itâ€™s:</p>
<ul>
<li>AMO: Atomic memory operation</li>
<li>LR/SC: Load Reserved/Store Conditional</li>
</ul>
<p><strong>AMO</strong>: will read the value in memory and write new value, then store the old value to target register(s.t. <code>amoadd.w rd, rs2, (rs1)</code>). </p>
<p><strong>LR/SC</strong>: <strong>LR</strong> will read memory and store in target register, and leave the addr of this memory, then <strong>SC</strong> could check the addr and write data to this addr, output a condition(0/1) to target register.(s.t. <code>lr.w rd, (rs1)</code>, <code>sc.w rd, rs2, (rs1)</code>)</p>
<p>We can use it to implement a atomic function:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># RISC-V sequence for implementing a TAS  at (s1)</span><br><span class="line">li t2, 1                 # t2 &lt;-- 1</span><br><span class="line">Try: lr  t1, s1          # t1 &lt;-- mem[s1]  (load reserved)</span><br><span class="line">        bne t1, x0, Try     # if t1 !&#x3D; 0, goto Try:</span><br><span class="line">        sc  t0, s1, t2      # mem[s1] &lt;-- t2  (store conditional)</span><br><span class="line">        bne t0, x0, Try     # if t0 !&#x3D;0 (&#39;sc&#39; Instr failed), goto Try:</span><br><span class="line">Locked:</span><br><span class="line">        ...                 # critical section</span><br><span class="line">Unlock:</span><br><span class="line">        sw x0,0(s1)         # mem[s1] &lt;-- 0</span><br></pre></td></tr></table></figure>

<p>Here the logic of <code>Try</code> is <code>mem[s1]</code> would be zero if itâ€™s unlocked, and would be non-zero if itâ€™s locked. So, <code>Try</code> will compare <code>t1</code> and <code>x0</code>, actually <code>mem[s1]</code> and <code>0</code>, if equal to zero, then try to store <code>t2</code> into <code>s1</code>, if succeed, it will compare it again for the output signal <code>t0</code> and <code>x0</code>, actually the output signal and <code>0</code>, if succeed, it will jump out otherwise repeat.In this process, if the write operation failed, <code>t0</code> would be non-zero, and repeat in <code>Try</code>.</p>
<p>If we want to <code>Unlock</code>, we write <code>x0</code> to <code>s1</code> to set <code>mem[s1]</code> to zero. Which is the unlocked state.</p>
<h4 id="S-level"><a href="#S-level" class="headerlink" title="S-level"></a>S-level</h4><p>Then we could take the function to rust and package it. A simple refactor is when we in repetition loop, we <code>yield</code>, and give CPU to others.</p>
<hr>
<p>Now, for any kinds of locks, we could apply it to our structure.</p>
<p>First, when we create a lock, we create and push it to list or set in empty element.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/syscall/sync.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">sys_mutex_create</span></span>(blocking: <span class="built_in">bool</span>) -&gt; <span class="built_in">isize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> process = current_process();</span><br><span class="line">    <span class="keyword">let</span> mutex: <span class="built_in">Option</span>&lt;Arc&lt;<span class="keyword">dyn</span> Mutex&gt;&gt; = <span class="keyword">if</span> !blocking &#123;</span><br><span class="line">        <span class="literal">Some</span>(Arc::new(MutexSpin::new()))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">Some</span>(Arc::new(MutexBlocking::new()))</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> process_inner = process.inner_exclusive_access();</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(id) = process_inner</span><br><span class="line">        .mutex_list</span><br><span class="line">        .iter()</span><br><span class="line">        .enumerate()</span><br><span class="line">        .find(|(_, item)| item.is_none())</span><br><span class="line">        .map(|(id, _)| id)</span><br><span class="line">    &#123;</span><br><span class="line">        process_inner.mutex_list[id] = mutex;</span><br><span class="line">        id <span class="keyword">as</span> <span class="built_in">isize</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        process_inner.mutex_list.push(mutex);</span><br><span class="line">        process_inner.mutex_list.len() <span class="keyword">as</span> <span class="built_in">isize</span> - <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When we call <code>lock</code>, we should provide corresponding id of the lock, if itâ€™s already locked, we push to <code>wait_queue</code>, else we lock it and goes on.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/syscall/sync.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">sys_mutex_lock</span></span>(mutex_id: <span class="built_in">usize</span>) -&gt; <span class="built_in">isize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> process = current_process();</span><br><span class="line">    <span class="keyword">let</span> process_inner = process.inner_exclusive_access();</span><br><span class="line">    <span class="keyword">let</span> mutex = Arc::clone(process_inner.mutex_list[mutex_id].as_ref().unwrap());</span><br><span class="line">    <span class="built_in">drop</span>(process_inner);</span><br><span class="line">    <span class="built_in">drop</span>(process);</span><br><span class="line">    mutex.lock();</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// os/src/sync/mutex.rs</span></span><br><span class="line"><span class="keyword">impl</span> Lock <span class="keyword">for</span> MutexBlocking &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">lock</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> mutex_inner = <span class="keyword">self</span>.inner.exclusive_access();</span><br><span class="line">        <span class="keyword">if</span> ... &#123;</span><br><span class="line">            mutex_inner.wait_queue.push_back(current_task().unwrap());</span><br><span class="line">			<span class="comment">// ... other operations</span></span><br><span class="line">            <span class="built_in">drop</span>(mutex_inner);</span><br><span class="line">            block_current_and_run_next();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// ... other operations</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Same reverse operation:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/syscall/sync.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">sys_mutex_unlock</span></span>(mutex_id: <span class="built_in">usize</span>) -&gt; <span class="built_in">isize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> process = current_process();</span><br><span class="line">    <span class="keyword">let</span> process_inner = process.inner_exclusive_access();</span><br><span class="line">    <span class="keyword">let</span> mutex = Arc::clone(process_inner.mutex_list[mutex_id].as_ref().unwrap());</span><br><span class="line">    <span class="built_in">drop</span>(process_inner);</span><br><span class="line">    <span class="built_in">drop</span>(process);</span><br><span class="line">    mutex.unlock();</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// os/src/sync/mutex.rs</span></span><br><span class="line"><span class="keyword">impl</span> Mutex <span class="keyword">for</span> MutexBlocking &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">unlock</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> mutex_inner = <span class="keyword">self</span>.inner.exclusive_access();</span><br><span class="line">		<span class="comment">// ... other operation</span></span><br><span class="line">		<span class="keyword">if</span> ... &#123;</span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(waking_task) = mutex_inner.wait_queue.pop_front() &#123;</span><br><span class="line">				add_task(waking_task);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><p>Itâ€™s simple, we only need to switch boolean to number and check the bound. So, the initiated count is the bound, if one thread access, it will minus one, and release, add one. We only need to check positive or negative.</p>
<p>Apply our structure:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">up</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> inner = <span class="keyword">self</span>.inner.exclusive_access();</span><br><span class="line">    inner.count += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> inner.count &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(task) = inner.wait_queue.pop_front() &#123;</span><br><span class="line">            add_task(task);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">down</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> inner = <span class="keyword">self</span>.inner.exclusive_access();</span><br><span class="line">    inner.count -= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> inner.count &lt; <span class="number">0</span> &#123;</span><br><span class="line">        inner.wait_queue.push_back(current_task().unwrap());</span><br><span class="line">        <span class="built_in">drop</span>(inner);</span><br><span class="line">        block_current_and_run_next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If the initiated count equal to <code>1</code>, we back to <code>mutex</code>!, which indicates sole thread access!</p>
<p>Actually, we could use it for <strong>synchronization</strong> operation, we set count to <code>0</code>, if one thread access, it will be blocked, and another thread will could release and add one to count, then the original thread finally could access. Then the second thread will always be advanced to first one.</p>
<p>Here, the first is always advanced to second.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> SEM_SYNC: <span class="built_in">usize</span> = <span class="number">0</span>; <span class="comment">//ä¿¡å·é‡ID</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">first</span></span>() -&gt; ! &#123;</span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"First work and wakeup Second"</span>);</span><br><span class="line">    semaphore_up(SEM_SYNC); <span class="comment">//ä¿¡å·é‡Væ“ä½œ</span></span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">second</span></span>() -&gt; ! &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Second want to continue,but need to wait first"</span>);</span><br><span class="line">    semaphore_down(SEM_SYNC); <span class="comment">//ä¿¡å·é‡Pæ“ä½œ</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Second can work now"</span>);</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Conditional-Variable"><a href="#Conditional-Variable" class="headerlink" title="Conditional Variable"></a>Conditional Variable</h3><p>If we want one thread owns the ability of release lock for others, we need the <code>CondVar</code>. We have to dispatch operation in <code>wait_queue</code>, if one thread <code>signal</code> others, it will pop out a thread, which means trigger it <strong>You are free!</strong>. And if one thread <code>wait</code>, it will push itself to queue to <strong>wait</strong>, The unlock and lock is important because in wait operation, it allow other thread to modify <strong>condition</strong>, but it should be after of the push operation, in case that the signal is before the push, then we can never receive the signal again! We wonâ€™t encapsulate condition check to <code>CondVar</code> because it should leave to user to design it, we only leave out interface for user.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">signal</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="keyword">mut</span> inner = <span class="keyword">self</span>.inner.exclusive_access();</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(task) = inner.wait_queue.pop_front() &#123;</span><br><span class="line">		add_task(task);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">wait</span></span>(&amp;<span class="keyword">self</span>, mutex: Arc&lt;<span class="keyword">dyn</span> Mutex&gt;) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> inner = <span class="keyword">self</span>.inner.exclusive_access();</span><br><span class="line">    inner.wait_queue.push_back(current_task().unwrap());</span><br><span class="line">    <span class="built_in">drop</span>(inner);</span><br><span class="line">    mutex.unlock();                 </span><br><span class="line">    block_current_and_run_next();</span><br><span class="line">    mutex.lock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, if condition check is leave out to user, we canâ€™t ensure the condition be violated due to data sharing, so usually we need to append <code>mutex</code> lock for this section.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> A: <span class="built_in">usize</span> = <span class="number">0</span>;   <span class="comment">//å…¨å±€å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CONDVAR_ID: <span class="built_in">usize</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> MUTEX_ID: <span class="built_in">usize</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">first</span></span>() -&gt; ! &#123;</span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"First work, Change A --&gt; 1 and wakeup Second"</span>);</span><br><span class="line">    mutex_lock(MUTEX_ID);</span><br><span class="line">    A=<span class="number">1</span>;</span><br><span class="line">    condvar_signal(CONDVAR_ID);</span><br><span class="line">    mutex_unlock(MUTEX_ID);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">second</span></span>() -&gt; ! &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Second want to continue,but need to wait A=1"</span>);</span><br><span class="line">    mutex_lock(MUTEX_ID);</span><br><span class="line">    <span class="keyword">while</span> A==<span class="number">0</span> &#123;</span><br><span class="line">        condvar_wait(CONDVAR_ID, MUTEX_ID);</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_unlock(MUTEX_ID);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We can see that if <code>A=1</code>, second wonâ€™t <code>wait</code> repeatly, and goes out.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2025/04/27/day-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/04/27/day-1/" class="post-title-link" itemprop="url">arceos-handnote-1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-27 09:40:28" itemprop="dateCreated datePublished" datetime="2025-04-27T09:40:28+00:00">2025-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-06 07:13:15" itemprop="dateModified" datetime="2025-05-06T07:13:15+00:00">2025-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/handnote/" itemprop="url" rel="index"><span itemprop="name">handnote</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Day-1"><a href="#Day-1" class="headerlink" title="Day-1"></a>Day-1</h2><h2 id="Component-Kernel"><a href="#Component-Kernel" class="headerlink" title="Component Kernel"></a>Component Kernel</h2><p>Based on experiment, we will construct kernel in increment by demand.</p>
<ul>
<li><strong>UniKernel</strong>: Single S-Level, App is within kernel.</li>
</ul>
<p>Each kernel instance can be considered as a construction based on unikernel.</p>
<ul>
<li><strong>MacroKernel</strong>: Manage U-Level with support on multiple apps, process management etcâ€¦</li>
<li><strong>Hypervisor</strong>: Virtual state with restricted communication between U-level and S-level.</li>
</ul>
<h2 id="Aceros-Design"><a href="#Aceros-Design" class="headerlink" title="Aceros Design"></a>Aceros Design</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    App &lt;--&gt; Runtime</span><br><span class="line">    Runtime &lt;--&gt; HAL</span><br></pre></td></tr></table></figure>
<p>The design of Aceros is simple, first <strong>HAL</strong>(<code>axhal</code>) is the abstraction of hardware to initiation trap, stack, MMU, registers based on various architectures. Then <strong>Runtime</strong>(<code>ax*</code>) will be classified as many components to support various environments, like net, task, fs etcâ€¦</p>
<p>Each arrow is reversible, in boot, it will be from bottom to top to initiate App. Then when App call something, it will be from top to bottom to evoke functionality.</p>
<p>In real situation, we choose thing based on <em>features</em>. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">	App --&gt; axstd</span><br><span class="line">	axstd --&gt; |axfeat| aceros_api</span><br><span class="line">	aceros_api --&gt; axruntime</span><br><span class="line">	axruntime --&gt;|alloc| axalloc</span><br><span class="line">	axruntime --&gt; axhal</span><br><span class="line">	axruntime --&gt;|irq| irq</span><br><span class="line">	axruntime --&gt;|multitask| axtask</span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2025/04/27/day-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/04/27/day-3/" class="post-title-link" itemprop="url">arceos-handnote-3</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-27 09:40:28" itemprop="dateCreated datePublished" datetime="2025-04-27T09:40:28+00:00">2025-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-06 07:13:15" itemprop="dateModified" datetime="2025-05-06T07:13:15+00:00">2025-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/handnote/" itemprop="url" rel="index"><span itemprop="name">handnote</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Day-3"><a href="#Day-3" class="headerlink" title="Day-3"></a>Day-3</h2><h2 id="Device"><a href="#Device" class="headerlink" title="Device"></a>Device</h2><p>In common, devices can be separated to <strong>FS</strong>, <strong>Net</strong>, <strong>Dispaly</strong>.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A structure that contains all device drivers, organized by their category.</span></span><br><span class="line"><span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">AllDevices</span></span> &#123;</span><br><span class="line">    <span class="comment">/// All network device drivers.</span></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="meta-string">"net"</span>)]</span></span><br><span class="line">    <span class="keyword">pub</span> net: AxDeviceContainer&lt;AxNetDevice&gt;,</span><br><span class="line">    <span class="comment">/// All block device drivers.</span></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="meta-string">"block"</span>)]</span></span><br><span class="line">    <span class="keyword">pub</span> block: AxDeviceContainer&lt;AxBlockDevice&gt;,</span><br><span class="line">    <span class="comment">/// All graphics device drivers.</span></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="meta-string">"display"</span>)]</span></span><br><span class="line">    <span class="keyword">pub</span> display: AxDeviceContainer&lt;AxDisplayDevice&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Devices will be initiated in <code>axruntime</code>, where <code>axdriver</code> module will be loaded to seek each device and mount drivers.</p>
<p>In qemu, <code>virtio-mmio</code> will send request to probe driver response otherwise return 0 as non-driver.</p>
<h3 id="Block-Driver"><a href="#Block-Driver" class="headerlink" title="Block Driver"></a>Block Driver</h3><p>Block driver provide interface to write and read block providing IO operations and perennial storage.</p>
<p>Aceros use module <code>axfs</code>, with definition of interface <code>vfs</code>, and concrete implementation of <code>ramfs</code> and <code>devfs</code>.</p>
<h2 id="Monolith"><a href="#Monolith" class="headerlink" title="Monolith"></a>Monolith</h2><p>In U-Level, we will separate kernel memory and user memory, allowing user context used for process.</p>
<p>The basic logic would be construct new user space,load file to it and initiate user stack, then spawn user task with app_entry.</p>
<p>The top of page root would be shared as kernel space, and below would be independent as user space.</p>
<p>In user space separation, many kinds of resources canâ€™t be shared as global resources, rather the demand of <code>TaskExt</code> as a reference to those independent resources owned by each user apps.</p>
<p>In <code>TaskInner</code>, we store the ptr of <code>TaskExt</code> by macro declaration of such type.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AxTask</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    task_ext_ptr: *<span class="keyword">mut</span> <span class="built_in">u8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Task extended data for the monolithic kernel.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">TaskExt</span></span> &#123;</span><br><span class="line">    <span class="comment">/// The process ID.</span></span><br><span class="line">    <span class="keyword">pub</span> proc_id: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="comment">/// The user space context.</span></span><br><span class="line">    <span class="keyword">pub</span> uctx: UspaceContext,</span><br><span class="line">    <span class="comment">/// The virtual memory address space.</span></span><br><span class="line">    <span class="keyword">pub</span> aspace: Arc&lt;Mutex&lt;AddrSpace&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// It will expanded as a trait implmentation of reference to ptr as the `TaskExt` type.</span></span><br><span class="line">def_task_ext!(TaskExt)</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">spawn_user_task</span></span>(aspace: Arc&lt;Mutex&lt;AddrSpace&gt;&gt;, uctx: UspaceContext) -&gt; AxTaskRef &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> task = TaskInner::new(</span><br><span class="line">        || &#123;</span><br><span class="line">            <span class="keyword">let</span> curr = axtask::current();</span><br><span class="line">            <span class="keyword">let</span> kstack_top = curr.kernel_stack_top().unwrap();</span><br><span class="line">            ax_println!(</span><br><span class="line">                <span class="string">"Enter user space: entry=&#123;:#x&#125;, ustack=&#123;:#x&#125;, kstack=&#123;:#x&#125;"</span>,</span><br><span class="line">                curr.task_ext().uctx.get_ip(),</span><br><span class="line">                curr.task_ext().uctx.get_sp(),</span><br><span class="line">                kstack_top,</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">unsafe</span> &#123; curr.task_ext().uctx.enter_uspace(kstack_top) &#125;;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"userboot"</span>.into(),</span><br><span class="line">        crate::KERNEL_STACK_SIZE,</span><br><span class="line">    );</span><br><span class="line">    task.ctx_mut()</span><br><span class="line">        .set_page_table_root(aspace.lock().page_table_root());</span><br><span class="line">    task.init_task_ext(TaskExt::new(uctx, aspace));</span><br><span class="line">    axtask::spawn_task(task)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="NameSpace"><a href="#NameSpace" class="headerlink" title="NameSpace"></a>NameSpace</h3><p>To reuse resources, we will construct a <code>axns_resource</code> section in compilation to form a global namespace. Each will be shared by <code>Arc::new()</code>.</p>
<p>If thereâ€™s a demand of uniqueness, we will allocate space and copy them.</p>
<h3 id="Page-Fault"><a href="#Page-Fault" class="headerlink" title="Page Fault"></a>Page Fault</h3><p>We could implement lazy allocation of user space memory. We register <code>PAGE_FAULT</code> for our function and call <code>handle_page_fault</code> for <code>AddrSpace</code>.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> AddrSpace</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">handle_page_fault</span></span>(...) -&gt; ...</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(area) = <span class="keyword">self</span>.areas.find(vaddr) &#123;</span><br><span class="line">            <span class="keyword">let</span> orig_flags = area.flags();</span><br><span class="line">            <span class="keyword">if</span> orig_flags.contains(access_flags) &#123;</span><br><span class="line">                <span class="keyword">return</span> area</span><br><span class="line">                    .backend()</span><br><span class="line">                    .handle_page_fault(vaddr, orig_flags, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.pt);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><code>MemoryArea</code> has two way:</p>
<ul>
<li>Linear: direct construct map relation of memory based on physical contiguous mmemory.</li>
<li>Alloc: only construct null-map, and call <code>handle_page_fault</code> to really allocate memory.</li>
</ul>
<h3 id="User-App"><a href="#User-App" class="headerlink" title="User App"></a>User App</h3><p><strong>ELF</strong> is the default format of many apps. Kernel take the responsibility to load app to correct region.</p>
<p>Notice the offset of file and virtual space may be different due to optimization of <strong>ELF</strong>.</p>
<p>In order to load apps from linux, we will construct a <strong>Posix Api</strong> given interface mimic to linux.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2025/04/27/day-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/04/27/day-2/" class="post-title-link" itemprop="url">arceos-handnote-2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-27 09:40:28" itemprop="dateCreated datePublished" datetime="2025-04-27T09:40:28+00:00">2025-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-06 07:13:15" itemprop="dateModified" datetime="2025-05-06T07:13:15+00:00">2025-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/handnote/" itemprop="url" rel="index"><span itemprop="name">handnote</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Day-2"><a href="#Day-2" class="headerlink" title="Day-2"></a>Day-2</h2><h2 id="Paging"><a href="#Paging" class="headerlink" title="Paging"></a>Paging</h2><p>We delve into paging.</p>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Physical address for pflash#1</span></span><br><span class="line"><span class="keyword">const</span> PFLASH_START: <span class="built_in">usize</span> = <span class="number">0x2200_0000</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg_attr(feature = <span class="meta-string">"axstd"</span>, no_mangle)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="comment">// Makesure that we can access pflash region.</span></span><br><span class="line">    <span class="keyword">let</span> va = phys_to_virt(PFLASH_START.into()).as_usize();</span><br><span class="line">    <span class="keyword">let</span> ptr = va <span class="keyword">as</span> *<span class="keyword">const</span> <span class="built_in">u32</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Try to access dev region [&#123;:#X&#125;], got &#123;:#X&#125;"</span>, va, *ptr);</span><br><span class="line">        <span class="keyword">let</span> magic = mem::transmute::&lt;<span class="built_in">u32</span>, [<span class="built_in">u8</span>; <span class="number">4</span>]&gt;(*ptr);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Got pflash magic: &#123;&#125;"</span>, <span class="built_in">str</span>::from_utf8(&amp;magic).unwrap());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>PFlash</strong> is the simulation of flash memory of qemu. When qemu boot, it will automatically load file to fixed <strong>MMIO</strong>, and can be directly accessed.</p>
<p><strong>Paging</strong>: <code>feature = [&quot;paging&quot;]</code> is the way to evoke virtual memory management tu support <code>MMIO</code>. Located in <code>axruntime</code>.</p>
<p>The workflow would be:</p>
<ul>
<li>qemu fdt: from <code>0x0c00_0000</code> to <code>0x3000_0000</code>. Construct the space of device.</li>
<li>SBI: from <code>0x8000_0000</code> to <code>0x8020_0000</code>. RISC-V <strong>Supervisor Binary Interface</strong>, it construct a interface for programming language to manipulate device level things.</li>
<li>Kernel Image: from <code>0x8020_0000</code>. <code>_skernel</code> contains S-level things like static data, code etcâ€¦ <code>_ekernel</code> is user thing.</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[link_section = <span class="meta-string">".data.boot_page_table"</span>]</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> BOOT_PT_SV39: [<span class="built_in">u64</span>; <span class="number">512</span>] = [<span class="number">0</span>; <span class="number">512</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">init_boot_page_table</span></span>() &#123;</span><br><span class="line">    <span class="comment">// 0x8000_0000..0xc000_0000, VRWX_GAD, 1G block</span></span><br><span class="line">    BOOT_PT_SV39[<span class="number">2</span>] = (<span class="number">0x80000</span> &lt;&lt; <span class="number">10</span>) | <span class="number">0xef</span>;</span><br><span class="line">    <span class="comment">// 0xffff_ffc0_8000_0000..0xffff_ffc0_c000_0000, VRWX_GAD, 1G block</span></span><br><span class="line">	<span class="comment">// shift 10 bits to store flags</span></span><br><span class="line">    BOOT_PT_SV39[<span class="number">0x102</span>] = (<span class="number">0x80000</span> &lt;&lt; <span class="number">10</span>) | <span class="number">0xef</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">init_mmu</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> page_table_root = BOOT_PT_SV39.as_ptr() <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">    satp::set(satp::Mode::Sv39, <span class="number">0</span>, page_table_root &gt;&gt; <span class="number">12</span>);</span><br><span class="line">    riscv::asm::sfence_vma_all();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Each entry of page table will map 1G(<code>0x4000_0000</code>) memory. From <code>0x8000_0000</code> to <code>0xc0000_0000</code> at <code>pgd_idx = 2</code> to <code>0xffff_ffc0_8000_0000</code> to <code>0xffff_ffc0_c000_0000</code> at <code>pgd_idx = 102</code>. This will map to a bigger range.</p>
<h2 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h2><h3 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> worker = thread::spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">	<span class="built_in">println!</span>(<span class="string">"Spawned-thread ..."</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Makesure that we can access pflash region.</span></span><br><span class="line">	<span class="keyword">let</span> va = phys_to_virt(PFLASH_START.into()).as_usize();</span><br><span class="line">	<span class="keyword">let</span> ptr = va <span class="keyword">as</span> *<span class="keyword">const</span> <span class="built_in">u32</span>;</span><br><span class="line">	<span class="keyword">let</span> magic = <span class="keyword">unsafe</span> &#123;</span><br><span class="line">		mem::transmute::&lt;<span class="built_in">u32</span>, [<span class="built_in">u8</span>; <span class="number">4</span>]&gt;(*ptr)</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Ok</span>(s) = <span class="built_in">str</span>::from_utf8(&amp;magic) &#123;</span><br><span class="line">		<span class="built_in">println!</span>(<span class="string">"Got pflash magic: &#123;s&#125;"</span>);</span><br><span class="line">		<span class="number">0</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		-<span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Each task will be in concurrency and dispatched by strategy. If itâ€™s blocked, it will be moved to <code>wait_queue</code> to wait. If itâ€™s ready, it will be moved to <code>run_queue</code> which is scheduler to be dispatched.</p>
<h3 id="Message-Communication"><a href="#Message-Communication" class="headerlink" title="Message Communication"></a>Message Communication</h3><h3 id="Example-2"><a href="#Example-2" class="headerlink" title="Example"></a>Example</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> q1 = Arc::new(SpinNoIrq::new(VecDeque::new()));</span><br><span class="line"><span class="keyword">let</span> q2 = q1.clone();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> worker1 = thread::spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"worker1 ..."</span>);</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..=LOOP_NUM &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"worker1 [&#123;i&#125;]"</span>);</span><br><span class="line">        q1.lock().push_back(i);</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> If worker1 doesn't yield, others have</span></span><br><span class="line">        <span class="comment">// no chance to run until it exits!</span></span><br><span class="line">        thread::yield_now();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"worker1 ok!"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> worker2 = thread::spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"worker2 ..."</span>);</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(num) = q2.lock().pop_front() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"worker2 [&#123;num&#125;]"</span>);</span><br><span class="line">            <span class="keyword">if</span> num == LOOP_NUM &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"worker2: nothing to do!"</span>);</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> it should sleep and wait for notify!</span></span><br><span class="line">            thread::yield_now();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"worker2 ok!"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>Cooperative Scheduling</strong>: Each tasks kindly yield themselves or exit otherwise it will block everyone because the power of CPU occupation is ownned by each tasks.</p>
<p><strong>Preemptive Scheduling</strong>: Each tasks will be automatically suspended by external condition: No lock, no device access; inner condition: run out of current time slice. We can use a <code>disable_count</code> to record this, even for multiple condition restriction, we can sum them up.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">axhal::irq::register_handler(TIMER_IRQ_NUM, || &#123;</span><br><span class="line">    update_timer();</span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="meta-string">"multitask"</span>)]</span></span><br><span class="line">    axtask::on_timer_tick();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Enable IRQs before starting app</span></span><br><span class="line">axhal::arch::enable_irqs()</span><br></pre></td></tr></table></figure>

<p><code>on_timer_tick</code> will be trigger in time slice. When time ticker ticks, <code>run_queue</code> will check and suspend task if possible.</p>
<p>We can make it more dynamic. Which means each task has priority and during the implementation of cpu, each task has a <code>vruntime</code> to be dynamically adjusted by <code>init_vruntime + (delta/weight(nice))</code> where <code>delta</code> and <code>nice</code> are dynamic adjustment number. <code>delta</code> will be incremented by <code>timer</code>, <code>weight(nice)</code> is actually the priority of the task. We ensure that task with lowest <code>vruntime</code> will be placed at top.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2025/04/27/day-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/04/27/day-4/" class="post-title-link" itemprop="url">arceos-handnote-4</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-27 09:40:28" itemprop="dateCreated datePublished" datetime="2025-04-27T09:40:28+00:00">2025-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-06 07:13:15" itemprop="dateModified" datetime="2025-05-06T07:13:15+00:00">2025-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/handnote/" itemprop="url" rel="index"><span itemprop="name">handnote</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Day-4"><a href="#Day-4" class="headerlink" title="Day-4"></a>Day-4</h2><h3 id="Hypervisor"><a href="#Hypervisor" class="headerlink" title="Hypervisor"></a>Hypervisor</h3><p>A physical computer system can build multiple virtual computer system with its own virtual resources. Just like apps in U-level, each virtual system will consider themselves uniquely occupies these resources.</p>
<p><strong>Emulator</strong> like a interpretor to stimulate a virtual system while in loose demand of efficiency.</p>
<p><strong>Hypervisor</strong> will execute most instructions directly as a isomorphism of the stimulated virtual system to gain a huge efficiency.</p>
<p><strong>*I</strong> type<em>: Each virtual OS is equal on hardware.<br><strong>*II</strong> type</em>: Virtual OS is on host OS. </p>
<p>Each instance as <strong>Guest(OS Image)</strong> be loaded on our host os kernel.</p>
<h3 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h3><p>Only focus on hypervisor(I type).</p>
<p>Levels are extended, because we need to separate host and guest, so U-Level become U, VU-Level. So does the kernel level because we need to separate host, the hypervisor and guest, the virtual OS. So S-Level become HS, VS-Level.</p>
<h4 id="Communication"><a href="#Communication" class="headerlink" title="Communication"></a>Communication</h4><p>Instructions will be implemented in communication of <code>HS</code> and <code>VS</code>, when thereâ€™s a <code>sbi-call</code>, <code>VS</code> will communicate <code>HS</code> to implement.</p>
<p>In <code>hstatus</code> of RISC-V, design the virtualization mode:</p>
<p><code>SPV</code>: the source of <code>HS</code> or <code>VS</code>, which determines the <code>sret</code> to <code>VU</code> or <code>U</code>.<br><code>SPVP</code>: the permission of modification of memory that <code>HS</code> to <code>V</code>.</p>
<p>We need to store guest context and host context, then switch between <code>ret(VM-Exit)</code> and <code>sret</code>. We implement this by <code>run_guest</code> and <code>guest_exit</code> which both is the otherâ€™s reverse.</p>
<hr>
<p>Timer will be injected to <code>sbi-call</code> by setting a virtual clock in <code>VS</code>, when <code>set timer</code>, we clear timer of guest and set timer of host; when <code>interrupt</code>, we set clear timer of host and set timer of guest waiting for next request of timer.</p>
<hr>
<p>Memory will be separated based on guest and host too. <code>GVA</code> will be a map of <code>GPA</code> as guest memory. However, <code>HPA</code> take responsibility of handle <code>GPA</code> as the virtualization process.</p>
<hr>
<p>Dev will record each start <code>vaddr</code> and when <code>VM-Exit</code> of <code>PageFault</code>, it will find<code>vmdevs.find(addr)</code> and call <code>handle_mmio</code> for corresponding request.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2025/04/25/2025%E6%98%A5%E5%A4%8F%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A53%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-%E6%98%8E%E6%89%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/04/25/2025%E6%98%A5%E5%A4%8F%E5%BC%80%E6%BA%90%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%AD%E7%BB%83%E8%90%A53%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93-%E6%98%8E%E6%89%AC/" class="post-title-link" itemprop="url">2025æ˜¥å¤å¼€æºæ“ä½œç³»ç»Ÿè®­ç»ƒè¥3é˜¶æ®µæ€»ç»“-æ˜Žæ‰¬</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-25 22:33:44" itemprop="dateCreated datePublished" datetime="2025-04-25T22:33:44+00:00">2025-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-06 07:13:15" itemprop="dateModified" datetime="2025-05-06T07:13:15+00:00">2025-05-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="èµ·ç‚¹"><a href="#èµ·ç‚¹" class="headerlink" title="èµ·ç‚¹"></a>èµ·ç‚¹</h1><p>åå¤šå¹´å‰çš„ä¸€ä¸ªä¸‹åˆï¼Œæˆ‘ååœ¨ç”µè„‘å‰ï¼Œåˆ·å®Œäº†æ‰€æœ‰å‘¨å¸¸ä»»åŠ¡ã€‚æ¸¸æˆå…¬ä¼šé‡Œæœ€åŽä¸€ä½æˆå‘˜ä¸‹çº¿å›žè€å®¶åƒé¥­ã€‚è¿žç»­åœ¨çº¿åå‡ ä¸ªå°æ—¶åŽï¼Œæˆ‘é€€å‡ºæ¸¸æˆã€å…³æŽ‰ç”µæºï¼Œä¸€è‚¡å·¨å¤§çš„ç©ºè™šæ„Ÿçªç„¶æ¶Œä¸Šå¿ƒå¤´ã€‚</p>
<p>æˆ‘æ¯•ä¸šäºŽé’å²›ä¸€æ‰€ä¸“ç§‘é™¢æ ¡è®¡ç®—æœºä¸“ä¸šï¼Œä»Žè¾¾å†…åŸ¹è®­ç­ç»“ä¸šåŽï¼Œè¿›å…¥ä¸€å®¶å¯¹æ—¥å¤–åŒ…å…¬å¸ï¼Œç»´æŠ¤ç€1995å¹´å¼€å‘çš„VB6.0ç¨‹åºã€‚åœ¨é’å²›ï¼Œæœˆè–ªä¸‰åƒå…ƒçœåƒä¿­ç”¨æ‰èƒ½å‹‰å¼ºåº¦æ—¥ã€‚æˆ‘æ€»è§‰å¾—è‡ªå·±çš„èƒ½åŠ›ä¸æ­¢äºŽæ­¤ï¼Œäººç”Ÿä¸è¯¥æ˜¯è¿™å‰¯æ¨¡æ ·ã€‚</p>
<p>æƒ³è¦æ”¹å˜å´æ¯«æ— æ–¹å‘ï¼Œæ—¢ç¼ºèµ„æºåˆç¼ºæœºä¼šã€‚</p>
<p>åŽæ¥åœ¨ç½‘ä¸Šç¿»å¸–ï¼Œå¬è¯´ã€Šè®¡ç®—æœºç¨‹åºè®¾è®¡è‰ºæœ¯ã€‹æ˜¯è®¡ç®—æœºé¢†åŸŸçš„åœ£ç»ã€‚è¿™ä½æ²¡æœ‰æ–¹å‘çš„å¹´è½»äººï¼Œå†³å®šå•ƒä¸‹è¿™éƒ¨å·¨è‘—ã€‚å®ƒçš„ä½œè€…æ˜¯å›¾çµå¥–å¾—ä¸»ã€ç®—æ³•é¢†åŸŸå…ˆé©±ã€è¢«èª‰ä¸ºâ€ç®—æ³•ä¹‹çˆ¶â€çš„Donald E. Knuthã€‚ä¸ºé…åˆæœ¬ä¹¦ï¼Œä½œè€…ç”šè‡³ä¸“é—¨ç¼–å†™äº†é…å¥—æ•™æã€Šå…·ä½“æ•°å­¦ã€‹ã€‚æˆ‘ä¹°æ¥è¿™æœ¬ä¹¦ï¼Œå´åªåšæŒè¯»äº†ä¸€å¤©å°±æ”¾å¼ƒäº†ã€‚</p>
<p>æ‰¾ä¸åˆ°ã€Šå…·ä½“æ•°å­¦ã€‹çš„å…¬å¼€è¯¾ï¼Œå¶ç„¶å‘çŽ°å…¶ç›®å½•ä¸Žç¦»æ•£æ•°å­¦ç›¸ä¼¼ã€‚å¾—çŸ¥æ¸…åŽå¤§å­¦åœ¨å­¦å ‚åœ¨çº¿å¼€è®¾ã€Šç»„åˆæ•°å­¦ã€‹è¯¾ç¨‹ï¼Œæˆ‘ç«‹å³æŠ¥åå¹¶å®Œæˆå­¦ä¹ ã€‚åŒæ—¶åœ¨çŸ¥ä¹Žäº†è§£åˆ°ï¼Œè‹¥æƒ³è¡¥å……ç¼–è¯‘åŽŸç†çŸ¥è¯†ï¼Œå¯å­¦ä¹ ã€ŠSICPã€‹ï¼Œä¾¿ä¹°æ¥è¿™æœ¬ä¹¦è·Ÿç€ä¸Šå¤å½•åƒå­¦äº†å‰ä¸‰ç« ã€‚</p>
<p>è¿™ä¸¤é—¨è¯¾è®©æˆ‘èŽ·å¾—è–ªèµ„å…­å€çš„offerï¼Œä»Žé’å²›æ¬åˆ°ä¸Šæµ·åŠ å…¥åˆ›ä¸šå…¬å¸ã€‚å¦‚ä»Šä»Žä¸šåä½™å¹´ï¼Œä»Žå¤–åŒ…ç¨‹åºå‘˜åˆ°å‰ç«¯/å…¨æ ˆå·¥ç¨‹å¸ˆï¼Œå†åˆ°ç³»ç»Ÿæž¶æž„å¸ˆï¼Œç”šè‡³æ‹…ä»»è¿‡CTOã€‚ç›¸è¾ƒäºŽèµ·ç‚¹ï¼Œè¿™æˆ–è®¸ç®—å¾—ä¸Šé€†è¢­ã€‚</p>
<p>ä½†å‘½è¿çš„é½¿è½®ç©¶ç«Ÿä½•æ—¶å¼€å§‹è½¬åŠ¨ï¼Ÿ</p>
<p>æ˜¯å…³é—­æ¸¸æˆæ„Ÿåˆ°ç©ºè™šçš„é‚£ä¸ªä¸‹åˆï¼Ÿè¿˜æ˜¯ä¹°ä¸‹ã€Šå…·ä½“æ•°å­¦ã€‹ç¿»å¼€æ‰‰é¡µçš„é‚£å¤©ï¼Ÿ</p>
<p>éƒ½ä¸æ˜¯ã€‚æˆ‘å§‹ç»ˆè®¤ä¸ºï¼Œå‘½è¿çš„é½¿è½®çœŸæ­£è½¬åŠ¨å§‹äºŽæŠ¥åã€Šç»„åˆæ•°å­¦ã€‹è¯¾ç¨‹çš„é‚£ä¸€åˆ»ã€‚</p>
<p>çŽ°åœ¨é—®å‚åŠ æ“ä½œç³»ç»Ÿè®­ç»ƒè¥çš„åŒå­¦ä»¬ï¼šä½ ä»¬æ˜¯å¦å·²æ„Ÿå—åˆ°å‘½è¿é½¿è½®å¼€å§‹è½¬åŠ¨ï¼Ÿ</p>
<h1 id="é€šå…³æ”»ç•¥"><a href="#é€šå…³æ”»ç•¥" class="headerlink" title="é€šå…³æ”»ç•¥"></a>é€šå…³æ”»ç•¥</h1><p>å½“ä»Šç¤¾ä¼šè¢«èµ„æœ¬æž„å»ºçš„ä¿¡æ¯èŒ§æˆ¿ç¬¼ç½©ï¼Œæ¯å¤©è¢«Pythonç¼–ç¨‹è¯¾å¹¿å‘Šè½°ç‚¸ï¼Œç”šè‡³ä¸Šä¸‡çš„AIè¯¾ç¨‹ã€æ•°åƒå…ƒçš„çŸ¥è¯†æ˜Ÿçƒâ€¦æ‰€è°“å¤§åŽ‚é«˜Pè®²å¸ˆä»¬åäº«æ—¶ä»£çº¢åˆ©ï¼Œåˆ©ç”¨ä¿¡æ¯ä¸å¯¹ç§°æ”¶å‰²éŸ­èœï¼Œæ•™æå´æ˜¯ä¸œæ‹¼è¥¿å‡‘ã€å……æ–¥å¤§é‡é”™è¯¯å’Œè¯¯å¯¼çš„å…«è‚¡æ–‡ã€‚</p>
<p>è€Œä¸€æµå¤§å­¦çš„ä¼˜è´¨è¯¾ç¨‹å…è´¹å¼€æ”¾å´é²œä¸ºäººçŸ¥ã€‚æ­å–œè¯¸ä½çªç ´ä¿¡æ¯èŒ§æˆ¿ï¼Œæœ¬æ¬¡è®­ç»ƒè¥ä¾æ‰˜æ¸…åŽå¤§å­¦æ“ä½œç³»ç»Ÿè¯¾ç¨‹ï¼Œé…æœ‰ä¸“ä¸šå¸ˆèµ„å›¢é˜Ÿã€‚</p>
<p>ç™»å½•å®˜ç½‘å¯è§å…ˆä¿®è¦æ±‚ï¼š</p>
<ul>
<li>Rustè¯­è¨€åŸºç¡€</li>
<li>è®¡ç®—æœºç»„æˆä¸Žè®¾è®¡</li>
<li>RISC-V æ±‡ç¼–ç‰¹æƒæŒ‡ä»¤é›†</li>
</ul>
<p>ä½†ä½œä¸ºæ³¨é‡å®žè·µçš„è®­ç»ƒè¥ï¼Œæœ€ç»ˆè€ƒæ ¸æ˜¯å®Œæˆæ“ä½œç³»ç»Ÿå®žçŽ°å¹¶åœ¨QEMUéªŒè¯ã€‚è¿˜æœ‰ä¸€äº›å®˜ç½‘æœªæåŠçš„éšè—é—¨æ§›ï¼š</p>
<ul>
<li>Gitï¼šæ˜¯å¦ç†Ÿç»ƒæŽŒæ¡<code>commit</code>/<code>checkout</code>/<code>branch</code>/<code>merge</code>/<code>rebase</code>ç­‰æ“ä½œï¼Ÿ</li>
<li>Linuxï¼šæ˜¯å¦æœ‰ä½¿ç”¨ç»éªŒå¹¶ç†Ÿæ‚‰å¸¸ç”¨å‘½ä»¤ï¼Ÿ</li>
<li>è‹±è¯­ï¼šèƒ½å¦é˜…è¯»è‹±æ–‡æ–‡æ¡£ï¼ˆå³ä½¿å€ŸåŠ©ç¿»è¯‘å·¥å…·ï¼‰ï¼Ÿ</li>
<li>ç¼–ç ä¸Žè°ƒè¯•ï¼šæ˜¯å¦å…·å¤‡ä¸‡è¡Œä»£ç ç»éªŒï¼Œèƒ½å¦å°†ä»£ç æ‹†åˆ†åˆ°å¤šä¸ªå‡½æ•°å’Œæ–‡ä»¶ï¼Ÿ</li>
<li>ç½‘ç»œï¼šæ˜¯å¦èƒ½æ— éšœç¢è®¿é—®å›½é™…äº’è”ç½‘ï¼Œå¹¶ä¸ºå¼€å‘å·¥å…·é…ç½®ä»£ç†æˆ–é•œåƒæºï¼Ÿ</li>
<li>æé—®ï¼šèƒ½å¦ç²¾å‡†æè¿°é—®é¢˜å¹¶æ˜Žç¡®æ‰€éœ€å¸®åŠ©ï¼Ÿ</li>
</ul>
<p>æ¯é¡¹æŠ€èƒ½è‡³å°‘éœ€è¦10å°æ—¶å­¦ä¹ æŠ•å…¥ã€‚è‹¥ç¼ºå°‘å…¶ä¸­ä»»ä½•ä¸€é¡¹ï¼Œå®žéªŒè¿‡ç¨‹ä¸­å°†éœ€è¦ä»˜å‡ºæ›´å¤šæ—¶é—´ç²¾åŠ›æ¥è¡¥è¶³ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ„Ÿè°¢é™ˆæ¸ã€å‘å‹‡ã€çŸ³ç£Šç­‰æ•™æŽˆå¼€è®¾è¯¾ç¨‹ï¼Œæ„Ÿè°¢æŽæ˜Žè€å¸ˆæŽ¨å¹¿å®£ä¼ ï¼Œæ„Ÿè°¢åŠ©æ•™å›¢é˜Ÿçš„ä»˜å‡ºã€‚è¿™é—¨è¯¾ç¨‹ï¼š</p>
<ul>
<li>äºŽå›½ï¼šåŸ¹å…»æ“ä½œç³»ç»Ÿäººæ‰ï¼ŒåŠ©åŠ›ç§‘æŠ€è‡ªç«‹è‡ªå¼º</li>
<li>äºŽæ°‘ï¼šä¿ƒè¿›æ•™è‚²å…¬å¹³ï¼Œè®©æ•™è‚²èµ„æºåŒ®ä¹åœ°åŒºçš„å­¦ç”ŸèŽ·å¾—ä¸€æµè¯¾ç¨‹</li>
<li>äºŽæˆ‘ï¼šè¿™ä¸ªä¸“ç§‘ç”Ÿç»ˆäºŽèƒ½ä¸Ž985/211å­¦ç”Ÿç«™åœ¨åŒä¸€èµ·è·‘çº¿ã€‚è¿‡åŽ»æ€»æŠ±æ€¨å‘½è¿ä¸å…¬ï¼Œå¦‚ä»Šè¯æ˜Žè‡ªå·±çš„æœºä¼šå°±åœ¨çœ¼å‰â€”â€”æˆ‘åªéœ€å…¨åŠ›ä»¥èµ´ã€‚</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2025/04/25/2025OS%E8%AE%AD%E7%BB%83%E8%90%A5%E4%B8%80%E9%98%B6%E6%AE%B5%E8%AE%B0%E5%BD%95-%E5%88%98%E7%A7%91%E8%BF%AA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/04/25/2025OS%E8%AE%AD%E7%BB%83%E8%90%A5%E4%B8%80%E9%98%B6%E6%AE%B5%E8%AE%B0%E5%BD%95-%E5%88%98%E7%A7%91%E8%BF%AA/" class="post-title-link" itemprop="url">2025OSè®­ç»ƒè¥ä¸€é˜¶æ®µè®°å½•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-25 17:21:55" itemprop="dateCreated datePublished" datetime="2025-04-25T17:21:55+00:00">2025-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-06 07:13:15" itemprop="dateModified" datetime="2025-05-06T07:13:15+00:00">2025-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/catogory/" itemprop="url" rel="index"><span itemprop="name"><catogory></span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="2025OSè®­ç»ƒè¥ä¸€é˜¶æ®µè®°å½•"><a href="#2025OSè®­ç»ƒè¥ä¸€é˜¶æ®µè®°å½•" class="headerlink" title="2025OSè®­ç»ƒè¥ä¸€é˜¶æ®µè®°å½•"></a>2025OSè®­ç»ƒè¥ä¸€é˜¶æ®µè®°å½•</h1><p>è¯´æ˜Žä¸€ä¸‹ï¼Œæˆ‘æ˜¯æå‰ä¸ºè®­ç»ƒè¥åšå‡†å¤‡ï¼Œæ‰€ä»¥è®°å½•æ—¶é—´æ¯”å¼€è¥è¦æ—©ï¼Œæ¯•ç«Ÿä»¥æˆ‘è¿™ç§åŸºç¡€ä¸ç¬¨é¸Ÿå…ˆé£žæ€•è·Ÿä¸ä¸Šå“ˆå“ˆã€‚</p>
<h2 id="3-12"><a href="#3-12" class="headerlink" title="3.12"></a>3.12</h2><p>ä»Šå¤©å¼€å§‹å­¦Rustï¼Œä¹‹å‰å¯¹è¿™ä¸ªè¯­è¨€ä¹Ÿæ²¡å’‹æŽ¥è§¦è¿‡ï¼Œä½†æ˜¯ä¹‹å‰å­¦è¿‡ç‚¹goï¼Œéƒ½æ˜¯å‡½æ•°å¼ç¼–ç¨‹ï¼Œåº”è¯¥æœ‰ç›¸é€šå¤„å§ã€‚</p>
<p>æˆ‘æ‰¾äº†ç»éªŒè´´éƒ½è¯´çœ‹course.rsçš„Ruståœ£ç»ï¼ŒäºŽæ˜¯æŒ‰ç…§æç¤ºæ­å»ºäº†ä¸‹çŽ¯å¢ƒï¼Œæˆ‘ç”¨çš„æ˜¯ubuntu20.04ï¼Œè£…èµ·çŽ¯å¢ƒæ²¡æœ‰ç¢°åˆ°ä»€ä¹ˆé—®é¢˜ã€‚è¿˜è·Ÿç€ä½œè€…ç”¨vscodeï¼Œè£…äº†å‡ ä¸ªæŽ¨èçš„æ’ä»¶ã€‚</p>
<p>äº†è§£äº†cargo è·‘äº†ä¸‹helloworldï¼Œä¹‹å‰å†™c++çš„ï¼Œæ¯æ¬¡éƒ½è¢«çŽ¯å¢ƒæŠ˜è…¾çš„ä¸è¡Œï¼Œæ‰¾ä¸åˆ°çš„åŒ…è¿˜è¦è‡ªå·±æ‰‹åŠ¨ç¼–è¯‘ï¼Œè€Œä¸”æ˜¯winçŽ¯å¢ƒä¸‹â€¦ä¸ä¼šå†™makefileè¿˜è¦ç”¨cmakeï¼Œè¿™ä¸œè¥¿æ›´æ–°è¿˜å¿«ï¼Œæ¯ç§åº“å¤–éƒ¨æ–‡ä»¶å¯¼å…¥æ–¹å¼è¿˜ä¸ä¸€æ ·ï¼Œå¯èƒ½è¢«æŠ˜ç£¨ä¹ æƒ¯äº†è§‰å¾—è¿™å¾ˆæ­£å¸¸ã€‚åŽŸæ¥çŽ°åœ¨çš„ç¼–ç¨‹è¯­è¨€èƒ½åšåˆ°è¿™ä¹ˆåŽ‰å®³ï¼Œä¸ä»…ä¸ç”¨è‡ªå·±ç¼–è¯‘ï¼Œæ‰‹åŠ¨å¯¼å…¥ï¼Œè¿žåº“çš„å¯ç”¨æ€§ä¹Ÿä¼šæ£€æµ‹ã€‚è€Œä¸”rustè¿˜æœ‰åª²ç¾Žc++çš„æ€§èƒ½ï¼Œå¤ªåŽ‰å®³äº†ï¼ç¼–è¯‘çš„æ–¹å¼ä¹Ÿéžå¸¸ç®€å•ï¼Œtomlçš„ä¾èµ–æ–¹å¼ä¹Ÿæ¯”ä»»ä½•è¯­è¨€çš„ä¾èµ–æ–¹å¼éƒ½è¦ç®€å•ã€‚Rust åŽŸç”Ÿæ”¯æŒ UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„ä½¿ç”¨ä¸–ç•Œå„å›½æ–‡å­—ä½œä¸ºå­—ç¬¦ä¸²å†…å®¹ï¼Œå†ä¹Ÿä¸ç”¨è¢«msvcçš„å­—ç¬¦é›†é—®é¢˜æŠ˜è…¾äº†ã€‚{}ä½œä¸ºå ä½ç¬¦ï¼Œæ•°å­—ã€å­—ç¬¦ä¸²ã€ç»“æž„ä½“éƒ½èƒ½æ‰“å°ã€‚rustæœ‰å¾ˆå¥½çš„é“¾å¼ç¼–ç¨‹ç‰¹æ€§ï¼Œæ ‡å‡†åº“çš„å‡½æ•°ç†Ÿç»ƒè¿ç”¨èµ·æ¥åº”è¯¥éžå¸¸æ–¹ä¾¿ä¼˜é›…ã€‚</p>
<p>ç¬¬ä¸€ç« å˜é‡ç»‘å®šä¸Žè§£æž„ã€‚å˜é‡é»˜è®¤ä¸å¯å˜ ï¼šRustå˜é‡é»˜è®¤ä¸èƒ½ä¿®æ”¹ï¼Œå¿…é¡»åŠ <code>mut</code>æ‰èƒ½å˜æˆå¯å˜å˜é‡ã€‚è¿™ä¸ªè®¾è®¡æŒºç‰¹åˆ«çš„ï¼Œä¸€å¼€å§‹ä¸ä¹ æƒ¯ä½†ç¡®å®žèƒ½é¿å…å¾ˆå¤šæ„å¤–ä¿®æ”¹çš„bugã€‚å˜é‡é®è”½ï¼šå¯ä»¥ç”¨åŒåå˜é‡è¦†ç›–ä¹‹å‰çš„å˜é‡ï¼Œå®žé™…ä¸Šæ˜¯åˆ›å»ºäº†æ–°å˜é‡ã€‚å’Œ<code>mut</code>çš„åŒºåˆ«åœ¨äºŽä¼šåˆ›å»ºæ–°å†…å­˜ç©ºé—´ï¼Œè¿˜èƒ½ç”¨æ¥æ”¹å˜å˜é‡ç±»åž‹ã€‚è§£æž„èµ‹å€¼ ï¼šå¯ä»¥ä»Žå…ƒç»„ã€ç»“æž„ä½“ç­‰å¤æ‚ç±»åž‹ä¸­æå–å€¼èµ‹ç»™å˜é‡ï¼Œå†™æ³•å¾ˆç®€æ´ã€‚å¸¸é‡ ï¼šç”¨<code>const</code>å£°æ˜Žï¼Œå¿…é¡»æŒ‡å®šç±»åž‹ï¼Œå‘½åä¹ æƒ¯æ˜¯å…¨å¤§å†™åŠ ä¸‹åˆ’çº¿ã€‚å‘½åè§„èŒƒ ï¼šä¸‹åˆ’çº¿å¼€å¤´çš„å˜é‡åå¯ä»¥é¿å…æœªä½¿ç”¨å˜é‡çš„è­¦å‘Šã€‚</p>
<p>æ•´ä½“æ„Ÿè§‰Rustçš„å˜é‡ç³»ç»Ÿè®¾è®¡å¾—å¾ˆä¸¥è°¨ï¼Œè™½ç„¶å¼€å§‹æœ‰ç‚¹ä¸ä¹ æƒ¯ï¼Œä½†è¿™äº›ç‰¹æ€§ç¡®å®žèƒ½å†™å‡ºæ›´å®‰å…¨çš„ä»£ç ã€‚ç‰¹åˆ«æ˜¯é»˜è®¤ä¸å¯å˜è¿™ä¸ªè®¾è®¡ï¼Œå¼ºè¿«å¼€å‘è€…æƒ³æ¸…æ¥šå“ªäº›å˜é‡çœŸçš„éœ€è¦ä¿®æ”¹ã€‚</p>
<p>ç¬¬äºŒç« åŸºæœ¬ç±»åž‹ã€‚åŸºæœ¬ç±»åž‹ä¸Žc++æ²¡ä»€ä¹ˆå·®åˆ«ï¼Œç‰¹åˆ«çš„å°±æ˜¯å•å…ƒç±»åž‹ <code>()</code> ï¼Œå…¶å”¯ä¸€çš„å€¼ä¹Ÿæ˜¯ <code>()</code>ã€‚rustç¼–è¯‘å™¨å¿…é¡»åœ¨ç¼–è¯‘æœŸçŸ¥é“æˆ‘ä»¬æ‰€æœ‰å˜é‡çš„ç±»åž‹ï¼Œä½†è¿™ä¸æ„å‘³ç€éœ€è¦ä¸ºæ¯ä¸ªå˜é‡æŒ‡å®šç±»åž‹ï¼Œå®ƒå¯ä»¥æ ¹æ®å˜é‡çš„å€¼å’Œä¸Šä¸‹æ–‡ä¸­çš„ä½¿ç”¨æ–¹å¼æ¥è‡ªåŠ¨æŽ¨å¯¼å‡ºå˜é‡çš„ç±»åž‹ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®ƒæ— æ³•æŽ¨å¯¼å‡ºå˜é‡ç±»åž‹ï¼Œéœ€è¦æ‰‹åŠ¨åŽ»ç»™äºˆä¸€ä¸ªç±»åž‹æ ‡æ³¨ã€‚åœ¨æ•´æ•°ä¸Šï¼Œåœ¨release æ¨¡å¼æž„å»ºæ—¶ï¼ŒRust ä¸æ£€æµ‹æº¢å‡ºã€‚ç›¸åï¼Œå½“æ£€æµ‹åˆ°æ•´åž‹æº¢å‡ºæ—¶ï¼ŒRust ä¼šæŒ‰ç…§è¡¥ç å¾ªçŽ¯æº¢å‡ºï¼ˆ<em>twoâ€™s complement wrapping</em>ï¼‰çš„è§„åˆ™å¤„ç†ï¼Œä¹Ÿæœ‰ä¸€äº›å‡½æ•°ç”¨æ¥æ£€æŸ¥æº¢å‡ºã€‚åœ¨å¤„ç†æµ®ç‚¹æ•°è®¡ç®—æ—¶è¦ç›¸å½“æ³¨æ„ã€‚NaNä¸ºæ•°å­¦ä¸Šä¸ºå®šä¹‰ï¼Œä¸Žä¹‹äº¤äº’éƒ½ä¼šæˆä¸ºNaNã€‚</p>
<p>æˆ‘æ³¨æ„åˆ°range for i in 1..=5è¿™æ ·çš„æ–¹å¼éžå¸¸æœ‰æ„æ€å’Œæ–¹ä¾¿ï¼Œè¿˜å¯ä»¥ç”¨å­—æ¯ã€‚Rust æ‹¥æœ‰ç›¸å½“å¤šçš„æ•°å€¼ç±»åž‹. éœ€è¦ç†Ÿæ‚‰è¿™äº›ç±»åž‹æ‰€å ç”¨çš„å­—èŠ‚æ•°ï¼Œè¿™æ ·å°±çŸ¥é“è¯¥ç±»åž‹å…è®¸çš„å¤§å°èŒƒå›´ä»¥åŠé€‰æ‹©çš„ç±»åž‹æ˜¯å¦èƒ½è¡¨è¾¾è´Ÿæ•°ã€‚ç±»åž‹è½¬æ¢å¿…é¡»æ˜¯æ˜¾å¼çš„. Rust æ°¸è¿œä¹Ÿä¸ä¼šå·å·æŠŠä½ çš„ 16bit æ•´æ•°è½¬æ¢æˆ 32bit æ•´æ•°ã€‚</p>
<p>Rust çš„å‡½æ•°ä½“æ˜¯ç”±ä¸€ç³»åˆ—è¯­å¥ç»„æˆï¼Œæœ€åŽç”±ä¸€ä¸ªè¡¨è¾¾å¼æ¥è¿”å›žå€¼ï¼Œéœ€è¦åŒºåˆ†è¯­å¥å’Œè¡¨è¾¾å¼ï¼Œè¡¨è¾¾å¼æ€»è¦è¿”å›žå€¼ï¼Œåˆ†å·ç»“å°¾çš„æ˜¯è¯­å¥ã€‚</p>
<p>å½“ç”¨ <code>!</code> ä½œå‡½æ•°è¿”å›žç±»åž‹çš„æ—¶å€™ï¼Œè¡¨ç¤ºè¯¥å‡½æ•°æ°¸ä¸è¿”å›žï¼Œè¿™ç§è¯­æ³•å¾€å¾€ç”¨åšä¼šå¯¼è‡´ç¨‹åºå´©æºƒçš„å‡½æ•°ã€‚</p>
<h2 id="3-13"><a href="#3-13" class="headerlink" title="3.13"></a>3.13</h2><p>ä»Šå¤©å­¦ä¹ åŸºç¡€ç¬¬ä¸‰ç« æ‰€æœ‰æƒå’Œå€Ÿç”¨ã€‚ä¸ºäº†è§£å†³å†…å­˜å®‰å…¨é—®é¢˜ï¼Œrustæå‡ºæ‰€æœ‰æƒæ¦‚å¿µï¼Œæ‰€æœ‰æƒä¸‰æ¡è§„åˆ™ï¼šRust ä¸­æ¯ä¸€ä¸ªå€¼éƒ½è¢«ä¸€ä¸ªå˜é‡æ‰€æ‹¥æœ‰ï¼Œè¯¥å˜é‡è¢«ç§°ä¸ºå€¼çš„æ‰€æœ‰è€…ï¼›ä¸€ä¸ªå€¼åŒæ—¶åªèƒ½è¢«ä¸€ä¸ªå˜é‡æ‰€æ‹¥æœ‰ï¼Œæˆ–è€…è¯´ä¸€ä¸ªå€¼åªèƒ½æ‹¥æœ‰ä¸€ä¸ªæ‰€æœ‰è€…ï¼›å½“æ‰€æœ‰è€…ï¼ˆå˜é‡ï¼‰ç¦»å¼€ä½œç”¨åŸŸèŒƒå›´æ—¶ï¼Œè¿™ä¸ªå€¼å°†è¢«ä¸¢å¼ƒ(drop)ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> x = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">let</span> y = x;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç å¹¶æ²¡æœ‰å‘ç”Ÿæ‰€æœ‰æƒçš„è½¬ç§»ï¼ŒåŽŸå› å¾ˆç®€å•ï¼š ä»£ç é¦–å…ˆå°† <code>5</code> ç»‘å®šåˆ°å˜é‡ <code>x</code>ï¼ŒæŽ¥ç€<strong>æ‹·è´</strong> <code>x</code> çš„å€¼èµ‹ç»™ <code>y</code>ï¼Œæœ€ç»ˆ <code>x</code> å’Œ <code>y</code> éƒ½ç­‰äºŽ <code>5</code>ï¼Œå› ä¸ºæ•´æ•°æ˜¯ Rust åŸºæœ¬æ•°æ®ç±»åž‹ï¼Œæ˜¯å›ºå®šå¤§å°çš„ç®€å•å€¼ï¼Œå› æ­¤è¿™ä¸¤ä¸ªå€¼éƒ½æ˜¯é€šè¿‡<strong>è‡ªåŠ¨æ‹·è´</strong>çš„æ–¹å¼æ¥èµ‹å€¼çš„ï¼Œéƒ½è¢«å­˜åœ¨æ ˆä¸­ï¼Œå®Œå…¨æ— éœ€åœ¨å †ä¸Šåˆ†é…å†…å­˜ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line"><span class="keyword">let</span> s2 = s1;</span><br></pre></td></tr></table></figure>

<p>å½“ s1 è¢«èµ‹äºˆ s2 åŽï¼ŒRust è®¤ä¸º s1 ä¸å†æœ‰æ•ˆï¼Œå› æ­¤ä¹Ÿæ— éœ€åœ¨ s1 ç¦»å¼€ä½œç”¨åŸŸåŽ drop ä»»ä½•ä¸œè¥¿ï¼Œè¿™å°±æ˜¯æŠŠæ‰€æœ‰æƒä»Ž s1 è½¬ç§»ç»™äº† s2ï¼Œs1 åœ¨è¢«èµ‹äºˆ s2 åŽå°±é©¬ä¸Šå¤±æ•ˆäº†ã€‚å…¶å®žç±»ä¼¼äºŽc++é‡Œçš„moveã€‚å¦‚æžœä¸æƒ³å¤ºå–åŽŸæœ‰çš„æ‰€æœ‰æƒå¯ä»¥ä½¿ç”¨cloneï¼ˆï¼‰ï¼ŒruståŸºæœ¬ç±»åž‹è‡ªå¸¦cloneå±žæ€§ã€‚</p>
<p>Rusté€šè¿‡å€Ÿç”¨(Borrowing) èŽ·å–å˜é‡çš„å¼•ç”¨ï¼Œç§°ä¹‹ä¸ºå€Ÿç”¨ã€‚å¼•ç”¨åˆ†ä¸ºå¯å˜å¼•ç”¨å’Œä¸å¯å˜å¼•ç”¨ï¼ŒåŒºåˆ«å°±æ˜¯å¯ä¸å¯å˜ï¼Œè¿™ç§é™åˆ¶çš„å¥½å¤„å°±æ˜¯ä½¿ Rust åœ¨ç¼–è¯‘æœŸå°±é¿å…æ•°æ®ç«žäº‰ï¼Œä¸¤ä¸ªæˆ–æ›´å¤šçš„æŒ‡é’ˆåŒæ—¶è®¿é—®åŒä¸€æ•°æ®ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªæŒ‡é’ˆè¢«ç”¨æ¥å†™å…¥æ•°æ®ï¼Œæ²¡æœ‰åŒæ­¥æ•°æ®è®¿é—®çš„æœºåˆ¶ã€‚å¯å˜å¼•ç”¨å’Œä¸å¯å˜å¼•ç”¨ä¸å¯ä»¥åŒæ—¶å­˜åœ¨ï¼Œå¯å˜å¼•ç”¨å¯ä»¥åŒæ—¶å­˜åœ¨ä¸€ä¸ªï¼Œä¸å¯å˜å¼•ç”¨å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªã€‚</p>
<p>åŸºç¡€ç¬¬å››ç« <strong>å¤åˆç±»åž‹</strong>ã€‚&amp;s[0..len]åˆ‡ç‰‡æ“ä½œå¾ˆæ–¹ä¾¿å¾—ç”¨åˆ°stringï¼Œå­—èŠ‚åºç­‰ï¼Œ0..lenä¸ºrangeç±»ï¼Œå·¦é—­å³å¼€ï¼Œåœ¨å¤„ç†å­—èŠ‚æµæ—¶è¦æ³¨æ„ï¼Œæ±‰å­—åœ¨utf8å ä¸‰ä¸ªå­—èŠ‚ã€‚å­—ç¬¦ä¸²å­—é¢é‡ä¹Ÿæ˜¯ä¸ªåˆ‡ç‰‡ã€‚</p>
<p>å…ƒç»„æ˜¯ç”±å¤šç§ç±»åž‹ç»„åˆåˆ°ä¸€èµ·å½¢æˆçš„ï¼Œå› æ­¤å®ƒæ˜¯å¤åˆç±»åž‹ï¼Œå…ƒç»„çš„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œå…ƒç»„ä¸­å…ƒç´ çš„é¡ºåºä¹Ÿæ˜¯å›ºå®šçš„ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹è¯­æ³•åˆ›å»ºä¸€ä¸ªå…ƒç»„ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> tup: (<span class="built_in">i32</span>, <span class="built_in">f64</span>, <span class="built_in">u8</span>) = (<span class="number">500</span>, <span class="number">6.4</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>å˜é‡ <code>tup</code> è¢«ç»‘å®šäº†ä¸€ä¸ªå…ƒç»„å€¼ <code>(500, 6.4, 1)</code>ï¼Œè¯¥å…ƒç»„çš„ç±»åž‹æ˜¯ <code>(i32, f64, u8)</code>ï¼Œå…ƒç»„æ˜¯ç”¨æ‹¬å·å°†å¤šä¸ªç±»åž‹ç»„åˆåˆ°ä¸€èµ·ï¼Œå¯ä»¥ä½¿ç”¨æ¨¡å¼åŒ¹é…æˆ–è€… <code>.</code> æ“ä½œç¬¦æ¥èŽ·å–å…ƒç»„ä¸­çš„å€¼ã€‚</p>
<p>ç”¨æ¨¡å¼åŒ¹é…è§£æž„å…ƒç»„ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> (x, y, z) = tup;</span><br></pre></td></tr></table></figure>

<p>structç»“æž„ä½“å’Œcè¯­è¨€ç±»ä¼¼ï¼Œè®¿é—®å­—æ®µç”¨ . ,åˆå§‹åŒ–å®žä¾‹æ—¶ï¼Œæ¯ä¸ªå­—æ®µéƒ½éœ€è¦è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆå§‹åŒ–æ—¶çš„å­—æ®µé¡ºåºä¸éœ€è¦å’Œç»“æž„ä½“å®šä¹‰æ—¶çš„é¡ºåºä¸€è‡´ã€‚ç»“æž„ä½“ä¸­å…·æœ‰æ‰€æœ‰æƒçš„å­—æ®µè½¬ç§»å‡ºåŽ»åŽï¼Œå°†æ— æ³•å†è®¿é—®è¯¥å­—æ®µï¼Œä½†æ˜¯å¯ä»¥æ­£å¸¸è®¿é—®å…¶å®ƒçš„å­—æ®µï¼Œ</p>
<p>ç»“æž„ä½“å¿…é¡»è¦æœ‰åç§°ï¼Œä½†æ˜¯å…ƒç»„ç»“æž„ä½“çš„å­—æ®µå¯ä»¥æ²¡æœ‰åç§°ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Color</span></span>(<span class="built_in">i32</span>, <span class="built_in">i32</span>, <span class="built_in">i32</span>);</span><br><span class="line"><span class="keyword">let</span> origin = Point(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>å…ƒç»„ç»“æž„ä½“åœ¨ä½ å¸Œæœ›æœ‰ä¸€ä¸ªæ•´ä½“åç§°ï¼Œä½†æ˜¯åˆä¸å…³å¿ƒé‡Œé¢å­—æ®µçš„åç§°æ—¶å°†éžå¸¸æœ‰ç”¨ã€‚</p>
<p>å¦‚æžœæƒ³åœ¨ç»“æž„ä½“é‡ŒåŒ…å«ä¸€ä¸ªå¼•ç”¨ï¼Œå¿…é¡»å£°æ˜Žç”Ÿå‘½å‘¨æœŸã€‚å¯ä»¥ä¸ºç»“æž„ä½“æ·»åŠ debugå±žæ€§ï¼Œå®žçŽ°fmtå‡½æ•°ç”¨æ¥è‡ªå®šä¹‰æ‰“å°ç»“æž„ä½“ä¿¡æ¯ã€‚</p>
<p>æžšä¸¾ç±»æ¯”å¤§å¤šè¯­è¨€è¦å¼ºå¤§ï¼Œæ¯ä¸ªå…ƒç´ å¯ä»¥æ˜¯ç»“æž„ä½“åŒ…å«ä¸åŒä¿¡æ¯ï¼Œ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Message</span></span> &#123;</span><br><span class="line">    Quit,</span><br><span class="line">    Move &#123; x: <span class="built_in">i32</span>, y: <span class="built_in">i32</span> &#125;,</span><br><span class="line">    Write(<span class="built_in">String</span>),</span><br><span class="line">    ChangeColor(<span class="built_in">i32</span>, <span class="built_in">i32</span>, <span class="built_in">i32</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Option æžšä¸¾ç”¨äºŽå¤„ç†ç©ºå€¼ï¼Œåœ¨å…¶å®ƒç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå¾€å¾€éƒ½æœ‰ä¸€ä¸ª null å…³é”®å­—ï¼Œå½“null å¼‚å¸¸å¯¼è‡´ç¨‹åºçš„å´©æºƒæ—¶æˆ‘ä»¬éœ€è¦å¤„ç†è¿™äº› null ç©ºå€¼ã€‚Rust å¸å–äº†ä¼—å¤šæ•™è®­ï¼Œå†³å®šæŠ›å¼ƒ nullï¼Œè€Œæ”¹ä¸ºä½¿ç”¨ Option æžšä¸¾å˜é‡æ¥è¡¨è¿°è¿™ç§ç»“æžœã€‚<code>Option</code> æžšä¸¾åŒ…å«ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªæˆå‘˜è¡¨ç¤ºå«æœ‰å€¼ï¼š<code>Some(T)</code>, å¦ä¸€ä¸ªè¡¨ç¤ºæ²¡æœ‰å€¼ï¼š<code>None</code>ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Option</span></span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="literal">Some</span>(T),</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>T</code> æ˜¯æ³›åž‹å‚æ•°ï¼Œ<code>Some(T)</code>è¡¨ç¤ºè¯¥æžšä¸¾æˆå‘˜çš„æ•°æ®ç±»åž‹æ˜¯ <code>T</code>ï¼Œæ¢å¥è¯è¯´ï¼Œ<code>Some</code> å¯ä»¥åŒ…å«ä»»ä½•ç±»åž‹çš„æ•°æ®ã€‚</p>
<p>åœ¨ Rust ä¸­ï¼Œæœ€å¸¸ç”¨çš„æ•°ç»„æœ‰ä¸¤ç§ï¼Œç¬¬ä¸€ç§æ˜¯é€Ÿåº¦å¾ˆå¿«ä½†æ˜¯é•¿åº¦å›ºå®šçš„ <code>array</code>ï¼Œç¬¬äºŒç§æ˜¯å¯åŠ¨æ€å¢žé•¿çš„ä½†æ˜¯æœ‰æ€§èƒ½æŸè€—çš„ <code>Vector</code>ï¼Œåœ¨æœ¬ä¹¦ä¸­ï¼Œæˆ‘ä»¬ç§° <code>array</code> ä¸ºæ•°ç»„ï¼Œ<code>Vector</code> ä¸ºåŠ¨æ€æ•°ç»„ã€‚æ•°ç»„çš„ä¸‰è¦ç´ ï¼šé•¿åº¦å›ºå®šã€å…ƒç´ å¿…é¡»æœ‰ç›¸åŒçš„ç±»åž‹ã€ä¾æ¬¡çº¿æ€§æŽ’åˆ—ã€‚å£°æ˜Žæ–¹å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let a: [i32; 5] &#x3D; [1, 2, 3, 4, 5];</span><br></pre></td></tr></table></figure>

<h2 id="3-14"><a href="#3-14" class="headerlink" title="3.14"></a>3.14</h2><p>ä»Šå¤©å­¦ä¹ åŸºç¡€ç¬¬äº”ç« <strong>æµç¨‹æŽ§åˆ¶</strong>å’Œç¬¬å…­ç« <strong>æ¨¡å¼åŒ¹é…</strong>ã€‚æµç¨‹æŽ§åˆ¶å°±æ˜¯for â€¦ in while loopå¾ˆå®¹æ˜“ã€‚æ¨¡å¼åŒ¹é…è¿˜æ˜¯å¯¹c++eræ¯”è¾ƒæ–°é¢–ã€‚matchçš„ç”¨æ³•å’Œswitchç›¸ä¼¼ï¼Œå¼ºå¤§çš„ç‚¹åœ¨äºŽå¯ä»¥åŒæ—¶è§£æž„å†…å®¹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">match action &#123;</span><br><span class="line">            Action::Say(s) &#x3D;&gt; &#123;</span><br><span class="line">                println!(&quot;&#123;&#125;&quot;, s);</span><br><span class="line">            &#125;,</span><br><span class="line">            _ &#x3D;&gt; &#123;&#125;,</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>if let ç›¸å½“äºŽå•ä¸ªåŒ¹é…çš„matchï¼ŒåŒæ ·ç”¨äºŽèŽ·å–å¹¶è§£æž„ã€‚</p>
<p><code>matches!</code>ï¼Œå®ƒå¯ä»¥å°†ä¸€ä¸ªè¡¨è¾¾å¼è·Ÿæ¨¡å¼è¿›è¡ŒåŒ¹é…ï¼Œç„¶åŽè¿”å›žåŒ¹é…çš„ç»“æžœ <code>true</code> or <code>false</code>ã€‚</p>
<p>match å’Œ if let éƒ½å¯ä»¥è§¦å‘å˜é‡é®è”½ï¼Œå°±æ˜¯å¯ä»¥åŒåå˜é‡ä¼˜å…ˆä½¿ç”¨å½“å‰ä½œç”¨äºŽä¸‹çš„ï¼Œåœ¨å¤„ç†æ—¶å¾ˆæ–¹ä¾¿ã€‚</p>
<p>Optionè§£æž„åœ¨rustç»å¸¸ç”¨åˆ°ï¼Œè¿”å›žç»“æžœè¦ä¹ˆæ˜¯Someï¼ˆTï¼‰ï¼Œè¦ä¹ˆæ˜¯Noneï¼Œåœ¨å¤„ç†æ—¶è§£æž„å¤„ç†ä¸åŒæƒ…å†µéžå¸¸å¼ºå¤§ã€‚</p>
<p>è§£æž„æ–¹å¼è¿˜æœ‰ä¸ªwhile let ï¼Œå¯ä»¥å¾ªçŽ¯å¤„ç†è§£æž„ï¼Œæ•°ç»„å’Œå…ƒç»„ä¹Ÿå¯ä»¥ç”¨å¯¹åº”çš„ç»“æž„æ¥è§£æž„ï¼Œ_å¯ä»¥ç”¨æ¥å¿½ç•¥è¿™ä¸ªä½ç½®çš„å˜é‡ï¼ŒåŒ¹é…çš„èŒƒå›´åŒæ ·å¯ä»¥ä½¿ç”¨rangeã€‚</p>
<p>åŸºç¡€ç¬¬ä¸ƒç« <strong>æ–¹æ³•</strong>ã€‚å¯ä»¥ä½¿ç”¨impl å¯¹struct enumå®žçŽ°æ–¹æ³•ï¼Œæ–¹æ³•å…¬å¼€éœ€å‰ç½®pubï¼Œæ–¹æ³•çš„å‡½æ•°å¦‚è‹¥è°ƒç”¨ç»“æž„ä½“çš„å†…å®¹éœ€è¦ç¬¬ä¸€ä¸ªå‚æ•°ä½selfï¼Œä¸€èˆ¬æƒ…å†µæ—¶&amp;selfï¼Œåœ¨éœ€è¦å¯¹ç»“æž„ä½“å†…å®¹æ›´æ”¹æ—¶ä¸º&amp;mut selfï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä¸æ˜¯å¼•ç”¨ï¼Œselfè½¬è®©æ‰€æœ‰æƒåˆ°æ–¹æ³•é‡Œã€‚åœ¨å‡½æ•°é‡Œæ²¡æœ‰ç»“æž„ä½“çš„å¼•ç”¨æ—¶ï¼ˆå…³è”å‡½æ•°ï¼‰éœ€è¦ä½¿ç”¨ç»“æž„ä½“ï¼šï¼šæ¥è®¿é—®ï¼Œå¦åˆ™ä¸€æ¦‚ä½¿ç”¨ . æ¥è®¿é—®ã€‚impl å†…éƒ¨ä¹Ÿå¯ä»¥å£°æ˜Žå˜é‡ã€å¸¸é‡ç­‰ã€‚impl å¯ä»¥å¤šæ¬¡è¿›è¡Œå®žçŽ°ã€‚</p>
<p>ç¬¬å…«ç« æ³›åž‹ä¸Žç‰¹å¾ã€‚åœ¨ Rust ä¸­ï¼Œæ³›åž‹å‚æ•°çš„åç§°å¯ä»¥ä»»æ„èµ·ï¼Œä½†æ˜¯å‡ºäºŽæƒ¯ä¾‹éƒ½ç”¨ <code>T</code> ï¼Œä½¿ç”¨æ³›åž‹å‚æ•°ï¼Œæœ‰ä¸€ä¸ªå…ˆå†³æ¡ä»¶ï¼Œå¿…éœ€åœ¨ä½¿ç”¨å‰å¯¹å…¶è¿›è¡Œå£°æ˜Žï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">largest</span></span>&lt;T&gt;(list: &amp;[T]) -&gt; T &#123;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ³›åž‹å‡½æ•°çš„ä½œç”¨æ˜¯ä»Žåˆ—è¡¨ä¸­æ‰¾å‡ºæœ€å¤§çš„å€¼ï¼Œå…¶ä¸­åˆ—è¡¨ä¸­çš„å…ƒç´ ç±»åž‹ä¸º Tã€‚é¦–å…ˆ <code>largest&lt;T&gt;</code> å¯¹æ³›åž‹å‚æ•° <code>T</code> è¿›è¡Œäº†å£°æ˜Žï¼Œç„¶åŽæ‰åœ¨å‡½æ•°å‚æ•°ä¸­è¿›è¡Œä½¿ç”¨è¯¥æ³›åž‹å‚æ•° <code>list: &amp;[T]</code> ï¼Œå‡½æ•° <code>largest</code> æœ‰æ³›åž‹ç±»åž‹ <code>T</code>ï¼Œå®ƒæœ‰ä¸ªå‚æ•° <code>list</code>ï¼Œå…¶ç±»åž‹æ˜¯å…ƒç´ ä¸º <code>T</code> çš„æ•°ç»„åˆ‡ç‰‡ï¼Œæœ€åŽï¼Œè¯¥å‡½æ•°è¿”å›žå€¼çš„ç±»åž‹ä¹Ÿæ˜¯ <code>T</code>ã€‚</p>
<p> <code>T</code> å¯ä»¥æ˜¯ä»»ä½•ç±»åž‹ï¼Œä½†ä¸æ˜¯æ‰€æœ‰çš„ç±»åž‹éƒ½èƒ½è¿›è¡Œæ¯”è¾ƒï¼Œç¼–è¯‘å™¨å»ºè®®æˆ‘ä»¬ç»™ <code>T</code> æ·»åŠ ä¸€ä¸ªç±»åž‹é™åˆ¶ï¼šä½¿ç”¨ <code>std::cmp::PartialOrd</code> ç‰¹å¾ï¼ˆTraitï¼‰å¯¹ <code>T</code> è¿›è¡Œé™åˆ¶ã€‚</p>
<p>æœ‰æ—¶å€™ï¼Œç¼–è¯‘å™¨æ— æ³•æŽ¨æ–­ä½ æƒ³è¦çš„æ³›åž‹å‚æ•°ï¼Œè¿™æ—¶å€™éœ€è¦æ˜¾å¼åœ°æ¥å£°æ˜Žã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fn create_and_print&lt;T&gt;() where T: From&lt;i32&gt; + Display &#123;</span><br><span class="line">    let a: T &#x3D; 100.into(); &#x2F;&#x2F; åˆ›å»ºäº†ç±»åž‹ä¸º T çš„å˜é‡ aï¼Œå®ƒçš„åˆå§‹å€¼ç”± 100 è½¬æ¢è€Œæ¥</span><br><span class="line">    println!(&quot;a is: &#123;&#125;&quot;, a);</span><br><span class="line">&#125;</span><br><span class="line">fn main() &#123;</span><br><span class="line">    create_and_print::&lt;i64&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æž„ä½“å’Œæžšä¸¾çš„æ³›åž‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">enum Option&lt;T&gt; &#123;</span><br><span class="line">    Some(T),</span><br><span class="line">    None,</span><br><span class="line">&#125;</span><br><span class="line">struct Point&lt;T,U&gt; &#123;</span><br><span class="line">    x: T,</span><br><span class="line">    y: U,</span><br><span class="line">&#125;</span><br><span class="line">impl&lt;T&gt; Point&lt;T&gt; &#123;</span><br><span class="line">    fn x(&amp;self) -&gt; &amp;T &#123;</span><br><span class="line">        &amp;self.x</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–¹æ³•ä¸­ä½¿ç”¨æ³›åž‹ï¼šä½¿ç”¨æ³›åž‹å‚æ•°å‰è¦æå‰å£°æ˜Žï¼š<code>impl&lt;T&gt;</code>ï¼Œè¿™æ · Rust å°±çŸ¥é“ <code>Point</code> çš„å°–æ‹¬å·ä¸­çš„ç±»åž‹æ˜¯æ³›åž‹è€Œä¸æ˜¯å…·ä½“ç±»åž‹ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ <code>Point&lt;T&gt;</code> ä¸å†æ˜¯æ³›åž‹å£°æ˜Žï¼Œè€Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„ç»“æž„ä½“ç±»åž‹ï¼Œå› ä¸ºæˆ‘ä»¬å®šä¹‰çš„ç»“æž„ä½“å°±æ˜¯ <code>Point&lt;T&gt;</code> è€Œä¸å†æ˜¯ <code>Point</code>ã€‚é™¤äº†ç»“æž„ä½“ä¸­çš„æ³›åž‹å‚æ•°ï¼Œè¿˜èƒ½åœ¨è¯¥ç»“æž„ä½“çš„æ–¹æ³•ä¸­å®šä¹‰é¢å¤–çš„æ³›åž‹å‚æ•°ï¼Œå°±è·Ÿæ³›åž‹å‡½æ•°ä¸€æ ·ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">impl&lt;T, U&gt; Point&lt;T, U&gt; &#123;</span><br><span class="line">    fn mixup&lt;V, W&gt;(self, other: Point&lt;V, W&gt;) -&gt; Point&lt;T, W&gt; &#123;</span><br><span class="line">        Point &#123;</span><br><span class="line">            x: self.x,</span><br><span class="line">            y: other.y,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>constæ³›åž‹ï¼š<code>[i32; 3]</code> å’Œ <code>[i32; 2]</code> ç¡®å®žæ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ç±»åž‹ï¼Œå› æ­¤æ— æ³•ç”¨åŒä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œconst æ³›åž‹ï¼Œä¹Ÿå°±æ˜¯é’ˆå¯¹å€¼çš„æ³›åž‹å¯ä»¥ç”¨äºŽå¤„ç†æ•°ç»„é•¿åº¦çš„é—®é¢˜ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">display_array</span></span>&lt;T: std::fmt::<span class="built_in">Debug</span>, <span class="keyword">const</span> N: <span class="built_in">usize</span>&gt;(arr: [T; N]) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;:?&#125;"</span>, arr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> arr: [<span class="built_in">i32</span>; <span class="number">3</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    display_array(arr);</span><br><span class="line">    <span class="keyword">let</span> arr: [<span class="built_in">i32</span>; <span class="number">2</span>] = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">    display_array(arr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>const fn</code>ï¼Œå³å¸¸é‡å‡½æ•°ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå‡½æ•°æ˜¯åœ¨è¿è¡Œæ—¶è¢«è°ƒç”¨å’Œæ‰§è¡Œçš„ã€‚ç„¶è€Œï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ç¼–è¯‘æœŸå°±è®¡ç®—å‡ºä¸€äº›å€¼ï¼Œä»¥æé«˜è¿è¡Œæ—¶çš„æ€§èƒ½æˆ–æ»¡è¶³æŸäº›ç¼–è¯‘æœŸçš„çº¦æŸæ¡ä»¶ã€‚ä¾‹å¦‚ï¼Œå®šä¹‰æ•°ç»„çš„é•¿åº¦ã€è®¡ç®—å¸¸é‡å€¼ç­‰ã€‚æœ‰äº† <code>const fn</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¼–è¯‘æœŸæ‰§è¡Œè¿™äº›å‡½æ•°ï¼Œä»Žè€Œå°†è®¡ç®—ç»“æžœç›´æŽ¥åµŒå…¥åˆ°ç”Ÿæˆçš„ä»£ç ä¸­ã€‚</p>
<p><strong>ç‰¹å¾traitï¼š</strong>å¦‚æžœä¸åŒçš„ç±»åž‹å…·æœ‰ç›¸åŒçš„è¡Œä¸ºï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰ä¸€ä¸ªç‰¹å¾ï¼Œç„¶åŽä¸ºè¿™äº›ç±»åž‹å®žçŽ°è¯¥ç‰¹å¾ã€‚<strong>å®šä¹‰ç‰¹å¾</strong>æ˜¯æŠŠä¸€äº›æ–¹æ³•ç»„åˆåœ¨ä¸€èµ·ï¼Œç›®çš„æ˜¯å®šä¹‰ä¸€ä¸ªå®žçŽ°æŸäº›ç›®æ ‡æ‰€å¿…éœ€çš„è¡Œä¸ºçš„é›†åˆã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pub trait Summary &#123;</span><br><span class="line">    fn summarize(&amp;self) -&gt; String;</span><br><span class="line">&#125;</span><br><span class="line">pub struct Post &#123;</span><br><span class="line">    pub title: String, &#x2F;&#x2F; æ ‡é¢˜</span><br><span class="line">    pub author: String, &#x2F;&#x2F; ä½œè€…</span><br><span class="line">    pub content: String, &#x2F;&#x2F; å†…å®¹</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">impl Summary for Post &#123;</span><br><span class="line">    fn summarize(&amp;self) -&gt; String &#123;</span><br><span class="line">        format!(&quot;æ–‡ç« &#123;&#125;, ä½œè€…æ˜¯&#123;&#125;&quot;, self.title, self.author)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pub struct Weibo &#123;</span><br><span class="line">    pub username: String,</span><br><span class="line">    pub content: String</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">impl Summary for Weibo &#123;</span><br><span class="line">    fn summarize(&amp;self) -&gt; String &#123;</span><br><span class="line">        format!(&quot;&#123;&#125;å‘è¡¨äº†å¾®åš&#123;&#125;&quot;, self.username, self.content)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³äºŽç‰¹å¾å®žçŽ°ä¸Žå®šä¹‰çš„ä½ç½®ï¼Œæœ‰ä¸€æ¡éžå¸¸é‡è¦çš„åŽŸåˆ™ï¼š<strong>å¦‚æžœä½ æƒ³è¦ä¸ºç±»åž‹</strong> <code>A</code> <strong>å®žçŽ°ç‰¹å¾</strong> <code>T</code><strong>ï¼Œé‚£ä¹ˆ</strong> <code>A</code> <strong>æˆ–è€…</strong> <code>T</code> <strong>è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯åœ¨å½“å‰ä½œç”¨åŸŸä¸­å®šä¹‰çš„ï¼</strong> ä¾‹å¦‚å¯ä»¥ä¸ºä¸Šé¢çš„ <code>Post</code> ç±»åž‹å®žçŽ°æ ‡å‡†åº“ä¸­çš„ <code>Display</code> ç‰¹å¾ï¼Œè¿™æ˜¯å› ä¸º <code>Post</code> ç±»åž‹å®šä¹‰åœ¨å½“å‰çš„ä½œç”¨åŸŸä¸­ã€‚åŒæ—¶ä¹Ÿå¯ä»¥åœ¨å½“å‰åŒ…ä¸­ä¸º <code>String</code> ç±»åž‹å®žçŽ° <code>Summary</code> ç‰¹å¾ï¼Œå› ä¸º <code>Summary</code> å®šä¹‰åœ¨å½“å‰ä½œç”¨åŸŸä¸­.</p>
<p>ç‰¹å¾ä¸­å®šä¹‰å…·æœ‰<strong>é»˜è®¤å®žçŽ°</strong>çš„æ–¹æ³•ï¼Œè¿™æ ·å…¶å®ƒç±»åž‹æ— éœ€å†å®žçŽ°è¯¥æ–¹æ³•ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥é€‰æ‹©é‡è½½è¯¥æ–¹æ³•.</p>
<p>ä½¿ç”¨ç‰¹å¾ä½œä¸ºå‡½æ•°å‚æ•°ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">notify</span></span>(item: &amp;<span class="keyword">impl</span> Summary) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Breaking news! &#123;&#125;"</span>, item.summarize());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>impl Summary</code>é¡¾åæ€ä¹‰ï¼Œå®ƒçš„æ„æ€æ˜¯ <strong>å®žçŽ°äº†<code>Summary</code>ç‰¹å¾</strong> çš„ <code>item</code> å‚æ•°ã€‚</p>
<p>å¦‚æžœæƒ³è¦å¼ºåˆ¶å‡½æ•°çš„ä¸¤ä¸ªå‚æ•°æ˜¯åŒä¸€ç±»åž‹åªèƒ½ä½¿ç‰¹å¾çº¦æŸæ¥å®žçŽ°ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">notify</span></span>&lt;T: Summary&gt;(item1: &amp;T, item2: &amp;T) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>æ³›åž‹ç±»åž‹ <code>T</code> è¯´æ˜Žäº† <code>item1</code> å’Œ <code>item2</code> å¿…é¡»æ‹¥æœ‰åŒæ ·çš„ç±»åž‹ï¼ŒåŒæ—¶ <code>T: Summary</code> è¯´æ˜Žäº† <code>T</code> å¿…é¡»å®žçŽ° <code>Summary</code> ç‰¹å¾ã€‚</p>
<p><strong>å¤šé‡çº¦æŸ:</strong>é™¤äº†å•ä¸ªçº¦æŸæ¡ä»¶ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªçº¦æŸæ¡ä»¶ï¼Œ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">notify</span></span>(item: &amp;(<span class="keyword">impl</span> Summary + Display)) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>é™¤äº†ä¸Šè¿°çš„è¯­æ³•ç³–å½¢å¼ï¼Œè¿˜èƒ½ä½¿ç”¨ç‰¹å¾çº¦æŸçš„å½¢å¼ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">notify</span></span>&lt;T: Summary + Display&gt;(item: &amp;T) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>ç‰¹å¾çº¦æŸï¼Œå¯ä»¥è®©æˆ‘ä»¬åœ¨æŒ‡å®šç±»åž‹ + æŒ‡å®šç‰¹å¾çš„æ¡ä»¶ä¸‹åŽ»å®žçŽ°æ–¹æ³•,<strong>ä¹Ÿå¯ä»¥æœ‰æ¡ä»¶åœ°å®žçŽ°ç‰¹å¾</strong>ï¼Œä¾‹å¦‚ï¼Œæ ‡å‡†åº“ä¸ºä»»ä½•å®žçŽ°äº† <code>Display</code> ç‰¹å¾çš„ç±»åž‹å®žçŽ°äº† <code>ToString</code> ç‰¹å¾ã€‚</p>
<p>å¯ä»¥é€šè¿‡ <code>impl Trait</code> æ¥è¯´æ˜Žä¸€ä¸ªå‡½æ•°è¿”å›žäº†ä¸€ä¸ªç±»åž‹ï¼Œè¯¥ç±»åž‹å®žçŽ°äº†æŸä¸ªç‰¹å¾ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">returns_summarizable</span></span>() -&gt; <span class="keyword">impl</span> Summary &#123;</span><br><span class="line">    Weibo &#123;</span><br><span class="line">        ã€‚ã€‚ã€‚</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ç§ <code>impl Trait</code> å½¢å¼çš„è¿”å›žå€¼ï¼Œåœ¨ä¸€ç§åœºæ™¯ä¸‹éžå¸¸éžå¸¸æœ‰ç”¨ï¼Œé‚£å°±æ˜¯è¿”å›žçš„çœŸå®žç±»åž‹éžå¸¸å¤æ‚ï¼Œä½ ä¸çŸ¥é“è¯¥æ€Žä¹ˆå£°æ˜Žæ—¶ã€‚</p>
<p><strong><code>#[derive(Debug)]</code></strong> ï¼šæ˜¯ä¸€ç§ç‰¹å¾æ´¾ç”Ÿè¯­æ³•ï¼Œè¢« <code>derive</code> æ ‡è®°çš„å¯¹è±¡ä¼šè‡ªåŠ¨å®žçŽ°å¯¹åº”çš„é»˜è®¤ç‰¹å¾ä»£ç ï¼Œç»§æ‰¿ç›¸åº”çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ <code>Debug</code> ç‰¹å¾ï¼Œå®ƒæœ‰ä¸€å¥—è‡ªåŠ¨å®žçŽ°çš„é»˜è®¤ä»£ç ï¼Œå½“ä½ ç»™ä¸€ä¸ªç»“æž„ä½“æ ‡è®°åŽï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>println!(&quot;{:?}&quot;, s)</code> çš„å½¢å¼æ‰“å°è¯¥ç»“æž„ä½“çš„å¯¹è±¡ã€‚</p>
<p>å†å¦‚ <code>Copy</code> ç‰¹å¾ï¼Œå®ƒä¹Ÿæœ‰ä¸€å¥—è‡ªåŠ¨å®žçŽ°çš„é»˜è®¤ä»£ç ï¼Œå½“æ ‡è®°åˆ°ä¸€ä¸ªç±»åž‹ä¸Šæ—¶ï¼Œå¯ä»¥è®©è¿™ä¸ªç±»åž‹è‡ªåŠ¨å®žçŽ° <code>Copy</code> ç‰¹å¾ï¼Œè¿›è€Œå¯ä»¥è°ƒç”¨ <code>copy</code> æ–¹æ³•ï¼Œè¿›è¡Œè‡ªæˆ‘å¤åˆ¶ã€‚</p>
<p>æ€»ä¹‹ï¼Œ<code>derive</code> æ´¾ç”Ÿå‡ºæ¥çš„æ˜¯ Rust é»˜è®¤ç»™æˆ‘ä»¬æä¾›çš„ç‰¹å¾ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­æžå¤§çš„ç®€åŒ–äº†è‡ªå·±æ‰‹åŠ¨å®žçŽ°ç›¸åº”ç‰¹å¾çš„éœ€æ±‚ï¼Œå½“ç„¶ï¼Œå¦‚æžœä½ æœ‰ç‰¹æ®Šçš„éœ€æ±‚ï¼Œè¿˜å¯ä»¥è‡ªå·±æ‰‹åŠ¨é‡è½½è¯¥å®žçŽ°</p>
<p><strong>ç‰¹å¾å¯¹è±¡</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Draw</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">draw</span></span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åªè¦ç»„ä»¶å®žçŽ°äº† <code>Draw</code> ç‰¹å¾ï¼Œå°±å¯ä»¥è°ƒç”¨ <code>draw</code> æ–¹æ³•æ¥è¿›è¡Œæ¸²æŸ“ã€‚å‡è®¾æœ‰ä¸€ä¸ª <code>Button</code> å’Œ <code>SelectBox</code> ç»„ä»¶å®žçŽ°äº† <code>Draw</code> ç‰¹å¾ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Button</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> width: <span class="built_in">u32</span>,</span><br><span class="line">    <span class="keyword">pub</span> height: <span class="built_in">u32</span>,</span><br><span class="line">    <span class="keyword">pub</span> label: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Draw <span class="keyword">for</span> Button &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">draw</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// ç»˜åˆ¶æŒ‰é’®çš„ä»£ç </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SelectBox</span></span> &#123;</span><br><span class="line">    width: <span class="built_in">u32</span>,</span><br><span class="line">    height: <span class="built_in">u32</span>,</span><br><span class="line">    options: <span class="built_in">Vec</span>&lt;<span class="built_in">String</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Draw <span class="keyword">for</span> SelectBox &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">draw</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// ç»˜åˆ¶SelectBoxçš„ä»£ç </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">draw1</span></span>(x: <span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> Draw&gt;) &#123;</span><br><span class="line">    <span class="comment">// ç”±äºŽå®žçŽ°äº† Deref ç‰¹å¾ï¼ŒBox æ™ºèƒ½æŒ‡é’ˆä¼šè‡ªåŠ¨è§£å¼•ç”¨ä¸ºå®ƒæ‰€åŒ…è£¹çš„å€¼ï¼Œç„¶åŽè°ƒç”¨è¯¥å€¼å¯¹åº”çš„ç±»åž‹ä¸Šå®šä¹‰çš„ `draw` æ–¹æ³•</span></span><br><span class="line">    x.draw();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">draw2</span></span>(x: &amp;<span class="keyword">dyn</span> Draw) &#123;</span><br><span class="line">    x.draw();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ï¼Œè¿˜éœ€è¦ä¸€ä¸ªåŠ¨æ€æ•°ç»„æ¥å­˜å‚¨è¿™äº› UI å¯¹è±¡ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Screen</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> components: <span class="built_in">Vec</span>&lt;?&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç‰¹å¾å¯¹è±¡**æŒ‡å‘å®žçŽ°äº† <code>Draw</code> ç‰¹å¾çš„ç±»åž‹çš„å®žä¾‹ï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘äº† <code>Button</code> æˆ–è€… <code>SelectBox</code> çš„å®žä¾‹ï¼Œè¿™ç§æ˜ å°„å…³ç³»æ˜¯å­˜å‚¨åœ¨ä¸€å¼ è¡¨ä¸­ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡ç‰¹å¾å¯¹è±¡æ‰¾åˆ°å…·ä½“è°ƒç”¨çš„ç±»åž‹æ–¹æ³•ã€‚</p>
<ul>
<li><code>draw1</code> å‡½æ•°çš„å‚æ•°æ˜¯ <code>Box&lt;dyn Draw&gt;</code> å½¢å¼çš„ç‰¹å¾å¯¹è±¡ï¼Œè¯¥ç‰¹å¾å¯¹è±¡æ˜¯é€šè¿‡ <code>Box::new(x)</code> çš„æ–¹å¼åˆ›å»ºçš„</li>
<li><code>draw2</code> å‡½æ•°çš„å‚æ•°æ˜¯ <code>&amp;dyn Draw</code> å½¢å¼çš„ç‰¹å¾å¯¹è±¡ï¼Œè¯¥ç‰¹å¾å¯¹è±¡æ˜¯é€šè¿‡ <code>&amp;x</code> çš„æ–¹å¼åˆ›å»ºçš„</li>
<li><code>dyn</code> å…³é”®å­—åªç”¨åœ¨ç‰¹å¾å¯¹è±¡çš„ç±»åž‹å£°æ˜Žä¸Šï¼Œåœ¨åˆ›å»ºæ—¶æ— éœ€ä½¿ç”¨ <code>dyn</code></li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Screen</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> components: <span class="built_in">Vec</span>&lt;<span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> Draw&gt;&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­å­˜å‚¨äº†ä¸€ä¸ªåŠ¨æ€æ•°ç»„ï¼Œé‡Œé¢å…ƒç´ çš„ç±»åž‹æ˜¯ <code>Draw</code> ç‰¹å¾å¯¹è±¡ï¼š<code>Box&lt;dyn Draw&gt;</code>ï¼Œä»»ä½•å®žçŽ°äº† <code>Draw</code> ç‰¹å¾çš„ç±»åž‹ï¼Œéƒ½å¯ä»¥å­˜æ”¾å…¶ä¸­ã€‚</p>
<p>å†æ¥ä¸º <code>Screen</code> å®šä¹‰ <code>run</code> æ–¹æ³•ï¼Œç”¨äºŽå°†åˆ—è¡¨ä¸­çš„ UI ç»„ä»¶æ¸²æŸ“åœ¨å±å¹•ä¸Šï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> Screen &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> component <span class="keyword">in</span> <span class="keyword">self</span>.components.iter() &#123;</span><br><span class="line">            component.draw();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³›åž‹æ˜¯åœ¨ç¼–è¯‘æœŸå®Œæˆå¤„ç†çš„ï¼šç¼–è¯‘å™¨ä¼šä¸ºæ¯ä¸€ä¸ªæ³›åž‹å‚æ•°å¯¹åº”çš„å…·ä½“ç±»åž‹ç”Ÿæˆä¸€ä»½ä»£ç ï¼Œè¿™ç§æ–¹å¼æ˜¯<strong>é™æ€åˆ†å‘</strong>ï¼Œå› ä¸ºæ˜¯åœ¨ç¼–è¯‘æœŸå®Œæˆçš„ï¼Œå¯¹äºŽè¿è¡ŒæœŸæ€§èƒ½å®Œå…¨æ²¡æœ‰ä»»ä½•å½±å“ã€‚ä¸Žé™æ€åˆ†å‘ç›¸å¯¹åº”çš„æ˜¯<strong>åŠ¨æ€åˆ†å‘(dynamic dispatch)</strong>ï¼Œç›´åˆ°è¿è¡Œæ—¶ï¼Œæ‰èƒ½ç¡®å®šéœ€è¦è°ƒç”¨ä»€ä¹ˆæ–¹æ³•ã€‚</p>
<h2 id="3-15"><a href="#3-15" class="headerlink" title="3.15"></a>3.15</h2><p>ç¬¬ä¹ç« <strong>é›†åˆç±»åž‹</strong></p>
<p>ä½¿ç”¨ <code>Vec::new</code> åˆ›å»ºåŠ¨æ€æ•°ç»„</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> v: <span class="built_in">Vec</span>&lt;<span class="built_in">i32</span>&gt; = <span class="built_in">Vec</span>::new();</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œï¼Œ<code>v</code> è¢«æ˜¾å¼åœ°å£°æ˜Žäº†ç±»åž‹ <code>Vec&lt;i32&gt;</code>ï¼Œè¿™æ˜¯å› ä¸º Rust ç¼–è¯‘å™¨æ— æ³•ä»Ž <code>Vec::new()</code> ä¸­å¾—åˆ°ä»»ä½•å…³äºŽç±»åž‹çš„æš—ç¤ºä¿¡æ¯ï¼Œå› æ­¤ä¹Ÿæ— æ³•æŽ¨å¯¼å‡º <code>v</code> çš„å…·ä½“ç±»åž‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut</span> v = <span class="built_in">Vec</span>::new();</span><br><span class="line">v.push(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ï¼Œ<code>v</code> å°±æ— éœ€æ‰‹åŠ¨å£°æ˜Žç±»åž‹ï¼Œå› ä¸ºç¼–è¯‘å™¨é€šè¿‡ <code>v.push(1)</code>ï¼ŒæŽ¨æµ‹å‡º <code>v</code> ä¸­çš„å…ƒç´ ç±»åž‹æ˜¯ <code>i32</code>ï¼Œå› æ­¤æŽ¨å¯¼å‡º <code>v</code> çš„ç±»åž‹æ˜¯ <code>Vec&lt;i32&gt;</code>ã€‚</p>
<blockquote>
<p>å¦‚æžœé¢„å…ˆçŸ¥é“è¦å­˜å‚¨çš„å…ƒç´ ä¸ªæ•°ï¼Œå¯ä»¥ä½¿ç”¨ <code>Vec::with_capacity(capacity)</code> åˆ›å»ºåŠ¨æ€æ•°ç»„ï¼Œè¿™æ ·å¯ä»¥é¿å…å› ä¸ºæ’å…¥å¤§é‡æ–°æ•°æ®å¯¼è‡´é¢‘ç¹çš„å†…å­˜åˆ†é…å’Œæ‹·è´ï¼Œæå‡æ€§èƒ½</p>
</blockquote>
<p>è¿˜å¯ä»¥ä½¿ç”¨å® <code>vec!</code> æ¥åˆ›å»ºæ•°ç»„ï¼Œä¸Ž <code>Vec::new</code> æœ‰æ‰€ä¸åŒï¼Œå‰è€…èƒ½åœ¨åˆ›å»ºåŒæ—¶ç»™äºˆåˆå§‹åŒ–å€¼ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> v = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br></pre></td></tr></table></figure>

<p>åŒæ ·ï¼Œæ­¤å¤„çš„ <code>v</code> ä¹Ÿæ— éœ€æ ‡æ³¨ç±»åž‹ï¼Œç¼–è¯‘å™¨åªéœ€æ£€æŸ¥å®ƒå†…éƒ¨çš„å…ƒç´ å³å¯è‡ªåŠ¨æŽ¨å¯¼å‡º <code>v</code> çš„ç±»åž‹æ˜¯ `Vec<i32></i32></p>
<p>è·Ÿç»“æž„ä½“ä¸€æ ·ï¼Œ<code>Vector</code> ç±»åž‹åœ¨è¶…å‡ºä½œç”¨åŸŸèŒƒå›´åŽï¼Œä¼šè¢«è‡ªåŠ¨åˆ é™¤ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> v = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="comment">// &lt;- vè¶…å‡ºä½œç”¨åŸŸå¹¶åœ¨æ­¤å¤„è¢«åˆ é™¤</span></span><br></pre></td></tr></table></figure>

<p>å½“ <code>Vector</code> è¢«åˆ é™¤åŽï¼Œå®ƒå†…éƒ¨å­˜å‚¨çš„æ‰€æœ‰å†…å®¹ä¹Ÿä¼šéšä¹‹è¢«åˆ é™¤ã€‚</p>
<p><strong>åŒæ—¶å€Ÿç”¨å¤šä¸ªæ•°ç»„å…ƒç´ </strong> é‡åˆ°åŒæ—¶å€Ÿç”¨å¤šä¸ªæ•°ç»„å…ƒç´ çš„æƒ…å†µ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut</span> v = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">let</span> first = &amp;v[<span class="number">0</span>];</span><br><span class="line">v.push(<span class="number">6</span>);</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">"The first element is: &#123;first&#125;"</span>)ï¼›</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ç¼–è¯‘å™¨æŠ¥é”™ã€‚æ•°ç»„çš„å¤§å°æ˜¯å¯å˜çš„ï¼Œå½“æ—§æ•°ç»„çš„å¤§å°ä¸å¤Ÿç”¨æ—¶ï¼ŒRust ä¼šé‡æ–°åˆ†é…ä¸€å—æ›´å¤§çš„å†…å­˜ç©ºé—´ï¼Œç„¶åŽæŠŠæ—§æ•°ç»„æ‹·è´è¿‡æ¥ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä¹‹å‰çš„å¼•ç”¨æ˜¾ç„¶ä¼šæŒ‡å‘ä¸€å—æ— æ•ˆçš„å†…å­˜ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">use std::collections::HashMap;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; åˆ›å»ºä¸€ä¸ªHashMapï¼Œç”¨äºŽå­˜å‚¨å®çŸ³ç§ç±»å’Œå¯¹åº”çš„æ•°é‡</span><br><span class="line">let mut my_gems &#x3D; HashMap::new();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å°†å®çŸ³ç±»åž‹å’Œå¯¹åº”çš„æ•°é‡å†™å…¥è¡¨ä¸­</span><br><span class="line">my_gems.insert(&quot;çº¢å®çŸ³&quot;, 1);</span><br><span class="line">my_gems.insert(&quot;è“å®çŸ³&quot;, 2);</span><br></pre></td></tr></table></figure>

<h2 id="3-16"><a href="#3-16" class="headerlink" title="3.16"></a>3.16</h2><p>ç¬¬åç« ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p><strong>å€Ÿç”¨æ£€æŸ¥ï¼š</strong>ä¸ºäº†ä¿è¯ Rust çš„æ‰€æœ‰æƒå’Œå€Ÿç”¨çš„æ­£ç¡®æ€§ï¼ŒRust ä½¿ç”¨äº†ä¸€ä¸ªå€Ÿç”¨æ£€æŸ¥å™¨(Borrow checker)æ¥æ£€æŸ¥ç¨‹åºçš„å€Ÿç”¨æ­£ç¡®æ€§ã€‚</p>
<p><strong>å‡½æ•°ä¸­çš„ç”Ÿå‘½å‘¨æœŸï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">fn longest(x: &amp;str, y: &amp;str) -&gt; &amp;str &#123;</span><br><span class="line">    if x.len() &gt; y.len() &#123;</span><br><span class="line">        x</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        y</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">--------</span><br><span class="line"> --&gt; src&#x2F;main.rs:9:33</span><br><span class="line">  |</span><br><span class="line">9 | fn longest(x: &amp;str, y: &amp;str) -&gt; &amp;str &#123;</span><br><span class="line">  |               ----     ----     ^ expected named lifetime parameter &#x2F;&#x2F; å‚æ•°éœ€è¦ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸ</span><br><span class="line">  |</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘å™¨æ— æ³•çŸ¥é“è¯¥å‡½æ•°çš„è¿”å›žå€¼åˆ°åº•å¼•ç”¨ <code>x</code> è¿˜æ˜¯ <code>y</code> ï¼Œ<strong>å› ä¸ºç¼–è¯‘å™¨éœ€è¦çŸ¥é“è¿™äº›ï¼Œæ¥ç¡®ä¿å‡½æ•°è°ƒç”¨åŽçš„å¼•ç”¨ç”Ÿå‘½å‘¨æœŸåˆ†æž</strong>ã€‚åœ¨å­˜åœ¨å¤šä¸ªå¼•ç”¨æ—¶ï¼Œç¼–è¯‘å™¨æœ‰æ—¶ä¼šæ— æ³•è‡ªåŠ¨æŽ¨å¯¼ç”Ÿå‘½å‘¨æœŸï¼Œæ­¤æ—¶å°±éœ€è¦æ‰‹åŠ¨åŽ»æ ‡æ³¨ï¼Œé€šè¿‡ä¸ºå‚æ•°æ ‡æ³¨åˆé€‚çš„ç”Ÿå‘½å‘¨æœŸæ¥å¸®åŠ©ç¼–è¯‘å™¨è¿›è¡Œå€Ÿç”¨æ£€æŸ¥çš„åˆ†æžã€‚</p>
<p><strong>ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ï¼š</strong>ç”Ÿå‘½å‘¨æœŸçš„è¯­æ³•ä»¥ <code>&#39;</code> å¼€å¤´ï¼Œåç§°å¾€å¾€æ˜¯ä¸€ä¸ªå•ç‹¬çš„å°å†™å­—æ¯ï¼Œå¤§å¤šæ•°äººéƒ½ç”¨ <code>&#39;a</code> æ¥ä½œä¸ºç”Ÿå‘½å‘¨æœŸçš„åç§°ã€‚ å¦‚æžœæ˜¯å¼•ç”¨ç±»åž‹çš„å‚æ•°ï¼Œé‚£ä¹ˆç”Ÿå‘½å‘¨æœŸä¼šä½äºŽå¼•ç”¨ç¬¦å· <code>&amp;</code> ä¹‹åŽï¼Œå¹¶ç”¨ä¸€ä¸ªç©ºæ ¼æ¥å°†ç”Ÿå‘½å‘¨æœŸå’Œå¼•ç”¨å‚æ•°åˆ†éš”å¼€</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;<span class="built_in">i32</span>        <span class="comment">// ä¸€ä¸ªå¼•ç”¨</span></span><br><span class="line">&amp;<span class="symbol">'a</span> <span class="built_in">i32</span>     <span class="comment">// å…·æœ‰æ˜¾å¼ç”Ÿå‘½å‘¨æœŸçš„å¼•ç”¨</span></span><br><span class="line">&amp;<span class="symbol">'a</span> <span class="keyword">mut</span> <span class="built_in">i32</span> <span class="comment">// å…·æœ‰æ˜¾å¼ç”Ÿå‘½å‘¨æœŸçš„å¯å˜å¼•ç”¨</span></span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ï¼Œå®ƒè‡ªèº«å¹¶ä¸å…·æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œå› ä¸ºç”Ÿå‘½å‘¨æœŸçš„ä½œç”¨å°±æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨å¤šä¸ªå¼•ç”¨ä¹‹é—´çš„å…³ç³»ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•° <code>first</code> æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>i32</code> ç±»åž‹çš„å¼•ç”¨ï¼Œå…·æœ‰ç”Ÿå‘½å‘¨æœŸ <code>&#39;a</code>ï¼Œè¯¥å‡½æ•°è¿˜æœ‰å¦ä¸€ä¸ªå‚æ•° <code>second</code>ï¼Œå®ƒä¹Ÿæ˜¯æŒ‡å‘ <code>i32</code> ç±»åž‹çš„å¼•ç”¨ï¼Œå¹¶ä¸”åŒæ ·å…·æœ‰ç”Ÿå‘½å‘¨æœŸ <code>&#39;a</code>ã€‚æ­¤å¤„ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ä»…ä»…è¯´æ˜Žï¼Œ<strong>è¿™ä¸¤ä¸ªå‚æ•° <code>first</code> å’Œ <code>second</code> è‡³å°‘æ´»å¾—å’Œâ€™a ä¸€æ ·ä¹…ï¼Œè‡³äºŽåˆ°åº•æ´»å¤šä¹…æˆ–è€…å“ªä¸ªæ´»å¾—æ›´ä¹…ï¼Œæˆ‘ä»¬éƒ½æ— æ³•å¾—çŸ¥</strong>ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">useless</span></span>&lt;<span class="symbol">'a</span>&gt;(first: &amp;<span class="symbol">'a</span> <span class="built_in">i32</span>, second: &amp;<span class="symbol">'a</span> <span class="built_in">i32</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å‡½æ•°ç­¾åä¸­çš„ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">longest</span></span>&lt;<span class="symbol">'a</span>&gt;(x: &amp;<span class="symbol">'a</span> <span class="built_in">str</span>, y: &amp;<span class="symbol">'a</span> <span class="built_in">str</span>) -&gt; &amp;<span class="symbol">'a</span> <span class="built_in">str</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> x.len() &gt; y.len() &#123;</span><br><span class="line">        x</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        y</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>å’Œæ³›åž‹ä¸€æ ·ï¼Œä½¿ç”¨ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œéœ€è¦å…ˆå£°æ˜Ž <code>&lt;&#39;a&gt;</code></li>
<li><code>x</code>ã€<code>y</code> å’Œè¿”å›žå€¼è‡³å°‘æ´»å¾—å’Œ <code>&#39;a</code> ä¸€æ ·ä¹…ï¼ˆå› ä¸ºè¿”å›žå€¼è¦ä¹ˆæ˜¯ <code>x</code>ï¼Œè¦ä¹ˆæ˜¯ <code>y</code>ï¼‰</li>
</ul>
<p>è¯¥å‡½æ•°ç­¾åè¡¨æ˜Žå¯¹äºŽæŸäº›ç”Ÿå‘½å‘¨æœŸ <code>&#39;a</code>ï¼Œå‡½æ•°çš„ä¸¤ä¸ªå‚æ•°éƒ½è‡³å°‘è·Ÿ <code>&#39;a</code> æ´»å¾—ä¸€æ ·ä¹…ï¼ŒåŒæ—¶å‡½æ•°çš„è¿”å›žå¼•ç”¨ä¹Ÿè‡³å°‘è·Ÿ <code>&#39;a</code> æ´»å¾—ä¸€æ ·ä¹…ã€‚å®žé™…ä¸Šï¼Œè¿™æ„å‘³ç€è¿”å›žå€¼çš„ç”Ÿå‘½å‘¨æœŸä¸Žå‚æ•°ç”Ÿå‘½å‘¨æœŸä¸­çš„è¾ƒå°å€¼ä¸€è‡´ï¼šè™½ç„¶ä¸¤ä¸ªå‚æ•°çš„ç”Ÿå‘½å‘¨æœŸéƒ½æ˜¯æ ‡æ³¨äº† <code>&#39;a</code>ï¼Œä½†æ˜¯å®žé™…ä¸Šè¿™ä¸¤ä¸ªå‚æ•°çš„çœŸå®žç”Ÿå‘½å‘¨æœŸå¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼ˆç”Ÿå‘½å‘¨æœŸ <code>&#39;a</code> ä¸ä»£è¡¨ç”Ÿå‘½å‘¨æœŸç­‰äºŽ <code>&#39;a</code>ï¼Œè€Œæ˜¯å¤§äºŽç­‰äºŽ <code>&#39;a</code>ï¼‰ã€‚<strong>åœ¨é€šè¿‡å‡½æ•°ç­¾åæŒ‡å®šç”Ÿå‘½å‘¨æœŸå‚æ•°æ—¶ï¼Œå¹¶æ²¡æœ‰æ”¹å˜ä¼ å…¥å¼•ç”¨æˆ–è€…è¿”å›žå¼•ç”¨çš„çœŸå®žç”Ÿå‘½å‘¨æœŸï¼Œè€Œæ˜¯å‘Šè¯‰ç¼–è¯‘å™¨å½“ä¸æ»¡è¶³æ­¤çº¦æŸæ¡ä»¶æ—¶ï¼Œå°±æ‹’ç»ç¼–è¯‘é€šè¿‡</strong>ã€‚</p>
<p>å› æ­¤ <code>longest</code> å‡½æ•°å¹¶ä¸çŸ¥é“ <code>x</code> å’Œ <code>y</code> å…·ä½“ä¼šæ´»å¤šä¹…ï¼Œåªè¦çŸ¥é“å®ƒä»¬çš„ä½œç”¨åŸŸè‡³å°‘èƒ½æŒç»­ <code>&#39;a</code> è¿™ä¹ˆé•¿å°±è¡Œã€‚</p>
<p>è¯¥ä¾‹å­è¯æ˜Žäº† <code>result</code> çš„ç”Ÿå‘½å‘¨æœŸå¿…é¡»ç­‰äºŽä¸¤ä¸ªå‚æ•°ä¸­ç”Ÿå‘½å‘¨æœŸè¾ƒå°çš„é‚£ä¸ª:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> string1 = <span class="built_in">String</span>::from(<span class="string">"long string is long"</span>);</span><br><span class="line">    <span class="keyword">let</span> result;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> string2 = <span class="built_in">String</span>::from(<span class="string">"xyz"</span>);</span><br><span class="line">        result = longest(string1.as_str(), string2.as_str());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"The longest string is &#123;&#125;"</span>, result);</span><br><span class="line">&#125;</span><br><span class="line">error[E0597]: `string2` does not live long enough</span><br><span class="line"> --&gt; src/main.rs:<span class="number">6</span>:<span class="number">44</span></span><br><span class="line">  |</span><br><span class="line"><span class="number">6</span> |         result = longest(string1.as_str(), string2.as_str());</span><br><span class="line">  |                                            ^^^^^^^ borrowed value does not live long enough</span><br><span class="line"><span class="number">7</span> |     &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ<code>result</code> å¿…é¡»è¦æ´»åˆ° <code>println!</code>å¤„ï¼Œå› ä¸º <code>result</code> çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ <code>&#39;a</code>ï¼Œå› æ­¤ <code>&#39;a</code> å¿…é¡»æŒç»­åˆ° <code>println!</code>ã€‚</p>
<p><strong>ç»“æž„ä½“ä¸­çš„ç”Ÿå‘½å‘¨æœŸï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">struct ImportantExcerpt&lt;&#39;a&gt; &#123;</span><br><span class="line">    part: &amp;&#39;a str,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ImportantExcerpt</code> ç»“æž„ä½“ä¸­æœ‰ä¸€ä¸ªå¼•ç”¨ç±»åž‹çš„å­—æ®µ <code>part</code>ï¼Œå› æ­¤éœ€è¦ä¸ºå®ƒæ ‡æ³¨ä¸Šç”Ÿå‘½å‘¨æœŸã€‚ç»“æž„ä½“çš„ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨è¯­æ³•è·Ÿæ³›åž‹å‚æ•°è¯­æ³•å¾ˆåƒï¼Œéœ€è¦å¯¹ç”Ÿå‘½å‘¨æœŸå‚æ•°è¿›è¡Œå£°æ˜Ž <code>&lt;&#39;a&gt;</code>ã€‚è¯¥ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨è¯´æ˜Žï¼Œ<strong>ç»“æž„ä½“ <code>ImportantExcerpt</code> æ‰€å¼•ç”¨çš„å­—ç¬¦ä¸² <code>str</code> ç”Ÿå‘½å‘¨æœŸéœ€è¦å¤§äºŽç­‰äºŽè¯¥ç»“æž„ä½“çš„ç”Ÿå‘½å‘¨æœŸ</strong></p>
<p><strong>ç”Ÿå‘½å‘¨æœŸæ¶ˆé™¤ï¼š</strong>å°½ç®¡æˆ‘ä»¬æ²¡æœ‰æ˜¾å¼çš„ä¸ºå…¶æ ‡æ³¨ç”Ÿå‘½å‘¨æœŸï¼Œç¼–è¯‘ä¾ç„¶å¯ä»¥é€šè¿‡ã€‚å…¶å®žåŽŸå› ä¸å¤æ‚ï¼Œ<strong>ç¼–è¯‘å™¨ä¸ºäº†ç®€åŒ–ç”¨æˆ·çš„ä½¿ç”¨ï¼Œè¿ç”¨äº†ç”Ÿå‘½å‘¨æœŸæ¶ˆé™¤å¤§æ³•</strong>ã€‚</p>
<p>ä¸‰æ¡æ¶ˆé™¤è§„åˆ™ï¼š</p>
<p>ç¼–è¯‘å™¨ä½¿ç”¨ä¸‰æ¡æ¶ˆé™¤è§„åˆ™æ¥ç¡®å®šå“ªäº›åœºæ™¯ä¸éœ€è¦æ˜¾å¼åœ°åŽ»æ ‡æ³¨ç”Ÿå‘½å‘¨æœŸã€‚å…¶ä¸­ç¬¬ä¸€æ¡è§„åˆ™åº”ç”¨åœ¨è¾“å…¥ç”Ÿå‘½å‘¨æœŸä¸Šï¼Œç¬¬äºŒã€ä¸‰æ¡åº”ç”¨åœ¨è¾“å‡ºç”Ÿå‘½å‘¨æœŸä¸Šã€‚è‹¥ç¼–è¯‘å™¨å‘çŽ°ä¸‰æ¡è§„åˆ™éƒ½ä¸é€‚ç”¨æ—¶ï¼Œå°±ä¼šæŠ¥é”™ï¼Œæç¤ºä½ éœ€è¦æ‰‹åŠ¨æ ‡æ³¨ç”Ÿå‘½å‘¨æœŸã€‚</p>
<ol>
<li><p><strong>æ¯ä¸€ä¸ªå¼•ç”¨å‚æ•°éƒ½ä¼šèŽ·å¾—ç‹¬è‡ªçš„ç”Ÿå‘½å‘¨æœŸ</strong></p>
<p>ä¾‹å¦‚ä¸€ä¸ªå¼•ç”¨å‚æ•°çš„å‡½æ•°å°±æœ‰ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ ‡æ³¨: <code>fn foo&lt;&#39;a&gt;(x: &amp;&#39;a i32)</code>ï¼Œä¸¤ä¸ªå¼•ç”¨å‚æ•°çš„æœ‰ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸæ ‡æ³¨:<code>fn foo&lt;&#39;a, &#39;b&gt;(x: &amp;&#39;a i32, y: &amp;&#39;b i32)</code>, ä¾æ­¤ç±»æŽ¨ã€‚</p>
</li>
<li><p><strong>è‹¥åªæœ‰ä¸€ä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸï¼ˆå‡½æ•°å‚æ•°ä¸­åªæœ‰ä¸€ä¸ªå¼•ç”¨ç±»åž‹ï¼‰ï¼Œé‚£ä¹ˆè¯¥ç”Ÿå‘½å‘¨æœŸä¼šè¢«èµ‹ç»™æ‰€æœ‰çš„è¾“å‡ºç”Ÿå‘½å‘¨æœŸ</strong>ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰è¿”å›žå€¼çš„ç”Ÿå‘½å‘¨æœŸéƒ½ç­‰äºŽè¯¥è¾“å…¥ç”Ÿå‘½å‘¨æœŸ</p>
<p>ä¾‹å¦‚å‡½æ•° <code>fn foo(x: &amp;i32) -&gt; &amp;i32</code>ï¼Œ<code>x</code> å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸä¼šè¢«è‡ªåŠ¨èµ‹ç»™è¿”å›žå€¼ <code>&amp;i32</code>ï¼Œå› æ­¤è¯¥å‡½æ•°ç­‰åŒäºŽ <code>fn foo&lt;&#39;a&gt;(x: &amp;&#39;a i32) -&gt; &amp;&#39;a i32</code></p>
</li>
<li><p><strong>è‹¥å­˜åœ¨å¤šä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸï¼Œä¸”å…¶ä¸­ä¸€ä¸ªæ˜¯ <code>&amp;self</code> æˆ– <code>&amp;mut self</code>ï¼Œåˆ™ <code>&amp;self</code> çš„ç”Ÿå‘½å‘¨æœŸè¢«èµ‹ç»™æ‰€æœ‰çš„è¾“å‡ºç”Ÿå‘½å‘¨æœŸ</strong></p>
<p>æ‹¥æœ‰ <code>&amp;self</code> å½¢å¼çš„å‚æ•°ï¼Œè¯´æ˜Žè¯¥å‡½æ•°æ˜¯ä¸€ä¸ª <code>æ–¹æ³•</code>ï¼Œè¯¥è§„åˆ™è®©æ–¹æ³•çš„ä½¿ç”¨ä¾¿åˆ©åº¦å¤§å¹…æå‡ã€‚</p>
</li>
</ol>
<h2 id="3-17"><a href="#3-17" class="headerlink" title="3.17"></a>3.17</h2><p><strong>æ–¹æ³•ä¸­çš„ç”Ÿå‘½å‘¨æœŸï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct ImportantExcerpt&lt;&#39;a&gt; &#123;</span><br><span class="line">    part: &amp;&#39;a str,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">impl&lt;&#39;a&gt; ImportantExcerpt&lt;&#39;a&gt; &#123;</span><br><span class="line">    fn level(&amp;self) -&gt; i32 &#123;</span><br><span class="line">        3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>impl</code> ä¸­å¿…é¡»ä½¿ç”¨ç»“æž„ä½“çš„å®Œæ•´åç§°ï¼ŒåŒ…æ‹¬ <code>&lt;&#39;a&gt;</code>ï¼Œå› ä¸º<em>ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ä¹Ÿæ˜¯ç»“æž„ä½“ç±»åž‹çš„ä¸€éƒ¨åˆ†</em>ï¼</li>
<li>æ–¹æ³•ç­¾åä¸­ï¼Œå¾€å¾€ä¸éœ€è¦æ ‡æ³¨ç”Ÿå‘½å‘¨æœŸï¼Œå¾—ç›ŠäºŽç”Ÿå‘½å‘¨æœŸæ¶ˆé™¤çš„ç¬¬ä¸€å’Œç¬¬ä¸‰è§„åˆ™</li>
</ul>
<p><strong>é™æ€ç”Ÿå‘½å‘¨æœŸï¼š</strong>ç”Ÿå‘½å‘¨æœŸ <code>&#39;static</code>ï¼Œæ‹¥æœ‰è¯¥ç”Ÿå‘½å‘¨æœŸçš„å¼•ç”¨å¯ä»¥å’Œæ•´ä¸ªç¨‹åºæ´»å¾—ä¸€æ ·ä¹…ã€‚</p>
<p>å­—ç¬¦ä¸²å­—é¢é‡æ˜¯è¢«ç¡¬ç¼–ç è¿› Rust çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œå› æ­¤è¿™äº›å­—ç¬¦ä¸²å˜é‡å…¨éƒ¨å…·æœ‰ <code>&#39;static</code> çš„ç”Ÿå‘½å‘¨æœŸï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> s: &amp;<span class="symbol">'static</span> <span class="built_in">str</span> = <span class="string">"å°±æ˜¯æ´»å¾—ä¹…ï¼Œå˜¿å˜¿"</span>;</span><br></pre></td></tr></table></figure>

<p>Rust ä¸­çš„é”™è¯¯ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li><strong>å¯æ¢å¤é”™è¯¯</strong>ï¼Œé€šå¸¸ç”¨äºŽä»Žç³»ç»Ÿå…¨å±€è§’åº¦æ¥çœ‹å¯ä»¥æŽ¥å—çš„é”™è¯¯ï¼Œä¾‹å¦‚å¤„ç†ç”¨æˆ·çš„è®¿é—®ã€æ“ä½œç­‰é”™è¯¯ï¼Œè¿™äº›é”™è¯¯åªä¼šå½±å“æŸä¸ªç”¨æˆ·è‡ªèº«çš„æ“ä½œè¿›ç¨‹ï¼Œè€Œä¸ä¼šå¯¹ç³»ç»Ÿçš„å…¨å±€ç¨³å®šæ€§äº§ç”Ÿå½±å“</li>
<li><strong>ä¸å¯æ¢å¤é”™è¯¯</strong>ï¼Œåˆšå¥½ç›¸åï¼Œè¯¥é”™è¯¯é€šå¸¸æ˜¯å…¨å±€æ€§æˆ–è€…ç³»ç»Ÿæ€§çš„é”™è¯¯ï¼Œä¾‹å¦‚æ•°ç»„è¶Šç•Œè®¿é—®ï¼Œç³»ç»Ÿå¯åŠ¨æ—¶å‘ç”Ÿäº†å½±å“å¯åŠ¨æµç¨‹çš„é”™è¯¯ç­‰ç­‰ï¼Œè¿™äº›é”™è¯¯çš„å½±å“å¾€å¾€å¯¹äºŽç³»ç»Ÿæ¥è¯´æ˜¯è‡´å‘½çš„</li>
</ul>
<p>Rust æä¾›äº† <code>panic!</code> å®ï¼Œå½“è°ƒç”¨æ‰§è¡Œè¯¥å®æ—¶ï¼Œ<strong>ç¨‹åºä¼šæ‰“å°å‡ºä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼Œå±•å¼€æŠ¥é”™ç‚¹å¾€å‰çš„å‡½æ•°è°ƒç”¨å †æ ˆï¼Œæœ€åŽé€€å‡ºç¨‹åº</strong>ã€‚</p>
<p>å½“å‡ºçŽ° <code>panic!</code> æ—¶ï¼Œç¨‹åºæä¾›äº†ä¸¤ç§æ–¹å¼æ¥å¤„ç†ç»ˆæ­¢æµç¨‹ï¼š<strong>æ ˆå±•å¼€</strong>å’Œ<strong>ç›´æŽ¥ç»ˆæ­¢</strong>ã€‚</p>
<p>å…¶ä¸­ï¼Œé»˜è®¤çš„æ–¹å¼å°±æ˜¯ <code>æ ˆå±•å¼€</code>ï¼Œè¿™æ„å‘³ç€ Rust ä¼šå›žæº¯æ ˆä¸Šæ•°æ®å’Œå‡½æ•°è°ƒç”¨ï¼Œå› æ­¤ä¹Ÿæ„å‘³ç€æ›´å¤šçš„å–„åŽå·¥ä½œï¼Œå¥½å¤„æ˜¯å¯ä»¥ç»™å‡ºå……åˆ†çš„æŠ¥é”™ä¿¡æ¯å’Œæ ˆè°ƒç”¨ä¿¡æ¯ï¼Œä¾¿äºŽäº‹åŽçš„é—®é¢˜å¤ç›˜ã€‚<code>ç›´æŽ¥ç»ˆæ­¢</code>ï¼Œé¡¾åæ€ä¹‰ï¼Œä¸æ¸…ç†æ•°æ®å°±ç›´æŽ¥é€€å‡ºç¨‹åºï¼Œå–„åŽå·¥ä½œäº¤ä¸Žæ“ä½œç³»ç»Ÿæ¥è´Ÿè´£ã€‚</p>
<p>å¯¹äºŽç»å¤§å¤šæ•°ç”¨æˆ·ï¼Œä½¿ç”¨é»˜è®¤é€‰æ‹©æ˜¯æœ€å¥½çš„ï¼Œä½†æ˜¯å½“ä½ å…³å¿ƒæœ€ç»ˆç¼–è¯‘å‡ºçš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å¤§å°æ—¶ï¼Œé‚£ä¹ˆå¯ä»¥å°è¯•åŽ»ä½¿ç”¨ç›´æŽ¥ç»ˆæ­¢çš„æ–¹å¼ï¼Œä¾‹å¦‚ä¸‹é¢çš„é…ç½®ä¿®æ”¹ <code>Cargo.toml</code> æ–‡ä»¶ï¼Œå®žçŽ°åœ¨ <a href="https://course.rs/first-try/cargo.html#æ‰‹åŠ¨ç¼–è¯‘å’Œè¿è¡Œé¡¹ç›®" target="_blank" rel="noopener"><code>release</code></a> æ¨¡å¼ä¸‹é‡åˆ° <code>panic</code> ç›´æŽ¥ç»ˆæ­¢ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[profile.release]</span><br><span class="line">panic &#x3D; &#39;abort&#39;</span><br></pre></td></tr></table></figure>

<p>panicåŽå¦‚æžœæ˜¯ <code>main</code> çº¿ç¨‹ï¼Œåˆ™ç¨‹åºä¼šç»ˆæ­¢ï¼Œå¦‚æžœæ˜¯å…¶å®ƒå­çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ä¼šç»ˆæ­¢ï¼Œä½†æ˜¯ä¸ä¼šå½±å“ <code>main</code> çº¿ç¨‹ã€‚</p>
<p>*<em><code>Result&lt;T, E&gt;</code> *</em>æ˜¯ä¸€ä¸ªæžšä¸¾ç±»åž‹ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Result</span></span>&lt;T, E&gt; &#123;</span><br><span class="line">    <span class="literal">Ok</span>(T),</span><br><span class="line">    <span class="literal">Err</span>(E),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³›åž‹å‚æ•° <code>T</code> ä»£è¡¨æˆåŠŸæ—¶å­˜å…¥çš„æ­£ç¡®å€¼çš„ç±»åž‹ï¼Œå­˜æ”¾æ–¹å¼æ˜¯ <code>Ok(T)</code>ï¼Œ<code>E</code> ä»£è¡¨é”™è¯¯æ—¶å­˜å…¥çš„é”™è¯¯å€¼ï¼Œå­˜æ”¾æ–¹å¼æ˜¯ <code>Err(E)</code>ï¼Œ</p>
<p>ä¸æƒ³ä½¿ç”¨ <code>match</code> åŽ»åŒ¹é… <code>Result&lt;T, E&gt;</code>ä»¥èŽ·å–å…¶ä¸­çš„ <code>T</code> å€¼ï¼Œå› ä¸º <code>match</code> çš„ç©·å°½åŒ¹é…ç‰¹æ€§ï¼Œä½ æ€»è¦åŽ»å¤„ç†ä¸‹ <code>Err</code> åˆ†æ”¯ã€‚æœ‰ä¸ªåŠžæ³•ç®€åŒ–è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ <code>unwrap</code> å’Œ <code>expect</code>ã€‚å®ƒä»¬çš„ä½œç”¨å°±æ˜¯ï¼Œå¦‚æžœè¿”å›žæˆåŠŸï¼Œå°±å°† <code>Ok(T)</code> ä¸­çš„å€¼å–å‡ºæ¥ï¼Œå¦‚æžœå¤±è´¥ï¼Œå°±ç›´æŽ¥ panicã€‚<code>expect</code> è·Ÿ <code>unwrap</code> å¾ˆåƒï¼Œä¹Ÿæ˜¯é‡åˆ°é”™è¯¯ç›´æŽ¥ <code>panic</code>, ä½†æ˜¯ä¼šå¸¦ä¸Šè‡ªå®šä¹‰çš„é”™è¯¯æç¤ºä¿¡æ¯ï¼Œç›¸å½“äºŽé‡è½½äº†é”™è¯¯æ‰“å°çš„å‡½æ•°.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let f &#x3D; File::open(&quot;hello.txt&quot;).unwrap();</span><br><span class="line">let f &#x3D; File::open(&quot;hello.txt&quot;).expect(&quot;Failed to open hello.txt&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>é”™è¯¯ä¼ æ’­ï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fn read_username_from_file() -&gt; Result&lt;String, io::Error&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>è¯¥å‡½æ•°è¿”å›žä¸€ä¸ª <code>Result&lt;String, io::Error&gt;</code> ç±»åž‹ï¼Œå½“è¯»å–ç”¨æˆ·åæˆåŠŸæ—¶ï¼Œè¿”å›ž <code>Ok(String)</code>ï¼Œå¤±è´¥æ—¶ï¼Œè¿”å›ž <code>Err(io:Error)</code></li>
<li><code>File::open</code> å’Œ <code>f.read_to_string</code> è¿”å›žçš„ <code>Result&lt;T, E&gt;</code> ä¸­çš„ <code>E</code> å°±æ˜¯ <code>io::Error</code></li>
</ul>
<h2 id="3-18"><a href="#3-18" class="headerlink" title="3.18"></a>3.18</h2><ul>
<li><strong>é¡¹ç›®(Package)</strong>ï¼šå¯ä»¥ç”¨æ¥æž„å»ºã€æµ‹è¯•å’Œåˆ†äº«åŒ…</li>
<li><strong>å·¥ä½œç©ºé—´(WorkSpace)</strong>ï¼šå¯¹äºŽå¤§åž‹é¡¹ç›®ï¼Œå¯ä»¥è¿›ä¸€æ­¥å°†å¤šä¸ªåŒ…è”åˆåœ¨ä¸€èµ·ï¼Œç»„ç»‡æˆå·¥ä½œç©ºé—´</li>
<li><strong>åŒ…(Crate)</strong>ï¼šä¸€ä¸ªç”±å¤šä¸ªæ¨¡å—ç»„æˆçš„æ ‘å½¢ç»“æž„ï¼Œå¯ä»¥ä½œä¸ºä¸‰æ–¹åº“è¿›è¡Œåˆ†å‘ï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œè¿è¡Œ</li>
<li><strong>æ¨¡å—(Module)</strong>ï¼šå¯ä»¥ä¸€ä¸ªæ–‡ä»¶å¤šä¸ªæ¨¡å—ï¼Œä¹Ÿå¯ä»¥ä¸€ä¸ªæ–‡ä»¶ä¸€ä¸ªæ¨¡å—ï¼Œæ¨¡å—å¯ä»¥è¢«è®¤ä¸ºæ˜¯çœŸå®žé¡¹ç›®ä¸­çš„ä»£ç ç»„ç»‡å•å…ƒ</li>
</ul>
<p><strong>åŒ… Crate</strong></p>
<p>å¯¹äºŽ Rust è€Œè¨€ï¼ŒåŒ…æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯ç¼–è¯‘å•å…ƒï¼Œå®ƒç¼–è¯‘åŽä¼šç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æˆ–è€…ä¸€ä¸ªåº“ã€‚</p>
<p>ä¸€ä¸ªåŒ…ä¼šå°†ç›¸å…³è”çš„åŠŸèƒ½æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œä½¿å¾—è¯¥åŠŸèƒ½å¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨å¤šä¸ªé¡¹ç›®ä¸­åˆ†äº«ã€‚ä¾‹å¦‚æ ‡å‡†åº“ä¸­æ²¡æœ‰æä¾›ä½†æ˜¯åœ¨ä¸‰æ–¹åº“ä¸­æä¾›çš„ <code>rand</code> åŒ…ï¼Œå®ƒæä¾›äº†éšæœºæ•°ç”Ÿæˆçš„åŠŸèƒ½ï¼Œåªéœ€è¦å°†è¯¥åŒ…é€šè¿‡ <code>use rand;</code> å¼•å…¥åˆ°å½“å‰é¡¹ç›®çš„ä½œç”¨åŸŸä¸­ï¼Œå°±å¯ä»¥åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ <code>rand</code> çš„åŠŸèƒ½ï¼š<code>rand::XXX</code>ã€‚</p>
<p>åŒä¸€ä¸ªåŒ…ä¸­ä¸èƒ½æœ‰åŒåçš„ç±»åž‹ï¼Œä½†æ˜¯åœ¨ä¸åŒåŒ…ä¸­å°±å¯ä»¥ã€‚ä¾‹å¦‚ï¼Œè™½ç„¶ <code>rand</code> åŒ…ä¸­ï¼Œæœ‰ä¸€ä¸ª <code>Rng</code> ç‰¹å¾ï¼Œå¯æ˜¯ä¾ç„¶å¯ä»¥åœ¨è‡ªå·±çš„é¡¹ç›®ä¸­å®šä¹‰ä¸€ä¸ª <code>Rng</code>ï¼Œå‰è€…é€šè¿‡ <code>rand::Rng</code> è®¿é—®ï¼ŒåŽè€…é€šè¿‡ <code>Rng</code> è®¿é—®ï¼Œä¸ä¼šå­˜åœ¨å¼•ç”¨æ­§ä¹‰ã€‚</p>
<p><strong>é¡¹ç›® Package</strong></p>
<p>ç”±äºŽ <code>Package</code> å°±æ˜¯ä¸€ä¸ªé¡¹ç›®ï¼Œå› æ­¤å®ƒåŒ…å«æœ‰ç‹¬ç«‹çš„ <code>Cargo.toml</code> æ–‡ä»¶ï¼Œä»¥åŠå› ä¸ºåŠŸèƒ½æ€§è¢«ç»„ç»‡åœ¨ä¸€èµ·çš„ä¸€ä¸ªæˆ–å¤šä¸ªåŒ…ã€‚ä¸€ä¸ª <code>Package</code> åªèƒ½åŒ…å«<strong>ä¸€ä¸ª</strong>åº“(library)ç±»åž‹çš„åŒ…ï¼Œä½†æ˜¯å¯ä»¥åŒ…å«<strong>å¤šä¸ª</strong>äºŒè¿›åˆ¶å¯æ‰§è¡Œç±»åž‹çš„åŒ…ã€‚</p>
<p><strong>åº“ Package</strong></p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cargo new my-lib --lib</span></span><br><span class="line">     Created library `my-lib` package</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls my-lib</span></span><br><span class="line">Cargo.toml</span><br><span class="line">src</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls my-lib/src</span></span><br><span class="line">lib.rs</span><br></pre></td></tr></table></figure>

<p>å¦‚æžœä½ è¯•å›¾è¿è¡Œ <code>my-lib</code>ï¼Œä¼šæŠ¥é”™ï¼š</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cargo run</span></span><br><span class="line">error: a bin target must be available for `cargo run`</span><br></pre></td></tr></table></figure>

<p>åŽŸå› æ˜¯åº“ç±»åž‹çš„ <code>Package</code> åªèƒ½ä½œä¸ºä¸‰æ–¹åº“è¢«å…¶å®ƒé¡¹ç›®å¼•ç”¨ï¼Œè€Œä¸èƒ½ç‹¬ç«‹è¿è¡Œï¼Œåªæœ‰ä¹‹å‰çš„äºŒè¿›åˆ¶ <code>Package</code> æ‰å¯ä»¥è¿è¡Œã€‚</p>
<p>ä¸Ž <code>src/main.rs</code> ä¸€æ ·ï¼ŒCargo çŸ¥é“ï¼Œå¦‚æžœä¸€ä¸ª <code>Package</code> åŒ…å«æœ‰ <code>src/lib.rs</code>ï¼Œæ„å‘³å®ƒåŒ…å«æœ‰ä¸€ä¸ªåº“ç±»åž‹çš„åŒååŒ… <code>my-lib</code>ï¼Œè¯¥åŒ…çš„æ ¹æ–‡ä»¶æ˜¯ <code>src/lib.rs</code>ã€‚</p>
<p><strong>æ¨¡å—</strong></p>
<ul>
<li>ä½¿ç”¨ <code>mod</code> å…³é”®å­—æ¥åˆ›å»ºæ–°æ¨¡å—ï¼ŒåŽé¢ç´§è·Ÿç€æ¨¡å—åç§°</li>
<li>æ¨¡å—å¯ä»¥åµŒå¥—ï¼Œè¿™é‡ŒåµŒå¥—çš„åŽŸå› æ˜¯æ‹›å¾…å®¢äººå’ŒæœåŠ¡éƒ½å‘ç”Ÿåœ¨å‰åŽ…ï¼Œå› æ­¤æˆ‘ä»¬çš„ä»£ç æ¨¡æ‹Ÿäº†çœŸå®žåœºæ™¯</li>
<li>æ¨¡å—ä¸­å¯ä»¥å®šä¹‰å„ç§ Rust ç±»åž‹ï¼Œä¾‹å¦‚å‡½æ•°ã€ç»“æž„ä½“ã€æžšä¸¾ã€ç‰¹å¾ç­‰</li>
<li>æ‰€æœ‰æ¨¡å—å‡å®šä¹‰åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­</li>
</ul>
<p>æ¨¡å—æ ‘ä¸ºæ¨¡å—çš„åµŒå¥—ç»“æž„ï¼Œä»–ä»¬éƒ½æœ‰ä¸€ä¸ªæ ¹æ¨¡å— <code>crate</code>ã€‚å¦‚æžœæ¨¡å— <code>A</code> åŒ…å«æ¨¡å— <code>B</code>ï¼Œé‚£ä¹ˆ <code>A</code> æ˜¯ <code>B</code> çš„çˆ¶æ¨¡å—ï¼Œ<code>B</code> æ˜¯ <code>A</code> çš„å­æ¨¡å—ã€‚</p>
<p>æƒ³è¦è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œå°±éœ€è¦çŸ¥é“å®ƒçš„è·¯å¾„ï¼Œåœ¨ Rust ä¸­ï¼Œè¿™ç§è·¯å¾„æœ‰ä¸¤ç§å½¢å¼ï¼š</p>
<ul>
<li><strong>ç»å¯¹è·¯å¾„</strong>ï¼Œä»ŽåŒ…æ ¹å¼€å§‹ï¼Œè·¯å¾„åä»¥åŒ…åæˆ–è€… <code>crate</code> ä½œä¸ºå¼€å¤´</li>
<li><strong>ç›¸å¯¹è·¯å¾„</strong>ï¼Œä»Žå½“å‰æ¨¡å—å¼€å§‹ï¼Œä»¥ <code>self</code>ï¼Œ<code>super</code> æˆ–å½“å‰æ¨¡å—çš„æ ‡è¯†ç¬¦ä½œä¸ºå¼€å¤´</li>
</ul>
<p>Rust å‡ºäºŽå®‰å…¨çš„è€ƒè™‘ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„ç±»åž‹éƒ½æ˜¯ç§æœ‰åŒ–çš„ï¼ŒåŒ…æ‹¬å‡½æ•°ã€æ–¹æ³•ã€ç»“æž„ä½“ã€æžšä¸¾ã€å¸¸é‡ï¼Œæ˜¯çš„ï¼Œå°±è¿žæ¨¡å—æœ¬èº«ä¹Ÿæ˜¯ç§æœ‰åŒ–çš„ã€‚<strong>çˆ¶æ¨¡å—å®Œå…¨æ— æ³•è®¿é—®å­æ¨¡å—ä¸­çš„ç§æœ‰é¡¹ï¼Œä½†æ˜¯å­æ¨¡å—å´å¯ä»¥è®¿é—®çˆ¶æ¨¡å—ã€çˆ¶çˆ¶..æ¨¡å—çš„ç§æœ‰é¡¹</strong>ã€‚</p>
<p>æ¨¡å—å¯è§æ€§ä¸ä»£è¡¨æ¨¡å—å†…éƒ¨é¡¹çš„å¯è§æ€§ï¼Œæ¨¡å—çš„å¯è§æ€§ä»…ä»…æ˜¯å…è®¸å…¶å®ƒæ¨¡å—åŽ»å¼•ç”¨å®ƒï¼Œä½†æ˜¯æƒ³è¦å¼•ç”¨å®ƒå†…éƒ¨çš„é¡¹ï¼Œè¿˜å¾—ç»§ç»­å°†å¯¹åº”çš„é¡¹æ ‡è®°ä¸º <code>pub</code>ã€‚</p>
<p>å½“å¤–éƒ¨çš„æ¨¡å—é¡¹ <code>A</code> è¢«å¼•å…¥åˆ°å½“å‰æ¨¡å—ä¸­æ—¶ï¼Œå®ƒçš„å¯è§æ€§è‡ªåŠ¨è¢«è®¾ç½®ä¸ºç§æœ‰çš„ï¼Œå¦‚æžœä½ å¸Œæœ›å…è®¸å…¶å®ƒå¤–éƒ¨ä»£ç å¼•ç”¨æˆ‘ä»¬çš„æ¨¡å—é¡¹ <code>A</code>ï¼Œé‚£ä¹ˆå¯ä»¥å¯¹å®ƒè¿›è¡Œå†å¯¼å‡ºã€‚ä½¿ç”¨ <code>pub use</code> å³å¯å®žçŽ°ã€‚</p>
<p>å¼•å…¥ç¬¬ä¸‰æ–¹åŒ…ä¸­çš„æ¨¡å—ï¼Œå…³äºŽå¦‚ä½•å¼•å…¥å¤–éƒ¨ä¾èµ–ï¼š</p>
<p>ä¿®æ”¹ <code>Cargo.toml</code> æ–‡ä»¶ï¼Œåœ¨ <code>[dependencies]</code> åŒºåŸŸæ·»åŠ ä¸€è¡Œï¼š<code>rand = &quot;0.8.3&quot;</code></p>
<h2 id="3-21-3-24-rustlings"><a href="#3-21-3-24-rustlings" class="headerlink" title="3.21-3.24 rustlings"></a>3.21-3.24 rustlings</h2><p>å…³äºŽrustlingsï¼Œç³»ç»Ÿå­¦è¿‡ruståŽå‡ ä¹Žæ²¡æœ‰éš¾é¢˜ï¼Œæ‰€ä»¥æˆ‘åœ¨6å·ä¸€å¤©å°±å®Œæˆäº†70å¤šé“ï¼Œå‰ä¸¤å¤©åœ¨ç†Ÿæ‚‰github classroomå’Œrustlingsçš„è‡ªæ£€æ–¹å¼ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2025/04/25/2025OS%E8%AE%AD%E7%BB%83%E8%90%A5%E4%BA%8C%E9%98%B6%E6%AE%B5%E8%AE%B0%E5%BD%95-%E5%88%98%E7%A7%91%E8%BF%AA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/04/25/2025OS%E8%AE%AD%E7%BB%83%E8%90%A5%E4%BA%8C%E9%98%B6%E6%AE%B5%E8%AE%B0%E5%BD%95-%E5%88%98%E7%A7%91%E8%BF%AA/" class="post-title-link" itemprop="url">2025OSè®­ç»ƒè¥äºŒé˜¶æ®µè®°å½•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-25 17:21:55" itemprop="dateCreated datePublished" datetime="2025-04-25T17:21:55+00:00">2025-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-06 07:13:15" itemprop="dateModified" datetime="2025-05-06T07:13:15+00:00">2025-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/catogory/" itemprop="url" rel="index"><span itemprop="name"><catogory></span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="2025OSè®­ç»ƒè¥äºŒé˜¶æ®µè®°å½•"><a href="#2025OSè®­ç»ƒè¥äºŒé˜¶æ®µè®°å½•" class="headerlink" title="2025OSè®­ç»ƒè¥äºŒé˜¶æ®µè®°å½•"></a>2025OSè®­ç»ƒè¥äºŒé˜¶æ®µè®°å½•</h1><h2 id="3-18-3-21"><a href="#3-18-3-21" class="headerlink" title="3.18-3.21"></a>3.18-3.21</h2><p>è¿™æ®µæ—¶é—´æ˜¯åœ¨å¼€è¥å‰ï¼Œæˆ‘åœ¨ç”¨rcorebookå­¦ä¹ ï¼Œè¿™å‡ å¤©å®Œæˆäº†ch1-ch3çš„å­¦ä¹ ã€‚</p>
<h3 id="ch1"><a href="#ch1" class="headerlink" title="ch1"></a>ch1</h3><p><strong>çŽ¯å¢ƒé…ç½®</strong>ï¼šæˆ‘ç”¨çš„æ˜¯ubuntu20.04ï¼ŒæŒ‰ç…§æ•™ç¨‹æ¥é…ç½®è¿˜æ˜¯ç›¸å½“å®¹æ˜“çš„ï¼Œæ²¡æœ‰ç¢°åˆ°ä»€ä¹ˆé—®é¢˜ã€‚</p>
<p><strong>ä¸ªäººåŸºç¡€</strong>ï¼šæˆ‘æ˜¯åœ¨å¯’å‡æŽ¥è§¦è‡ªåˆ¶æ“ä½œç³»ç»Ÿçš„ï¼Œçœ‹çš„ä¸€æœ¬ä¹¦å«åšã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŽŸã€‹ï¼Œè¿™æœ¬ä¹¦ç”¨cè¯­è¨€å’Œæ±‡ç¼–å®žçŽ°äº†ä¸€ä¸ªx86çš„32çš„æ“ä½œç³»ç»Ÿã€‚ä¹¦çš„å†…å®¹å¾ˆå¤šï¼Œå¯¹äºŽåŸºç¡€ç›²åŒºä¹Ÿè®²è§£å¾ˆå…¨ï¼Œä½œè€…ä»ŽMBRåˆ°Biosã€bootloaderå†åˆ°ç”¨æ˜¾å­˜æ¥å®žçŽ°printï¼Œæ“ä½œç³»ç»Ÿçš„å¿…è¦ç»„ä»¶ã€‚æ‰€ä»¥æˆ‘å­¦èµ·æ¥è¿˜æ²¡é‚£ä¹ˆåƒåŠ›ã€‚</p>
<p>riscvæˆ‘æ²¡æœ‰æŽ¥è§¦è¿‡ï¼Œæœ‰ä¸€äº›x86çš„æ±‡ç¼–å…ˆä¸ç³»ç»Ÿå­¦ä¹ è¿˜æ˜¯å¯ä»¥çœ‹å¾—æ‡‚çš„ï¼Œæ¯•ç«Ÿrcoreæ²¡æœ‰æ¶‰åŠå¤ªå¤šæ±‡ç¼–å†…å®¹ã€‚</p>
<p>rustçš„ç¼–è¯‘å·¥å…·å®‰è£…ã€ç¼–è¯‘æ–¹ä¾¿åœ¨å¼€å§‹éƒ½è®©æˆ‘éžå¸¸æƒŠå–œã€‚å†…æ ¸çš„ç¬¬ä¸€æ¡æŒ‡ä»¤æ¶‰åŠåˆ°ä¸€ä¸ªlinker.ldï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯é“¾æŽ¥è„šæœ¬ï¼Œé€šè¿‡åˆ†æžå†…å®¹å¯ä»¥å¾ˆå®¹æ˜“ç†è§£ç¨‹åºçš„å†…å­˜åˆ†å¸ƒï¼Œé¦–å…ˆæ˜¯å›ºå®šçš„å†…å­˜å…¥å£ï¼Œå…¶æ¬¡æ˜¯ .data .bss .rodataç­‰æ®µçš„æŽ’å¸ƒå¾ˆæ¸…æ™°ã€‚</p>
<p>ç®€å•å­¦ä¹ äº†ä¸‹gdbè°ƒè¯•å’Œè¿œç¨‹è¿žæŽ¥ï¼Œåç¼–è¯‘åæ±‡ç¼–å·¥å…·ã€‚</p>
<p>ç¬¬ä¸€æ¬¡æŽ¥è§¦rustçš„å¤–éƒ¨é“¾æŽ¥extern â€œCâ€ï¼Œä½¿ç”¨å£°æ˜Žå‡½æ•°çš„æ–¹å¼æ¥æ‰¾åˆ°é“¾æŽ¥è„šæœ¬ç¡®å®šçš„å†…å­˜åŒºåŸŸèµ·å§‹ç¬¦å·ã€‚</p>
<p>rustsbiè¿™ä¸ªä¸œè¥¿çœŸçš„å¾ˆæ–¹ä¾¿ï¼Œå½“ç„¶ä¹Ÿæ˜¯riscvæž¶æž„çš„æ ‡å‡†ã€‚åƒæ‰“å°å­—ç¬¦è¿™ç§å‡½æ•°éƒ½å®žçŽ°åœ¨é‡Œé¢ï¼Œè¦ä¸ç„¶éœ€è¦ç”¨æ±‡ç¼–æ¥è‡ªå·±å®žçŽ°ã€‚å¯¹sbiè¿›è¡Œå°è£…åŽå¾ˆå®¹æ˜“å°±èƒ½å®žçŽ°writeå‡½æ•°å’Œprintå®ã€‚</p>
<h3 id="ch2"><a href="#ch2" class="headerlink" title="ch2"></a>ch2</h3><p>è¿™ä¸€ç« æ˜¯å†™ä¸€ä¸ªæ‰¹å¤„ç†ç³»ç»Ÿï¼Œç³»ç»Ÿåœ¨è¿è¡Œå‰å°±æ˜Žç¡®äº†æ‰€æœ‰è¦è¿è¡Œçš„appï¼Œè¿™äº›appéƒ½æŒ‰é¡ºåºæ‰§è¡Œç›´åˆ°æœ€åŽä¸€é“ï¼Œç„¶åŽç³»ç»Ÿpanicç»“æŸã€‚åº”ç”¨çš„å†…å­˜åœ°å€éƒ½æ˜¯åœ¨è¿è¡Œå‰è¦æ‰‹åŠ¨è®¡ç®—ç¡®å®šçš„ã€‚riscvæž¶æž„ä»Žå¤§åˆ°å°åˆ†ä¸º0ï¼Œ1ï¼Œ2ï¼Œ3å››ä¸ªç‰¹æƒçº§ï¼Œè¿˜æä¾›äº†ecallï¼Œeretç”¨æ¥åˆ‡æ¢ç‰¹æƒçº§ã€‚è¿™ä¸ªæ‰¹å¤„ç†ç³»ç»Ÿåˆ†æˆäº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Œecallå°±æ˜¯ç”¨æ¥ä»Žç”¨æˆ·æ€è¿›å…¥å†…æ ¸æ€ï¼Œeretç”¨æ¥è¿”å›žç”¨æˆ·æ€ã€‚ecallå±žäºŽriscvè§„å®šçš„ä¸€ç§å¼‚å¸¸ï¼Œè€Œæ“ä½œç³»ç»Ÿå±žäºŽåœ¨riscvçš„sæ¨¡å¼ç‰¹æƒçº§ï¼Œåœ¨ç”¨æˆ·æ€ecallå°±ä¼šè§¦å‘é™·å…¥æœºåˆ¶è¿›å…¥sæ¨¡å¼ç‰¹æƒçº§ï¼Œç”¨sretæ¥è¿”å›žuç‰¹æƒçº§ã€‚è¿›å…¥sæ¨¡å¼åŽä¼šè°ƒç”¨äºŒè¿›åˆ¶æŽ¥å£ï¼Œä¹Ÿç§°ä¸ºç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p>ç³»ç»Ÿè°ƒç”¨çš„æ„ä¹‰åœ¨äºŽå¾ˆå¤šæ“ä½œäº¤ç»™ç”¨æˆ·æ¥åšéžå¸¸ä¸å®‰å…¨ï¼Œç³»ç»Ÿç¨³å®šæ€§éš¾ä»¥ä¿è¯ï¼Œæ‰€ä»¥éœ€è¦åˆ’åˆ†å‡ºå†…æ ¸æ€ç”¨æˆ·æ€ï¼Œå†…æ ¸æ ¹æ®éœ€æ±‚åšå‡ºå®‰å…¨çš„ç³»ç»Ÿè°ƒç”¨æ“ä½œã€‚</p>
<p>ç¨‹åºçš„å…¥å£å‡†ç¡®æ¥è¯´æ˜¯_startå°±æ˜¯linkeré‡Œçš„startç¬¦å·ä½ç½®ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨åŽŸç”Ÿæž¶æž„ç¼–è¯‘å·¥å…·ï¼Œè€Œæ˜¯ä½¿ç”¨äº¤å‰å·¥å…·é“¾ï¼Œæ‰€ä»¥rust stdå†…å®¹éƒ½ç”¨ä¸äº†ï¼Œmainå‡½æ•°ä¹Ÿä¸èƒ½å®Œæˆä½œä¸ºç¨‹åºå…¥å£çš„ä½œç”¨ã€‚åœ¨rustå£°æ˜Žå¤–éƒ¨é“¾æŽ¥ç¬¦å·å°±è¦åœ¨linkæ“ä½œçš„å®ã€‚</p>
<p>åˆ›å»ºç³»ç»Ÿè°ƒç”¨çš„è§¦å‘æŽ¥å£ï¼Œä½¿ç”¨å†…æ•›æ±‡ç¼–è°ƒç”¨ecallä¼ å…¥ç³»ç»Ÿè°ƒç”¨å·å’Œå‚æ•°ï¼Œåœ¨æ“ä½œç³»ç»Ÿå°±ä¼šæ•æ‰å¼‚å¸¸ï¼Œåˆ¤æ–­ç±»åž‹ä¸ºecallåŽæ ¹æ®å¯¹åº”ç³»ç»Ÿè°ƒç”¨å·å³å¯å¤„ç†ç³»ç»Ÿè°ƒç”¨ï¼Œå®Œæˆç³»ç»Ÿè°ƒç”¨åŽè¿”å›žç”¨æˆ·æ€ã€‚</p>
<p>è¿™é‡Œçš„æµ‹è¯•æ²¡æœ‰å®žçŽ°å…·ä½“çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæ˜¯ç”¨äº†linuxç›¸åŒçš„ç³»ç»Ÿè°ƒç”¨å¥½åœ¨linuxçŽ¯å¢ƒè¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•æ­£å¸¸ã€‚</p>
<p>rcoreå†™äº†build.rsç”¨æ¥æž„å»ºlinker.ldé“¾æŽ¥è„šæœ¬ï¼Œappéœ€è¦ä½¿ç”¨è·¯å¾„æ–¹å¼è¿›è¡Œå¯¼å…¥ï¼Œæ¯ä¸ªappçš„å…¥å£åœ°å€å’Œæ‰§è¡Œé¡ºåºæŒ‚é’©ã€‚ä½¿ç”¨çš„æµ‹è¯•ç”¨ä¾‹æ˜¯åœ¨linuxç³»ç»Ÿè°ƒç”¨çŽ¯å¢ƒä¸‹ç¼–è¯‘çš„ï¼Œç¼–è¯‘çš„ç»“æžœæ˜¯elfçš„ï¼Œéœ€è¦ä½¿ç”¨å·¥å…·æ¥å°†elfè½¬æ¢æˆbinäºŒè¿›åˆ¶æ–‡ä»¶ã€‚åœ¨è®¾è®¡ä¸Šrcoreåˆ›å»ºäº†UnSafeCellç”¨æ¥åœ¨å•æ ¸ä¸Šå¯ä»¥å®‰å…¨ä½¿ç”¨å…¨å±€å¯å˜å€Ÿç”¨ã€‚</p>
<p>load_appæ ¹æ®å›ºå®šçš„æ ‡å·å…¥å£åœ°å€æ¥ä»Žå†…å­˜é‡Œæ‰¾åˆ°appçš„ä»£ç æ®µï¼ŒåŠ è½½åˆ°APP_BASE_ADDRï¼Œè¿™ä¸ªåœ°å€æ˜¯ä¸ªå›ºå®šå€¼ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿä¸ºäº†å»ºç«‹å¥½åº”ç”¨ç¨‹åºçš„æ‰§è¡ŒçŽ¯å¢ƒï¼Œéœ€è¦åœ¨æ‰§è¡Œåº”ç”¨ç¨‹åºä¹‹å‰è¿›è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œå¹¶ç›‘æŽ§åº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼Œå…·ä½“ä½“çŽ°åœ¨ï¼š</span><br><span class="line">å½“å¯åŠ¨åº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œéœ€è¦åˆå§‹åŒ–åº”ç”¨ç¨‹åºçš„ç”¨æˆ·æ€ä¸Šä¸‹æ–‡ï¼Œå¹¶èƒ½åˆ‡æ¢åˆ°ç”¨æˆ·æ€æ‰§è¡Œåº”ç”¨ç¨‹åºï¼›</span><br><span class="line">å½“åº”ç”¨ç¨‹åºå‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼ˆå³å‘å‡º Trapï¼‰ä¹‹åŽï¼Œéœ€è¦åˆ°æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿä¸­è¿›è¡Œå¤„ç†ï¼›</span><br><span class="line">å½“åº”ç”¨ç¨‹åºæ‰§è¡Œå‡ºé”™çš„æ—¶å€™ï¼Œéœ€è¦åˆ°æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿä¸­æ€æ­»è¯¥åº”ç”¨å¹¶åŠ è½½è¿è¡Œä¸‹ä¸€ä¸ªåº”ç”¨ï¼›</span><br><span class="line">å½“åº”ç”¨ç¨‹åºæ‰§è¡Œç»“æŸçš„æ—¶å€™ï¼Œéœ€è¦åˆ°æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿä¸­åŠ è½½è¿è¡Œä¸‹ä¸€ä¸ªåº”ç”¨ï¼ˆå®žé™…ä¸Šä¹Ÿæ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨ sys_exit æ¥å®žçŽ°çš„ï¼‰ã€‚</span><br><span class="line">è¿™äº›å¤„ç†éƒ½æ¶‰åŠåˆ°ç‰¹æƒçº§åˆ‡æ¢ï¼Œå› æ­¤éœ€è¦åº”ç”¨ç¨‹åºã€æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ä¸€èµ·ååŒï¼Œå®Œæˆç‰¹æƒçº§åˆ‡æ¢æœºåˆ¶ã€‚</span><br></pre></td></tr></table></figure>

<p>ç³»ç»Ÿè°ƒç”¨å’Œå¼‚å¸¸éƒ½æ¶‰åŠåˆ°äº†åˆ‡æ¢ç‰¹æƒçº§ï¼Œç‰¹æƒçº§çš„åˆ‡æ¢æœ€é‡è¦çš„å°±æ˜¯ä¿å­˜ä¸Šä¸‹æ–‡ã€‚å› ä¸ºä¸ç®¡æ˜¯trapè¿˜æ˜¯å¼‚å¸¸éƒ½æ˜¯åœæ­¢æ‰§è¡Œå½“å‰çš„ç¨‹åºï¼Œè½¬åŽ»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æˆ–è€…å¼‚å¸¸å¤„ç†ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä¿å­˜å½“å‰åº”ç”¨çš„å¯„å­˜å™¨çŽ¯å¢ƒï¼Œè¿™ä¸ªå°±æ˜¯ä¸Šä¸‹æ–‡ï¼Œå°†è¿™äº›å¯„å­˜å™¨æŒ‰å›ºå®šé¡ºåºä¿å­˜åˆ°ç”¨æˆ·æ ˆï¼Œåœ¨retæ—¶å†é€†é¡ºåºæ¢å¤å¯„å­˜å™¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sstatus çš„ SPP å­—æ®µä¼šè¢«ä¿®æ”¹ä¸º CPU å½“å‰çš„ç‰¹æƒçº§ï¼ˆU&#x2F;Sï¼‰ã€‚</span><br><span class="line">sepc ä¼šè¢«ä¿®æ”¹ä¸º Trap å¤„ç†å®ŒæˆåŽé»˜è®¤ä¼šæ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚</span><br><span class="line">scause&#x2F;stval åˆ†åˆ«ä¼šè¢«ä¿®æ”¹æˆè¿™æ¬¡ Trap çš„åŽŸå› ä»¥åŠç›¸å…³çš„é™„åŠ ä¿¡æ¯ã€‚</span><br><span class="line">CPU ä¼šè·³è½¬åˆ° stvec æ‰€è®¾ç½®çš„ Trap å¤„ç†å…¥å£åœ°å€ï¼Œå¹¶å°†å½“å‰ç‰¹æƒçº§è®¾ç½®ä¸º S ï¼Œç„¶åŽä»ŽTrap å¤„ç†å…¥å£åœ°å€å¤„å¼€å§‹æ‰§è¡Œã€‚</span><br></pre></td></tr></table></figure>

<p>è¿™äº›æ˜¯riscvç”¨åˆ°çš„ç¡¬ä»¶è¾…åŠ©å¯„å­˜å™¨ã€‚</p>
<p>rcoreä½¿ç”¨æ±‡ç¼–å®žçŽ°äº†alltrapå’Œrestoreï¼Œç”¨æ¥ä¿å­˜å’Œæ¢å¤å¯„å­˜å™¨ï¼Œéœ€è¦æ³¨æ„spå¯„å­˜å™¨ï¼Œspå¯„å­˜å™¨çš„å€¼ç”¨åˆ°sscratchï¼Œè¿™ä¸ªå¯„å­˜å™¨ç”¨æ¥äº¤æ¢å†…æ ¸æ ˆspå€¼ï¼Œè¿˜è¦æ³¨æ„å¤„ç†å½“å‰æ‰§è¡Œçš„ä½ç½®ã€‚</p>
<p>traphandlerä¸­æ ¹æ®scauseçš„ç»“æžœï¼Œå¯¹ä¸åŒçš„å¼‚å¸¸è¿›è¡Œå¤„ç†ï¼ŒåŒ…æ‹¬ecallï¼Œrunnextç­‰æ“ä½œã€‚</p>
<h3 id="ch3"><a href="#ch3" class="headerlink" title="ch3"></a>ch3</h3><p>è¿™ä¸€ç« è¦åˆ›å»ºä¸€ä¸ªå¤šé“ç¨‹åºå¤„ç†ç³»ç»Ÿï¼Œéœ€è¦å®žçŽ°åˆ†æ—¶è°ƒç”¨å°±å¿…é¡»è¦å°†åº”ç”¨éƒ½åŠ è½½åˆ°å†…å­˜ï¼Œè¿™ä¹Ÿæ„å‘³ç€ä¹Ÿè¦ä¸ºå½“å‰æ¯ä¸ªåº”ç”¨éƒ½åˆ†é…ç‹¬ç«‹æ ˆç©ºé—´ã€‚æ‰€ä»¥ä¸èƒ½åƒä¸ŠèŠ‚ä¸€æ ·éƒ½åŠ è½½åˆ°baseåœ°å€ï¼Œéœ€è¦ç¡®ä¿åº”ç”¨å ç”¨çš„ç©ºé—´ä¸ä¼šé‡å ã€‚åˆ‡æ¢ä»»åŠ¡å¿…ç„¶ä¹Ÿè¦ä¿å­˜ä¸Šä¸‹æ–‡ï¼Œä¸Žç³»ç»Ÿè°ƒç”¨ä¸åŒçš„æ˜¯ï¼Œä»»åŠ¡åˆ‡æ¢çš„æ“ä½œä¿å­˜å¯„å­˜å™¨æ¢å¤å¯„å­˜å™¨éƒ½æ˜¯åœ¨ç”¨æˆ·æ€ã€‚rcoreæ ¹æ®sbiå®žçŽ°äº†gettimeï¼Œè®¾å®šè®¡æ—¶å™¨åŽï¼Œè®¡æ—¶å™¨åˆ°æ—¶è§¦å‘å¼‚å¸¸ï¼Œtraphandleræ•æ‰åˆ°åŽæ‰§è¡Œä»»åŠ¡åˆ‡æ¢æ“ä½œã€‚</p>
<p>ä»»åŠ¡åˆ‡æ¢æœ€é‡è¦çš„æ˜¯switchæ“ä½œï¼Œåœ¨æ‰§è¡Œä¹‹å‰å·²ç»å°†ä¸‹ä¸ªä»»åŠ¡çš„æ ˆé¡¶åœ°å€ä¿å­˜èµ·æ¥ï¼Œä¿å­˜å½“å‰å¯„å­˜å™¨çŽ¯å¢ƒåŽï¼Œå¯¼å…¥ä¸‹ä¸ªä»»åŠ¡çš„å¯„å­˜å™¨çŽ¯å¢ƒã€‚yeildæ“ä½œä¸ºè®¡æ—¶å™¨ä¸­æ–­è§¦å‘åˆ‡æ¢ä»»åŠ¡çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<h2 id="3-24-3-25"><a href="#3-24-3-25" class="headerlink" title="3.24-3.25"></a>3.24-3.25</h2><p>å…³äºŽtraceçš„ç³»ç»Ÿè°ƒç”¨å®žçŽ°,éœ€è¦åˆ¤æ–­requestæ¥å®žçŽ°ä¸åŒåŠŸèƒ½. åœ¨requestä¸º0æ—¶:éœ€è¦å°†idè½¬æ¢æˆ<em>const u8 å†è§£å¼•ç”¨,å†è½¬æ¢ä¸ºisizeè¿”å›ž;åœ¨requestä¸º1æ—¶:è¦å°†idè½¬æ¢æˆ</em>mut u8,å†å°†dataè½¬æ¢æˆu8,å¤åˆ¶ç»™idè½¬æ¢åŽæŒ‡é’ˆçš„è§£å¼•ç”¨,è¿”å›ž0;</p>
<p>å½“requestä¸º2æ—¶: æƒ³è¦èŽ·å–æ¯ä¸ªä»»åŠ¡çš„æŸä¸ªç³»ç»Ÿè°ƒç”¨æ¬¡æ•°,å¹¶ä¸”è€ƒè™‘åˆ°æ‰¹å¤„ç†ç³»ç»Ÿä¼šè¿›è¡Œä»»åŠ¡åˆ‡æ¢,æ‰€ä»¥åœ¨åˆ‡æ¢åˆ°å…¶ä»–ä»»åŠ¡æ—¶ä¹Ÿè¦ä¿å­˜ç€å…¶ä»–åˆ®èµ·çš„äººç‰©çš„è°ƒç”¨æ¬¡æ•°,æ‰€ä»¥æˆ‘å°±åœ¨syscall/mod.rsä¸­å®žçŽ°äº†ä¸ªå…¨å±€å˜é‡SYSCALL_COUNT,ç±»åž‹ä¸ºMutex&lt;BTreeMap&lt;usize, BTreeMap&lt;usize, usize&gt;&gt;&gt;,MutexåŒ…è£¹æ˜¯å› ä¸ºä»–æ˜¯å…¨å±€å˜é‡(rustçš„è¦æ±‚? æŒ‰ç†è¯´æ‰¹å¤„ç†å•è¿›ç¨‹ç”¨ä¸åˆ°é”,ä½†æ˜¯æˆ‘ç¼–è¯‘æ²¡è¿‡å°±åŠ ä¸Šäº†.),å¤–å±‚BTree keyä¸ºapp_id,valueä¸ºå†…å±‚BTree,å†…å±‚BTreeä¸º(sys_id, count).è¿™æ ·å°±å¯ä»¥é€šè¿‡app_idæ¥å¾—åˆ°æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°.syscall_countæ–¹æ³•åœ¨syscallé‡Œç”¨æ¥è®¡æ•°,insert_syscall_countä¸ºå½“å‰ä»»åŠ¡åˆå§‹åŒ–è®°å½•,å·²æœ‰è®°å½•åˆ™è¿”å›ž,delete_syscall_countåœ¨è¿›ç¨‹é€€å‡ºæ—¶åˆ é™¤è®°å½•,get_syscall_countå°±ç”¨æ¥åœ¨sys_traceé‡ŒèŽ·å–å½“å‰ä»»åŠ¡çš„ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°.</p>
<h2 id="3-25-3-26"><a href="#3-25-3-26" class="headerlink" title="3.25-3.26"></a>3.25-3.26</h2><p>åœ¨sys_get_timeå’Œsys_traceå®žçŽ°æœ€ä¸»è¦çš„æ˜¯å°†è™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€,å› ä¸ºå†…æ ¸ä¸èƒ½è®¿é—®åº”ç”¨çš„è™šæ‹Ÿåœ°å€.sys_get_timeé¦–å…ˆèŽ·å–åº”ç”¨è™šæ‹Ÿé¡µè¡¨,å°†tsè½¬æ¢æˆè™šæ‹Ÿåœ°å€,è®°å½•åç§»,é€šè¿‡é¡µè¡¨è½¬æ¢åŽå¯ä»¥å¾—åˆ°å¯¹åº”çš„ç‰©ç†é¡µè¡¨é¡¹,å°†è¡¨é¡¹åŠ ä¸Šåç§»å°±å¾—åˆ°äº†å¯¹åº”tsçš„ç‰©ç†åœ°å€,ç„¶åŽè½¬æ¢æˆmutæŒ‡é’ˆ,å°†èŽ·å–çš„timevalå¤åˆ¶ç»™è¯¥åœ°å€.åˆ¤æ–­è·¨é¡µæ˜¯è¦åœ¨tsåœ°å€ä¸ŠåŠ ä¸Štimevalé•¿åº¦å¾—åˆ°æˆªè‡³åœ°å€,ä¸Žstart%PagesizeåŽåˆ¤æ–­æ˜¯å¦ç›¸ç­‰,ä¸ç›¸ç­‰åˆ™è¦å¤„ç†è·¨é¡µ,è¿˜æ˜¯è®¡ç®—å‡ºç‰©ç†åœ°å€åˆ†åˆ«åœ¨å¯¹åº”éƒ¨åˆ†æ‹·è´è¯¥éƒ¨åˆ†çš„æ•°æ®.</p>
<p> sys_traceç›¸æ¯”ä¸Šæ¬¡åªéœ€è¦å¤„ç†0,1çš„æƒ…å†µ,è¦æƒ³åŠžæ³•é€šè¿‡è™šæ‹Ÿåœ°å€è¯»å–æˆ–å†™å…¥,åŒæ ·è½¬æ¢ä¸ºç‰©ç†åœ°å€å°±å¯ä»¥å°†å…¶è½¬æ¢æˆæŒ‡é’ˆ.åœ¨èŽ·å–ç‰©ç†é¡µè¡¨é¡¹æ—¶è¦æ³¨æ„åˆ¤æ–­é¡µè¡¨é¡¹çš„æœ‰æ•ˆæ€§ å¯è¯»æ€§ å¯å†™æ€§.</p>
<p> mmapå°±æ˜¯è¦ä¸ºåº”ç”¨ç¨‹åºç”³è¯·ä¸€å—åŠ¨æ€åŒºåŸŸ,è¿™ä¸ªå°±è¦åœ¨memsetä¸Šå¤„ç†,æœ¬æ¥æˆ‘æ˜¯å‡†å¤‡å°†å†…å­˜åŠ å…¥areasçš„,ä½†æ˜¯åœ¨å†™unmapæ—¶åˆ¤æ–­vpnæ¥åˆ é™¤æœ‰äº›å›°éš¾,å°±è€ƒè™‘é‡æ–°ä¸ºmmapçš„å†…å­˜é‡æ–°å»ºç«‹æ˜ å°„ç»“æž„.å¤„ç†æ—¶å°±æ˜¯è¦å‡ ä¸ªç‚¹æ³¨æ„,1:åˆ¤æ–­portæ˜¯å¦å…¨0æˆ–è€…æ— æ•ˆä½æœ‰éž0, 2:åˆ¤æ–­startæ˜¯å¦é¡µè¡¨å¯¹é½,æ²¡æœ‰å¯¹é½å°±è¿”å›ž, 3:PTEFlagsä¸ä»…è¦åŠ ä¸Športçš„æ ‡å¿—,è¿˜éœ€è¦æœ‰æ•ˆä½Vå’Œç”¨æˆ·ä½U, 4:è®¡ç®—è™šæ‹Ÿé¡µè¡¨èµ·å§‹åœ°å€,ç„¶åŽå¯¹æ¯ä¸ªé¡µå¾ªçŽ¯éåŽ†, 5: åˆ¤æ–­è™šæ‹Ÿé¡µè¡¨æœ‰æ•ˆæ€§,æœ‰æ•ˆåˆ™è¿”å›ž(mapped), 6: ç”³è¯·ç‰©ç†é¡µå»ºç«‹æ˜ å°„.</p>
<p> unmapè¦åˆ¤æ–­è™šæ‹Ÿé¡µè¡¨æ— æ•ˆæ€§,ç„¶åŽå¾ªçŽ¯éåŽ†æ¯ä¸ªvpnåœ¨è™šæ‹Ÿé¡µè¡¨ä¸­è¢«unmap,å¹¶ç§»é™¤mmap_setå¯¹åº”é¡¹.</p>
<h2 id="3-26-3-28"><a href="#3-26-3-28" class="headerlink" title="3.26-3.28"></a>3.26-3.28</h2><p>å…³äºŽspawn,ç›¸æ¯”forkå°±æ˜¯ä¸è¦å¤åˆ¶çˆ¶è¿›ç¨‹çš„å†…å­˜å¸ƒå±€,å°†ä¼ è¿›æ¥çš„å­—ç¬¦ä¸²æŒ‡é’ˆè½¬æ¢æˆstring,é€šè¿‡è¿™ä¸ªåå­—èŽ·å–åº”ç”¨elf_data,åŽé¢å°±å¯¹TCBè¿›è¡Œåˆå§‹åŒ–,å’ŒTCB::newä¸€æ ·,æ³¨æ„ä¸‰ç‚¹,çˆ¶è¿›ç¨‹è®¾ç½®ä¸ºå½“å‰è¿›ç¨‹;å°†è¯¥è¿›ç¨‹åŠ å…¥çˆ¶è¿›ç¨‹çš„childåˆ—è¡¨;å°†è¯¥è¿›ç¨‹åŠ å…¥è¿è¡Œé˜Ÿåˆ—.</p>
<p> å…³äºŽstride,æˆ‘å®šä¹‰äº†ä¸¤ä¸ªå¸¸é‡BASE_STRIDE=91,BIG_STRIDE=99991.åœ¨TCBinneré‡ŒåŠ å…¥ä¸¤ä¸ªé‡:pass=0,prio=1,å°è£…updatepass:</p>
<p>pass += (BASE_STRIDE / prio) % BIG_STRIDE</p>
<p>ç•™å‡ºç›¸å…³æŽ¥å£.å†åˆ°run_taskè°ƒç”¨updatepass, åœ¨fatché‡Œå¯¹ready_queueå–å‡ºæœ€å°passçš„TCB.</p>
<h2 id="3-28-3-30"><a href="#3-28-3-30" class="headerlink" title="3.28-3.30"></a>3.28-3.30</h2><p> å…³äºŽlinkï¼Œä¸Žlinuxçš„lnå‘½ä»¤ç±»ä¼¼ï¼Œå¯¹æ–‡ä»¶åˆ›å»ºé“¾æŽ¥ç›¸å½“äºŽåœ¨æ“ä½œç³»ç»Ÿå±‚é¢å¢žåŠ ä¸ªINodeï¼Œä½†æ˜¯ç£ç›˜é‡Œå…±ç”¨ç»Ÿä¸€ç‰‡å—ï¼Œé‚£ç›¸å½“äºŽæ‹¥æœ‰ç›¸åŒçš„inodeç¼–å·ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡åŽŸæ–‡ä»¶åç§°èŽ·å–ç¼–å·ï¼Œå·²çŸ¥æ‰€æœ‰æ–‡ä»¶éƒ½åœ¨æ ¹ç›®å½•ã€‚æ‰¾åˆ°ç¼–å·åŽå°±å¯ä»¥å¾—åˆ°å—ä½ç½®idå’Œoffsetï¼Œåœ¨åˆ›å»ºinodeæ—¶éœ€è¦ã€‚æŽ¥ä¸‹æ¥ä¿®æ”¹ç›®å½•é¡¹ï¼Œéœ€è¦å…ˆæ‰©å±•ç›®å½•é¡¹çš„å­˜å‚¨åŒºåŸŸï¼ŒåŽå†™å…¥ç›®å½•é¡¹ã€‚è¿”å›žä¸€ä¸ªæ–°çš„inodeã€‚</p>
<p> å…³äºŽunlinkï¼Œé€šè¿‡nameæ‰¾åˆ°æ ¹èŠ‚ç‚¹åŽè®¡ç®—ç›®å½•é¡¹æ•°ç›®ï¼Œå¾ªçŽ¯è¯»å–æ ¹èŠ‚ç‚¹æ¯ä¸ªæ–‡ä»¶å¯¹æ¯”åç§°ï¼Œæ‰¾åˆ°indexåŽï¼ŒæŠŠæœ«å°¾çš„ç›®å½•é¡¹æ¢åˆ°indexå¤„ï¼Œå‡å°ç›®å½•å¤§å°ã€‚</p>
<p> statå°±è¿žä¸¤ä¸ªé¡¹éœ€è¦èŽ·å–ï¼Œinoå°±æ˜¯blockidï¼Œnlinkéœ€è¦é€šè¿‡å—ä½ç½®æ¥å¯¹ç›®å½•é‡Œæ‰€æœ‰æ–‡ä»¶çš„å—ä½ç½®è¿›è¡Œæ¯”è¾ƒï¼Œç›¸åŒè®¡æ•°åŠ 1.åœ¨è¿”å›žæ—¶æˆ‘å’Œgettimeçš„å¤„ç†ä¸€æ ·ï¼Œå°†è™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€åŽå†è½¬æ¢æˆå¯å˜æŒ‡é’ˆï¼Œå°†statç»“æž„ä½“æŒ‡é’ˆæ”¾è¿›åŽ»ã€‚</p>
<h2 id="3-30-4-3"><a href="#3-30-4-3" class="headerlink" title="3.30-4.3"></a>3.30-4.3</h2><p>è¿™èŠ‚è¿˜æŒºè´¹åŠ²çš„ã€‚åˆšå¼€å§‹çœ‹äº†å¾ˆä¹…æ²¡å‘çŽ°æ˜¯é“¶è¡Œå®¶ç®—æ³•ï¼Œä¸çŸ¥é“å¦‚ä½•æ¥æŠ½è±¡è¿™äº›èµ„æºã€‚</p>
<p>é¦–å…ˆå°±æ˜¯æ¸…æ¥šæ˜¯è¦ä»¥æ¯ä¸ªè¿›ç¨‹ä¸ºå•ä½æ¥è¿›è¡Œèµ„æºç®¡ç†ï¼Œæ‰€ä»¥åœ¨pcb inneré‡Œæ·»åŠ äº†æ­»é”æ£€æµ‹æ¨¡å—ã€‚æ¨¡å—æ•°æ®ä¸€ç»´ä¸ºçº¿ç¨‹tidï¼ŒäºŒç»´ä¸ºèµ„æºridï¼Œæ¨¡å—éœ€è¦å®žçŽ°å‡ ä¸ªåŠŸèƒ½ï¼Œisunsafeå°±æ˜¯é“¶è¡Œå®¶ç®—æ³•ç”¨æ¥æŸ¥çœ‹å½“å‰çŠ¶æ€æ˜¯å¦å®‰å…¨ï¼Œtryallocateåœ¨æ£€æŸ¥unsafeåŒæ—¶é€šè¿‡tidå’Œridå¤„ç†å‡å°availableå’Œneedï¼Œå¢žåŠ allocationï¼›setneedéœ€è¦åœ¨è®¾ç½®èµ„æºå‰è°ƒç”¨ï¼Œåœ¨åˆ†é…å¤±è´¥æ—¶ä¼šä¿ç•™ï¼Œåœ¨åˆ†é…æˆåŠŸä¼šå‡å°ã€‚releaseåœ¨upæ—¶å¢žåŠ availableå’Œå‡å°allocationï¼›æ£€æµ‹å¼€å…³åªéœ€è¦è®¾ç½®enabledã€‚åœ¨åˆ›å»ºçº¿ç¨‹å’Œåˆ›å»ºèµ„æºæ—¶éœ€è¦æ›´æ–°æ•°æ®ç»“æž„ï¼Œåœ¨æ·»åŠ ä¸€ä¸ªçº¿ç¨‹æ—¶ä¼šä¸ºäºŒç»´ç»“æž„æ·»åŠ èµ„æºæ•°çš„å…¨ä¸º0çš„å‘é‡ï¼Œåœ¨æ·»åŠ mutexæ—¶availåˆ™push 1ï¼Œsemåˆ™push åˆå§‹åŒ–å€¼ã€‚åœ¨downæ—¶é¦–å…ˆåˆ¤æ–­æ˜¯å¦æ‰“å¼€äº†æ£€æµ‹ï¼Œæ‰“å¼€äº†å°±é¦–å…ˆsetneedï¼Œç„¶åŽåˆ¤æ–­unsafeå¦‚æžœä¸å®‰å…¨åˆ™ç›´æŽ¥è¿”å›ždeadï¼Œå®‰å…¨åˆ™å°è¯•åˆ†é…ï¼ˆä¼šå¤±è´¥ï¼‰ï¼Œç„¶åŽè°ƒç”¨downï¼›upæ—¶åˆ¤æ–­æ£€æµ‹æ‰“å¼€ä¹‹åŽå°±è°ƒç”¨releaseï¼Œreleaseåˆ¤æ–­äº†å½“å‰åˆ†é…æ•°æ˜¯å¦ä¸º0ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/blog/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/61/">61</a><a class="extend next" rel="next" href="/blog/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rcore-os Group</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>


  















  

  

  

</body>
</html>
