<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">
  
  <link rel="stylesheet" href="/blog/lib/animate-css/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rcore-os.github.io","root":"/blog/","scheme":"Muse","version":"8.0.0-rc.4","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}}};
  </script>

  <meta name="description" content="ArceOS RecordArceOS 的设计可以说优雅而不失健壮性，利用rust优秀的包管理机制和crates的特性组件化地搭建OS，将复杂的OS设计解耦，各个模块功能清晰、层次鲜明， tutorial出于教学的目的，在modules引入了dependence crates；而在主线arceos中，将解耦做到了极致，形成了清晰的Unikernel层次：dependence crates -&amp;gt">
<meta property="og:type" content="article">
<meta property="og:title" content="ArceOS Learning Record-Anekoqie">
<meta property="og:url" content="http://rcore-os.github.io/blog/2025/04/23/ArceOS-Learning-Record-Anekoqie/index.html">
<meta property="og:site_name" content="rcore-os Blog">
<meta property="og:description" content="ArceOS RecordArceOS 的设计可以说优雅而不失健壮性，利用rust优秀的包管理机制和crates的特性组件化地搭建OS，将复杂的OS设计解耦，各个模块功能清晰、层次鲜明， tutorial出于教学的目的，在modules引入了dependence crates；而在主线arceos中，将解耦做到了极致，形成了清晰的Unikernel层次：dependence crates -&amp;gt">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://rcore-os.github.io/blog/2025/04/23/ArceOS-Learning-Record-Anekoqie/image.png">
<meta property="og:image" content="https://oslearning365.github.io/arceos-tutorial-book/img/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.svg">
<meta property="og:image" content="https://oslearning365.github.io/arceos-tutorial-book/img/Unikernel%E4%B8%8E%E5%85%B6%E5%AE%83%E5%BD%A2%E6%80%81%E5%AF%B9%E6%AF%94.svg">
<meta property="og:image" content="https://oslearning365.github.io/arceos-tutorial-book/img/%E6%9C%80%E6%97%A9%E7%9A%84%E7%BB%84%E4%BB%B6.svg">
<meta property="og:image" content="https://oslearning365.github.io/arceos-tutorial-book/img/%E4%B8%BB%E5%B9%B2%E7%BB%84%E4%BB%B6%E5%B1%82%E6%AC%A1.png">
<meta property="og:image" content="https://oslearning365.github.io/arceos-tutorial-book/img/%E6%97%A9%E6%9C%9F%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8.svg">
<meta property="og:image" content="https://oslearning365.github.io/arceos-tutorial-book/img/crate_interface.svg">
<meta property="og:image" content="https://oslearning365.github.io/arceos-tutorial-book/img/bitmap-allocator.svg">
<meta property="og:image" content="https://oslearning365.github.io/arceos-tutorial-book/img/buddy%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D.png">
<meta property="og:image" content="https://oslearning365.github.io/arceos-tutorial-book/img/%E5%88%9D%E5%A7%8B%E4%BB%BB%E5%8A%A1InitTask.svg">
<meta property="og:image" content="https://oslearning365.github.io/arceos-tutorial-book/img/maintask-create-apptask.svg">
<meta property="og:image" content="https://oslearning365.github.io/arceos-tutorial-book/img/wait-for-task.svg">
<meta property="article:published_time" content="2025-04-23T17:13:44.000Z">
<meta property="article:modified_time" content="2025-07-08T07:23:43.536Z">
<meta property="article:author" content="rcore-os Group">
<meta property="article:tag" content="author:Anekoique">
<meta property="article:tag" content="repo:https:&#x2F;&#x2F;github.com&#x2F;Anekoique&#x2F;ArceOS-Record.github">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://rcore-os.github.io/blog/2025/04/23/ArceOS-Learning-Record-Anekoqie/image.png">

<link rel="canonical" href="http://rcore-os.github.io/blog/2025/04/23/ArceOS-Learning-Record-Anekoqie/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>ArceOS Learning Record-Anekoqie | rcore-os Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">rcore-os Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ArceOS-Record"><span class="nav-number">1.</span> <span class="nav-text">ArceOS Record</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Tutorial-Record"><span class="nav-number">1.1.</span> <span class="nav-text">Tutorial Record</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Ch0-Hello-World"><span class="nav-number">1.1.1.</span> <span class="nav-text">Ch0 Hello World</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一、启动内核"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">一、启动内核</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二、建立内核程序入口"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">二、建立内核程序入口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ch1-Hello-ArceOS"><span class="nav-number">1.1.2.</span> <span class="nav-text">Ch1 Hello ArceOS</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一、Unikernel与组件化"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">一、Unikernel与组件化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二、解耦Unikernel"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">二、解耦Unikernel</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三、组件测试-模块测试"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">三、组件测试&#x2F;模块测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#四、添加组件"><span class="nav-number">1.1.2.4.</span> <span class="nav-text">四、添加组件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ch2-内存管理1"><span class="nav-number">1.1.3.</span> <span class="nav-text">Ch2 内存管理1</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一、内核框架构建"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">一、内核框架构建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二、引入分页机制"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">二、引入分页机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三、启用动态内存分配"><span class="nav-number">1.1.3.3.</span> <span class="nav-text">三、启用动态内存分配</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#byte-pos-和-page-pos-的意义"><span class="nav-number">1.1.3.3.1.</span> <span class="nav-text">byte_pos 和 page_pos 的意义</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ch3-Basic-Component"><span class="nav-number">1.1.4.</span> <span class="nav-text">Ch3 Basic Component</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一、打破循环依赖"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">一、打破循环依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二、其他组件"><span class="nav-number">1.1.4.2.</span> <span class="nav-text">二、其他组件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#axlog"><span class="nav-number">1.1.4.2.1.</span> <span class="nav-text">axlog</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#axdtb"><span class="nav-number">1.1.4.2.2.</span> <span class="nav-text">axdtb</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ch4-内存管理2"><span class="nav-number">1.1.5.</span> <span class="nav-text">Ch4 内存管理2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一、实现多级页表"><span class="nav-number">1.1.5.1.</span> <span class="nav-text">一、实现多级页表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二、页内存分配器"><span class="nav-number">1.1.5.2.</span> <span class="nav-text">二、页内存分配器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三、字节内存分配器"><span class="nav-number">1.1.5.3.</span> <span class="nav-text">三、字节内存分配器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ch5-线程管理"><span class="nav-number">1.1.6.</span> <span class="nav-text">Ch5 线程管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一、初始任务"><span class="nav-number">1.1.6.1.</span> <span class="nav-text">一、初始任务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二、创建任务"><span class="nav-number">1.1.6.2.</span> <span class="nav-text">二、创建任务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三、任务切换"><span class="nav-number">1.1.6.3.</span> <span class="nav-text">三、任务切换</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ch6-异常和中断"><span class="nav-number">1.1.7.</span> <span class="nav-text">Ch6 异常和中断</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一、异常处理"><span class="nav-number">1.1.7.1.</span> <span class="nav-text">一、异常处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二、启用自旋锁"><span class="nav-number">1.1.7.2.</span> <span class="nav-text">二、启用自旋锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三、启用时钟中断"><span class="nav-number">1.1.7.3.</span> <span class="nav-text">三、启用时钟中断</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ch7-抢占式调度"><span class="nav-number">1.1.8.</span> <span class="nav-text">Ch7 抢占式调度</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一、抢占式调度"><span class="nav-number">1.1.8.1.</span> <span class="nav-text">一、抢占式调度</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二、Mutex锁"><span class="nav-number">1.1.8.2.</span> <span class="nav-text">二、Mutex锁</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Main-Record"><span class="nav-number">1.2.</span> <span class="nav-text">Main Record</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#axconfig"><span class="nav-number">1.2.1.</span> <span class="nav-text">axconfig</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axruntime"><span class="nav-number">1.2.2.</span> <span class="nav-text">axruntime</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#abstract-graph"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">abstract graph</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axhal"><span class="nav-number">1.2.3.</span> <span class="nav-text">axhal</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#abstract-graph-1"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">abstract graph</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Framework"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">Framework</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#support-crates"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">support crates</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axns"><span class="nav-number">1.2.4.</span> <span class="nav-text">axns</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#abstract-graph-2"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">abstract graph</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Data-Structure"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">Data Structure</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axalloc"><span class="nav-number">1.2.5.</span> <span class="nav-text">axalloc</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#abstract-graph-3"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">abstract graph</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Data-Structure-1"><span class="nav-number">1.2.5.2.</span> <span class="nav-text">Data Structure</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axmm"><span class="nav-number">1.2.6.</span> <span class="nav-text">axmm</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#abstract-graph-4"><span class="nav-number">1.2.6.1.</span> <span class="nav-text">abstract graph</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Data-structure"><span class="nav-number">1.2.6.2.</span> <span class="nav-text">Data structure</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#support-crates-1"><span class="nav-number">1.2.6.3.</span> <span class="nav-text">support crates</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axtask"><span class="nav-number">1.2.7.</span> <span class="nav-text">axtask</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#abstract-graph-5"><span class="nav-number">1.2.7.1.</span> <span class="nav-text">abstract graph</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Data-structure-1"><span class="nav-number">1.2.7.2.</span> <span class="nav-text">Data structure</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#support-crates-2"><span class="nav-number">1.2.7.3.</span> <span class="nav-text">support crates</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axdriver"><span class="nav-number">1.2.8.</span> <span class="nav-text">axdriver</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#abstract-graph-6"><span class="nav-number">1.2.8.1.</span> <span class="nav-text">abstract graph</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Data-structure-2"><span class="nav-number">1.2.8.2.</span> <span class="nav-text">Data structure</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#support-crates-3"><span class="nav-number">1.2.8.3.</span> <span class="nav-text">support crates</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axfs"><span class="nav-number">1.2.9.</span> <span class="nav-text">axfs</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#abstract-graph-7"><span class="nav-number">1.2.9.1.</span> <span class="nav-text">abstract graph</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Data-structure-3"><span class="nav-number">1.2.9.2.</span> <span class="nav-text">Data structure</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#support-crates-4"><span class="nav-number">1.2.9.3.</span> <span class="nav-text">support crates</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axnet"><span class="nav-number">1.2.10.</span> <span class="nav-text">axnet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axdma"><span class="nav-number">1.2.11.</span> <span class="nav-text">axdma</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axsync"><span class="nav-number">1.2.12.</span> <span class="nav-text">axsync</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#support-crates-5"><span class="nav-number">1.2.12.1.</span> <span class="nav-text">support crates</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axlog-1"><span class="nav-number">1.2.13.</span> <span class="nav-text">axlog</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Appendix-A-Makefile"><span class="nav-number">1.2.14.</span> <span class="nav-text">Appendix A: Makefile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Appendix-B-Linker-lds-S"><span class="nav-number">1.2.15.</span> <span class="nav-text">Appendix B: Linker.lds.S</span></a></li></ol></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rcore-os Group</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">730</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">69</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">633</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content post posts-expand">
          

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://rcore-os.github.io/blog/2025/04/23/ArceOS-Learning-Record-Anekoqie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="rcore-os Group">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rcore-os Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ArceOS Learning Record-Anekoqie
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-23 17:13:44" itemprop="dateCreated datePublished" datetime="2025-04-23T17:13:44+00:00">2025-04-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-08 07:23:43" itemprop="dateModified" datetime="2025-07-08T07:23:43+00:00">2025-07-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="ArceOS-Record"><a href="#ArceOS-Record" class="headerlink" title="ArceOS Record"></a>ArceOS Record</h1><p>ArceOS 的设计可以说优雅而不失健壮性，利用rust优秀的包管理机制和crates的特性组件化地搭建OS，将复杂的OS设计解耦，各个模块功能清晰、层次鲜明，</p>
<p>tutorial出于教学的目的，在modules引入了dependence crates；而在主线arceos中，将解耦做到了极致，形成了清晰的Unikernel层次：dependence crates -&gt; kernel modules -&gt; api -&gt; ulib -&gt; app,下为上提供功能，上到下形成层次鲜明的抽象，这种抽象又为异构内核的实现提供支持，以宏内核为例，其既可以使用api提供的功能，又可以复用kernel modules支持更多的功能，这种自由的复用和组织可以为定制化操作系统提供极大的便利和支持，方便基于需求实现特定OS</p>
<a id="more"></a>

<img src="/blog/2025/04/23/ArceOS-Learning-Record-Anekoqie/image.png" class="" title="image">

<h2 id="Tutorial-Record"><a href="#Tutorial-Record" class="headerlink" title="Tutorial Record"></a>Tutorial Record</h2><h3 id="Ch0-Hello-World"><a href="#Ch0-Hello-World" class="headerlink" title="Ch0 Hello World"></a>Ch0 Hello World</h3><p>Target：让qemu成功跳转到内核入口，执行指令</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ch0 code framework</span></span><br><span class="line">.</span><br><span class="line">├── axorigin</span><br><span class="line">│   ├── Cargo.lock</span><br><span class="line">│   ├── Cargo.toml</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lang_items.rs</span><br><span class="line">│       └── main.rs</span><br><span class="line">├── linker.lds</span><br><span class="line">├── Makefile</span><br><span class="line">├── qemu.log</span><br><span class="line">├── README.md</span><br><span class="line">└── rust-toolchain.toml</span><br></pre></td></tr></table></figure>

<h4 id="一、启动内核"><a href="#一、启动内核" class="headerlink" title="一、启动内核"></a>一、启动内核</h4><p><img src="https://oslearning365.github.io/arceos-tutorial-book/img/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.svg" alt="启动过程"></p>
<p>qemu-riscv启动内核过程</p>
<ol>
<li><p>PC初始化为0x1000</p>
</li>
<li><p>qemu在0x1000预先放置ROM，执行其中代码，跳转到0x8000_0000</p>
</li>
<li><p>qemu在0x8000_0000预先放置OpenSBI，由此启动SBI，进行硬件初始化工作，提供功能调用；M-Mode切换到S-Mode，跳转到0x8020_0000</p>
</li>
<li><p>我们将内核加载到0x8020_0000,启动内核</p>
</li>
</ol>
<blockquote>
<p>[!CAUTION]</p>
<p>riscv 体系结构及平台设计的简洁性：</p>
<p>RISC-V SBI 规范定义了平台固件应当具备的功能和服务接口，多数情况下 SBI 本身就可以代替传统上固件 BIOS/UEFI + BootLoader 的位置和作用</p>
<p>// qemu-riscv 启动<br>QEMU 启动 → 加载内置 OpenSBI（固件） → 直接跳转至内核入口 → 内核运行<br>// qemu-x86 启动<br>QEMU 启动 → 加载 SeaBIOS（传统 BIOS） → 加载 GRUB（BootLoader） → 解析配置文件 → 加载内核 → 内核运行</p>
</blockquote>
<h4 id="二、建立内核程序入口"><a href="#二、建立内核程序入口" class="headerlink" title="二、建立内核程序入口"></a>二、建立内核程序入口</h4><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 准备编译工具链</span></span><br><span class="line"><span class="comment"># rust-roolchain.toml</span></span><br><span class="line"><span class="section">[toolchain]</span></span><br><span class="line"><span class="attr">profile</span> = <span class="string">"minimal"</span></span><br><span class="line"><span class="attr">channel</span> = <span class="string">"nightly"</span></span><br><span class="line"><span class="attr">components</span> = [<span class="string">"rust-src"</span>, <span class="string">"llvm-tools-preview"</span>, <span class="string">"rustfmt"</span>, <span class="string">"clippy"</span>]</span><br><span class="line"><span class="attr">targets</span> = [<span class="string">"riscv64gc-unknown-none-elf"</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 将内核入口放置在image文件开头</span><br><span class="line"># linker.lds</span><br><span class="line">OUTPUT_ARCH(riscv)</span><br><span class="line"></span><br><span class="line">BASE_ADDRESS &#x3D; 0x80200000;</span><br><span class="line"></span><br><span class="line">ENTRY(_start)</span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">    . &#x3D; BASE_ADDRESS;</span><br><span class="line">    _skernel &#x3D; .;</span><br><span class="line"></span><br><span class="line">    .text : ALIGN(4K) &#123;</span><br><span class="line">        _stext &#x3D; .;</span><br><span class="line">        &#x2F;&#x2F; 内核入口标记：*(.text.boot)</span><br><span class="line">        *(.text.boot)                      </span><br><span class="line">        *(.text .text.*)</span><br><span class="line">        . &#x3D; ALIGN(4K);</span><br><span class="line">        _etext &#x3D; .;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axorigin/src/main.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"><span class="keyword">mod</span> lang_items;                                         <span class="comment">// 需要实现panic handler处理不可恢复异常</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[unsafe(no_mangle)]</span>                                    <span class="comment">// 要求编译器保持_start函数名称</span></span><br><span class="line"><span class="meta">#[unsafe(link_section = <span class="meta-string">".text.boot"</span>)]</span>                  <span class="comment">// 将_start放置在链接文件标记处</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">"C"</span> <span class="function"><span class="keyword">fn</span> <span class="title">_start</span></span>() -&gt; ! &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        core::arch::asm!(<span class="string">"wfi"</span>, options(noreturn),);    <span class="comment">// 嵌入一条汇编</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// axorigin/src/lang_items.rs</span></span><br><span class="line"><span class="keyword">use</span> core::panic::PanicInfo;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">panic</span></span>(_info: &amp;PanicInfo) -&gt; ! &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 编译axorigin</span></span><br><span class="line">cargo build --manifest-path axorigin/Cargo.toml \</span><br><span class="line">    --target riscv64gc-unknown-none-elf --target-dir ./target --release</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将编译得到的ELF文件转为二进制格式</span></span><br><span class="line">rust-objcopy --binary-architecture=riscv64 --strip-all -O binary \</span><br><span class="line">    target/riscv64gc-unknown-none-elf/release/axorigin \</span><br><span class="line">    target/riscv64gc-unknown-none-elf/release/axorigin.bin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行qemu</span></span><br><span class="line">qemu-system-riscv64 -m 128M -machine virt -bios default -nographic \</span><br><span class="line">    -kernel target/riscv64gc-unknown-none-elf/release/axorigin.bin \</span><br><span class="line">    -D qemu.log -d in_asm</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Ch1-Hello-ArceOS"><a href="#Ch1-Hello-ArceOS" class="headerlink" title="Ch1 Hello ArceOS"></a>Ch1 Hello ArceOS</h3><p>Target：以组件化方式解耦Unikernel内核，实现输出</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ch1 code framework</span></span><br><span class="line">.</span><br><span class="line">├── axconfig</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axhal</span><br><span class="line">│   ├── linker.lds</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── riscv64</span><br><span class="line">│       │   ├── boot.rs</span><br><span class="line">│       │   ├── console.rs</span><br><span class="line">│       │   └── lang_items.rs</span><br><span class="line">│       └── riscv64.rs</span><br><span class="line">├── axorigin</span><br><span class="line">│   └── src</span><br><span class="line">│       └── main.rs</span><br><span class="line">├── axsync</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── bootcell.rs</span><br><span class="line">│       └── lib.rs</span><br><span class="line">└── spinlock</span><br><span class="line">    └── src</span><br><span class="line">        ├── lib.rs</span><br><span class="line">        └── raw.rs</span><br></pre></td></tr></table></figure>

<h4 id="一、Unikernel与组件化"><a href="#一、Unikernel与组件化" class="headerlink" title="一、Unikernel与组件化"></a>一、Unikernel与组件化</h4><p><img src="https://oslearning365.github.io/arceos-tutorial-book/img/Unikernel%E4%B8%8E%E5%85%B6%E5%AE%83%E5%BD%A2%E6%80%81%E5%AF%B9%E6%AF%94.svg" alt="Unikernel与其它形态对比"></p>
<p>Unikernel：单内核，将应用程序与kernel编译为单一image</p>
<p>Monolithic：内核态，用户态（Linux</p>
<p>Microkernel：仅在内核保留最基础功能，其他服务在用户态</p>
<p>组件化：组件作为模块封装功能，提供接口，各个组件构成操作系统的基本元素；以构建 crate 的方式来构建组件，通过 dependencies+features 的方式组合组件-&gt;<code>ArceOS = 组件仓库 + 组合方式</code></p>
<h4 id="二、解耦Unikernel"><a href="#二、解耦Unikernel" class="headerlink" title="二、解耦Unikernel"></a>二、解耦Unikernel</h4><p><img src="https://oslearning365.github.io/arceos-tutorial-book/img/%E6%9C%80%E6%97%A9%E7%9A%84%E7%BB%84%E4%BB%B6.svg" alt="最早的组件"></p>
<ol>
<li>根据功能将Unikernel分为系统层(axhal)和应用层(axorigin)</li>
</ol>
<p>系统层：封装对体系结构和具体硬件的支持和操作，对外提供硬件操作接口</p>
<p>应用层：实现具体功能，在Ch1中为调用axhal提供的console功能，输出信息</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 系统层实现内核启动：</span></span><br><span class="line"><span class="comment">// 1. 清零BSS区域</span></span><br><span class="line"><span class="comment">// 2. 建立栈支持函数调用</span></span><br><span class="line"><span class="comment">// 3. 跳转到rust_entry</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// axhal/src/boot.rs</span></span><br><span class="line"><span class="meta">#[unsafe(no_mangle)]</span></span><br><span class="line"><span class="meta">#[unsafe(link_section = <span class="meta-string">".text.boot"</span>)]</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">"C"</span> <span class="function"><span class="keyword">fn</span> <span class="title">_start</span></span>() -&gt; ! &#123;</span><br><span class="line">    <span class="comment">// a0 = hartid</span></span><br><span class="line">    <span class="comment">// a1 = dtb</span></span><br><span class="line">    core::arch::asm!(<span class="string">"</span></span><br><span class="line"><span class="string">        la a3, _sbss</span></span><br><span class="line"><span class="string">        la a4, _ebss</span></span><br><span class="line"><span class="string">        ble a4, a3, 2f</span></span><br><span class="line"><span class="string">1:</span></span><br><span class="line"><span class="string">        sd zero, (a3)</span></span><br><span class="line"><span class="string">        add a3, a3, 8</span></span><br><span class="line"><span class="string">        blt a3, a4, 1b</span></span><br><span class="line"><span class="string">2:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        la      sp, boot_stack_top      // setup boot stack（定义在linker.lds</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        la      a2, &#123;entry&#125;</span></span><br><span class="line"><span class="string">        jalr    a2                      // call rust_entry(hartid, dtb)</span></span><br><span class="line"><span class="string">        j       ."</span>,</span><br><span class="line">        entry = sym super::rust_entry,</span><br><span class="line">        options(noreturn),</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过axhal的rust_entry跳转到axorigin的main入口</span></span><br><span class="line"><span class="comment">// axhal/src/lib.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> lang_items;</span><br><span class="line"><span class="keyword">mod</span> boot;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> console;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">"C"</span> <span class="function"><span class="keyword">fn</span> <span class="title">rust_entry</span></span>(_hartid: <span class="built_in">usize</span>, _dtb: <span class="built_in">usize</span>) &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>(hartid: <span class="built_in">usize</span>, dtb: <span class="built_in">usize</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    main(_hartid, _dtb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axhal使用SBI提供的功能调用，实现字符输出</span></span><br><span class="line"><span class="comment">// axhal与SBI交互的过程也体现了其作为系统层封装硬件操作，对外提供硬件操作接口的功能</span></span><br><span class="line"><span class="comment">// axhal/src/console.rs</span></span><br><span class="line"><span class="keyword">use</span> core::fmt::&#123;Error, Write&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Console</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">putchar</span></span>(c: <span class="built_in">u8</span>) &#123;</span><br><span class="line">    <span class="meta">#[allow(deprecated)]</span></span><br><span class="line">    sbi_rt::legacy::console_putchar(c <span class="keyword">as</span> <span class="built_in">usize</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">write_bytes</span></span>(bytes: &amp;[<span class="built_in">u8</span>]) &#123;</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> bytes &#123;</span><br><span class="line">        putchar(*c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Write <span class="keyword">for</span> Console &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">write_str</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, s: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">Result</span>&lt;(), Error&gt; &#123;</span><br><span class="line">        write_bytes(s.as_bytes());</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">__print_impl</span></span>(args: core::fmt::Arguments) &#123;</span><br><span class="line">    Console.write_fmt(args).unwrap();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> ax_print &#123;</span><br><span class="line">    ($($arg:tt)*) =&gt; &#123;</span><br><span class="line">        $crate::console::__print_impl(<span class="built_in">format_args!</span>($($arg)*));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> ax_println &#123;</span><br><span class="line">    () =&gt; &#123; $crate::<span class="built_in">print!</span>(<span class="string">"\n"</span>) &#125;;</span><br><span class="line">    ($($arg:tt)*) =&gt; &#123;</span><br><span class="line">        $crate::console::__print_impl(<span class="built_in">format_args!</span>(<span class="string">"&#123;&#125;\n"</span>, <span class="built_in">format_args!</span>($($arg)*)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将两个组件进行组合，形成可运行Unikernel</li>
</ol>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># axhal/Cargo.toml</span></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">"axhal"</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">"0.1.0"</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">"2021"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">sbi-rt</span> = &#123; version = <span class="string">"0.0.2"</span>, features = [<span class="string">"legacy"</span>] &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># axorigin/Cargo.toml  </span></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">"axorigin"</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">"0.1.0"</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">"2021"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">axhal</span> = &#123; path = <span class="string">"../axhal"</span> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="三、组件测试-模块测试"><a href="#三、组件测试-模块测试" class="headerlink" title="三、组件测试/模块测试"></a>三、组件测试/模块测试</h4><p>组件测试相当于 crate 级的测试，直接在 crate 根目录下建立 tests 模块，对组件进行基于公开接口的黑盒测试；模块测试对应于单元测试，在模块内建立子模块tests，对模块的内部方法进行白盒测试</p>
<blockquote>
<p>[!CAUTION]</p>
<p>make run 和 make test编译执行环境不同，make run编译目标为riscv架构，运行在qumu上，make test相当于将测试作为应用直接运行于x86 linux(your pc)上</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 互相隔离的环境，test下不能有RUSTFLAGS环境变量</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">filter</span> <span class="variable">$(MAKECMDGOALS)</span>,test)</span>,)  <span class="comment"># not run `cargo test`</span></span><br><span class="line">RUSTFLAGS := -C link-arg=-T<span class="variable">$(LD_SCRIPT)</span> -C link-arg=-no-pie</span><br><span class="line"><span class="keyword">export</span> RUSTFLAGS</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="section">test:</span></span><br><span class="line">	cargo test --workspace --exclude <span class="string">"axorigin"</span> -- --nocapture</span><br><span class="line">	</span><br><span class="line"><span class="comment"># 为了便于测试，增加测试模块功能：</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">filter</span> test test_mod,<span class="variable">$(MAKECMDGOALS)</span>)</span>,)  <span class="comment"># not run `cargo test` 或 `cargo test_mod`</span></span><br><span class="line">RUSTFLAGS := -C link-arg=-T<span class="variable">$(LD_SCRIPT)</span> -C link-arg=-no-pie</span><br><span class="line"><span class="keyword">export</span> RUSTFLAGS</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="section">test_mod:</span></span><br><span class="line"><span class="keyword">ifndef</span> MOD</span><br><span class="line">		@printf <span class="string">"    <span class="variable">$(YELLOW_C)</span>Error<span class="variable">$(END_C)</span>: Please specify a module using MOD=&lt;module_name&gt;\n"</span></span><br><span class="line">		@printf <span class="string">"    Example: make test_mod MOD=axhal\n"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">		@printf <span class="string">"    <span class="variable">$(GREEN_C)</span>Testing<span class="variable">$(END_C)</span> module: <span class="variable">$(MOD)\n</span>"</span></span><br><span class="line">		cargo test --package <span class="variable">$(MOD)</span> -- --nocapture</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 支持test，工程 Workspace 级的 Cargo.toml</span></span><br><span class="line">// ArceOS/Cargo.toml</span><br><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">resolver</span> = <span class="string">"2"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">members</span> = [</span><br><span class="line">    <span class="string">"axorigin"</span>,</span><br><span class="line">    <span class="string">"axhal"</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="section">[profile.release]</span></span><br><span class="line"><span class="attr">lto</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axhal需要屏蔽体系结构差异，原来在riscv64环境下的实现代码应该被隔离</span></span><br><span class="line"><span class="comment">// axhal/src/lib.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(target_arch = <span class="meta-string">"riscv64"</span>)]</span></span><br><span class="line"><span class="keyword">mod</span> riscv64;</span><br><span class="line"><span class="meta">#[cfg(target_arch = <span class="meta-string">"riscv64"</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> self::riscv64::*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// axhal/src/riscv64.rs</span></span><br><span class="line"><span class="keyword">mod</span> lang_items;</span><br><span class="line"><span class="keyword">mod</span> boot;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> console;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">"C"</span> <span class="function"><span class="keyword">fn</span> <span class="title">rust_entry</span></span>(_hartid: <span class="built_in">usize</span>, _dtb: <span class="built_in">usize</span>) &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>(hartid: <span class="built_in">usize</span>, dtb: <span class="built_in">usize</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    main(_hartid, _dtb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// axhal/Cargo.toml</span></span><br><span class="line">[target.<span class="symbol">'cfg</span>(target_arch = <span class="string">"riscv64"</span>)'.dependencies]</span><br><span class="line">sbi-rt = &#123; version = <span class="string">"0.0.2"</span>, features = [<span class="string">"legacy"</span>] &#125;</span><br></pre></td></tr></table></figure>

<p><code>axhal</code>隔离riscv64环境后：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Cargo.toml                            | 10 ++++++++++</span><br><span class="line">Makefile                              |  7 ++++++-</span><br><span class="line">axhal/Cargo.toml                      |  2 +-</span><br><span class="line">axhal/src/lib.rs                      | 15 ++++-----------</span><br><span class="line">axhal/src/riscv64.rs                  | 10 ++++++++++</span><br><span class="line">axhal/src/&#123; =&gt; riscv64&#125;/boot.rs       |  0</span><br><span class="line">axhal/src/&#123; =&gt; riscv64&#125;/console.rs    |  0</span><br><span class="line">axhal/src/&#123; =&gt; riscv64&#125;/lang_items.rs |  0</span><br><span class="line">8 files changed, 31 insertions(+), 13 deletions(-)</span><br></pre></td></tr></table></figure>

<h4 id="四、添加组件"><a href="#四、添加组件" class="headerlink" title="四、添加组件"></a>四、添加组件</h4><ol>
<li><p>全局配置组件 <code>axconfig</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局常量 与 工具函数</span></span><br><span class="line"><span class="comment">// axconfig/src/lib.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> PAGE_SHIFT: <span class="built_in">usize</span> = <span class="number">12</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> PAGE_SIZE: <span class="built_in">usize</span> = <span class="number">1</span> &lt;&lt; PAGE_SHIFT;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> PHYS_VIRT_OFFSET: <span class="built_in">usize</span> = <span class="number">0xffff_ffc0_0000_0000</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> ASPACE_BITS: <span class="built_in">usize</span> = <span class="number">39</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> SIZE_1G: <span class="built_in">usize</span> = <span class="number">0x4000_0000</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> SIZE_2M: <span class="built_in">usize</span> = <span class="number">0x20_0000</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">align_up</span></span>(val: <span class="built_in">usize</span>, align: <span class="built_in">usize</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">    (val + align - <span class="number">1</span>) &amp; !(align - <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">align_down</span></span>(val: <span class="built_in">usize</span>, align: <span class="built_in">usize</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">    (val) &amp; !(align - <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">align_offset</span></span>(addr: <span class="built_in">usize</span>, align: <span class="built_in">usize</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">    addr &amp; (align - <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_aligned</span></span>(addr: <span class="built_in">usize</span>, align: <span class="built_in">usize</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    align_offset(addr, align) == <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">phys_pfn</span></span>(pa: <span class="built_in">usize</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">    pa &gt;&gt; PAGE_SHIFT</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自旋锁 <code>SpinRaw</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 并没有真正实现自旋锁，目前处于单线程状态不会出现数据争用问题</span></span><br><span class="line"><span class="comment">// 自旋锁的作用是为了包装mut全局变量，假装实现同步保护</span></span><br><span class="line"><span class="comment">// spinlock/src/lib.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="keyword">mod</span> raw;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> raw::&#123;SpinRaw, SpinRawGuard&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// spinlock/src/raw.rs</span></span><br><span class="line"><span class="keyword">use</span> core::cell::UnsafeCell;</span><br><span class="line"><span class="keyword">use</span> core::ops::&#123;Deref, DerefMut&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">SpinRaw</span></span>&lt;T&gt; &#123;</span><br><span class="line">    data: UnsafeCell&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">SpinRawGuard</span></span>&lt;T&gt; &#123;</span><br><span class="line">    data: *<span class="keyword">mut</span> T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> SpinRaw&lt;T&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Send</span> <span class="keyword">for</span> SpinRaw&lt;T&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; SpinRaw&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline(always)]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(data: T) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            data: UnsafeCell::new(data),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[inline(always)]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">lock</span></span>(&amp;<span class="keyword">self</span>) -&gt; SpinRawGuard&lt;T&gt; &#123;</span><br><span class="line">        SpinRawGuard &#123;</span><br><span class="line">            data: <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> *<span class="keyword">self</span>.data.get() &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> SpinRawGuard&lt;T&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Target</span></span> = T;</span><br><span class="line">    <span class="meta">#[inline(always)]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">deref</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;T &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;*<span class="keyword">self</span>.data &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; DerefMut <span class="keyword">for</span> SpinRawGuard&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline(always)]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">deref_mut</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; &amp;<span class="keyword">mut</span> T &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> *<span class="keyword">self</span>.data &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE]</p>
<p>UnsafeCell<T>是实现 <strong>内部可变性（Interior Mutability）</strong> 的核心机制</p>
<ul>
<li><p><strong>常规规则</strong>：<br>Rust 默认通过引用规则禁止通过不可变引用（<code>&amp;T</code>）修改数据，只能通过可变引用（<code>&amp;mut T</code>）修改，且同一作用域内只能存在一个可变引用。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> x = <span class="number">42</span>;</span><br><span class="line"><span class="keyword">let</span> y = &amp;x;</span><br><span class="line">*y = <span class="number">10</span>; <span class="comment">// 错误：不能通过不可变引用修改数据</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>UnsafeCell</code> 的魔法</strong>：<br>通过 <code>UnsafeCell&lt;T&gt;</code> 包裹数据，允许在不可变引用（<code>&amp;UnsafeCell&lt;T&gt;</code>）的上下文中修改内部数据：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> core::cell::UnsafeCell;</span><br><span class="line">                                                                  </span><br><span class="line"><span class="keyword">let</span> cell = UnsafeCell::new(<span class="number">42</span>);</span><br><span class="line"><span class="keyword">let</span> ptr = cell.get(); <span class="comment">// 获取 *mut T 裸指针</span></span><br><span class="line"><span class="keyword">unsafe</span> &#123; *ptr = <span class="number">10</span>; &#125; <span class="comment">// 允许修改</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
</li>
<li><p>初始化组件<code>axsync</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BootOnceCell 是对 lazy_static 的替代实现</span></span><br><span class="line"><span class="comment">// 初始化阶段单线程：仅在启动阶段由单个线程调用 init()</span></span><br><span class="line"><span class="comment">// 初始化后只读：初始化完成后，所有线程仅通过 get() 读取数据</span></span><br><span class="line"><span class="comment">// axsync/src/lib.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> bootcell;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> bootcell::BootOnceCell;</span><br><span class="line"></span><br><span class="line"><span class="comment">// axsync/src/bootcell.rs</span></span><br><span class="line"><span class="keyword">use</span> core::cell::OnceCell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">BootOnceCell</span></span>&lt;T&gt; &#123;</span><br><span class="line">    inner: OnceCell&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; BootOnceCell&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            inner: OnceCell::new()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">init</span></span>(&amp;<span class="keyword">self</span>, val: T) &#123;</span><br><span class="line">        <span class="keyword">let</span> _ = <span class="keyword">self</span>.inner.set(val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;T &#123;</span><br><span class="line">        <span class="keyword">self</span>.inner.get().unwrap()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_init</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.inner.get().is_some()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> BootOnceCell&lt;T&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<hr>
<h3 id="Ch2-内存管理1"><a href="#Ch2-内存管理1" class="headerlink" title="Ch2 内存管理1"></a>Ch2 内存管理1</h3><p>Target：组织Unikernel为四层系统架构，引入虚拟内存和内存分配</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Ch2 Code Framework</span></span><br><span class="line">.</span><br><span class="line">├── axalloc</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── early</span><br><span class="line">│       │   └── tests.rs</span><br><span class="line">│       ├── early.rs</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axconfig</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axhal</span><br><span class="line">│   ├── linker.lds</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── riscv64</span><br><span class="line">│       │   ├── boot.rs</span><br><span class="line">│       │   ├── console.rs</span><br><span class="line">│       │   ├── lang_items.rs</span><br><span class="line">│       │   └── paging.rs</span><br><span class="line">│       └── riscv64.rs</span><br><span class="line">├── axorigin</span><br><span class="line">│   └── src</span><br><span class="line">│       └── main.rs</span><br><span class="line">├── axruntime</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axstd</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axsync</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── bootcell.rs</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── page_table</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">└── spinlock</span><br><span class="line">    └── src</span><br><span class="line">        ├── lib.rs</span><br><span class="line">        └── raw.rs</span><br></pre></td></tr></table></figure>

<h4 id="一、内核框架构建"><a href="#一、内核框架构建" class="headerlink" title="一、内核框架构建"></a>一、内核框架构建</h4><p><img src="https://oslearning365.github.io/arceos-tutorial-book/img/%E4%B8%BB%E5%B9%B2%E7%BB%84%E4%BB%B6%E5%B1%82%E6%AC%A1.png" alt="主干组件层次"></p>
<p>原来的系统只有系统层axhal和应用层axorigin，我们需要另外增加一层管理组织组件的axstd层，它负责了应用和系统的隔离，抽象了系统为应用提供的功能；另外axhal负责了与硬件体系相关的工作，另外一些组件的初始化（硬件体系无关）需要一个位于axhal之上的抽象层来负责，因此引入了axruntime提供运行时管理</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动过程axhal -&gt; axruntime -&gt; axorigin (axstd作为axorigin的依赖载入)</span></span><br><span class="line"><span class="comment">// axhal/src/riscv64.rs</span></span><br><span class="line"><span class="keyword">mod</span> lang_items;</span><br><span class="line"><span class="keyword">mod</span> boot;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> console;</span><br><span class="line"><span class="keyword">mod</span> paging;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">"C"</span> <span class="function"><span class="keyword">fn</span> <span class="title">rust_entry</span></span>(hartid: <span class="built_in">usize</span>, dtb: <span class="built_in">usize</span>) &#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">rust_main</span></span>(hartid: <span class="built_in">usize</span>, dtb: <span class="built_in">usize</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    rust_main(hartid, dtb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// axruntime/src/lib.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> axhal::ax_println <span class="keyword">as</span> println;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">extern</span> <span class="string">"C"</span> <span class="function"><span class="keyword">fn</span> <span class="title">rust_main</span></span>(_hartid: <span class="built_in">usize</span>, _dtb: <span class="built_in">usize</span>) -&gt; ! &#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">_skernel</span></span>();</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"\nArceOS is starting ..."</span>);</span><br><span class="line">    <span class="comment">// We reserve 2M memory range [0x80000000, 0x80200000) for SBI,</span></span><br><span class="line">    <span class="comment">// but it only occupies ~194K. Split this range in half,</span></span><br><span class="line">    <span class="comment">// requisition the higher part(1M) for early heap.</span></span><br><span class="line">    axalloc::early_init(_skernel <span class="keyword">as</span> <span class="built_in">usize</span> - <span class="number">0x100000</span>, <span class="number">0x100000</span>);    <span class="comment">// 加载组件启用内存分配器</span></span><br><span class="line">    <span class="keyword">unsafe</span> &#123; main(); &#125;</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// axorigin/src/main.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> axstd::&#123;<span class="built_in">String</span>, println&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>(_hartid: <span class="built_in">usize</span>, _dtb: <span class="built_in">usize</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> s = <span class="built_in">String</span>::from(<span class="string">"from String"</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"\nHello, ArceOS![&#123;&#125;]"</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="二、引入分页机制"><a href="#二、引入分页机制" class="headerlink" title="二、引入分页机制"></a>二、引入分页机制</h4><p>为什么需要虚拟内存和分页机制：物理地址空间是硬件平台生产构造时就已经确定的，而虚拟地址空间则是内核可以根据实际需要灵活定义和实时改变的，这是将来内核很多重要机制的基础。按照近年来流行的说法，分页机制赋予了内核“软件定义”地址空间的能力。</p>
<p>内核可以开启CPU的MMU的分页机制，通过MMU提供的地址映射功能，使内核见到的是虚拟地址空间</p>
<p>我们启用Sv39分页机制，这是rCore就涉及的内容，不多赘述</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// page_table/src/lib.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * RiscV64 PTE format:</span></span><br><span class="line"><span class="comment"> * | XLEN-1  10 | 9             8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0</span></span><br><span class="line"><span class="comment"> *       PFN      reserved for SW   D   A   G   U   X   W   R   V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">use</span> axconfig::&#123;phys_pfn, PAGE_SHIFT, ASPACE_BITS&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> _PAGE_V : <span class="built_in">usize</span> = <span class="number">1</span> &lt;&lt; <span class="number">0</span>;     <span class="comment">/* Valid */</span></span><br><span class="line"><span class="keyword">const</span> _PAGE_R : <span class="built_in">usize</span> = <span class="number">1</span> &lt;&lt; <span class="number">1</span>;     <span class="comment">/* Readable */</span></span><br><span class="line"><span class="keyword">const</span> _PAGE_W : <span class="built_in">usize</span> = <span class="number">1</span> &lt;&lt; <span class="number">2</span>;     <span class="comment">/* Writable */</span></span><br><span class="line"><span class="keyword">const</span> _PAGE_E : <span class="built_in">usize</span> = <span class="number">1</span> &lt;&lt; <span class="number">3</span>;     <span class="comment">/* Executable */</span></span><br><span class="line"><span class="keyword">const</span> _PAGE_U : <span class="built_in">usize</span> = <span class="number">1</span> &lt;&lt; <span class="number">4</span>;     <span class="comment">/* User */</span></span><br><span class="line"><span class="keyword">const</span> _PAGE_G : <span class="built_in">usize</span> = <span class="number">1</span> &lt;&lt; <span class="number">5</span>;     <span class="comment">/* Global */</span></span><br><span class="line"><span class="keyword">const</span> _PAGE_A : <span class="built_in">usize</span> = <span class="number">1</span> &lt;&lt; <span class="number">6</span>;     <span class="comment">/* Accessed (set by hardware) */</span></span><br><span class="line"><span class="keyword">const</span> _PAGE_D : <span class="built_in">usize</span> = <span class="number">1</span> &lt;&lt; <span class="number">7</span>;     <span class="comment">/* Dirty (set by hardware)*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PAGE_TABLE: <span class="built_in">usize</span> = _PAGE_V;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> PAGE_KERNEL_RO: <span class="built_in">usize</span> = _PAGE_V | _PAGE_R | _PAGE_G | _PAGE_A | _PAGE_D;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> PAGE_KERNEL_RW: <span class="built_in">usize</span> = PAGE_KERNEL_RO | _PAGE_W;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> PAGE_KERNEL_RX: <span class="built_in">usize</span> = PAGE_KERNEL_RO | _PAGE_E;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> PAGE_KERNEL_RWX: <span class="built_in">usize</span> = PAGE_KERNEL_RW | _PAGE_E;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">PagingError</span></span> &#123;&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">PagingResult</span></span>&lt;T = ()&gt; = <span class="built_in">Result</span>&lt;T, PagingError&gt;;</span><br><span class="line"><span class="keyword">const</span> PAGE_PFN_SHIFT: <span class="built_in">usize</span> = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> ENTRIES_COUNT: <span class="built_in">usize</span> = <span class="number">1</span> &lt;&lt; (PAGE_SHIFT - <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Clone, Copy)]</span></span><br><span class="line"><span class="meta">#[repr(transparent)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">PTEntry</span></span>(<span class="built_in">u64</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> PTEntry &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, pa: <span class="built_in">usize</span>, flags: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="number">0</span> = Self::make(phys_pfn(pa), flags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">make</span></span>(pfn: <span class="built_in">usize</span>, prot: <span class="built_in">usize</span>) -&gt; <span class="built_in">u64</span> &#123;</span><br><span class="line">        ((pfn &lt;&lt; PAGE_PFN_SHIFT) | prot) <span class="keyword">as</span> <span class="built_in">u64</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">PageTable</span></span>&lt;<span class="symbol">'a</span>&gt; &#123;</span><br><span class="line">    level: <span class="built_in">usize</span>,</span><br><span class="line">    table: &amp;<span class="symbol">'a</span> <span class="keyword">mut</span> [PTEntry],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> PageTable&lt;<span class="symbol">'_</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">init</span></span>(root_pa: <span class="built_in">usize</span>, level: <span class="built_in">usize</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> table = <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            core::slice::from_raw_parts_mut(root_pa <span class="keyword">as</span> *<span class="keyword">mut</span> PTEntry, ENTRIES_COUNT)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">Self</span> &#123; level, table &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">entry_shift</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        ASPACE_BITS - (<span class="keyword">self</span>.level + <span class="number">1</span>) * (PAGE_SHIFT - <span class="number">3</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">entry_size</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="number">1</span> &lt;&lt; <span class="keyword">self</span>.entry_shift()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">entry_index</span></span>(&amp;<span class="keyword">self</span>, va: <span class="built_in">usize</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        (va &gt;&gt; <span class="keyword">self</span>.entry_shift()) &amp; (ENTRIES_COUNT - <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">map</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, <span class="keyword">mut</span> va: <span class="built_in">usize</span>, <span class="keyword">mut</span> pa: <span class="built_in">usize</span>,</span><br><span class="line">        <span class="keyword">mut</span> total_size: <span class="built_in">usize</span>, best_size: <span class="built_in">usize</span>, flags: <span class="built_in">usize</span></span><br><span class="line">    ) -&gt; PagingResult &#123;</span><br><span class="line">        <span class="keyword">let</span> entry_size = <span class="keyword">self</span>.entry_size();</span><br><span class="line">        <span class="keyword">while</span> total_size &gt;= entry_size &#123;</span><br><span class="line">            <span class="keyword">let</span> index = <span class="keyword">self</span>.entry_index(va);</span><br><span class="line">            <span class="keyword">if</span> entry_size == best_size &#123;</span><br><span class="line">                <span class="keyword">self</span>.table[index].set(pa, flags);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> pt = <span class="keyword">self</span>.next_table_mut(index)?;</span><br><span class="line">                pt.map(va, pa, entry_size, best_size, flags)?;</span><br><span class="line">            &#125;</span><br><span class="line">            total_size -= entry_size;</span><br><span class="line">            va += entry_size;</span><br><span class="line">            pa += entry_size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next_table_mut</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _index: <span class="built_in">usize</span>) -&gt; PagingResult&lt;PageTable&gt; &#123;</span><br><span class="line">        <span class="built_in">unimplemented!</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现组件page_table后，需要在axhal层init时映射内核空间，并使mmu启用分页</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axhal/src/riscv64/paging.rs</span></span><br><span class="line"><span class="keyword">use</span> axconfig::&#123;SIZE_1G, phys_pfn&#125;;</span><br><span class="line"><span class="keyword">use</span> page_table::&#123;PAGE_KERNEL_RWX, PageTable&#125;;</span><br><span class="line"><span class="keyword">use</span> riscv::register::satp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">boot_page_table</span></span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">init_boot_page_table</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> pt: PageTable = PageTable::init(boot_page_table <span class="keyword">as</span> <span class="built_in">usize</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">let</span> _ = pt.map(<span class="number">0x8000_0000</span>, <span class="number">0x8000_0000</span>, SIZE_1G, SIZE_1G, PAGE_KERNEL_RWX);</span><br><span class="line">    <span class="keyword">let</span> _ = pt.map(</span><br><span class="line">        <span class="number">0xffff_ffc0_8000_0000</span>,</span><br><span class="line">        <span class="number">0x8000_0000</span>,</span><br><span class="line">        SIZE_1G,</span><br><span class="line">        SIZE_1G,</span><br><span class="line">        PAGE_KERNEL_RWX,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">init_mmu</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> page_table_root = boot_page_table <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        satp::set(satp::Mode::Sv39, <span class="number">0</span>, phys_pfn(page_table_root));</span><br><span class="line">        riscv::asm::sfence_vma_all();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// boot时调用函数初始化</span></span><br><span class="line"><span class="comment">// axhal/src/riscv64/boot.rs</span></span><br><span class="line"><span class="keyword">use</span> crate::riscv64::paging;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="meta">#[link_section = <span class="meta-string">".text.boot"</span>]</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">"C"</span> <span class="function"><span class="keyword">fn</span> <span class="title">_start</span></span>() -&gt; ! &#123;</span><br><span class="line">    <span class="comment">// a0 = hartid</span></span><br><span class="line">    <span class="comment">// a1 = dtb</span></span><br><span class="line">    core::arch::asm!(<span class="string">"</span></span><br><span class="line"><span class="string">        mv      s0, a0                  // save hartid</span></span><br><span class="line"><span class="string">        mv      s1, a1                  // save DTB pointer</span></span><br><span class="line"><span class="string">        la a3, _sbss</span></span><br><span class="line"><span class="string">        la a4, _ebss</span></span><br><span class="line"><span class="string">        ble a4, a3, 2f</span></span><br><span class="line"><span class="string">1:</span></span><br><span class="line"><span class="string">        sd zero, (a3)</span></span><br><span class="line"><span class="string">        add a3, a3, 8</span></span><br><span class="line"><span class="string">        blt a3, a4, 1b</span></span><br><span class="line"><span class="string">2:</span></span><br><span class="line"><span class="string">        la      sp, boot_stack_top      // setup boot stack</span></span><br><span class="line"><span class="string">        call    &#123;init_boot_page_table&#125;  // setup boot page table</span></span><br><span class="line"><span class="string">        call    &#123;init_mmu&#125;              // enabel MMU</span></span><br><span class="line"><span class="string">        li      s2, &#123;phys_virt_offset&#125;  // fix up virtual high address</span></span><br><span class="line"><span class="string">        add     sp, sp, s2              // readjust stack address</span></span><br><span class="line"><span class="string">        mv      a0, s0                  // restore hartid</span></span><br><span class="line"><span class="string">        mv      a1, s1                  // restore DTB pointer</span></span><br><span class="line"><span class="string">        la      a2, &#123;entry&#125;</span></span><br><span class="line"><span class="string">        add     a2, a2, s2              // readjust rust_entry address</span></span><br><span class="line"><span class="string">        jalr    a2                      // call rust_entry(hartid, dtb)</span></span><br><span class="line"><span class="string">        j       ."</span>,</span><br><span class="line">        init_boot_page_table = sym paging::init_boot_page_table,</span><br><span class="line">        init_mmu = sym paging::init_mmu,</span><br><span class="line">        phys_virt_offset = <span class="keyword">const</span> axconfig::PHYS_VIRT_OFFSET,</span><br><span class="line">        entry = sym super::rust_entry,</span><br><span class="line">        options(noreturn),</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="三、启用动态内存分配"><a href="#三、启用动态内存分配" class="headerlink" title="三、启用动态内存分配"></a>三、启用动态内存分配</h4><p>在第一部分的框架代码中我们使用了String，但是String的实现需要动态内存分配支持，这本来是rust std库提供的功能，我们需要实现内核级的动态内存堆管理的支持，因此我们引入了axalloc组件，它的初始化在axruntime中完成。</p>
<p>全局内存分配器 GlobalAllocator 实现 GlobalAlloc Trait，它包含两个功能：字节分配和页分配，分别用于响应对应请求。区分两种请求的策略是，请求分配的大小是页大小的倍数且按页对齐，就视作申请页；否则就是按字节申请分配。我们在GlobalAllocator的下层实现一个early allocator提供底层内存分配的抽象封装</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axalloc/src/lib.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="keyword">use</span> axconfig::PAGE_SIZE;</span><br><span class="line"><span class="keyword">use</span> core::alloc::Layout;</span><br><span class="line"><span class="keyword">use</span> core::ptr::NonNull;</span><br><span class="line"><span class="keyword">use</span> spinlock::SpinRaw;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> alloc;</span><br><span class="line"><span class="keyword">use</span> alloc::alloc::GlobalAlloc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> early;</span><br><span class="line"><span class="keyword">use</span> early::EarlyAllocator;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">AllocError</span></span> &#123;</span><br><span class="line">    InvalidParam,</span><br><span class="line">    MemoryOverlap,</span><br><span class="line">    NoMemory,</span><br><span class="line">    NotAllocated,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">AllocResult</span></span>&lt;T = ()&gt; = <span class="built_in">Result</span>&lt;T, AllocError&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 #[global_allocator] 属性将 GlobalAllocator 注册为全局分配器，使 String 等类型默认使用它</span></span><br><span class="line"><span class="meta">#[cfg_attr(not(test), global_allocator)]</span></span><br><span class="line"><span class="keyword">static</span> GLOBAL_ALLOCATOR: GlobalAllocator = GlobalAllocator::new();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">GlobalAllocator</span></span> &#123;</span><br><span class="line">    <span class="comment">// 使用实现的自旋锁组件，防止争用</span></span><br><span class="line">    early_alloc: SpinRaw&lt;EarlyAllocator&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> GlobalAllocator &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            early_alloc: SpinRaw::new(EarlyAllocator::uninit_new()),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">early_init</span></span>(&amp;<span class="keyword">self</span>, start: <span class="built_in">usize</span>, size: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.early_alloc.lock().init(start, size)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> GlobalAllocator &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">alloc_bytes</span></span>(&amp;<span class="keyword">self</span>, layout: Layout) -&gt; *<span class="keyword">mut</span> <span class="built_in">u8</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Ok</span>(ptr) = <span class="keyword">self</span>.early_alloc.lock().alloc_bytes(layout) &#123;</span><br><span class="line">            ptr.as_ptr()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alloc::alloc::handle_alloc_error(layout)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">dealloc_bytes</span></span>(&amp;<span class="keyword">self</span>, ptr: *<span class="keyword">mut</span> <span class="built_in">u8</span>, layout: Layout) &#123;</span><br><span class="line">        <span class="keyword">self</span>.early_alloc</span><br><span class="line">            .lock()</span><br><span class="line">            .dealloc_bytes(NonNull::new(ptr).expect(<span class="string">"dealloc null ptr"</span>), layout)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">alloc_pages</span></span>(&amp;<span class="keyword">self</span>, layout: Layout) -&gt; *<span class="keyword">mut</span> <span class="built_in">u8</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Ok</span>(ptr) = <span class="keyword">self</span>.early_alloc.lock().alloc_pages(layout) &#123;</span><br><span class="line">            ptr.as_ptr()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alloc::alloc::handle_alloc_error(layout)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">dealloc_pages</span></span>(&amp;<span class="keyword">self</span>, _ptr: *<span class="keyword">mut</span> <span class="built_in">u8</span>, _layout: Layout) &#123;</span><br><span class="line">        <span class="built_in">unimplemented!</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span> GlobalAlloc <span class="keyword">for</span> GlobalAllocator &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">alloc</span></span>(&amp;<span class="keyword">self</span>, layout: Layout) -&gt; *<span class="keyword">mut</span> <span class="built_in">u8</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> layout.size() % PAGE_SIZE == <span class="number">0</span> &amp;&amp; layout.align() == PAGE_SIZE &#123;</span><br><span class="line">            <span class="keyword">self</span>.alloc_pages(layout)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.alloc_bytes(layout)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">dealloc</span></span>(&amp;<span class="keyword">self</span>, ptr: *<span class="keyword">mut</span> <span class="built_in">u8</span>, layout: Layout) &#123;</span><br><span class="line">        <span class="keyword">if</span> layout.size() % PAGE_SIZE == <span class="number">0</span> &amp;&amp; layout.align() == PAGE_SIZE &#123;</span><br><span class="line">            <span class="keyword">self</span>.dealloc_pages(ptr, layout)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.dealloc_bytes(ptr, layout)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">early_init</span></span>(start: <span class="built_in">usize</span>, len: <span class="built_in">usize</span>) &#123;</span><br><span class="line">    GLOBAL_ALLOCATOR.early_init(start, len)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>底层内存分配器</p>
<p><img src="https://oslearning365.github.io/arceos-tutorial-book/img/%E6%97%A9%E6%9C%9F%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8.svg" alt="早期内存分配器"></p>
<blockquote>
<p>[!TIP]</p>
<p><code>Layout</code> 是 Rust 标准库中定义的一个结构体，用于描述内存分配的 <strong>布局要求</strong>，包含两个核心字段：</p>
<ul>
<li><strong><code>size: usize</code></strong>：需要分配的内存块大小。</li>
<li><strong><code>align: usize</code></strong>：内存块的最小对齐要求</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 分配一个 16 字节、按 8 字节对齐的内存块</span><br><span class="line">let layout &#x3D; Layout::from_size_align(16, 8).unwrap();</span><br></pre></td></tr></table></figure>

<h5 id="byte-pos-和-page-pos-的意义"><a href="#byte-pos-和-page-pos-的意义" class="headerlink" title="byte_pos 和 page_pos 的意义"></a><code>byte_pos</code> 和 <code>page_pos</code> 的意义</h5><p><code>EarlyAllocator</code> 通过两个指针管理内存区域：</p>
<ul>
<li><strong><code>byte_pos</code></strong>：从 <strong>低地址向高地址</strong> 分配小粒度内存（字节级）。</li>
<li><strong><code>page_pos</code></strong>：从 <strong>高地址向低地址</strong> 分配大粒度内存（页级）</li>
</ul>
<p><strong>设计特点</strong>：</p>
<ul>
<li>仅在所有字节分配都被释放时（<code>count == 0</code>），才将 <code>byte_pos</code> 重置到 <code>start</code>。</li>
<li>不支持部分释放，适用于 <strong>批量分配后一次性释放</strong> 的场景（如临时缓冲区）。</li>
<li>page_dealloc为支持</li>
</ul>
</blockquote>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axalloc/src/early.rs</span></span><br><span class="line"><span class="meta">#![allow(dead_code)]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::&#123;AllocError, AllocResult&#125;;</span><br><span class="line"><span class="keyword">use</span> axconfig::&#123;PAGE_SIZE, align_down, align_up&#125;;</span><br><span class="line"><span class="keyword">use</span> core::alloc::Layout;</span><br><span class="line"><span class="keyword">use</span> core::ptr::NonNull;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">EarlyAllocator</span></span> &#123;</span><br><span class="line">    start: <span class="built_in">usize</span>,</span><br><span class="line">    end: <span class="built_in">usize</span>,</span><br><span class="line">    count: <span class="built_in">usize</span>,</span><br><span class="line">    byte_pos: <span class="built_in">usize</span>,</span><br><span class="line">    page_pos: <span class="built_in">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> EarlyAllocator &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">init</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, start: <span class="built_in">usize</span>, size: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.start = start;</span><br><span class="line">        <span class="keyword">self</span>.end = start + size;</span><br><span class="line">        <span class="keyword">self</span>.byte_pos = start;</span><br><span class="line">        <span class="keyword">self</span>.page_pos = <span class="keyword">self</span>.end;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">uninit_new</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            start: <span class="number">0</span>,</span><br><span class="line">            end: <span class="number">0</span>,</span><br><span class="line">            count: <span class="number">0</span>,</span><br><span class="line">            byte_pos: <span class="number">0</span>,</span><br><span class="line">            page_pos: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> EarlyAllocator &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">alloc_pages</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, layout: Layout) -&gt; AllocResult&lt;NonNull&lt;<span class="built_in">u8</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(layout.size() % PAGE_SIZE, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">let</span> next = align_down(<span class="keyword">self</span>.page_pos - layout.size(), layout.align());</span><br><span class="line">        <span class="keyword">if</span> next &lt;= <span class="keyword">self</span>.byte_pos &#123;</span><br><span class="line">            alloc::alloc::handle_alloc_error(layout)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.page_pos = next;</span><br><span class="line">            NonNull::new(next <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">u8</span>).ok_or(AllocError::NoMemory)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">total_pages</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        (<span class="keyword">self</span>.end - <span class="keyword">self</span>.start) / PAGE_SIZE</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">used_pages</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        (<span class="keyword">self</span>.end - <span class="keyword">self</span>.page_pos) / PAGE_SIZE</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">available_pages</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        (<span class="keyword">self</span>.page_pos - <span class="keyword">self</span>.byte_pos) / PAGE_SIZE</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> EarlyAllocator &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">alloc_bytes</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, layout: Layout) -&gt; AllocResult&lt;NonNull&lt;<span class="built_in">u8</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> start = align_up(<span class="keyword">self</span>.byte_pos, layout.align());</span><br><span class="line">        <span class="keyword">let</span> next = start + layout.size();</span><br><span class="line">        <span class="keyword">if</span> next &gt; <span class="keyword">self</span>.page_pos &#123;</span><br><span class="line">            alloc::alloc::handle_alloc_error(layout)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.byte_pos = next;</span><br><span class="line">            <span class="keyword">self</span>.count += <span class="number">1</span>;</span><br><span class="line">            NonNull::new(start <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">u8</span>).ok_or(AllocError::NoMemory)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">dealloc_bytes</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _ptr: NonNull&lt;<span class="built_in">u8</span>&gt;, _layout: Layout) &#123;</span><br><span class="line">        <span class="keyword">self</span>.count -= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.count == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.byte_pos = <span class="keyword">self</span>.start;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">total_bytes</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.end - <span class="keyword">self</span>.start</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">used_bytes</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.byte_pos - <span class="keyword">self</span>.start</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">available_bytes</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.page_pos - <span class="keyword">self</span>.byte_pos</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Ch3-Basic-Component"><a href="#Ch3-Basic-Component" class="headerlink" title="Ch3 Basic Component"></a>Ch3 Basic Component</h3><p>Target:增加基础组件，扩展子系统</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Code </span></span><br><span class="line">.</span><br><span class="line">├── axalloc</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── early</span><br><span class="line">│       │   └── tests.rs</span><br><span class="line">│       ├── early.rs</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axconfig</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axdtb</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       └── util.rs</span><br><span class="line">├── axhal</span><br><span class="line">│   ├── linker.lds</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── riscv64</span><br><span class="line">│       │   ├── boot.rs</span><br><span class="line">│       │   ├── console.rs</span><br><span class="line">│       │   ├── lang_items.rs</span><br><span class="line">│       │   ├── misc.rs</span><br><span class="line">│       │   ├── paging.rs</span><br><span class="line">│       │   └── time.rs</span><br><span class="line">│       └── riscv64.rs</span><br><span class="line">├── axlog</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axorigin</span><br><span class="line">│   └── src</span><br><span class="line">│       └── main.rs</span><br><span class="line">├── axruntime</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axstd</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       └── time.rs</span><br><span class="line">├── axsync</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── bootcell.rs</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── buddy_allocator</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── linked_list</span><br><span class="line">│       │   └── tests.rs</span><br><span class="line">│       └── linked_list.rs</span><br><span class="line">├── page_table</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">└── spinlock</span><br><span class="line">    └── src</span><br><span class="line">        ├── lib.rs</span><br><span class="line">        └── raw.rs</span><br></pre></td></tr></table></figure>



<h4 id="一、打破循环依赖"><a href="#一、打破循环依赖" class="headerlink" title="一、打破循环依赖"></a>一、打破循环依赖</h4><p>我们希望在ch3引入axlog日志组件，但是这会出现循环依赖，无法通过编译：组件 axruntime 在初始化时，将会初始化 axhal 和 axlog 这两个组件。对于 axhal 和 axlog 这两个组件来说，一方面，axhal 组件需要日志功能，所以依赖 axlog 组件；与此同时，axlog 必须依赖 axhal 提供的标准输出或写文件功能以实现日志输出，所以 axlog 又反过来依赖 axhal。这就在二者之间形成了循环依赖。</p>
<p>我们使用extern ABI的方式声明外部函数，并在crate中直接调用避免循环依赖；创建组件crate_interface使用过程宏封装extern ABI来对这种方式提供抽象。</p>
<p><img src="https://oslearning365.github.io/arceos-tutorial-book/img/crate_interface.svg" alt="\crate_interface"></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过crate_interface提供的宏解决循环依赖问题</span></span><br><span class="line"><span class="comment">// axlog/src/lib.rs</span></span><br><span class="line"><span class="comment">// 定义跨crate接口Logif</span></span><br><span class="line"><span class="meta">#[crate_interface::def_interface]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">LogIf</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">write_str</span></span>(s: &amp;<span class="built_in">str</span>);</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">get_time</span></span>() -&gt; core::time::Duration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 axhal 中定义 LogIfImpl 实现 LogIf 接口</span></span><br><span class="line"><span class="comment">// /axhal/src/riscv64.rs</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">LogIfImpl</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[crate_interface::impl_interface]</span></span><br><span class="line"><span class="keyword">impl</span> axlog::LogIf <span class="keyword">for</span> LogIfImpl &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">write_str</span></span>(s: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">        console::write_bytes(s.as_bytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">get_time</span></span>() -&gt; core::time::Duration &#123;</span><br><span class="line">        time::current_time()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过宏 call_interface!(LogIf::XXX) 调用 LogIf 的实现</span></span><br><span class="line"><span class="comment">// axlog/src/lib.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">init</span></span>() &#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">crate</span> alloc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> now = crate_interface::call_interface!(LogIf::get_time());</span><br><span class="line">    <span class="keyword">let</span> s = alloc::<span class="built_in">format!</span>(<span class="string">"Logging startup time: &#123;&#125;.&#123;:06&#125;"</span>,</span><br><span class="line">        now.as_secs(), now.subsec_micros());</span><br><span class="line">    crate_interface::call_interface!(LogIf::write_str(s.as_str()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一次接触过程宏，详细看看如何自定义过程宏</span></span><br><span class="line"><span class="comment">// extern/crate_interface</span></span><br><span class="line"><span class="meta">#![doc = include_str!(<span class="meta-string">"../README.md"</span>)]</span>  <span class="comment">// 将 README.md 内容作为 crate 文档</span></span><br><span class="line"><span class="keyword">use</span> proc_macro::TokenStream;           <span class="comment">// 过程宏输入/输出的标准类型</span></span><br><span class="line"><span class="keyword">use</span> proc_macro2::Span;                 <span class="comment">// 用于追踪代码位置</span></span><br><span class="line"><span class="keyword">use</span> quote::&#123;format_ident, quote&#125;;      <span class="comment">// 代码生成工具</span></span><br><span class="line"><span class="keyword">use</span> syn::parse::&#123;Error, Parse, ParseStream, <span class="built_in">Result</span>&#125;; <span class="comment">// 解析宏输入的工具</span></span><br><span class="line"><span class="keyword">use</span> syn::punctuated::Punctuated;       <span class="comment">// 带分隔符的列表（如逗号分隔的参数）</span></span><br><span class="line"><span class="keyword">use</span> syn::&#123;parenthesized, parse_macro_input, Token&#125;; <span class="comment">// 解析语法结构的工具</span></span><br><span class="line"><span class="keyword">use</span> syn::&#123;Expr, FnArg, ImplItem, ImplItemFn, ItemImpl, ItemTrait, Path, PathArguments, PathSegment, TraitItem, Type&#125;; <span class="comment">// 各类 AST 节点类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 syn 的 Error 转换为编译器错误输出</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">compiler_error</span></span>(err: Error) -&gt; TokenStream &#123;</span><br><span class="line">    err.to_compile_error().into() <span class="comment">// 将错误转为可编译的 TokenStream</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[proc_macro_attribute]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">def_interface</span></span>(attr: TokenStream, item: TokenStream) -&gt; TokenStream &#123;</span><br><span class="line">    <span class="keyword">if</span> !attr.is_empty() &#123; <span class="comment">// 检查属性参数是否为空（如 #[def_interface] 不能带参数）</span></span><br><span class="line">        <span class="keyword">return</span> compiler_error(Error::new(</span><br><span class="line">            Span::call_site(),</span><br><span class="line">            <span class="string">"expect an empty attribute: `#[def_interface]`"</span>,</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> ast = syn::parse_macro_input!(item <span class="keyword">as</span> ItemTrait); <span class="comment">// 解析输入为 Trait 的 AST</span></span><br><span class="line">    <span class="keyword">let</span> trait_name = &amp;ast.ident; <span class="comment">// 获取 Trait 名称（如 MyTrait）</span></span><br><span class="line">    <span class="keyword">let</span> vis = &amp;ast.vis;         <span class="comment">// 获取 Trait 的可见性（如 pub）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> extern_fn_list = <span class="built_in">vec!</span>[]; <span class="comment">// 存储生成的外部函数声明</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> &amp;ast.items &#123; <span class="comment">// 遍历 Trait 中的每个项（如方法）</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> TraitItem::<span class="built_in">Fn</span>(method) = item &#123; <span class="comment">// 仅处理方法项</span></span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> sig = method.sig.clone(); <span class="comment">// 复制方法签名（如 fn my_method(arg: u32)）</span></span><br><span class="line">            <span class="keyword">let</span> fn_name = &amp;sig.ident;          <span class="comment">// 获取方法名（如 my_method）</span></span><br><span class="line">            sig.ident = format_ident!(<span class="string">"__&#123;&#125;_&#123;&#125;"</span>, trait_name, fn_name); <span class="comment">// 生成唯一函数名，如 __MyTrait_my_method</span></span><br><span class="line">            sig.inputs = syn::punctuated::Punctuated::new(); <span class="comment">// 清空输入参数（后续重新填充）</span></span><br><span class="line">            <span class="comment">// 仅保留类型参数（移除 self 等接收者）</span></span><br><span class="line">            <span class="keyword">for</span> arg <span class="keyword">in</span> &amp;method.sig.inputs &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> FnArg::Typed(_) = arg &#123; <span class="comment">// 过滤掉 Receiver（如 &amp;self）</span></span><br><span class="line">                    sig.inputs.push(arg.clone());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 生成外部函数声明代码块</span></span><br><span class="line">            <span class="keyword">let</span> extern_fn = quote! &#123; <span class="keyword">pub</span> #sig; &#125;;</span><br><span class="line">            extern_fn_list.push(extern_fn);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> mod_name = format_ident!(<span class="string">"__&#123;&#125;_mod"</span>, trait_name); <span class="comment">// 生成模块名，如 __MyTrait_mod</span></span><br><span class="line">    quote! &#123; <span class="comment">// 生成最终代码</span></span><br><span class="line">        #ast <span class="comment">// 原样保留 Trait 定义</span></span><br><span class="line">        <span class="meta">#[doc(hidden)]</span> <span class="comment">// 隐藏生成的模块</span></span><br><span class="line">        <span class="meta">#[allow(non_snake_case)]</span> <span class="comment">// 允许非蛇形命名</span></span><br><span class="line">        #vis <span class="keyword">mod</span> #mod_name &#123; <span class="comment">// 定义模块</span></span><br><span class="line">            <span class="keyword">use</span> super::*;     <span class="comment">// 引入父模块内容</span></span><br><span class="line">            <span class="keyword">extern</span> <span class="string">"Rust"</span> &#123;   <span class="comment">// 声明外部函数</span></span><br><span class="line">                #(#extern_fn_list)* <span class="comment">// 插入所有生成的外部函数</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .into() <span class="comment">// 转为 TokenStream</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[proc_macro_attribute]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">impl_interface</span></span>(attr: TokenStream, item: TokenStream) -&gt; TokenStream &#123;</span><br><span class="line">    <span class="keyword">if</span> !attr.is_empty() &#123; <span class="comment">// 检查属性参数是否为空</span></span><br><span class="line">        <span class="keyword">return</span> compiler_error(Error::new_spanned(...));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> ast = syn::parse_macro_input!(item <span class="keyword">as</span> ItemImpl); <span class="comment">// 解析为 Impl 块 AST</span></span><br><span class="line">    <span class="comment">// 提取 Trait 名称（如 impl MyTrait for MyStruct 中的 MyTrait）</span></span><br><span class="line">    <span class="keyword">let</span> trait_name = <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>((_, path, _)) = &amp;ast.trait_ &#123;</span><br><span class="line">        &amp;path.segments.last().unwrap().ident</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; ... &#125;;</span><br><span class="line">    <span class="comment">// 提取结构体名称（如 MyStruct）</span></span><br><span class="line">    <span class="keyword">let</span> impl_name = <span class="keyword">if</span> <span class="keyword">let</span> Type::Path(path) = &amp;ast.self_ty.as_ref() &#123;</span><br><span class="line">        path.path.get_ident().unwrap()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; ... &#125;;</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> &amp;<span class="keyword">mut</span> ast.items &#123; <span class="comment">// 遍历 Impl 块中的每个方法</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> ImplItem::<span class="built_in">Fn</span>(method) = item &#123;</span><br><span class="line">            <span class="keyword">let</span> (attrs, vis, sig, stmts) = <span class="comment">// 解构方法属性、可见性、签名和语句</span></span><br><span class="line">                (&amp;method.attrs, &amp;method.vis, &amp;method.sig, &amp;method.block.stmts);</span><br><span class="line">            <span class="keyword">let</span> fn_name = &amp;sig.ident; <span class="comment">// 方法名（如 my_method）</span></span><br><span class="line">            <span class="keyword">let</span> extern_fn_name = format_ident!(<span class="string">"__&#123;&#125;_&#123;&#125;"</span>, trait_name, fn_name); <span class="comment">// 生成外部函数名</span></span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> new_sig = sig.clone(); <span class="comment">// 复制方法签名</span></span><br><span class="line">            new_sig.ident = extern_fn_name.clone(); <span class="comment">// 修改函数名为外部名称</span></span><br><span class="line">            new_sig.inputs = Punctuated::new(); <span class="comment">// 清空参数（后续填充）</span></span><br><span class="line">                        <span class="keyword">let</span> <span class="keyword">mut</span> args = <span class="built_in">vec!</span>[]; <span class="comment">// 存储参数名（如 arg1, arg2）</span></span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> has_self = <span class="literal">false</span>; <span class="comment">// 是否包含 self 参数</span></span><br><span class="line">            <span class="keyword">for</span> arg <span class="keyword">in</span> &amp;sig.inputs &#123; <span class="comment">// 遍历方法参数</span></span><br><span class="line">                <span class="keyword">match</span> arg &#123;</span><br><span class="line">                    FnArg::Receiver(_) =&gt; has_self = <span class="literal">true</span>, <span class="comment">// 检测 self</span></span><br><span class="line">                    FnArg::Typed(ty) =&gt; &#123; <span class="comment">// 处理类型参数</span></span><br><span class="line">                        args.push(ty.pat.clone()); <span class="comment">// 提取参数名（如 arg）</span></span><br><span class="line">                        new_sig.inputs.push(arg.clone()); <span class="comment">// 添加到新签名</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 生成调用实际方法的代码（区分有无 self）</span></span><br><span class="line">            <span class="keyword">let</span> call_impl = <span class="keyword">if</span> has_self &#123;</span><br><span class="line">                quote! &#123; <span class="keyword">let</span> _<span class="keyword">impl</span>: #impl_name = #impl_name; _<span class="keyword">impl</span>.#fn_name(#(#args),*) &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                quote! &#123; #impl_name::#fn_name(#(#args),*) &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">                        <span class="keyword">let</span> item = quote! &#123; <span class="comment">// 生成新的方法实现</span></span><br><span class="line">                <span class="meta">#[inline]</span></span><br><span class="line">                #(#attrs)* <span class="comment">// 保留原属性（如 #[cfg]）</span></span><br><span class="line">                #vis</span><br><span class="line">                #sig</span><br><span class="line">                &#123;</span><br><span class="line">                    &#123; <span class="comment">// 内部块定义外部函数</span></span><br><span class="line">                        <span class="meta">#[inline]</span></span><br><span class="line">                        <span class="meta">#[export_name = #extern_fn_name]</span> <span class="comment">// 强制符号名</span></span><br><span class="line">                        <span class="keyword">extern</span> <span class="string">"Rust"</span> #new_sig &#123; <span class="comment">// 定义外部函数</span></span><br><span class="line">                            #call_impl <span class="comment">// 调用实际方法</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    #(#stmts)* <span class="comment">// 原方法语句</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            .into();</span><br><span class="line">            *method = syn::parse_macro_input!(item <span class="keyword">as</span> ImplItemFn); <span class="comment">// 替换原方法</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    quote! &#123; #ast &#125;.into() <span class="comment">// 返回修改后的 Impl 块</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[proc_macro]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">call_interface</span></span>(item: TokenStream) -&gt; TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> call = parse_macro_input!(item <span class="keyword">as</span> CallInterface); <span class="comment">// 解析为自定义结构体</span></span><br><span class="line">    <span class="keyword">let</span> args = call.args; <span class="comment">// 参数列表（如 42, "test"）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> path = call.path.segments; <span class="comment">// 路径（如 MyTrait::my_method）</span></span><br><span class="line">    <span class="comment">// 校验路径格式（至少 Trait 和方法名）</span></span><br><span class="line">    <span class="keyword">if</span> path.len() &lt; <span class="number">2</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> compiler_error(...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> fn_name = path.pop().unwrap(); <span class="comment">// 弹出方法名（如 my_method）</span></span><br><span class="line">    <span class="keyword">let</span> trait_name = path.pop().unwrap(); <span class="comment">// 弹出 Trait 名（如 MyTrait）</span></span><br><span class="line">    <span class="keyword">let</span> extern_fn_name = format_ident!(<span class="string">"__&#123;&#125;_&#123;&#125;"</span>, trait_name.ident, fn_name.ident); <span class="comment">// 生成外部函数名</span></span><br><span class="line">    <span class="comment">// 构造模块路径（如 __MyTrait_mod）</span></span><br><span class="line">    path.push_value(PathSegment &#123;</span><br><span class="line">        ident: format_ident!(<span class="string">"__&#123;&#125;_mod"</span>, trait_name.ident),</span><br><span class="line">        arguments: PathArguments::<span class="literal">None</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 生成 unsafe 调用代码</span></span><br><span class="line">    quote! &#123; <span class="keyword">unsafe</span> &#123; #path::#extern_fn_name(#args) &#125; &#125;.into()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CallInterface</span></span> &#123; path: Path, args: Punctuated&lt;Expr, Token![,]&gt; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Parse <span class="keyword">for</span> CallInterface &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">parse</span></span>(input: ParseStream) -&gt; <span class="built_in">Result</span>&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> path: Path = input.parse()?; <span class="comment">// 解析路径（如 MyTrait::my_method）</span></span><br><span class="line">        <span class="keyword">let</span> args = <span class="keyword">if</span> input.peek(Token![,]) &#123; <span class="comment">// 处理逗号分隔参数</span></span><br><span class="line">            input.parse::&lt;Token![,]&gt;()?;</span><br><span class="line">            input.parse_terminated(Expr::parse, Token![,])?</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> !input.is_empty() &#123; <span class="comment">// 处理括号参数（如 (42)）</span></span><br><span class="line">            parenthesized!(content <span class="keyword">in</span> input);</span><br><span class="line">            content.parse_terminated(Expr::parse, Token![,])?</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; Punctuated::new() &#125;;</span><br><span class="line">        <span class="literal">Ok</span>(CallInterface &#123; path, args &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="二、其他组件"><a href="#二、其他组件" class="headerlink" title="二、其他组件"></a>二、其他组件</h4><h5 id="axlog"><a href="#axlog" class="headerlink" title="axlog"></a>axlog</h5><p>封装并扩展crate.io中的crate - log。按照 crate log 的实现要求，为 定义的全局日志实例 Logger 实现 trait Log 接口。这个外部的 crate log 本身是一个框架，实现了日志的各种通用功能，但是如何对日志进行输出需要基于所在的环境，这个 trait Log 就是通用功能与环境交互的接口</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axlog/src/lib.rs</span></span><br><span class="line"><span class="built_in">macro_rules!</span> with_color &#123;</span><br><span class="line">    ($color_code:expr, $($arg:tt)*) =&gt; &#123;&#123;</span><br><span class="line">        <span class="built_in">format_args!</span>(<span class="string">"\u&#123;1B&#125;[&#123;&#125;m&#123;&#125;\u&#123;1B&#125;[m"</span>, $color_code <span class="keyword">as</span> <span class="built_in">u8</span>, <span class="built_in">format_args!</span>($($arg)*))</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(u8)]</span></span><br><span class="line"><span class="meta">#[allow(dead_code)]</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ColorCode</span></span> &#123;</span><br><span class="line">    Red = <span class="number">31</span>, Green = <span class="number">32</span>, Yellow = <span class="number">33</span>, Cyan = <span class="number">36</span>, White = <span class="number">37</span>, BrightBlack = <span class="number">90</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Log <span class="keyword">for</span> Logger &#123;</span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">enabled</span></span>(&amp;<span class="keyword">self</span>, _metadata: &amp;Metadata) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">log</span></span>(&amp;<span class="keyword">self</span>, record: &amp;Record) &#123;</span><br><span class="line">        <span class="keyword">let</span> level = record.level();</span><br><span class="line">        <span class="keyword">let</span> line = record.line().unwrap_or(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">let</span> path = record.target();</span><br><span class="line">        <span class="keyword">let</span> args_color = <span class="keyword">match</span> level &#123;</span><br><span class="line">            Level::Error =&gt; ColorCode::Red,</span><br><span class="line">            Level::Warn =&gt; ColorCode::Yellow,</span><br><span class="line">            Level::Info =&gt; ColorCode::Green,</span><br><span class="line">            Level::<span class="built_in">Debug</span> =&gt; ColorCode::Cyan,</span><br><span class="line">            Level::Trace =&gt; ColorCode::BrightBlack,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">let</span> now = call_interface!(LogIf::get_time);</span><br><span class="line"></span><br><span class="line">        print_fmt(with_color!(</span><br><span class="line">            ColorCode::White,</span><br><span class="line">            <span class="string">"[&#123;:&gt;3&#125;.&#123;:06&#125; &#123;path&#125;:&#123;line&#125;] &#123;args&#125;\n"</span>,</span><br><span class="line">            now.as_secs(),</span><br><span class="line">            now.subsec_micros(),</span><br><span class="line">            path = path,</span><br><span class="line">            line = line,</span><br><span class="line">            args = with_color!(args_color, <span class="string">"&#123;&#125;"</span>, record.args()),</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">flush</span></span>(&amp;<span class="keyword">self</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="axdtb"><a href="#axdtb" class="headerlink" title="axdtb"></a>axdtb</h5><p>内核最初启动时从 SBI 得到两个参数分别在 a0 和 a1 寄存器中。其中 a1 寄存器保存的是 dtb 的开始地址，而 dtb 就是 fdt 的二进制形式，它的全称 device tree blob。由于它已经在内存中放置好，内核启动时就可以直接解析它的内容获取信息。我们引入组件axdtb让内核自己解析 fdt 设备树来获得硬件平台的配置情况，作为后面启动过程的基础</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axdtb/src/lib.rs</span></span><br><span class="line"><span class="keyword">impl</span> DeviceTree &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">parse</span></span>(</span><br><span class="line">        &amp;<span class="keyword">self</span>, <span class="keyword">mut</span> pos: <span class="built_in">usize</span>,</span><br><span class="line">        <span class="keyword">mut</span> addr_cells: <span class="built_in">usize</span>,</span><br><span class="line">        <span class="keyword">mut</span> size_cells: <span class="built_in">usize</span>,</span><br><span class="line">        cb: &amp;<span class="keyword">mut</span> <span class="keyword">dyn</span> <span class="built_in">FnMut</span>(<span class="built_in">String</span>, <span class="built_in">usize</span>, <span class="built_in">usize</span>, <span class="built_in">Vec</span>&lt;(<span class="built_in">String</span>, <span class="built_in">Vec</span>&lt;<span class="built_in">u8</span>&gt;)&gt;)</span><br><span class="line">    ) -&gt; DeviceTreeResult&lt;<span class="built_in">usize</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> buf = <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            core::slice::from_raw_parts(<span class="keyword">self</span>.ptr <span class="keyword">as</span> *<span class="keyword">const</span> <span class="built_in">u8</span>, <span class="keyword">self</span>.totalsize)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// check for DT_BEGIN_NODE</span></span><br><span class="line">        <span class="keyword">if</span> buf.read_be_u32(pos)? != OF_DT_BEGIN_NODE &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(DeviceTreeError::ParseError(pos))</span><br><span class="line">        &#125;</span><br><span class="line">        pos += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> raw_name = buf.read_bstring0(pos)?;</span><br><span class="line">        pos = align_up(pos + raw_name.len() + <span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// First, read all the props.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> props = <span class="built_in">Vec</span>::new();</span><br><span class="line">        <span class="keyword">while</span> buf.read_be_u32(pos)? == OF_DT_PROP &#123;</span><br><span class="line">            <span class="keyword">let</span> val_size = buf.read_be_u32(pos+<span class="number">4</span>)? <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">            <span class="keyword">let</span> name_offset = buf.read_be_u32(pos+<span class="number">8</span>)? <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// get value slice</span></span><br><span class="line">            <span class="keyword">let</span> val_start = pos + <span class="number">12</span>;</span><br><span class="line">            <span class="keyword">let</span> val_end = val_start + val_size;</span><br><span class="line">            <span class="keyword">let</span> val = buf.subslice(val_start, val_end)?;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// lookup name in strings table</span></span><br><span class="line">            <span class="keyword">let</span> prop_name = buf.read_bstring0(<span class="keyword">self</span>.off_strings + name_offset)?;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> prop_name = <span class="built_in">str</span>::from_utf8(prop_name)?.to_owned();</span><br><span class="line">            <span class="keyword">if</span> prop_name == <span class="string">"#address-cells"</span> &#123;</span><br><span class="line">                addr_cells = val.read_be_u32(<span class="number">0</span>)? <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> prop_name == <span class="string">"#size-cells"</span> &#123;</span><br><span class="line">                size_cells = val.read_be_u32(<span class="number">0</span>)? <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            props.push((prop_name, val.to_owned()));</span><br><span class="line"></span><br><span class="line">            pos = align_up(val_end, <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Callback for parsing dtb</span></span><br><span class="line">        <span class="keyword">let</span> name = <span class="built_in">str</span>::from_utf8(raw_name)?.to_owned();</span><br><span class="line">        cb(name, addr_cells, size_cells, props);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Then, parse all its children.</span></span><br><span class="line">        <span class="keyword">while</span> buf.read_be_u32(pos)? == OF_DT_BEGIN_NODE &#123;</span><br><span class="line">            pos = <span class="keyword">self</span>.parse(pos, addr_cells, size_cells, cb)?;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> buf.read_be_u32(pos)? != OF_DT_END_NODE &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(DeviceTreeError::ParseError(pos))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pos += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(pos)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Ch4-内存管理2"><a href="#Ch4-内存管理2" class="headerlink" title="Ch4 内存管理2"></a>Ch4 内存管理2</h3><p>Target：实现多级页表和内存分配器，重建地址映射</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Code framework</span></span><br><span class="line">.</span><br><span class="line">├── axalloc</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── bitmap.rs</span><br><span class="line">│       ├── buddy.rs</span><br><span class="line">│       ├── early</span><br><span class="line">│       │   └── tests.rs</span><br><span class="line">│       ├── early.rs</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axconfig</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axdtb</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       └── util.rs</span><br><span class="line">├── axhal</span><br><span class="line">│   ├── linker.lds</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── riscv64</span><br><span class="line">│       │   ├── boot.rs</span><br><span class="line">│       │   ├── console.rs</span><br><span class="line">│       │   ├── lang_items.rs</span><br><span class="line">│       │   ├── mem.rs</span><br><span class="line">│       │   ├── misc.rs</span><br><span class="line">│       │   ├── paging.rs</span><br><span class="line">│       │   └── time.rs</span><br><span class="line">│       └── riscv64.rs</span><br><span class="line">├── axlog</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axorigin</span><br><span class="line">│   └── src</span><br><span class="line">│       └── main.rs</span><br><span class="line">├── axruntime</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axstd</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       └── time.rs</span><br><span class="line">├── axsync</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── bootcell.rs</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── bitmap_allocator</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── buddy_allocator</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── linked_list</span><br><span class="line">│       │   └── tests.rs</span><br><span class="line">│       └── linked_list.rs</span><br><span class="line">├── page_table</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">└── spinlock</span><br><span class="line">    └── src</span><br><span class="line">        ├── lib.rs</span><br><span class="line">        └── raw.rs</span><br></pre></td></tr></table></figure>

<h4 id="一、实现多级页表"><a href="#一、实现多级页表" class="headerlink" title="一、实现多级页表"></a>一、实现多级页表</h4><p>扩展实现Ch2的页表机制，之前的 map 实现十分简单，只是映射了 1G，并且 va/pa 地址以及总长度 total_size 都是按 1G 对齐的。但是如果地址范围可能出现不对齐的情况，这是指开始/结束地址没有按照 best_size 对齐或者总长度就小于 best_size。例如我们期望按照 2M 的粒度进行映射（即 best_size 是 2M，如上图所示），但是起止地址都没有按照 2M 对齐，那就需要把映射范围分成三个部分：把中间按照 2M 对齐的部分截出来，按照 2M 的 best_size 进行映射；把前后两个剩余部分按照 4K 的粒度单独映射.</p>
<p>改进map方法，如果映射范围总长度小于 best_size，后面都直接按照 4K 页粒度映射。如果地址范围的头部存在不对齐的部分，先按 4K 页粒度映射。调用 map_aligned 方法按照 best_size 进行映射。如果还存在剩余部分尚未映射，那这部分也是未对齐的部分，按照 4K 页粒度映射</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// page_table/src/lib.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">map</span></span>(</span><br><span class="line">    &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">    <span class="keyword">mut</span> va: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">mut</span> pa: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">mut</span> total_size: <span class="built_in">usize</span>,</span><br><span class="line">    best_size: <span class="built_in">usize</span>,</span><br><span class="line">    flags: <span class="built_in">usize</span>,</span><br><span class="line">) -&gt; PagingResult &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> map_size = best_size;</span><br><span class="line">    <span class="keyword">if</span> total_size &lt; best_size &#123;</span><br><span class="line">        map_size = PAGE_SIZE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> offset = align_offset(va, map_size);</span><br><span class="line">    <span class="keyword">if</span> offset != <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">assert!</span>(map_size != PAGE_SIZE);</span><br><span class="line">        <span class="keyword">let</span> offset = map_size - offset;</span><br><span class="line">        <span class="keyword">self</span>.map_aligned(va, pa, offset, PAGE_SIZE, flags)?;</span><br><span class="line">        va += offset;</span><br><span class="line">        pa += offset;</span><br><span class="line">        total_size -= offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> aligned_total_size = align_down(total_size, map_size);</span><br><span class="line">    total_size -= aligned_total_size;</span><br><span class="line">    <span class="keyword">self</span>.map_aligned(va, pa, aligned_total_size, map_size, flags)?;</span><br><span class="line">    <span class="keyword">if</span> total_size != <span class="number">0</span> &#123;</span><br><span class="line">        va += aligned_total_size;</span><br><span class="line">        pa += aligned_total_size;</span><br><span class="line">        <span class="keyword">self</span>.map_aligned(va, pa, total_size, PAGE_SIZE, flags)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">map_aligned</span></span>(</span><br><span class="line">    &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">    <span class="keyword">mut</span> va: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">mut</span> pa: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">mut</span> total_size: <span class="built_in">usize</span>,</span><br><span class="line">    best_size: <span class="built_in">usize</span>,</span><br><span class="line">    flags: <span class="built_in">usize</span>,</span><br><span class="line">) -&gt; PagingResult &#123;</span><br><span class="line">    <span class="built_in">assert!</span>(is_aligned(va, best_size));</span><br><span class="line">    <span class="built_in">assert!</span>(is_aligned(pa, best_size));</span><br><span class="line">    <span class="built_in">assert!</span>(is_aligned(total_size, best_size));</span><br><span class="line">    <span class="keyword">let</span> entry_size = <span class="keyword">self</span>.entry_size();</span><br><span class="line">    <span class="keyword">let</span> next_size = min(entry_size, total_size);</span><br><span class="line">    <span class="keyword">while</span> total_size &gt;= next_size &#123;</span><br><span class="line">        <span class="keyword">let</span> index = <span class="keyword">self</span>.entry_index(va);</span><br><span class="line">        <span class="keyword">if</span> entry_size == best_size &#123;</span><br><span class="line">            <span class="keyword">self</span>.table[index].set(pa, flags);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> pt = <span class="keyword">self</span>.next_table_mut(index)?;</span><br><span class="line">            pt.map(va, pa, next_size, best_size, flags)?;</span><br><span class="line">        &#125;</span><br><span class="line">        total_size -= next_size;</span><br><span class="line">        va += next_size;</span><br><span class="line">        pa += next_size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="literal">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><span id="0"></span></p>
<h4 id="二、页内存分配器"><a href="#二、页内存分配器" class="headerlink" title="二、页内存分配器"></a>二、页内存分配器</h4><p>这一分我们实现一个 bitmap 位分配器，下一步它将作为正式的页分配器的核心，管理内存页的分配与释放。位分配器基于bitmap数据结构，我们可以用每一位 bit 来代表一个内存块，通常 1 表示空闲可用，0 表示已分配；内存块的大小可以根据需要设定，粒度小到字节 byte，大到页面 page。我们对页内存进行层级化管理，形成若干级 bitmap，每一级 bitmap 包含 <strong>16 位</strong>，从上往下，第 1 级只有一个 bitmap，它每一位指向第 2 级的一个 bitmap，共 16 个；如此嵌套，直至最底层 leaf level，leaf level 对应 1M 位，所以包括 64K 个 bitmap（1M / 16 = 64K）。进一步来说，每一级的 bitmap 的 bit 位对应管理着不同数量的连续页空间，第 1 级 bitmap 的一个 bit 位代表 64K 个连续页（1M / 16 = 64K），而最底层 leaf level 上每个 bitmap 的每个 bit 位仅对应一个页。</p>
<p><img src="https://oslearning365.github.io/arceos-tutorial-book/img/bitmap-allocator.svg" alt="bitmap-allocator"></p>
<p>当搜索空闲页面时，只需要从上向下逐级递归查找，如果发现一个位是 0 时，就说明它对应的连续页空间已经被<strong>完全</strong>占用，不必再递归下一级，直接查看下一个位；否则说明其下对应的范围内还有空闲页，需要递归进去进一步查找和确认。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bitmap 数据结构</span></span><br><span class="line"><span class="comment">// bitmap_allocator/src/lib.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">BitAlloc1M</span></span> = BitAllocCascade16&lt;BitAlloc64K&gt;;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">BitAlloc64K</span></span> = BitAllocCascade16&lt;BitAlloc4K&gt;;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">BitAlloc4K</span></span> = BitAllocCascade16&lt;BitAlloc256&gt;;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">BitAlloc256</span></span> = BitAllocCascade16&lt;BitAlloc16&gt;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">BitAllocCascade16</span></span>&lt;T: BitAlloc&gt; &#123;</span><br><span class="line">    bitset: <span class="built_in">u16</span>, <span class="comment">// for each bit, 1 indicates available, 0 indicates inavailable</span></span><br><span class="line">    sub: [T; <span class="number">16</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">BitAlloc16</span></span>(<span class="built_in">u16</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">BitAlloc</span></span>: <span class="built_in">Default</span> &#123;</span><br><span class="line">    <span class="comment">/// The bitmap has a total of CAP bits, numbered from 0 to CAP-1 inclusively.</span></span><br><span class="line">    <span class="keyword">const</span> CAP: <span class="built_in">usize</span>;</span><br><span class="line">    <span class="keyword">const</span> DEFAULT: <span class="keyword">Self</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">alloc</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">usize</span>&gt;;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">alloc_contiguous</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, size: <span class="built_in">usize</span>, align_log2: <span class="built_in">usize</span>) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">usize</span>&gt;;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">self</span>, key: <span class="built_in">usize</span>) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">usize</span>&gt;;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">dealloc</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">usize</span>);</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">insert</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, range: Range&lt;<span class="built_in">usize</span>&gt;);</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">remove</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, range: Range&lt;<span class="built_in">usize</span>&gt;);</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">is_empty</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span>;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">test</span></span>(&amp;<span class="keyword">self</span>, key: <span class="built_in">usize</span>) -&gt; <span class="built_in">bool</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过bitmap位分配器实现页内存分配器</span></span><br><span class="line"><span class="comment">// axalloc/src/bitmap.rs</span></span><br><span class="line"><span class="keyword">impl</span> BitmapPageAllocator &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">alloc_pages</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, layout: Layout) -&gt; AllocResult&lt;NonNull&lt;<span class="built_in">u8</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="comment">// 检查对齐是否为页大小的整数倍且是2的幂</span></span><br><span class="line">        <span class="keyword">if</span> layout.align() % PAGE_SIZE != <span class="number">0</span> || !layout.align().is_power_of_two() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(AllocError::InvalidParam);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 计算页数（向上取整）</span></span><br><span class="line">        <span class="keyword">let</span> num_pages = (layout.size() + PAGE_SIZE - <span class="number">1</span>) / PAGE_SIZE;</span><br><span class="line">        <span class="keyword">if</span> num_pages == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">Err</span>(AllocError::InvalidParam);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 对齐参数转换</span></span><br><span class="line">        <span class="keyword">let</span> align_pow2 = layout.align() / PAGE_SIZE;</span><br><span class="line">        <span class="keyword">let</span> align_log2 = align_pow2.trailing_zeros() <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 分配页并转换为指针</span></span><br><span class="line">        <span class="keyword">let</span> result = <span class="keyword">match</span> num_pages &#123;</span><br><span class="line">            <span class="number">1</span> =&gt; <span class="keyword">self</span>.inner.alloc(),</span><br><span class="line">            _ =&gt; <span class="keyword">self</span>.inner.alloc_contiguous(num_pages, align_log2),</span><br><span class="line">        &#125;;</span><br><span class="line">        result</span><br><span class="line">            .map(|idx| idx * PAGE_SIZE + <span class="keyword">self</span>.base)</span><br><span class="line">            .map(|pos| NonNull::new(pos <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">u8</span>).unwrap())</span><br><span class="line">            .ok_or(AllocError::NoMemory)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">dealloc_pages</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, pos: <span class="built_in">usize</span>, num_pages: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> idx = (pos - <span class="keyword">self</span>.base) / PAGE_SIZE;</span><br><span class="line">        <span class="comment">// 假设inner支持批量释放</span></span><br><span class="line">        <span class="keyword">self</span>.inner.dealloc_range(idx, num_pages);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="三、字节内存分配器"><a href="#三、字节内存分配器" class="headerlink" title="三、字节内存分配器"></a>三、字节内存分配器</h4><p>我们完成了从早期的页分配器到正式页分配器的切换后继续实现字节分配器，我们将基于经典的伙伴算法（buddy）实现这个内存分配器。关于伙伴算法，简单来说，一个内存块可以分成对等大小、地址连续的两个内存块，它们称为伙伴。当进行内存分配时，如果没有正好符合要求的空闲内存块，则需要对更大的空闲内存块逐级平分，直到划分出符合要求的最小内存块；内存释放时，尝试与它的伙伴进行合并，直至不能合并为止。这个算法兼顾了分配速度和碎片化问题。它的实现原理如下图所示：</p>
<p><img src="https://oslearning365.github.io/arceos-tutorial-book/img/buddy%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D.png" alt="buddy内存分配"></p>
<p>从图中可见，buddy 内存分配器的实现结构简单，就是通过<strong>数组 + 链表</strong>来维护空闲的内存块。</p>
<p>数组索引称 Order，每个 Order 维护一组具有相同大小的空闲内存块，它们通过链表结构连接在一起。Order 与本级所维护的空闲块大小的对应关系：空闲块大小 = $ 2^{order} $ 字节。在分配时，每一级 Order 上的内存块都可以平分为一对伙伴内存块，挂到更低一级的 Order 链表上；反之在释放内存块时，查看它的伙伴内存块是否也是空闲，如果是则合并成上一级的大块，挂到上一级 Order 的链表中。</p>
<p>我们的链表使用<strong>侵入式链表</strong> <code>linked_list</code>，其特点是：链表的节点直接嵌入到空闲内存块内部</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// buddy_allocator/src/linked_list.rs</span></span><br><span class="line"><span class="meta">#[derive(Copy, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">LinkedList</span></span> &#123;</span><br><span class="line">    head: *<span class="keyword">mut</span> <span class="built_in">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span> <span class="built_in">Send</span> <span class="keyword">for</span> LinkedList &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> LinkedList &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; LinkedList &#123;</span><br><span class="line">        LinkedList &#123;</span><br><span class="line">            head: ptr::null_mut(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_empty</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.head.is_null()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">push</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, item: *<span class="keyword">mut</span> <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            *item = <span class="keyword">self</span>.head <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.head = item;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">pop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;*<span class="keyword">mut</span> <span class="built_in">usize</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.is_empty() &#123;</span><br><span class="line">            <span class="literal">true</span> =&gt; <span class="literal">None</span>,</span><br><span class="line">            <span class="literal">false</span> =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> item = <span class="keyword">self</span>.head;</span><br><span class="line">                <span class="keyword">self</span>.head = <span class="keyword">unsafe</span> &#123; *item <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">usize</span> &#125;;</span><br><span class="line">                <span class="literal">Some</span>(item)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">iter</span></span>(&amp;<span class="keyword">self</span>) -&gt; Iter &#123;</span><br><span class="line">        Iter &#123;</span><br><span class="line">            curr: <span class="keyword">self</span>.head,</span><br><span class="line">            list: PhantomData,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">iter_mut</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; IterMut &#123;</span><br><span class="line">        IterMut &#123;</span><br><span class="line">            prev: &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.head <span class="keyword">as</span> *<span class="keyword">mut</span> *<span class="keyword">mut</span> <span class="built_in">usize</span> <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">usize</span>,</span><br><span class="line">            curr: <span class="keyword">self</span>.head,</span><br><span class="line">            list: PhantomData,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Iter</span></span>&lt;<span class="symbol">'a</span>&gt; &#123;</span><br><span class="line">    curr: *<span class="keyword">mut</span> <span class="built_in">usize</span>,</span><br><span class="line">    list: PhantomData&lt;&amp;<span class="symbol">'a</span> LinkedList&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">'a</span>&gt; <span class="built_in">Iterator</span> <span class="keyword">for</span> Iter&lt;<span class="symbol">'a</span>&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Item</span></span> = *<span class="keyword">mut</span> <span class="built_in">usize</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;Self::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.curr.is_null() &#123;</span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> item = <span class="keyword">self</span>.curr;</span><br><span class="line">            <span class="keyword">let</span> next = <span class="keyword">unsafe</span> &#123; *item <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">usize</span> &#125;;</span><br><span class="line">            <span class="keyword">self</span>.curr = next;</span><br><span class="line">            <span class="literal">Some</span>(item)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">IterMut</span></span>&lt;<span class="symbol">'a</span>&gt; &#123;</span><br><span class="line">    list: PhantomData&lt;&amp;<span class="symbol">'a</span> <span class="keyword">mut</span> LinkedList&gt;,</span><br><span class="line">    prev: *<span class="keyword">mut</span> <span class="built_in">usize</span>,</span><br><span class="line">    curr: *<span class="keyword">mut</span> <span class="built_in">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">'a</span>&gt; <span class="built_in">Iterator</span> <span class="keyword">for</span> IterMut&lt;<span class="symbol">'a</span>&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Item</span></span> = ListNode;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;Self::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.curr.is_null() &#123;</span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> res = ListNode &#123;</span><br><span class="line">                prev: <span class="keyword">self</span>.prev,</span><br><span class="line">                curr: <span class="keyword">self</span>.curr,</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">self</span>.prev = <span class="keyword">self</span>.curr;</span><br><span class="line">            <span class="keyword">self</span>.curr = <span class="keyword">unsafe</span> &#123; *<span class="keyword">self</span>.curr <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">usize</span> &#125;;</span><br><span class="line">            <span class="literal">Some</span>(res)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE]</p>
<ul>
<li><p>裸指针 (<code>*mut T</code>/<code>*const T</code>) 和引用 (<code>&amp;T</code>/<code>&amp;mut T</code>) 的关键区别在于：</p>
<ul>
<li><strong>裸指针</strong>：<ul>
<li>不参与 Rust 的借用检查规则。</li>
<li>无生命周期注解，编译器不会自动保证其有效性。</li>
<li>可以指向任意内存地址（包括悬垂指针），安全责任完全由开发者承担。</li>
</ul>
</li>
<li><strong>引用</strong>：<ul>
<li>受 Rust 生命周期和借用规则严格约束。</li>
<li>必须显式或隐式标注生命周期，确保引用的有效性。</li>
</ul>
</li>
</ul>
<p><code>LinkedList</code> 内部使用裸指针 (<code>head: *mut usize</code>)，因此无需生命周期参数，因为它的安全性不依赖编译器的静态检查，而是由开发者通过 <code>unsafe</code> 代码手动保证。</p>
</li>
</ul>
</blockquote>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用linked_list数据结构实现buddy_allocator</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">AllocError</span></span> &#123;</span><br><span class="line">    NoMemory,</span><br><span class="line">    InvalidLayout,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Heap</span></span>&lt;<span class="keyword">const</span> ORDER: <span class="built_in">usize</span>&gt; &#123;</span><br><span class="line">    free_list: [linked_list::LinkedList; ORDER],</span><br><span class="line">    used: <span class="built_in">usize</span>,</span><br><span class="line">    allocated: <span class="built_in">usize</span>,</span><br><span class="line">    total: <span class="built_in">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="keyword">const</span> ORDER: <span class="built_in">usize</span>&gt; Heap&lt;ORDER&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Heap &#123;</span><br><span class="line">            free_list: [linked_list::LinkedList::new(); ORDER],</span><br><span class="line">            used: <span class="number">0</span>,</span><br><span class="line">            allocated: <span class="number">0</span>,</span><br><span class="line">            total: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">empty</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Self::new()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="keyword">const</span> ORDER: <span class="built_in">usize</span>&gt; Heap&lt;ORDER&gt; &#123;</span><br><span class="line">    <span class="comment">/// Adds a memory region to the heap.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// # Safety</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The caller must ensure that the memory region [start, end) is valid and not used by other allocators.</span></span><br><span class="line">    <span class="comment">/// The region must be properly aligned and not overlap with any existing heap regions.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">add_to_heap</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, <span class="keyword">mut</span> start: <span class="built_in">usize</span>, <span class="keyword">mut</span> end: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        start = (start + size_of::&lt;<span class="built_in">usize</span>&gt;() - <span class="number">1</span>) &amp; (!size_of::&lt;<span class="built_in">usize</span>&gt;() + <span class="number">1</span>);</span><br><span class="line">        end &amp;= !size_of::&lt;<span class="built_in">usize</span>&gt;() + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">assert!</span>(start &lt;= end);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> total = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> current_start = start;</span><br><span class="line">        <span class="keyword">while</span> current_start + size_of::&lt;<span class="built_in">usize</span>&gt;() &lt;= end &#123;</span><br><span class="line">            <span class="keyword">let</span> lowbit = current_start &amp; (!current_start + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">let</span> size = min(lowbit, prev_power_of_two(end - current_start));</span><br><span class="line">            total += size;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.free_list[size.trailing_zeros() <span class="keyword">as</span> <span class="built_in">usize</span>].push(current_start <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">usize</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            current_start += size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.total += total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">init</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, start: <span class="built_in">usize</span>, size: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.add_to_heap(start, start + size) &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="function"><span class="keyword">fn</span> <span class="title">prev_power_of_two</span></span>(num: <span class="built_in">usize</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">    <span class="number">1</span> &lt;&lt; (<span class="built_in">usize</span>::BITS <span class="keyword">as</span> <span class="built_in">usize</span> - num.leading_zeros() <span class="keyword">as</span> <span class="built_in">usize</span> - <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="keyword">const</span> ORDER: <span class="built_in">usize</span>&gt; Heap&lt;ORDER&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">alloc</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, layout: Layout) -&gt; <span class="built_in">Result</span>&lt;NonNull&lt;<span class="built_in">u8</span>&gt;, AllocError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> size = max(</span><br><span class="line">            layout.size().next_power_of_two(),</span><br><span class="line">            max(layout.align(), size_of::&lt;<span class="built_in">usize</span>&gt;()),</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">let</span> class = size.trailing_zeros() <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> class..<span class="keyword">self</span>.free_list.len() &#123;</span><br><span class="line">            <span class="keyword">if</span> !<span class="keyword">self</span>.free_list[i].is_empty() &#123;</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> (class + <span class="number">1</span>..i + <span class="number">1</span>).rev() &#123;</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(block) = <span class="keyword">self</span>.free_list[j].pop() &#123;</span><br><span class="line">                        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                            <span class="keyword">self</span>.free_list[j - <span class="number">1</span>]</span><br><span class="line">                                .push((block <span class="keyword">as</span> <span class="built_in">usize</span> + (<span class="number">1</span> &lt;&lt; (j - <span class="number">1</span>))) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">usize</span>);</span><br><span class="line">                            <span class="keyword">self</span>.free_list[j - <span class="number">1</span>].push(block);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">Err</span>(AllocError::NoMemory);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> result = NonNull::new(</span><br><span class="line">                    <span class="keyword">self</span>.free_list[class]</span><br><span class="line">                        .pop()</span><br><span class="line">                        .expect(<span class="string">"current block should have free space now"</span>)</span><br><span class="line">                        <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">u8</span>,</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(result) = result &#123;</span><br><span class="line">                    <span class="keyword">self</span>.used += layout.size();</span><br><span class="line">                    <span class="keyword">self</span>.allocated += size;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">Ok</span>(result);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">Err</span>(AllocError::NoMemory);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Err</span>(AllocError::NoMemory)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">dealloc</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ptr: NonNull&lt;<span class="built_in">u8</span>&gt;, layout: Layout) &#123;</span><br><span class="line">        <span class="keyword">let</span> size = max(</span><br><span class="line">            layout.size().next_power_of_two(),</span><br><span class="line">            max(layout.align(), size_of::&lt;<span class="built_in">usize</span>&gt;()),</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">let</span> class = size.trailing_zeros() <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.free_list[class].push(ptr.as_ptr() <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">usize</span>);</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> current_ptr = ptr.as_ptr() <span class="keyword">as</span> <span class="built_in">usize</span>;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> current_class = class;</span><br><span class="line">            <span class="keyword">while</span> current_class &lt; <span class="keyword">self</span>.free_list.len() &#123;</span><br><span class="line">                <span class="keyword">let</span> buddy = current_ptr ^ (<span class="number">1</span> &lt;&lt; current_class);</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> flag = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">for</span> block <span class="keyword">in</span> <span class="keyword">self</span>.free_list[current_class].iter_mut() &#123;</span><br><span class="line">                    <span class="keyword">if</span> block.value() <span class="keyword">as</span> <span class="built_in">usize</span> == buddy &#123;</span><br><span class="line">                        block.pop();</span><br><span class="line">                        flag = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> flag &#123;</span><br><span class="line">                    <span class="keyword">self</span>.free_list[current_class].pop();</span><br><span class="line">                    current_ptr = min(current_ptr, buddy);</span><br><span class="line">                    current_class += <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">self</span>.free_list[current_class].push(current_ptr <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="built_in">usize</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.used -= layout.size();</span><br><span class="line">        <span class="keyword">self</span>.allocated -= size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">stats_total_bytes</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.total</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="keyword">const</span> ORDER: <span class="built_in">usize</span>&gt; <span class="built_in">Default</span> <span class="keyword">for</span> Heap&lt;ORDER&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">default</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Self::new()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><span id="2"></span></p>
<h3 id="Ch5-线程管理"><a href="#Ch5-线程管理" class="headerlink" title="Ch5 线程管理"></a>Ch5 线程管理</h3><p>Target: 支持多任务管理与调度</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Code framework</span></span><br><span class="line">.</span><br><span class="line">├── axalloc</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── bitmap.rs</span><br><span class="line">│       ├── buddy.rs</span><br><span class="line">│       ├── early</span><br><span class="line">│       │   └── tests.rs</span><br><span class="line">│       ├── early.rs</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axconfig</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axdtb</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       └── util.rs</span><br><span class="line">├── axhal</span><br><span class="line">│   ├── linker.lds</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── riscv64</span><br><span class="line">│       │   ├── boot.rs</span><br><span class="line">│       │   ├── console.rs</span><br><span class="line">│       │   ├── context.rs</span><br><span class="line">│       │   ├── cpu.rs</span><br><span class="line">│       │   ├── lang_items.rs</span><br><span class="line">│       │   ├── mem.rs</span><br><span class="line">│       │   ├── misc.rs</span><br><span class="line">│       │   ├── paging.rs</span><br><span class="line">│       │   └── time.rs</span><br><span class="line">│       └── riscv64.rs</span><br><span class="line">├── axlog</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axorigin</span><br><span class="line">│   └── src</span><br><span class="line">│       └── main.rs</span><br><span class="line">├── axruntime</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axstd</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── io.rs</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── thread.rs</span><br><span class="line">│       └── time.rs</span><br><span class="line">├── axsync</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── bootcell.rs</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axtask</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── run_queue.rs</span><br><span class="line">│       ├── task.rs</span><br><span class="line">│       └── wait_queue.rs</span><br><span class="line">├── bitmap_allocator</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── buddy_allocator</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── linked_list</span><br><span class="line">│       │   └── tests.rs</span><br><span class="line">│       └── linked_list.rs</span><br><span class="line">├── kernel_guard</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── page_table</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">└── spinlock</span><br><span class="line">    └── src</span><br><span class="line">        ├── lib.rs</span><br><span class="line">        └── raw.rs</span><br></pre></td></tr></table></figure>

<h4 id="一、初始任务"><a href="#一、初始任务" class="headerlink" title="一、初始任务"></a>一、初始任务</h4><p>我们需要让内核支持任务与调度，任务是被调度的对象，它具有独立的工作逻辑。调度是资源不足时，协调每个请求对资源使用的方法。在 ArceOS 的语境下，任务等价于线程。也就是说，每个任务拥有<strong>独立的执行流</strong>和<strong>独立的栈</strong>，但是它们没有独立的地址空间，而是共享唯一的内核地址空间。</p>
<p>我们首先需要建立一个MainTask，后续我们将要创建的那些任务都是 MainTask 的分支和子任务，需要受到它的管理。因为arceos作为unikernel每次只会运行一个app，可以把MainTask看作应用的初始进程，维护未运行线程时的上下文，之后用spawn创建的任务为app的线程，如果线程退出，就再调度运行MainTask</p>
<p>另外，还有一个特殊的空闲系统任务 Idle，当没有任何其它任务可以调度时，Idle 将临时充当 CPU 当前任务：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">run_idle</span></span>() -&gt; ! &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        yield_now();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">维度</th>
<th align="left">MainTask (主任务)</th>
<th align="left">Idle (空闲任务)</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>角色</strong></td>
<td align="left">系统主逻辑入口</td>
<td align="left">CPU 空闲兜底任务</td>
</tr>
<tr>
<td align="left"><strong>调度优先级</strong></td>
<td align="left">正常优先级</td>
<td align="left">最低优先级（仅在无任务时运行）</td>
</tr>
<tr>
<td align="left"><strong>退出行为</strong></td>
<td align="left">退出时可能终止系统</td>
<td align="left">永不退出</td>
</tr>
<tr>
<td align="left"><strong>阻塞能力</strong></td>
<td align="left">可被阻塞</td>
<td align="left">不可阻塞</td>
</tr>
<tr>
<td align="left"><strong>实现目标</strong></td>
<td align="left">执行业务逻辑</td>
<td align="left">避免 CPU 空转，维持调度循环</td>
</tr>
</tbody></table>
<p><img src="https://oslearning365.github.io/arceos-tutorial-book/img/%E5%88%9D%E5%A7%8B%E4%BB%BB%E5%8A%A1InitTask.svg" alt="初始任务InitTask"></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axruntime初始化时调用init</span></span><br><span class="line"><span class="comment">// axtask/src/lib.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">init_scheduler</span></span>() &#123;</span><br><span class="line">    info!(<span class="string">"Initialize scheduling..."</span>);</span><br><span class="line">    run_queue::init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化MainTask和ldle任务</span></span><br><span class="line"><span class="comment">// axtask/src/run_queue.rs</span></span><br><span class="line"><span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="function"><span class="keyword">fn</span> <span class="title">init</span></span>() &#123;</span><br><span class="line">    <span class="keyword">const</span> IDLE_TASK_STACK_SIZE: <span class="built_in">usize</span> = <span class="number">4096</span>;</span><br><span class="line">    <span class="keyword">let</span> idle_task = Task::new(|| run_idle(), <span class="string">"idle"</span>.into(), IDLE_TASK_STACK_SIZE);</span><br><span class="line">    IDLE_TASK.init(idle_task.clone());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> main_task = Task::new_init(<span class="string">"main"</span>.into());</span><br><span class="line">    main_task.set_state(TaskState::Running);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> &#123; CurrentTask::init_current(main_task) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建任务</span></span><br><span class="line"><span class="comment">// axtask/src/task.rs</span></span><br><span class="line"><span class="keyword">impl</span> Task &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new_common</span></span>(id: TaskId, name: <span class="built_in">String</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            id,</span><br><span class="line">            name,</span><br><span class="line">            is_idle: <span class="literal">false</span>,</span><br><span class="line">            is_init: <span class="literal">false</span>,</span><br><span class="line">            entry: <span class="literal">None</span>,</span><br><span class="line">            state: AtomicU8::new(TaskState::Ready <span class="keyword">as</span> <span class="built_in">u8</span>),</span><br><span class="line">            in_wait_queue: AtomicBool::new(<span class="literal">false</span>),</span><br><span class="line">            exit_code: AtomicI32::new(<span class="number">0</span>),</span><br><span class="line">            wait_for_exit: WaitQueue::new(),</span><br><span class="line">            kstack: <span class="literal">None</span>,</span><br><span class="line">            ctx: UnsafeCell::new(TaskContext::new()),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Create a new task with the given entry function and stack size.</span></span><br><span class="line">    <span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>&lt;F&gt;(entry: F, name: <span class="built_in">String</span>, stack_size: <span class="built_in">usize</span>) -&gt; AxTaskRef</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        F: <span class="built_in">FnOnce</span>() + <span class="symbol">'static</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> t = Self::new_common(TaskId::new(), name);</span><br><span class="line">        debug!(<span class="string">"new task: &#123;&#125;"</span>, t.name());</span><br><span class="line">        <span class="keyword">let</span> kstack = TaskStack::alloc(align_up(stack_size, PAGE_SIZE));</span><br><span class="line">        t.entry = <span class="literal">Some</span>(<span class="built_in">Box</span>::into_raw(<span class="built_in">Box</span>::new(entry)));</span><br><span class="line">        t.ctx.get_mut().init(task_entry <span class="keyword">as</span> <span class="built_in">usize</span>, kstack.top());</span><br><span class="line">        t.kstack = <span class="literal">Some</span>(kstack);</span><br><span class="line">        <span class="keyword">if</span> t.name == <span class="string">"idle"</span> &#123;</span><br><span class="line">            t.is_idle = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Arc::new(t)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="function"><span class="keyword">fn</span> <span class="title">new_init</span></span>(name: <span class="built_in">String</span>) -&gt; AxTaskRef &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> t = Self::new_common(TaskId::new(), name);</span><br><span class="line">        t.is_init = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> t.name == <span class="string">"idle"</span> &#123;</span><br><span class="line">            t.is_idle = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Arc::new(t)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="二、创建任务"><a href="#二、创建任务" class="headerlink" title="二、创建任务"></a>二、创建任务</h4><p>前面我们已经让内核的主线程成为第一个任务 MainTask；本节将在 MainTask 的基础上，使用<code>spawn</code>创建一个应用级的任务，这个任务可以理解为app的一个线程</p>
<p><img src="https://oslearning365.github.io/arceos-tutorial-book/img/maintask-create-apptask.svg" alt="maintask-create-apptask"></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将spawn暴露为接口给用户调用</span></span><br><span class="line"><span class="comment">// axstd/src/thread.rs</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Builder</span></span> &#123;</span><br><span class="line">    <span class="comment">// A name for the thread-to-be, for identification in panic messages</span></span><br><span class="line">    name: <span class="built_in">Option</span>&lt;<span class="built_in">String</span>&gt;,</span><br><span class="line">    <span class="comment">// The size of the stack for the spawned thread in bytes</span></span><br><span class="line">    stack_size: <span class="built_in">Option</span>&lt;<span class="built_in">usize</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Builder &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">spawn</span></span>&lt;F, T&gt;(<span class="keyword">self</span>, f: F) -&gt; io::<span class="built_in">Result</span>&lt;JoinHandle&lt;T&gt;&gt;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        F: <span class="built_in">FnOnce</span>() -&gt; T + <span class="symbol">'static</span>,</span><br><span class="line">        F: <span class="symbol">'static</span>,</span><br><span class="line">        T: <span class="symbol">'static</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="keyword">self</span>.spawn_unchecked(f) &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">spawn_unchecked</span></span>&lt;F, T&gt;(<span class="keyword">self</span>, f: F) -&gt; <span class="built_in">Result</span>&lt;JoinHandle&lt;T&gt;&gt;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        F: <span class="built_in">FnOnce</span>() -&gt; T + <span class="symbol">'static</span>,</span><br><span class="line">        F: <span class="symbol">'static</span>,</span><br><span class="line">        T: <span class="symbol">'static</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> name = <span class="keyword">self</span>.name.unwrap_or_default();</span><br><span class="line">        <span class="keyword">let</span> stack_size = <span class="keyword">self</span>.stack_size.unwrap_or(axconfig::TASK_STACK_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> my_packet = Arc::new(Packet &#123;</span><br><span class="line">            result: UnsafeCell::new(<span class="literal">None</span>),</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">let</span> their_packet = my_packet.clone();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> main = <span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> ret = f();</span><br><span class="line">            <span class="keyword">unsafe</span> &#123; *their_packet.result.get() = <span class="literal">Some</span>(ret) &#125;;</span><br><span class="line">            <span class="built_in">drop</span>(their_packet);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> inner = axtask::spawn_raw(main, name, stack_size);</span><br><span class="line">        <span class="keyword">let</span> task = AxTaskHandle &#123;</span><br><span class="line">            id: inner.id().as_u64(),</span><br><span class="line">            inner,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="literal">Ok</span>(JoinHandle &#123;</span><br><span class="line">            thread: Thread::from_id(task.id),</span><br><span class="line">            native: task,</span><br><span class="line">            packet: my_packet,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">spawn</span></span>&lt;T, F&gt;(f: F) -&gt; JoinHandle&lt;T&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    F: <span class="built_in">FnOnce</span>() -&gt; T + <span class="symbol">'static</span>,</span><br><span class="line">    T: <span class="symbol">'static</span>,</span><br><span class="line">&#123;</span><br><span class="line">    Builder::new().spawn(f).expect(<span class="string">"failed to spawn thread"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户调用join将MainTask切换到spawn创建的线程</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axstd/src/thread.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">JoinHandle</span></span>&lt;T&gt; &#123;</span><br><span class="line">    native: AxTaskHandle,</span><br><span class="line">    thread: Thread,</span><br><span class="line">    packet: Arc&lt;Packet&lt;T&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Send</span> <span class="keyword">for</span> JoinHandle&lt;T&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Sync</span> <span class="keyword">for</span> JoinHandle&lt;T&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; JoinHandle&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">thread</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;Thread &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.thread</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">join</span></span>(<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Result</span>&lt;T&gt; &#123;</span><br><span class="line">        Self::wait_for_exit(<span class="keyword">self</span>.native).ok_or_else(|| IoError::BadState)?;</span><br><span class="line">        Arc::get_mut(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.packet)</span><br><span class="line">            .unwrap()</span><br><span class="line">            .result</span><br><span class="line">            .get_mut()</span><br><span class="line">            .take()</span><br><span class="line">            .ok_or_else(|| IoError::BadState)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">wait_for_exit</span></span>(task: AxTaskHandle) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">i32</span>&gt; &#123;</span><br><span class="line">        task.inner.join()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MainTask 对 AppTask 调用 join，建立等待关系，然后把自己状态设置为 Blocked，从运行队列 run_queue 转移到等待队列 wait_queue，然后触发重新调度让出执行权。直到 AppTask 退出时，MainTask 作为等待者被重新唤醒，继续执行。</p>
<p><img src="https://oslearning365.github.io/arceos-tutorial-book/img/wait-for-task.svg" alt="wait-for-task"></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axtask/src/wait_queue.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">wait_until</span></span>&lt;F&gt;(&amp;<span class="keyword">self</span>, condition: F)</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    F: <span class="built_in">Fn</span>() -&gt; <span class="built_in">bool</span>,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> rq = RUN_QUEUE.lock();</span><br><span class="line">        <span class="keyword">if</span> condition() &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        rq.block_current(|task| &#123;</span><br><span class="line">            task.set_in_wait_queue(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">self</span>.queue.lock().push_back(task);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.cancel_events(current());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="三、任务切换"><a href="#三、任务切换" class="headerlink" title="三、任务切换"></a>三、任务切换</h4><p>app调用join后MainTask将自己加入wait_queue后使用resched调度app线程</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axtask/src/run_queue.rs</span></span><br><span class="line"><span class="keyword">impl</span> AxRunQueue &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">resched</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, preempt: <span class="built_in">bool</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> prev = current();</span><br><span class="line">        <span class="keyword">if</span> prev.is_running() &#123;</span><br><span class="line">            prev.set_state(TaskState::Ready);</span><br><span class="line">            <span class="keyword">if</span> !prev.is_idle() &#123;</span><br><span class="line">                <span class="keyword">self</span>.put_prev_task(prev.clone(), preempt);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> next = <span class="keyword">self</span>.pick_next_task().unwrap();</span><br><span class="line">        <span class="keyword">self</span>.switch_to(prev, next);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">switch_to</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, prev_task: CurrentTask, next_task: AxTaskRef) &#123;</span><br><span class="line">        next_task.set_state(TaskState::Running);</span><br><span class="line">        <span class="keyword">if</span> prev_task.ptr_eq(&amp;next_task) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prev_ctx_ptr = prev_task.ctx_mut_ptr();</span><br><span class="line">            <span class="keyword">let</span> next_ctx_ptr = next_task.ctx_mut_ptr();</span><br><span class="line"></span><br><span class="line">            CurrentTask::set_current(prev_task, next_task);</span><br><span class="line">            (*prev_ctx_ptr).switch_to(&amp;*next_ctx_ptr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// axhal/src/riscv64/context.rs</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Default)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">TaskContext</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> ra: <span class="built_in">usize</span>, <span class="comment">// return address (x1)</span></span><br><span class="line">    <span class="keyword">pub</span> sp: <span class="built_in">usize</span>, <span class="comment">// stack pointer (x2)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> s0: <span class="built_in">usize</span>, <span class="comment">// x8-x9</span></span><br><span class="line">    <span class="keyword">pub</span> s1: <span class="built_in">usize</span>,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> s2: <span class="built_in">usize</span>, <span class="comment">// x18-x27</span></span><br><span class="line">    <span class="keyword">pub</span> s3: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">pub</span> s4: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">pub</span> s5: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">pub</span> s6: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">pub</span> s7: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">pub</span> s8: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">pub</span> s9: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">pub</span> s10: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="keyword">pub</span> s11: <span class="built_in">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> TaskContext &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">switch_to</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, next_ctx: &amp;<span class="keyword">Self</span>) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; context_switch(<span class="keyword">self</span>, next_ctx) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[naked]</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">"C"</span> <span class="function"><span class="keyword">fn</span> <span class="title">context_switch</span></span>(_current_task: &amp;<span class="keyword">mut</span> TaskContext, _next_task: &amp;TaskContext) &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        naked_asm!(</span><br><span class="line">            <span class="string">"</span></span><br><span class="line"><span class="string">        // save old context (callee-saved registers)</span></span><br><span class="line"><span class="string">        sd     ra, 0*8(a0)</span></span><br><span class="line"><span class="string">        sd     sp, 1*8(a0)</span></span><br><span class="line"><span class="string">        sd     s0, 2*8(a0)</span></span><br><span class="line"><span class="string">        sd     s1, 3*8(a0)</span></span><br><span class="line"><span class="string">        sd     s2, 4*8(a0)</span></span><br><span class="line"><span class="string">        sd     s3, 5*8(a0)</span></span><br><span class="line"><span class="string">        sd     s4, 6*8(a0)</span></span><br><span class="line"><span class="string">        sd     s5, 7*8(a0)</span></span><br><span class="line"><span class="string">        sd     s6, 8*8(a0)</span></span><br><span class="line"><span class="string">        sd     s7, 9*8(a0)</span></span><br><span class="line"><span class="string">        sd     s8, 10*8(a0)</span></span><br><span class="line"><span class="string">        sd     s9, 11*8(a0)</span></span><br><span class="line"><span class="string">        sd     s10, 12*8(a0)</span></span><br><span class="line"><span class="string">        sd     s11, 13*8(a0)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        // restore new context</span></span><br><span class="line"><span class="string">        ld     s11, 13*8(a1)</span></span><br><span class="line"><span class="string">        ld     s10, 12*8(a1)</span></span><br><span class="line"><span class="string">        ld     s9, 11*8(a1)</span></span><br><span class="line"><span class="string">        ld     s8, 10*8(a1)</span></span><br><span class="line"><span class="string">        ld     s7,  9*8(a1)</span></span><br><span class="line"><span class="string">        ld     s6,  8*8(a1)</span></span><br><span class="line"><span class="string">        ld     s5,  7*8(a1)</span></span><br><span class="line"><span class="string">        ld     s4,  6*8(a1)</span></span><br><span class="line"><span class="string">        ld     s3,  5*8(a1)</span></span><br><span class="line"><span class="string">        ld     s2,  4*8(a1)</span></span><br><span class="line"><span class="string">        ld     s1,  3*8(a1)</span></span><br><span class="line"><span class="string">        ld     s0,  2*8(a1)</span></span><br><span class="line"><span class="string">        ld     sp,  1*8(a1)</span></span><br><span class="line"><span class="string">        ld     ra,  0*8(a1)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ret"</span>,</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Ch6-异常和中断"><a href="#Ch6-异常和中断" class="headerlink" title="Ch6 异常和中断"></a>Ch6 异常和中断</h3><p>Target：支持异常处理和中断处理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Code Framework</span></span><br><span class="line">.</span><br><span class="line">├── axalloc</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── bitmap.rs</span><br><span class="line">│       ├── buddy.rs</span><br><span class="line">│       ├── early</span><br><span class="line">│       │   └── tests.rs</span><br><span class="line">│       ├── early.rs</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axconfig</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axdtb</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       └── util.rs</span><br><span class="line">├── axhal</span><br><span class="line">│   ├── linker.lds</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── riscv64</span><br><span class="line">│       │   ├── boot.rs</span><br><span class="line">│       │   ├── console.rs</span><br><span class="line">│       │   ├── context.rs</span><br><span class="line">│       │   ├── cpu.rs</span><br><span class="line">│       │   ├── irq.rs</span><br><span class="line">│       │   ├── lang_items.rs</span><br><span class="line">│       │   ├── mem.rs</span><br><span class="line">│       │   ├── misc.rs</span><br><span class="line">│       │   ├── paging.rs</span><br><span class="line">│       │   ├── time.rs</span><br><span class="line">│       │   ├── trap.rs</span><br><span class="line">│       │   └── trap.S</span><br><span class="line">│       └── riscv64.rs</span><br><span class="line">├── axlog</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axorigin</span><br><span class="line">│   └── src</span><br><span class="line">│       └── main.rs</span><br><span class="line">├── axruntime</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       └── trap.rs</span><br><span class="line">├── axstd</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── io.rs</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── thread.rs</span><br><span class="line">│       └── time.rs</span><br><span class="line">├── axsync</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── bootcell.rs</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axtask</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── run_queue.rs</span><br><span class="line">│       ├── task.rs</span><br><span class="line">│       └── wait_queue.rs</span><br><span class="line">├── bitmap_allocator</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── buddy_allocator</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── linked_list</span><br><span class="line">│       │   └── tests.rs</span><br><span class="line">│       └── linked_list.rs</span><br><span class="line">├── handler_table</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── kernel_guard</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── page_table</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">└── spinlock</span><br><span class="line">    └── src</span><br><span class="line">        ├── lib.rs</span><br><span class="line">        ├── noirq.rs</span><br><span class="line">        └── raw.rs</span><br></pre></td></tr></table></figure>

<h4 id="一、异常处理"><a href="#一、异常处理" class="headerlink" title="一、异常处理"></a>一、异常处理</h4><p>按照 RiscV 规范，异常和中断被触发时，当前的执行流程被打断，跳转到异常向量表中相应的例程进行处理。其中，stvec 寄存器指向的是向量表的基地址，scause 寄存器记录的异常编号则作为例程入口的偏移，二者相加得到异常处理例程的最终地址。</p>
<p>我们将准备一个符合规范的异常向量表，在异常中断处理前后分别需要保存和恢复原始的上下文，我们称之为异常上下文.与常见的宏内核陷阱处理不同，这段代码没有将栈指针切换到专用的监督者栈，而是继续使用原始栈保存上下文，这是因为arceos的宏内核设计，没有进行用户态和内核态的区分</p>
<p>trap处理流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    CPU-&gt;&gt;Trap入口: 触发中断</span><br><span class="line">    Trap入口-&gt;&gt;Trap分发器: 保存上下文</span><br><span class="line">    Trap分发器-&gt;&gt;IRQ处理表: 查找处理函数</span><br><span class="line">    IRQ处理表-&gt;&gt;设备驱动: 调用注册的handler</span><br><span class="line">    设备驱动-&gt;&gt;Trap返回: 处理完成</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; axhal&#x2F;src&#x2F;riscv&#x2F;trap.S</span><br><span class="line">.section .text</span><br><span class="line"> .balign 4</span><br><span class="line"> .global trap_vector_base</span><br><span class="line"> trap_vector_base:</span><br><span class="line">     csrrw   sp, sscratch, sp            &#x2F;&#x2F; switch sscratch and sp</span><br><span class="line">     csrr    sp, sscratch                &#x2F;&#x2F; put supervisor sp back</span><br><span class="line">     SAVE_REGS</span><br><span class="line">     mv      a0, sp</span><br><span class="line">     call    riscv_trap_handler</span><br><span class="line">     RESTORE_REGS</span><br><span class="line">     sret</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置中断向量表</span></span><br><span class="line"><span class="comment">// axhal/src/riscv64.rs</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">"C"</span> <span class="function"><span class="keyword">fn</span> <span class="title">rust_entry</span></span>(_hartid: <span class="built_in">usize</span>, _dtb: <span class="built_in">usize</span>) &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">trap_vector_base</span></span>();</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">rust_main</span></span>(hartid: <span class="built_in">usize</span>, dtb: <span class="built_in">usize</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        trap::set_trap_vector_base(trap_vector_base <span class="keyword">as</span> <span class="built_in">usize</span>);</span><br><span class="line">        rust_main(_hartid, _dtb);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异常处理入口</span></span><br><span class="line"><span class="comment">// axhal/src/riscv/trap.rs</span></span><br><span class="line"><span class="meta">#[unsafe(no_mangle)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">riscv_trap_handler</span></span>(tf: &amp;<span class="keyword">mut</span> TrapFrame) &#123;</span><br><span class="line">    <span class="keyword">let</span> scause = scause::read();</span><br><span class="line">    <span class="keyword">match</span> scause.cause() &#123;</span><br><span class="line">        <span class="comment">// Use usize constants for Exception codes since we don't have the Exception enum</span></span><br><span class="line">        Trap::Exception(<span class="number">3</span>) =&gt; handle_breakpoint(&amp;<span class="keyword">mut</span> tf.sepc), <span class="comment">// 3 is the standard code for Breakpoint exception</span></span><br><span class="line">        Trap::Interrupt(_) =&gt; handle_irq_extern(scause.bits()),</span><br><span class="line">        _ =&gt; &#123;</span><br><span class="line">            <span class="built_in">panic!</span>(</span><br><span class="line">                <span class="string">"Unhandled trap &#123;:?&#125; @ &#123;:#x&#125;:\n&#123;:#x?&#125;"</span>,</span><br><span class="line">                scause.cause(),</span><br><span class="line">                tf.sepc,</span><br><span class="line">                tf</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">handle_breakpoint</span></span>(sepc: &amp;<span class="keyword">mut</span> <span class="built_in">usize</span>) &#123;</span><br><span class="line">    debug!(<span class="string">"Exception(Breakpoint) @ &#123;:#x&#125; "</span>, sepc);</span><br><span class="line">    *sepc += <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Trap handler interface.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// This trait is defined with the [`#[def_interface]`][1] attribute. Users</span></span><br><span class="line"><span class="comment">/// should implement it with [`#[impl_interface]`][2] in any other crate.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// [1]: crate_interface::def_interface</span></span><br><span class="line"><span class="comment">/// [2]: crate_interface::impl_interface</span></span><br><span class="line"><span class="meta">#[def_interface]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">TrapHandler</span></span> &#123;</span><br><span class="line">    <span class="comment">/// Handles interrupt requests for the given IRQ number.</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">handle_irq</span></span>(irq_num: <span class="built_in">usize</span>);</span><br><span class="line">    <span class="comment">// more e.g.: handle_page_fault();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Call the external IRQ handler.</span></span><br><span class="line"><span class="meta">#[allow(dead_code)]</span></span><br><span class="line"><span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="function"><span class="keyword">fn</span> <span class="title">handle_irq_extern</span></span>(irq_num: <span class="built_in">usize</span>) &#123;</span><br><span class="line">    call_interface!(TrapHandler::handle_irq, irq_num);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="二、启用自旋锁"><a href="#二、启用自旋锁" class="headerlink" title="二、启用自旋锁"></a>二、启用自旋锁</h4><p>在真正开启和处理中断之前，我们首先需要实现真正的自旋锁。</p>
<p>现在一旦启用中断，就会引起两种新的可能性：</p>
<ol>
<li>当正常执行程序时，会随时被外部的中断而打断运行，然后就会去执行响应中断的例程。中断是随机不可预测的，这样有可能会把原本处于临界区中的一组操作打断，破坏它们的原子性、事务性。</li>
<li>虽然已经支持多任务并发，但这种并发是协作式的，即只有一个任务主动让出执行权时，另一个任务才能执行。因此，调度时机是可以协调的，完全可以避免打破临界区。但是下一步我们将基于时钟中断支持抢占式的并发，即任务调度可能随时发生，或许当前任务正好处于临界区中。</li>
</ol>
<p>为了杜绝上述两种可能性，我们需要重构新的自旋锁。根据上面的分析，其实我们只要在锁期间，关闭中断即可。为了支持自旋锁的实现，我们引入新的组件kernel_guard分别应对以下情况：四种核心保护类型：</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">功能描述</th>
<th align="left">适用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong><code>NoOp</code></strong></td>
<td align="left">空操作保护</td>
<td align="left">无同步要求的代码路径</td>
</tr>
<tr>
<td align="left"><strong><code>IrqSave</code></strong></td>
<td align="left">中断禁用 + 状态保存</td>
<td align="left">单核中断敏感操作</td>
</tr>
<tr>
<td align="left"><strong><code>NoPreempt</code></strong></td>
<td align="left">抢占禁用</td>
<td align="left">防止任务切换的临界区</td>
</tr>
<tr>
<td align="left"><strong><code>NoPreemptIrqSave</code></strong></td>
<td align="left">中断禁用 + 抢占禁用（组合保护）</td>
<td align="left">多核/复杂同步场景</td>
</tr>
</tbody></table>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel_guard/src/lib.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[crate_interface::def_interface]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">KernelGuardIf</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">enable_preempt</span></span>();</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">disable_preempt</span></span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">BaseGuard</span></span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">State</span></span>: <span class="built_in">Clone</span> + <span class="built_in">Copy</span>;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">acquire</span></span>() -&gt; Self::State;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">release</span></span>(state: Self::State);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">NoOp</span></span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">IrqSave</span></span>(<span class="built_in">usize</span>);</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">NoPreempt</span></span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">NoPreemptIrqSave</span></span>(<span class="built_in">usize</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> BaseGuard <span class="keyword">for</span> NoOp &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">State</span></span> = ();</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">acquire</span></span>() -&gt; Self::State &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">release</span></span>(_state: Self::State) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> NoOp &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">Drop</span> <span class="keyword">for</span> NoOp &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">drop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> BaseGuard <span class="keyword">for</span> IrqSave &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">State</span></span> = <span class="built_in">usize</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">acquire</span></span>() -&gt; Self::State &#123;</span><br><span class="line">        arch::local_irq_save_and_disable()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">release</span></span>(state: Self::State) &#123;</span><br><span class="line">        arch::local_irq_restore(state);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> BaseGuard <span class="keyword">for</span> NoPreempt &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">State</span></span> = ();</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">acquire</span></span>() -&gt; Self::State &#123;</span><br><span class="line">        <span class="comment">//crate_interface::call_interface!(KernelGuardIf::disable_preempt);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">release</span></span>(_state: Self::State) &#123;</span><br><span class="line">        <span class="comment">//crate_interface::call_interface!(KernelGuardIf::enable_preempt);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> BaseGuard <span class="keyword">for</span> NoPreemptIrqSave &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">State</span></span> = <span class="built_in">usize</span>;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">acquire</span></span>() -&gt; Self::State &#123;</span><br><span class="line">        <span class="comment">//crate_interface::call_interface!(KernelGuardIf::disable_preempt);</span></span><br><span class="line">        arch::local_irq_save_and_disable()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">release</span></span>(state: Self::State) &#123;</span><br><span class="line">        arch::local_irq_restore(state);</span><br><span class="line">        <span class="comment">//crate_interface::call_interface!(KernelGuardIf::enable_preempt);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(target_arch = <span class="meta-string">"riscv64"</span>)]</span></span><br><span class="line"><span class="keyword">mod</span> arch &#123;</span><br><span class="line">    <span class="keyword">use</span> core::arch::asm;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Bit 1: Supervisor Interrupt Enable</span></span><br><span class="line">    <span class="keyword">const</span> SIE_BIT: <span class="built_in">usize</span> = <span class="number">1</span> &lt;&lt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">local_irq_save_and_disable</span></span>() -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> flags: <span class="built_in">usize</span>;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; asm!(<span class="string">"csrrc &#123;&#125;, sstatus, &#123;&#125;"</span>, out(reg) flags, <span class="keyword">const</span> SIE_BIT) &#125;;</span><br><span class="line">        flags &amp; SIE_BIT</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">local_irq_restore</span></span>(flags: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; asm!(<span class="string">"csrrs x0, sstatus, &#123;&#125;"</span>, <span class="keyword">in</span>(reg) flags) &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(not(target_arch = <span class="meta-string">"riscv64"</span>))]</span></span><br><span class="line"><span class="keyword">mod</span> arch &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">local_irq_save_and_disable</span></span>() -&gt; <span class="built_in">usize</span> &#123;</span><br><span class="line">        <span class="built_in">unimplemented!</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">local_irq_restore</span></span>(_flags: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="built_in">unimplemented!</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>借助kernel_guard实现自旋锁,lock()后返回guard，通过guard访问data：</p>
<ul>
<li><strong>生命周期绑定</strong>：将锁的有效期与守卫对象的生命周期绑定</li>
<li><strong>安全访问代理</strong>：通过 <code>Deref/DerefMut</code> 提供对受保护数据的透明访问</li>
<li><strong>资源自动释放</strong>：在 <code>Drop</code> 时恢复中断和抢占状态</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; SpinNoIrq&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline(always)]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">lock</span></span>(&amp;<span class="keyword">self</span>) -&gt; SpinNoIrqGuard&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> irq_state = NoPreemptIrqSave::acquire();</span><br><span class="line">        SpinNoIrqGuard &#123;</span><br><span class="line">            irq_state,</span><br><span class="line">            data: <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> *<span class="keyword">self</span>.data.get() &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> SpinNoIrqGuard&lt;T&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Target</span></span> = T;</span><br><span class="line">    <span class="meta">#[inline(always)]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">deref</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;T &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;*<span class="keyword">self</span>.data &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; DerefMut <span class="keyword">for</span> SpinNoIrqGuard&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline(always)]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">deref_mut</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; &amp;<span class="keyword">mut</span> T &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> *<span class="keyword">self</span>.data &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> SpinNoIrqGuard&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">#[inline(always)]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">drop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        NoPreemptIrqSave::release(<span class="keyword">self</span>.irq_state);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="三、启用时钟中断"><a href="#三、启用时钟中断" class="headerlink" title="三、启用时钟中断"></a>三、启用时钟中断</h4><p>我们首先启用最简单的时钟中断，在axruntime调用<code>init_interrupt</code>前首先为启用中断做准备，进行平台初始化（将timer设为0，启用中断后马上发生首次时钟中断），然后调用<code>init_interrupt</code>具体是需要提供一个能够处理中断的函数给<code>register_handler</code>,<code>handler</code>将全局<code>TIMER_HANDLER</code>初始化为该函数。中断发生后，trap_handler调用借助crate_interface实现的函数（这里没有理解为什么使用crate_interface,没有发现循环依赖，直接调用函数也可以实现），这个函数调用dispatch_irq，然后再调用<code>init_interrupt</code>提供的函数，并设置下次时钟中断的时间</p>
<p><span id="1"></span></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 中断逻辑调用链:  platform_init(timer = 0) </span></span><br><span class="line"><span class="comment">//            -&gt; init_interrupt </span></span><br><span class="line"><span class="comment">//            -&gt; register_handler </span></span><br><span class="line"><span class="comment">//            -&gt; enable_irqs -&gt; [interrupt]</span></span><br><span class="line"><span class="comment">//            -&gt; riscv_trap_handler</span></span><br><span class="line"><span class="comment">//            -&gt; handle_irq_extern -&gt; dispatch_irq</span></span><br><span class="line"><span class="comment">//            -&gt; update_timer(timer = deadline)</span></span><br><span class="line"><span class="comment">// axruntime/src/lib.rs</span></span><br><span class="line"><span class="meta">#[cfg(all(target_os = <span class="meta-string">"none"</span>, not(test)))]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">init_interrupt</span></span>() &#123;</span><br><span class="line">    <span class="keyword">use</span> axhal::irq::TIMER_IRQ_NUM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup timer interrupt handler</span></span><br><span class="line">    <span class="keyword">const</span> PERIODIC_INTERVAL_NANOS: <span class="built_in">u64</span> =</span><br><span class="line">        axhal::time::NANOS_PER_SEC / axconfig::TICKS_PER_SEC <span class="keyword">as</span> <span class="built_in">u64</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">mut</span> NEXT_DEADLINE: <span class="built_in">u64</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">update_timer</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> now_ns = axhal::time::current_time_nanos();</span><br><span class="line">        <span class="comment">// Safety: we have disabled preemption in IRQ handler.</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> deadline = <span class="keyword">unsafe</span> &#123; NEXT_DEADLINE &#125;;</span><br><span class="line">        <span class="keyword">if</span> now_ns &gt;= deadline &#123;</span><br><span class="line">            deadline = now_ns + PERIODIC_INTERVAL_NANOS;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; NEXT_DEADLINE = deadline + PERIODIC_INTERVAL_NANOS &#125;;</span><br><span class="line">        trace!(<span class="string">"now &#123;&#125; deadline &#123;&#125;"</span>, now_ns, deadline);</span><br><span class="line">        axhal::time::set_oneshot_timer(deadline);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    axhal::irq::register_handler(TIMER_IRQ_NUM, || &#123;</span><br><span class="line">        update_timer();</span><br><span class="line">        debug!(<span class="string">"On timer tick!"</span>);</span><br><span class="line">        <span class="comment">//#[cfg(feature = "multitask")]</span></span><br><span class="line">        <span class="comment">//axtask::on_timer_tick();</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable IRQs before starting app</span></span><br><span class="line">    axhal::irq::enable_irqs();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// axhal/src/riscv/irq.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">register_handler</span></span>(scause: <span class="built_in">usize</span>, handler: IrqHandler) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> scause &#123;</span><br><span class="line">        S_TIMER =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> !TIMER_HANDLER.is_init() &#123;</span><br><span class="line">                TIMER_HANDLER.init(handler);</span><br><span class="line">                <span class="literal">true</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        S_EXT =&gt; crate::irq::register_handler_common(scause &amp; !INTC_IRQ_BASE, handler),</span><br><span class="line">        _ =&gt; <span class="built_in">panic!</span>(<span class="string">"invalid trap cause: &#123;:#x&#125;"</span>, scause),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// axhal/src/riscv/trap.rs</span></span><br><span class="line"><span class="meta">#[unsafe(no_mangle)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">riscv_trap_handler</span></span>(tf: &amp;<span class="keyword">mut</span> TrapFrame) &#123;</span><br><span class="line">    <span class="keyword">let</span> scause = scause::read();</span><br><span class="line">    <span class="keyword">match</span> scause.cause() &#123;</span><br><span class="line">        <span class="comment">// Use usize constants for Exception codes since we don't have the Exception enum</span></span><br><span class="line">        Trap::Exception(<span class="number">3</span>) =&gt; handle_breakpoint(&amp;<span class="keyword">mut</span> tf.sepc), <span class="comment">// 3 is the standard code for Breakpoint exception</span></span><br><span class="line">        Trap::Interrupt(_) =&gt; handle_irq_extern(scause.bits()),</span><br><span class="line">        _ =&gt; &#123;</span><br><span class="line">            <span class="built_in">panic!</span>(</span><br><span class="line">                <span class="string">"Unhandled trap &#123;:?&#125; @ &#123;:#x&#125;:\n&#123;:#x?&#125;"</span>,</span><br><span class="line">                scause.cause(),</span><br><span class="line">                tf.sepc,</span><br><span class="line">                tf</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[def_interface]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">TrapHandler</span></span> &#123;</span><br><span class="line">    <span class="comment">/// Handles interrupt requests for the given IRQ number.</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">handle_irq</span></span>(irq_num: <span class="built_in">usize</span>);</span><br><span class="line">    <span class="comment">// more e.g.: handle_page_fault();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Call the external IRQ handler.</span></span><br><span class="line"><span class="meta">#[allow(dead_code)]</span></span><br><span class="line"><span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="function"><span class="keyword">fn</span> <span class="title">handle_irq_extern</span></span>(irq_num: <span class="built_in">usize</span>) &#123;</span><br><span class="line">    call_interface!(TrapHandler::handle_irq, irq_num);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// super::irq::dispatch_irq(irq_num);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// axruntime/src/trap.rs</span></span><br><span class="line"><span class="meta">#[cfg(all(target_os = <span class="meta-string">"none"</span>, not(test)))]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TrapHandlerImpl</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(all(target_os = <span class="meta-string">"none"</span>, not(test)))]</span></span><br><span class="line"><span class="meta">#[crate_interface::impl_interface]</span></span><br><span class="line"><span class="keyword">impl</span> axhal::trap::TrapHandler <span class="keyword">for</span> TrapHandlerImpl &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">handle_irq</span></span>(irq_num: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        axhal::irq::dispatch_irq(irq_num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// axhal/src/riscv/irq.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">dispatch_irq</span></span>(scause: <span class="built_in">usize</span>) &#123;</span><br><span class="line">    <span class="keyword">match</span> scause &#123;</span><br><span class="line">        S_TIMER =&gt; &#123;</span><br><span class="line">            log::trace!(<span class="string">"IRQ: timer"</span>);</span><br><span class="line">            TIMER_HANDLER.get()();</span><br><span class="line">        &#125;</span><br><span class="line">        S_EXT =&gt; &#123;</span><br><span class="line">            crate::irq::dispatch_irq_common(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        _ =&gt; <span class="built_in">panic!</span>(<span class="string">"invalid trap cause: &#123;:#x&#125;"</span>, scause),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Ch7-抢占式调度"><a href="#Ch7-抢占式调度" class="headerlink" title="Ch7 抢占式调度"></a>Ch7 抢占式调度</h3><p>Target: 支持抢占调度和mutex锁</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Code Framework</span></span><br><span class="line">.</span><br><span class="line">├── axalloc</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── bitmap.rs</span><br><span class="line">│       ├── buddy.rs</span><br><span class="line">│       ├── early</span><br><span class="line">│       │   └── tests.rs</span><br><span class="line">│       ├── early.rs</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axconfig</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axdtb</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       └── util.rs</span><br><span class="line">├── axhal</span><br><span class="line">│   ├── linker.lds</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── riscv64</span><br><span class="line">│       │   ├── boot.rs</span><br><span class="line">│       │   ├── console.rs</span><br><span class="line">│       │   ├── context.rs</span><br><span class="line">│       │   ├── cpu.rs</span><br><span class="line">│       │   ├── irq.rs</span><br><span class="line">│       │   ├── lang_items.rs</span><br><span class="line">│       │   ├── mem.rs</span><br><span class="line">│       │   ├── misc.rs</span><br><span class="line">│       │   ├── paging.rs</span><br><span class="line">│       │   ├── time.rs</span><br><span class="line">│       │   ├── trap.rs</span><br><span class="line">│       │   └── trap.S</span><br><span class="line">│       └── riscv64.rs</span><br><span class="line">├── axlog</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axorigin</span><br><span class="line">│   └── src</span><br><span class="line">│       └── main.rs</span><br><span class="line">├── axruntime</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       └── trap.rs</span><br><span class="line">├── axstd</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── io.rs</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── sync</span><br><span class="line">│       │   ├── mod.rs</span><br><span class="line">│       │   └── mutex.rs</span><br><span class="line">│       ├── thread.rs</span><br><span class="line">│       └── time.rs</span><br><span class="line">├── axsync</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── bootcell.rs</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── axtask</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── run_queue.rs</span><br><span class="line">│       ├── task.rs</span><br><span class="line">│       └── wait_queue.rs</span><br><span class="line">├── bitmap_allocator</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── buddy_allocator</span><br><span class="line">│   └── src</span><br><span class="line">│       ├── lib.rs</span><br><span class="line">│       ├── linked_list</span><br><span class="line">│       │   └── tests.rs</span><br><span class="line">│       └── linked_list.rs</span><br><span class="line">├── handler_table</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── kernel_guard</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">├── page_table</span><br><span class="line">│   └── src</span><br><span class="line">│       └── lib.rs</span><br><span class="line">└── spinlock</span><br><span class="line">    └── src</span><br><span class="line">        ├── lib.rs</span><br><span class="line">        ├── noirq.rs</span><br><span class="line">        └── raw.rs</span><br></pre></td></tr></table></figure>

<h4 id="一、抢占式调度"><a href="#一、抢占式调度" class="headerlink" title="一、抢占式调度"></a>一、抢占式调度</h4><p>ArceOS 中，任务抢占采取的具体策略包括内部条件和外部条件，二者同时具备时，才能触发抢占。内部条件指的是，在任务内部维护的某种状态达到条件，例如本次运行的时间片配额耗尽；外部条件指的是，内核可以在某些阶段，暂时关闭抢占，比如，下步我们的自旋锁就需要在加锁期间关闭抢占，以保证锁范围的原子性。由此可见，这个抢占是兼顾了任务自身状况的，一个正在运行的任务即使是低优先级，在达到内部条件之前，也不会被其它任务抢占。抢占是边沿触发。在内部条件符合的前提下，外部状态从禁止抢占到启用抢占的那个变迁点，会触发一次抢占式重调度 resched。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内部条件：</span></span><br><span class="line"><span class="comment">// 修改时钟中断的闭包函数，减少task的时间片配额</span></span><br><span class="line"><span class="comment">// axruntime/src/lib.rs</span></span><br><span class="line">axhal::irq::register_handler(TIMER_IRQ_NUM, || &#123;</span><br><span class="line">    update_timer();</span><br><span class="line">    debug!(<span class="string">"On timer tick!"</span>);</span><br><span class="line">    <span class="comment">//#[cfg(feature = "multitask")]</span></span><br><span class="line">    axtask::on_timer_tick();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// axtask/src/run_queue.rs</span></span><br><span class="line"><span class="keyword">impl</span> AxRunQueue &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">scheduler_timer_tick</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> curr = current();</span><br><span class="line">        <span class="keyword">if</span> !curr.is_idle() &amp;&amp; curr.task_tick() &#123;</span><br><span class="line">            curr.set_preempt_pending(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// axtask/src/task.rs</span></span><br><span class="line"><span class="keyword">impl</span> task &#123;</span><br><span class="line">	<span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">task_tick</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> old_slice = <span class="keyword">self</span>.time_slice.fetch_sub(<span class="number">1</span>, Ordering::Release);</span><br><span class="line">        old_slice &lt;= <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 外部条件：</span></span><br><span class="line"><span class="comment">// 内核控制外部条件，调用锁叠加task的preempt_disable_count字段禁用抢占</span></span><br><span class="line"><span class="comment">// kernel_guard/src/lib.rs</span></span><br><span class="line"><span class="keyword">impl</span> BaseGuard <span class="keyword">for</span> NoPreempt &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">State</span></span> = ();</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">acquire</span></span>() -&gt; Self::State &#123;</span><br><span class="line">        crate_interface::call_interface!(KernelGuardIf::disable_preempt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">release</span></span>(_state: Self::State) &#123;</span><br><span class="line">        crate_interface::call_interface!(KernelGuardIf::enable_preempt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> BaseGuard <span class="keyword">for</span> NoPreemptIrqSave &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">State</span></span> = <span class="built_in">usize</span>;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">acquire</span></span>() -&gt; Self::State &#123;</span><br><span class="line">        crate_interface::call_interface!(KernelGuardIf::disable_preempt);</span><br><span class="line">        arch::local_irq_save_and_disable()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">release</span></span>(state: Self::State) &#123;</span><br><span class="line">        arch::local_irq_restore(state);</span><br><span class="line">        crate_interface::call_interface!(KernelGuardIf::enable_preempt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> task &#123;</span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="function"><span class="keyword">fn</span> <span class="title">disable_preempt</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.preempt_disable_count.fetch_add(<span class="number">1</span>, Ordering::Relaxed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="function"><span class="keyword">fn</span> <span class="title">enable_preempt</span></span>(&amp;<span class="keyword">self</span>, resched: <span class="built_in">bool</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.preempt_disable_count.fetch_sub(<span class="number">1</span>, Ordering::Relaxed) == <span class="number">1</span> &amp;&amp; resched &#123;</span><br><span class="line">            <span class="comment">// If current task is pending to be preempted, do rescheduling.</span></span><br><span class="line">            Self::current_check_preempt_pending();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">current_check_preempt_pending</span></span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> curr = current();</span><br><span class="line">        <span class="keyword">if</span> curr.need_resched.load(Ordering::Acquire) &amp;&amp; curr.can_preempt(<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> rq = RUN_QUEUE.lock();</span><br><span class="line">            <span class="keyword">if</span> curr.need_resched.load(Ordering::Acquire) &#123;</span><br><span class="line">                rq.preempt_resched();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="二、Mutex锁"><a href="#二、Mutex锁" class="headerlink" title="二、Mutex锁"></a>二、Mutex锁</h4><p>我们在这里实现Mutex锁为app提供同步原语支持线程共享资源，Mutex锁的实现借助wait_queue,在锁被占用的时候将task置入wait_queue直到锁的持有者来唤醒</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axstd/src/sync/mutex.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Mutex</span></span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    wq: AxWaitQueueHandle,</span><br><span class="line">    owner_id: AtomicU64,</span><br><span class="line">    data: UnsafeCell&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T: ?<span class="built_in">Sized</span>&gt; Mutex&lt;T&gt; &#123;</span><br><span class="line">	<span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">lock</span></span>(&amp;<span class="keyword">self</span>) -&gt; MutexGuard&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> current_id = super::ax_current_task_id();</span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="comment">// Can fail to lock even if the spinlock is not locked. May be more efficient than `try_lock`</span></span><br><span class="line">            <span class="comment">// when called in a loop.</span></span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.owner_id.compare_exchange_weak(</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                current_id,</span><br><span class="line">                Ordering::Acquire,</span><br><span class="line">                Ordering::Relaxed,</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(_) =&gt; <span class="keyword">break</span>,</span><br><span class="line">                <span class="literal">Err</span>(owner_id) =&gt; &#123;</span><br><span class="line">                    <span class="built_in">assert_ne!</span>(</span><br><span class="line">                        owner_id, current_id,</span><br><span class="line">                        <span class="string">"Thread(&#123;&#125;) tried to acquire mutex it already owns."</span>,</span><br><span class="line">                        current_id,</span><br><span class="line">                    );</span><br><span class="line">                    <span class="comment">// Wait until the lock looks unlocked before retrying</span></span><br><span class="line">                    super::ax_wait_queue_wait(&amp;<span class="keyword">self</span>.wq, || !<span class="keyword">self</span>.is_locked(), <span class="literal">None</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        MutexGuard &#123;</span><br><span class="line">            lock: <span class="keyword">self</span>,</span><br><span class="line">            data: <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> *<span class="keyword">self</span>.data.get() &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="function"><span class="keyword">fn</span> <span class="title">force_unlock</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> owner_id = <span class="keyword">self</span>.owner_id.swap(<span class="number">0</span>, Ordering::Release);</span><br><span class="line">        <span class="keyword">let</span> current_id = super::ax_current_task_id();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(</span><br><span class="line">            owner_id, current_id,</span><br><span class="line">            <span class="string">"Thread(&#123;&#125;) tried to release mutex it doesn't own"</span>,</span><br><span class="line">            current_id,</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// wake up one waiting thread.</span></span><br><span class="line">        super::ax_wait_queue_wake(&amp;<span class="keyword">self</span>.wq, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Main-Record"><a href="#Main-Record" class="headerlink" title="Main Record"></a>Main Record</h2><p>主线arceos与tutorial思想相同，但是模块的代码有较大差别，主线arceos借助rust的包管理机制将一些模块支持组件加入到dependence中，可以像学习tutorial一样追踪arceos的启动过程，从runtime的各个初始化操作中追踪各个模块的初始化与具体功能，再过渡到各个模块间的协同配合与api封装为ulib和app提供支持。学习arceos很重要的是建立整体框架，让ai生成框架图可以更好的理解模块内部工作机制和模块间的协调合作；在理解module的框架后，复用arceos提供的api来进行更灵活快速的开发而不需要拘泥与每个模块提供的底层api细节</p>
<p>PS：abstract graph全部由ai生成，给出对应module的设计理念和运行逻辑提示词并让cursor理解代码框架，可以生成逻辑清晰的框架图</p>
<h3 id="axconfig"><a href="#axconfig" class="headerlink" title="axconfig"></a>axconfig</h3><p>通过组件axconfig-gen解析<code>.axconfig.toml</code>生成默认config参数</p>
<h3 id="axruntime"><a href="#axruntime" class="headerlink" title="axruntime"></a>axruntime</h3><h4 id="abstract-graph"><a href="#abstract-graph" class="headerlink" title="abstract graph"></a>abstract graph</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[主入口 rust_main] --&gt; B[打印启动LOGO]</span><br><span class="line">    B --&gt; C[初始化日志系统]</span><br><span class="line">    C --&gt; E[内存管理初始化]</span><br><span class="line">    E --&gt; F&#123;是否启用驱动?&#125;</span><br><span class="line">    F --&gt;|fs&#x2F;net&#x2F;display| G[初始化驱动子系统]</span><br><span class="line">    G --&gt; H[初始化文件系统]</span><br><span class="line">    G --&gt; I[初始化网络协议栈]</span><br><span class="line">    G --&gt; J[初始化显示系统]</span><br><span class="line">    F --&gt;|无驱动需求| K[跳过驱动初始化]</span><br><span class="line">    H &amp; I &amp; J &amp; K --&gt; L[多核启动管理]</span><br><span class="line">    L --&gt; M[启动从核]</span><br><span class="line">    M --&gt; N[等待从核就绪]</span><br><span class="line">    N --&gt; O[中断控制器配置]</span><br><span class="line">    O --&gt; P[调用全局构造器]</span><br><span class="line">    P --&gt; Q[进入应用main函数]</span><br><span class="line">    </span><br><span class="line">    subgraph 多核管理</span><br><span class="line">        L --&gt; R[主核流程]</span><br><span class="line">        M --&gt; S[从核入口 rust_main_secondary]</span><br><span class="line">        S --&gt; T[从核内存初始化]</span><br><span class="line">        T --&gt; U[从核设备初始化]</span><br><span class="line">        U --&gt; V[从核调度器]</span><br><span class="line">        V --&gt; W[等待主核同步]</span><br><span class="line">        W --&gt; X[进入空闲任务]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    style A fill:#cff,stroke:#333</span><br><span class="line">    style G fill:#cdf,stroke:#369</span><br><span class="line">    style L fill:#ff9,stroke:#f90</span><br><span class="line">    style S fill:#9f9,stroke:#090</span><br></pre></td></tr></table></figure>



<p>运行时管理。在内核完成基本的 boot 之后，会将执行流交给运行 时层，初始化内核的各种功能模块，如驱动注册、任务调度队列初始化等，从而构造一个完整的内核运行时。</p>
<ul>
<li><p><code>axlog::init()</code>初始化日志</p>
</li>
<li><p><code>init_allocator</code>遍历<code>memory_regions</code>初始化<code>global_allocator</code>(<code>global_init</code>)</p>
</li>
<li><p><code>init_memory_management</code>初始化内核虚拟地址空间管理与细粒度内核页表</p>
</li>
<li><p><code>platform_init</code>arch相关，指定 CPU 可以响应哪些类型的中断</p>
</li>
<li><p><code>init_scheduler</code>初始化任务调度(初始化run_queue和timer)</p>
</li>
<li><p><code>init_drivers</code>检测并初始化所有设备驱动</p>
</li>
<li><p><code>init_filesystems</code>基于<code>init_drivers</code>发现的块设备初始化文件系统</p>
</li>
<li><p><code>init_interrupt</code>初始化中断，关于中断: <a href="#1">中断处理调用链</a></p>
</li>
<li><p><code>init_tls</code>在非多任务情况下(unikernel)引入线程局部存储,tls机制允许每个线程拥有自己独立的数据副本</p>
</li>
</ul>
<h3 id="axhal"><a href="#axhal" class="headerlink" title="axhal"></a>axhal</h3><p>硬件抽象层，提供了对硬件平台的抽象和适配，负责 boot 内核、时钟、 异常等硬件平台的细节处理，并为上层提供统一的硬件功能接口。</p>
<h4 id="abstract-graph-1"><a href="#abstract-graph-1" class="headerlink" title="abstract graph"></a>abstract graph</h4><p>硬件抽象层 分层架构图</p>
<p>总架构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">%% 总架构图</span><br><span class="line">graph TD</span><br><span class="line">    A[axhal硬件抽象层] --&gt; B[平台抽象层 Platform]</span><br><span class="line">    A --&gt; C[架构实现层 Arch]</span><br><span class="line">    A --&gt; D[核心HAL层 Core HAL]</span><br><span class="line">    </span><br><span class="line">    B --&gt; E[Boot]</span><br><span class="line">    B --&gt; F[Console]</span><br><span class="line">    B --&gt; G[IRQ]</span><br><span class="line">    B --&gt; H[Memory]</span><br><span class="line">    B --&gt; I[Time]</span><br><span class="line">    </span><br><span class="line">    C --&gt; J[aarch64]</span><br><span class="line">    C --&gt; K[x86_64]</span><br><span class="line">    C --&gt; L[riscv]</span><br><span class="line">    C --&gt; M[loongarch64]</span><br><span class="line">    </span><br><span class="line">    D --&gt; N[Trap处理]</span><br><span class="line">    D --&gt; O[上下文管理]</span><br><span class="line">    D --&gt; P[页表管理]</span><br><span class="line">    D --&gt; Q[物理内存]</span><br><span class="line">    D --&gt; R[时钟管理]</span><br><span class="line">    D --&gt; S[中断控制]</span><br><span class="line"></span><br><span class="line">    style A fill:#e6f3ff,stroke:#004c99</span><br><span class="line">    style B fill:#ffe6e6,stroke:#990000</span><br><span class="line">    style C fill:#e6ffe6,stroke:#009900</span><br><span class="line">    style D fill:#fff2cc,stroke:#d6b656</span><br></pre></td></tr></table></figure>

<p>核心hal：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">%% 核心HAL层分图</span><br><span class="line">graph TD</span><br><span class="line">    </span><br><span class="line">        D1[Trap处理] --&gt; D11[异常分发]</span><br><span class="line">        D1 --&gt; D12[IRQ处理表]</span><br><span class="line">        D1 --&gt; D13[系统调用路由]</span><br><span class="line">        </span><br><span class="line">        D2[上下文管理] --&gt; D21[任务上下文]</span><br><span class="line">        D2 --&gt; D22[用户空间上下文]</span><br><span class="line">        D2 --&gt; D23[FPU状态保存]</span><br><span class="line">        </span><br><span class="line">        D3[页表管理] --&gt; D31[页表根设置]</span><br><span class="line">        D3 --&gt; D32[TLB刷新]</span><br><span class="line">        D3 --&gt; D33[地址转换]</span><br><span class="line">        </span><br><span class="line">        D4[物理内存] --&gt; D41[内存区域迭代器]</span><br><span class="line">        D4 --&gt; D42[物理&#x2F;虚拟转换]</span><br><span class="line">        </span><br><span class="line">        D5[时钟管理] --&gt; D51[当前时钟ticks]</span><br><span class="line">        D5 --&gt; D52[定时器设置]</span><br><span class="line">        D5 --&gt; D53[忙等待实现]</span><br><span class="line">        </span><br><span class="line">        D6[中断控制] --&gt; D61[中断使能]</span><br><span class="line">        D6 --&gt; D62[处理函数注册]</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    D11 --&gt;|调用| D12</span><br><span class="line">    D31 --&gt;|影响| D32</span><br><span class="line">    D51 --&gt;|转换| D52</span><br></pre></td></tr></table></figure>

<h4 id="Framework"><a href="#Framework" class="headerlink" title="Framework"></a>Framework</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">axhal</span><br><span class="line">├── arch           				# -&gt; 体系结构相关</span><br><span class="line">├── cpu.rs						#</span><br><span class="line">├── irq.rs						#</span><br><span class="line">├── lib.rs						#</span><br><span class="line">├── mem.rs						#</span><br><span class="line">├── paging.rs					#</span><br><span class="line">├── platform					# -&gt; 平台相关</span><br><span class="line">├── time.rs						#</span><br><span class="line">├── tls.rs						#</span><br><span class="line">└── trap.rs						#</span><br></pre></td></tr></table></figure>

<p>Platform：</p>
<ul>
<li><code>boot.rs</code>entry point of the kernel,初始化启动栈和启动页表</li>
<li><code>consolo.rs</code>借助sbi提供的功能实现控制台输入输出</li>
<li><code>irq.rs</code>注册中断处理函数接口，设置platform and arch相关中断号</li>
<li><code>mem.rs</code>提供<code>platform_regions</code>，被chain调用并调用chain，得到memory_regions</li>
</ul>
<p>Hal:</p>
<ul>
<li><code>trap.rs</code>体系结构相关的trap处理函数，handler由中断向量表设置</li>
<li><code>context.rs</code>上下文相关操作，用于调度</li>
<li><code>macros.rs</code>定义汇编辅助宏，简化汇编代码的编写</li>
</ul>
<p>Non-hal and non-platform:</p>
<ul>
<li><code>trap.rs</code>借助linkme使用def_trap_handler向全局数组定义trap处理函数，包括<code>IRQ/PAGE_FAULT/SYSCALL</code>,用户可以通过<code>register_trap_handler</code>注册对应的处理函数</li>
<li><code>irq.rs</code>根据中断号设置中断处理表并接受中断号调用处理</li>
<li><code>paging.rs</code>设置根页表，提供物理内存操作</li>
<li><code>mem.rs</code>定义<code>memory_regions</code>，提供地址转换api</li>
<li><code>time.rs</code>提供了系统时钟和计时相关的功能，实现忙等待机制</li>
</ul>
<p>系统调用流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant User</span><br><span class="line">    participant Kernel</span><br><span class="line">    participant axhal</span><br><span class="line">    </span><br><span class="line">    User-&gt;&gt;Kernel: 系统调用指令</span><br><span class="line">    Kernel-&gt;&gt;axhal: 保存用户上下文</span><br><span class="line">    axhal-&gt;&gt;axhal: 权限级别切换</span><br><span class="line">    axhal-&gt;&gt;Kernel: 创建TrapFrame</span><br><span class="line">    Kernel-&gt;&gt;处理程序: 分发系统调用</span><br><span class="line">    处理程序--&gt;&gt;Kernel: 返回结果</span><br><span class="line">    Kernel-&gt;&gt;axhal: 恢复上下文</span><br><span class="line">    axhal-&gt;&gt;User: 返回用户空间</span><br></pre></td></tr></table></figure>



<h4 id="support-crates"><a href="#support-crates" class="headerlink" title="support crates"></a>support crates</h4><ul>
<li>linkme</li>
<li>handler_table</li>
<li>pagetable_multiarch</li>
</ul>
<h3 id="axns"><a href="#axns" class="headerlink" title="axns"></a>axns</h3><p>Namespace 机制实现，控制资源的隔离和共享</p>
<h4 id="abstract-graph-2"><a href="#abstract-graph-2" class="headerlink" title="abstract graph"></a>abstract graph</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[AxNamespace] --&gt; B[全局命名空间]</span><br><span class="line">    A --&gt; C[线程本地命名空间]</span><br><span class="line">    </span><br><span class="line">    B --&gt; D[[axns_resource内存段]]</span><br><span class="line">    B --&gt; E(&quot;alloc: false&quot;)</span><br><span class="line">    B --&gt; F(&quot;AxNamespace::global()&quot;)</span><br><span class="line">    </span><br><span class="line">    C --&gt; G[动态分配内存]</span><br><span class="line">    C --&gt; H(&quot;alloc: true&quot;)</span><br><span class="line">    C --&gt; I(&quot;new_thread_local()&quot;)</span><br><span class="line">    C --&gt; J[&quot;copy_nonoverlapping(全局资源)&quot;]</span><br><span class="line">    </span><br><span class="line">    K[ResArc&lt;T&gt;] --&gt; L[Arc&lt;T&gt;包装]</span><br><span class="line">    K --&gt; M[&quot;init_new()&#x2F;init_shared()&quot;]</span><br><span class="line">    </span><br><span class="line">    N[def_resource!宏] --&gt; O[&quot;static资源定义&quot;]</span><br><span class="line">    O --&gt; D</span><br><span class="line">    </span><br><span class="line">    P[线程1] --&gt;|访问| C</span><br><span class="line">    P --&gt;|修改| Q[独立资源副本]</span><br><span class="line">    R[线程2] --&gt;|访问| B</span><br><span class="line">    R --&gt;|修改| S[全局共享资源]</span><br><span class="line">    </span><br><span class="line">    style B fill:#e6f3ff,stroke:#004c99</span><br><span class="line">    style C fill:#e6ffe6,stroke:#009900</span><br><span class="line">    style K fill:#ffe6e6,stroke:#990000</span><br><span class="line">    style N fill:#fff2cc,stroke:#d6b656</span><br><span class="line"></span><br><span class="line">    subgraph 核心数据结构</span><br><span class="line">        A</span><br><span class="line">        K</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph 资源存储</span><br><span class="line">        D</span><br><span class="line">        G</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph 线程隔离</span><br><span class="line">        P</span><br><span class="line">        R</span><br><span class="line">        Q</span><br><span class="line">        S</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<h4 id="Data-Structure"><a href="#Data-Structure" class="headerlink" title="Data Structure"></a>Data Structure</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Defines a resource that managed by [`AxNamespace`].</span></span><br><span class="line"><span class="comment">/// Each resource will be collected into the `axns_resource` section. When  accessed, it /// is either dereferenced from the global namespace or the thread-local namespace </span></span><br><span class="line"><span class="comment">/// according to the `thread-local` feature.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">AxNamespace</span></span> &#123;</span><br><span class="line">    base: <span class="built_in">usize</span>,</span><br><span class="line">    alloc: <span class="built_in">bool</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>全局命名空间:</p>
<ul>
<li><p>整个系统只有一个，所有线程共享</p>
</li>
<li><p>直接使用axns_resource内存段中的静态资源</p>
</li>
<li><p>通过AxNamespace::global()创建</p>
</li>
<li><p>不需要额外内存分配(alloc: false)</p>
</li>
<li><p>一个线程修改资源会影响所有线程</p>
</li>
</ul>
</li>
<li><p>线程本地命名空间:</p>
<ul>
<li><p>每个线程拥有独立的命名空间实例</p>
</li>
<li><p>只在启用thread-local特性时可用</p>
</li>
<li><p>通过new_thread_local()方法创建</p>
</li>
<li><p>需要动态分配与全局命名空间相同大小的内存</p>
</li>
<li><p>初始值从全局命名空间复制而来(copy_nonoverlapping)</p>
</li>
<li><p>标记为alloc: true，在销毁时会释放内存</p>
</li>
<li><p>线程对资源的修改不会影响其他线程</p>
</li>
</ul>
</li>
</ul>
<h3 id="axalloc"><a href="#axalloc" class="headerlink" title="axalloc"></a>axalloc</h3><p>实例化内存分配器，负责物理页的分配和回收，支持 Buddy 分配算 法、Slab 分配算法等</p>
<h4 id="abstract-graph-3"><a href="#abstract-graph-3" class="headerlink" title="abstract graph"></a>abstract graph</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[GlobalAllocator] --&gt;|包含| B[&quot;SpinNoIrq&lt;DefaultByteAllocator&gt; (字节分配器)&quot;]</span><br><span class="line">    A --&gt;|包含| C[&quot;SpinNoIrq&lt;BitmapPageAllocator&gt; (页分配器)&quot;]</span><br><span class="line">    </span><br><span class="line">    B --&gt; D&#123;feature选择&#125;</span><br><span class="line">    D --&gt;|slab| E[SlabByteAllocator]</span><br><span class="line">    D --&gt;|buddy| F[BuddyByteAllocator]</span><br><span class="line">    D --&gt;|tlsf| G[TlsfByteAllocator]</span><br><span class="line">    </span><br><span class="line">    C --&gt; H[[BitmapPageAllocator]]</span><br><span class="line">    H --&gt; I[allocator::Bitmap]</span><br><span class="line">    H --&gt; J[PAGE_SIZE&#x3D;4K]</span><br><span class="line">    </span><br><span class="line">    A --&gt;|实现| K[core::alloc::GlobalAlloc]</span><br><span class="line">    K --&gt; L[alloc&#x2F;dealloc]</span><br><span class="line">    </span><br><span class="line">    M[GlobalPage] --&gt;|使用| N[alloc_pages]</span><br><span class="line">    M --&gt;|使用| O[dealloc_pages]</span><br><span class="line">    N &amp; O --&gt; C</span><br><span class="line">    </span><br><span class="line">    style A fill:#f0f8ff,stroke:#4682b4</span><br><span class="line">    style D fill:#fffacd,stroke:#daa520</span><br><span class="line">    style H fill:#e6e6fa,stroke:#9370db</span><br><span class="line">    style K fill:#f5f5dc,stroke:#deb887</span><br><span class="line"></span><br><span class="line">    subgraph 分配器实现层</span><br><span class="line">        B</span><br><span class="line">        C</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph 算法选择层</span><br><span class="line">        D</span><br><span class="line">        E</span><br><span class="line">        F</span><br><span class="line">        G</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph 标准库接口</span><br><span class="line">        K</span><br><span class="line">        L</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph 物理页管理</span><br><span class="line">        H</span><br><span class="line">        I</span><br><span class="line">        J</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<h4 id="Data-Structure-1"><a href="#Data-Structure-1" class="headerlink" title="Data Structure"></a>Data Structure</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//！ It provides [`GlobalAllocator`], which implements the trait</span></span><br><span class="line"><span class="comment">//! [`core::alloc::GlobalAlloc`]. A static global variable of type</span></span><br><span class="line"><span class="comment">//! [`GlobalAllocator`] is defined with the `#[global_allocator]` attribute, to</span></span><br><span class="line"><span class="comment">//! be registered as the standard library’s default allocator.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">GlobalAllocator</span></span> &#123;</span><br><span class="line">    balloc: SpinNoIrq&lt;DefaultByteAllocator&gt;,</span><br><span class="line">    palloc: SpinNoIrq&lt;BitmapPageAllocator&lt;PAGE_SIZE&gt;&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>Bitmap</code>作为数据结构实现<a href="#0">页内存分配器</a>，使用<code>feature</code>选择使用<code>slab</code>，<code>buddy</code>，<code>tlfs</code>作为字节内存分配器,通过impl GlobalAlloc实现<code>alloc</code>和<code>dealloc</code>支持GlobalAllocator</p>
<h3 id="axmm"><a href="#axmm" class="headerlink" title="axmm"></a>axmm</h3><h4 id="abstract-graph-4"><a href="#abstract-graph-4" class="headerlink" title="abstract graph"></a>abstract graph</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[AddrSpace] --&gt; B[va_range: VirtAddrRange]</span><br><span class="line">    A --&gt; C[areas: MemorySet]</span><br><span class="line">    A --&gt; D[pt: PageTable]</span><br><span class="line">    </span><br><span class="line">    C --&gt; E[MemoryArea]</span><br><span class="line">    E --&gt; F[Backend]</span><br><span class="line">    </span><br><span class="line">    F --&gt; G[Linear]</span><br><span class="line">    F --&gt; H[Alloc]</span><br><span class="line">    </span><br><span class="line">    G --&gt;|固定偏移| I[物理地址计算]</span><br><span class="line">    H --&gt;|动态分配| J[axalloc全局分配器]</span><br><span class="line">    </span><br><span class="line">    A --&gt; K[页表操作]</span><br><span class="line">    K --&gt; L[page_table_multiarch]</span><br><span class="line">    </span><br><span class="line">    M[memory_addr] --&gt;|地址转换| A</span><br><span class="line">    N[memory_set] --&gt;|区域管理| C</span><br><span class="line">    </span><br><span class="line">    style A fill:#e6f3ff,stroke:#004c99</span><br><span class="line">    style F fill:#ffe6e6,stroke:#990000</span><br><span class="line">    style G fill:#e6ffe6,stroke:#009900</span><br><span class="line">    style H fill:#e6ffe6,stroke:#009900</span><br><span class="line">    style L fill:#fff2cc,stroke:#d6b656</span><br><span class="line"></span><br><span class="line">    subgraph axmm模块</span><br><span class="line">        A</span><br><span class="line">        B</span><br><span class="line">        C</span><br><span class="line">        D</span><br><span class="line">        E</span><br><span class="line">        F</span><br><span class="line">        G</span><br><span class="line">        H</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph 依赖crates</span><br><span class="line">        L</span><br><span class="line">        M</span><br><span class="line">        N</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<h4 id="Data-structure"><a href="#Data-structure" class="headerlink" title="Data structure"></a>Data structure</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// The virtual memory address space.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">AddrSpace</span></span> &#123;</span><br><span class="line">    va_range: VirtAddrRange,</span><br><span class="line">    areas: MemorySet&lt;Backend&gt;,          <span class="comment">// Backend is the method managing areas </span></span><br><span class="line">    pt: PageTable,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A unified enum type for different memory mapping backends.</span></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Backend</span></span> &#123;</span><br><span class="line">    <span class="comment">/// Linear mapping backend.</span></span><br><span class="line">    Linear &#123;</span><br><span class="line">        <span class="comment">/// `vaddr - paddr`.</span></span><br><span class="line">        pa_va_offset: <span class="built_in">usize</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">/// Allocation mapping backend.</span></span><br><span class="line">    Alloc &#123;</span><br><span class="line">        <span class="comment">/// Whether to populate the physical frames when creating the mapping.</span></span><br><span class="line">        populate: <span class="built_in">bool</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> MappingBackend <span class="keyword">for</span> Backend &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Addr</span></span> = VirtAddr;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Flags</span></span> = MappingFlags;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">PageTable</span></span> = PageTable;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>axmm</code>使用<code>AddrSpace</code>管理地址空间，<code>va_range</code>记录虚拟地址范围，areas通过<code>BtreeMap</code>管理虚拟地址范围内的已映射空间，每个area backend可以使用linear和alloc两种方式进行管理</p>
<h4 id="support-crates-1"><a href="#support-crates-1" class="headerlink" title="support crates"></a>support crates</h4><ul>
<li>memory_addr</li>
<li>memory_set</li>
<li>page_table_multiarch</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// axmm_crates/memory_addr</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">AddrRange</span></span>&lt;A: MemoryAddr&gt; &#123;</span><br><span class="line">    <span class="comment">/// The lower bound of the range (inclusive).</span></span><br><span class="line">    <span class="keyword">pub</span> start: A,</span><br><span class="line">    <span class="comment">/// The upper bound of the range (exclusive).</span></span><br><span class="line">    <span class="keyword">pub</span> end: A,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A range of virtual addresses [`VirtAddr`].</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">VirtAddrRange</span></span> = AddrRange&lt;VirtAddr&gt;;</span><br><span class="line"><span class="comment">/// A range of physical addresses [`PhysAddr`].</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">type</span> <span class="title">PhysAddrRange</span></span> = AddrRange&lt;PhysAddr&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Implement the `MemoryAddr` trait for any type that is `Copy`, `From&lt;usize&gt;`,</span></span><br><span class="line"><span class="comment">/// `Into&lt;usize&gt;`, and `Ord`.</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; MemoryAddr <span class="keyword">for</span> T <span class="keyword">where</span> T: <span class="built_in">Copy</span> + <span class="built_in">From</span>&lt;<span class="built_in">usize</span>&gt; + <span class="built_in">Into</span>&lt;<span class="built_in">usize</span>&gt; + <span class="built_in">Ord</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// axmm_crates/memory_set</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">MemorySet</span></span>&lt;B: MappingBackend&gt; &#123;</span><br><span class="line">    areas: BTreeMap&lt;B::Addr, MemoryArea&lt;B&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A memory area represents a continuous range of virtual memory with the same</span></span><br><span class="line"><span class="comment">/// flags.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The target physical memory frames are determined by [`MappingBackend`] and</span></span><br><span class="line"><span class="comment">/// may not be contiguous.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">MemoryArea</span></span>&lt;B: MappingBackend&gt; &#123;</span><br><span class="line">    va_range: AddrRange&lt;B::Addr&gt;,</span><br><span class="line">    flags: B::Flags,</span><br><span class="line">    backend: B,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// page_table_multiarch</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// A generic page table struct for 64-bit platform.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// It also tracks all intermediate level tables. They will be deallocated</span></span><br><span class="line"><span class="comment">/// When the [`PageTable64`] itself is dropped.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">PageTable64</span></span>&lt;M: PagingMetaData, PTE: GenericPTE, H: PagingHandler&gt; &#123;</span><br><span class="line">    root_paddr: PhysAddr,</span><br><span class="line">    _phantom: PhantomData&lt;(M, PTE, H)&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="axtask"><a href="#axtask" class="headerlink" title="axtask"></a>axtask</h3><p>任务管理模块，定义内核的调度单元结构，并且实现了任务调度的相关功能，如任务创建、任务切换、任务唤醒等。它是内核的核心模块，负责 管理和调度所有的任务</p>
<h4 id="abstract-graph-5"><a href="#abstract-graph-5" class="headerlink" title="abstract graph"></a>abstract graph</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    %% 核心结构</span><br><span class="line">    AxTask[&quot;AxTask (Wrapper)&quot;]</span><br><span class="line">    TaskInner[&quot;TaskInner (核心任务结构)&quot;]</span><br><span class="line">    AxTaskRef[&quot;AxTaskRef (Arc&lt;AxTask&gt;)&quot;]</span><br><span class="line">    TaskExt[&quot;AxTaskExt (任务扩展数据)&quot;]</span><br><span class="line">    </span><br><span class="line">    %% 队列和调度器</span><br><span class="line">    RunQueue[&quot;AxRunQueue (运行队列)&quot;]</span><br><span class="line">    WaitQueue[&quot;WaitQueue (等待队列)&quot;]</span><br><span class="line">    Scheduler[&quot;Scheduler (调度器)&quot;]</span><br><span class="line">    </span><br><span class="line">    %% 调度器实现</span><br><span class="line">    FIFO[&quot;FIFO调度器 (不可抢占)&quot;]</span><br><span class="line">    RR[&quot;RR调度器 (可抢占)&quot;]</span><br><span class="line">    CFS[&quot;CFS调度器 (可抢占)&quot;]</span><br><span class="line">    </span><br><span class="line">    %% 定时器相关</span><br><span class="line">    TimerList[&quot;timer_list (最小堆事件管理)&quot;]</span><br><span class="line">    Timers[&quot;timers模块 (定时器管理)&quot;]</span><br><span class="line">    </span><br><span class="line">    %% 关系连接</span><br><span class="line">    TaskInner --&gt;|包含| TaskExt</span><br><span class="line">    AxTask --&gt;|封装| TaskInner</span><br><span class="line">    AxTaskRef --&gt;|Arc包装| AxTask</span><br><span class="line">    </span><br><span class="line">    RunQueue --&gt;|管理| AxTaskRef</span><br><span class="line">    RunQueue --&gt;|使用| Scheduler</span><br><span class="line">    </span><br><span class="line">    Scheduler --&gt;|根据feature选择| FIFO</span><br><span class="line">    Scheduler --&gt;|根据feature选择| RR</span><br><span class="line">    Scheduler --&gt;|根据feature选择| CFS</span><br><span class="line">    </span><br><span class="line">    WaitQueue --&gt;|存储阻塞| AxTaskRef</span><br><span class="line">    WaitQueue --&gt;|唤醒时通过| RunQueue</span><br><span class="line">    </span><br><span class="line">    Timers --&gt;|使用| TimerList</span><br><span class="line">    Timers --&gt;|设置任务timer_ticket_id| TaskInner</span><br><span class="line">    TaskInner --&gt;|timer_ticket_id标识定时事件| Timers</span><br><span class="line">    </span><br><span class="line">    %% 功能流程</span><br><span class="line">    InitScheduler[&#x2F;&quot;init_scheduler()&quot;&#x2F;]</span><br><span class="line">    InitScheduler --&gt;|创建| RunQueue</span><br><span class="line">    RunQueue --&gt;|初始化| IdleTask[&#x2F;&quot;idle task&quot;&#x2F;]</span><br><span class="line">    RunQueue --&gt;|初始化| MainTask[&#x2F;&quot;main task&quot;&#x2F;]</span><br><span class="line">    </span><br><span class="line">    %% 任务状态转换</span><br><span class="line">    TaskState&#123;&#123;&quot;任务状态&quot;&#125;&#125;</span><br><span class="line">    TaskState --&gt;|Running| Running[&quot;运行中&quot;]</span><br><span class="line">    TaskState --&gt;|Ready| Ready[&quot;就绪&quot;]</span><br><span class="line">    TaskState --&gt;|Blocked| Blocked[&quot;阻塞&quot;]</span><br><span class="line">    TaskState --&gt;|Exited| Exited[&quot;已退出&quot;]</span><br><span class="line">    </span><br><span class="line">    %% 定时器和中断处理</span><br><span class="line">    InterruptHandler[&quot;中断处理&quot;]</span><br><span class="line">    InterruptHandler --&gt;|时钟中断| Timers</span><br><span class="line">    Timers --&gt;|超时唤醒| AxTaskRef</span><br><span class="line">    </span><br><span class="line">    %% SMP支持</span><br><span class="line">    SMP[&quot;SMP支持&quot;]</span><br><span class="line">    SMP --&gt;|多核调度| RunQueue</span><br><span class="line">    RunQueue --&gt;|任务迁移| MigrateTask[&quot;任务迁移&quot;]</span><br><span class="line">    </span><br><span class="line">    %% 抢占支持</span><br><span class="line">    Preemption[&quot;抢占机制&quot;]</span><br><span class="line">    RR --&gt;|时间片耗尽| Preemption</span><br><span class="line">    CFS --&gt;|更高优先级任务| Preemption</span><br><span class="line">    Preemption --&gt;|设置need_resched| TaskInner</span><br><span class="line">    </span><br><span class="line">    %% 任务等待和唤醒</span><br><span class="line">    WaitTimeout[&quot;wait_timeout()&quot;]</span><br><span class="line">    WaitTimeout --&gt;|设置超时| Timers</span><br><span class="line">    WaitTimeout --&gt;|阻塞任务| WaitQueue</span><br><span class="line">    Notify[&quot;notify_one&#x2F;all()&quot;]</span><br><span class="line">    Notify --&gt;|唤醒任务| WaitQueue</span><br><span class="line">    WaitQueue --&gt;|取消定时器| Timers</span><br></pre></td></tr></table></figure>

<h4 id="Data-structure-1"><a href="#Data-structure-1" class="headerlink" title="Data structure"></a>Data structure</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task.rs</span></span><br><span class="line"><span class="comment">/// The inner task structure.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">TaskInner</span></span> &#123;</span><br><span class="line">    id: TaskId,</span><br><span class="line">    name: UnsafeCell&lt;<span class="built_in">String</span>&gt;,</span><br><span class="line">    is_idle: <span class="built_in">bool</span>,</span><br><span class="line">    is_init: <span class="built_in">bool</span>,</span><br><span class="line"></span><br><span class="line">    entry: <span class="built_in">Option</span>&lt;*<span class="keyword">mut</span> <span class="keyword">dyn</span> <span class="built_in">FnOnce</span>()&gt;,</span><br><span class="line">    state: AtomicU8,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// CPU affinity mask.</span></span><br><span class="line">    cpumask: SpinNoIrq&lt;AxCpuMask&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Mark whether the task is in the wait queue.</span></span><br><span class="line">    in_wait_queue: AtomicBool,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Used to indicate whether the task is running on a CPU.</span></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="meta-string">"smp"</span>)]</span></span><br><span class="line">    on_cpu: AtomicBool,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A ticket ID used to identify the timer event.</span></span><br><span class="line">    <span class="comment">/// Set by `set_timer_ticket()` when creating a timer event in `set_alarm_wakeup()`,</span></span><br><span class="line">    <span class="comment">/// expired by setting it as zero in `timer_ticket_expired()`, which is called by `cancel_events()`.</span></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="meta-string">"irq"</span>)]</span></span><br><span class="line">    timer_ticket_id: AtomicU64,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="meta-string">"preempt"</span>)]</span></span><br><span class="line">    need_resched: AtomicBool,</span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="meta-string">"preempt"</span>)]</span></span><br><span class="line">    preempt_disable_count: AtomicUsize,</span><br><span class="line"></span><br><span class="line">    exit_code: AtomicI32,</span><br><span class="line">    wait_for_exit: WaitQueue,</span><br><span class="line"></span><br><span class="line">    kstack: <span class="built_in">Option</span>&lt;TaskStack&gt;,</span><br><span class="line">    ctx: UnsafeCell&lt;TaskContext&gt;,</span><br><span class="line">    task_ext: AxTaskExt,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="meta-string">"tls"</span>)]</span></span><br><span class="line">    tls: TlsArea,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// runqueue.rs</span></span><br><span class="line">percpu_static! &#123;</span><br><span class="line">    RUN_QUEUE: LazyInit&lt;AxRunQueue&gt; = LazyInit::new(),</span><br><span class="line">    EXITED_TASKS: VecDeque&lt;AxTaskRef&gt; = VecDeque::new(),</span><br><span class="line">    WAIT_FOR_EXIT: WaitQueue = WaitQueue::new(),</span><br><span class="line">    IDLE_TASK: LazyInit&lt;AxTaskRef&gt; = LazyInit::new(),</span><br><span class="line">    <span class="comment">/// Stores the weak reference to the previous task that is running on this CPU.</span></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="meta-string">"smp"</span>)]</span></span><br><span class="line">    PREV_TASK: Weak&lt;crate::AxTask&gt; = Weak::new(),</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// [`AxRunQueue`] represents a run queue for global system or a specific CPU.</span></span><br><span class="line"><span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="class"><span class="keyword">struct</span> <span class="title">AxRunQueue</span></span> &#123;</span><br><span class="line">    <span class="comment">/// The ID of the CPU this run queue is associated with.</span></span><br><span class="line">    cpu_id: <span class="built_in">usize</span>,</span><br><span class="line">    <span class="comment">/// The core scheduler of this run queue.</span></span><br><span class="line">    <span class="comment">/// Since irq and preempt are preserved by the kernel guard hold by `AxRunQueueRef`,</span></span><br><span class="line">    <span class="comment">/// we just use a simple raw spin lock here.</span></span><br><span class="line">    scheduler: SpinRaw&lt;Scheduler&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// waitqueue.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">WaitQueue</span></span> &#123;</span><br><span class="line">    queue: SpinNoIrq&lt;VecDeque&lt;AxTaskRef&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="class"><span class="keyword">type</span> <span class="title">WaitQueueGuard</span></span>&lt;<span class="symbol">'a</span>&gt; = SpinNoIrqGuard&lt;<span class="symbol">'a</span>, VecDeque&lt;AxTaskRef&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>初始化时<code>init_scheduler</code>首先初始化运行队列，运行队列初始化一个idle task和一个main task，他们一个作为空闲系统任务,一个作为系统主逻辑入口,<a href="#2">工作流程</a></p>
<p>根据feature对每个task使用对应调度方法封装为节点axtask，使用对应scheduler进行调度<code>fifo</code>为不可抢占，<code>rr</code>和<code>cfs</code>为可抢占</p>
<p>中断：main arceos的中断与tutorial类似但是框架组织有所差别使其能够支持smp，tutorial将time_slice直接嵌入在taskinner中，main arceos将其封装为timer_list dependence crate和timer mod，其中timer_list使用最小堆管理事件，timer mod对其功能进行封装，使用timer_ticket_id标示定时器</p>
<p>抢占：根据不同的scheduler进行抢占设置</p>
<h4 id="support-crates-2"><a href="#support-crates-2" class="headerlink" title="support crates"></a>support crates</h4><ul>
<li>timer_list</li>
<li>scheduler</li>
</ul>
<h3 id="axdriver"><a href="#axdriver" class="headerlink" title="axdriver"></a>axdriver</h3><p>驱动管理模块，负责接入不同来源的设备，并为用户提供统一的驱 动功能调用接口，如块设备、网络设备和显示设备</p>
<h4 id="abstract-graph-6"><a href="#abstract-graph-6" class="headerlink" title="abstract graph"></a>abstract graph</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[应用层] --&gt;|调用| B[init_drivers]</span><br><span class="line">    B --&gt; C[AllDevices::probe]</span><br><span class="line">    C --&gt; D[全局设备探测]</span><br><span class="line">    C --&gt; E[总线设备探测]</span><br><span class="line">    </span><br><span class="line">    D --&gt;|for_each_drivers!宏| F[DriverProbe::probe_global]</span><br><span class="line">    E --&gt;|PCI&#x2F;MMIO| G[bus模块探测]</span><br><span class="line">    </span><br><span class="line">    subgraph axdriver核心结构</span><br><span class="line">        B --&gt; H[AllDevices]</span><br><span class="line">        H --&gt; I[AxDeviceContainer&lt;AxNetDevice&gt;]</span><br><span class="line">        H --&gt; J[AxDeviceContainer&lt;AxBlockDevice&gt;]</span><br><span class="line">        H --&gt; K[AxDeviceContainer&lt;AxDisplayDevice&gt;]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph 设备容器实现</span><br><span class="line">        I --&gt;|dyn启用| L[Vec&lt;Box&lt;dyn NetDriverOps&gt;&gt;]</span><br><span class="line">        I --&gt;|静态类型| M[Option&lt;具体网卡类型&gt;]</span><br><span class="line">        J --&gt;|dyn启用| N[Vec&lt;Box&lt;dyn BlockDriverOps&gt;&gt;]</span><br><span class="line">        J --&gt;|静态类型| O[Option&lt;具体块设备类型&gt;]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph 驱动注册</span><br><span class="line">        F --&gt; P[register_net_driver!]</span><br><span class="line">        F --&gt; Q[register_block_driver!]</span><br><span class="line">        P --&gt; R[VirtioNet&#x2F;Ixgbe&#x2F;FXmac]</span><br><span class="line">        Q --&gt; S[VirtioBlk&#x2F;RamDisk]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    G --&gt;|PCI总线扫描| T[pci.rs]</span><br><span class="line">    G --&gt;|MMIO设备树解析| U[mmio.rs]</span><br><span class="line">    T --&gt; V[配置PCI BAR空间]</span><br><span class="line">    U --&gt; W[映射MMIO区域]</span><br><span class="line">    </span><br><span class="line">    style B fill:#e6f3ff,stroke:#004c99</span><br><span class="line">    style H fill:#e6f3ff,stroke:#004c99</span><br><span class="line">    style I fill:#e6f3ff,stroke:#004c99</span><br><span class="line">    style T fill:#ffe6e6,stroke:#990000</span><br><span class="line">    style U fill:#ffe6e6,stroke:#990000</span><br></pre></td></tr></table></figure>

<h4 id="Data-structure-2"><a href="#Data-structure-2" class="headerlink" title="Data structure"></a>Data structure</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A structure that contains all device drivers, organized by their category.</span></span><br><span class="line"><span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">AllDevices</span></span> &#123;</span><br><span class="line">    <span class="comment">/// All network device drivers.</span></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="meta-string">"net"</span>)]</span></span><br><span class="line">    <span class="keyword">pub</span> net: AxDeviceContainer&lt;AxNetDevice&gt;,</span><br><span class="line">    <span class="comment">/// All block device drivers.</span></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="meta-string">"block"</span>)]</span></span><br><span class="line">    <span class="keyword">pub</span> block: AxDeviceContainer&lt;AxBlockDevice&gt;,</span><br><span class="line">    <span class="comment">/// All graphics device drivers.</span></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="meta-string">"display"</span>)]</span></span><br><span class="line">    <span class="keyword">pub</span> display: AxDeviceContainer&lt;AxDisplayDevice&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">AxDeviceContainer</span></span>&lt;D&gt;(<span class="built_in">Option</span>&lt;D&gt;)  <span class="comment">// static</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">AxDeviceContainer</span></span>&lt;D&gt;(<span class="built_in">Vec</span>&lt;D&gt;)  <span class="comment">// dyn</span></span><br></pre></td></tr></table></figure>

<p><code>AxDeviceContainer</code>包含特定类别的设备驱动结构体。如果启用了 <code>dyn</code> 功能，则内部类型为 [<code>Vec&lt;D&gt;</code>]。否则内部类型为 [<code>Option&lt;D&gt;</code>]，并且最多可包含一个设备;static静态分发的类型定义通过<code>register_drivers</code>宏实现，dyn动态分发的类型定义通过Box封装trait对象</p>
<p>初始化时先使用<code>for each drivers</code>和<code>probe_global</code>初始化全局设备驱动，再通过<code>self.probe_bus_devices()</code>初始化总线设备</p>
<blockquote>
<p>[!CAUTION]</p>
<p>静态分发 (static.rs)</p>
<ul>
<li><p>使用具体类型：type AxNetDevice = 特定设备类型</p>
</li>
<li><p>一个类别最多只能有一个设备：AxDeviceContainer<D>(Option<D>)</p>
</li>
<li><p>编译时确定，性能更好，但灵活性低</p>
</li>
</ul>
<p>动态分发 (dyn.rs)</p>
<ul>
<li><p>使用trait对象：type AxNetDevice = Box<dyn NetDriverOps></p>
</li>
<li><p>支持多个同类设备：AxDeviceContainer<D>(Vec<D>)</p>
</li>
<li><p>运行时多态，更灵活但有性能开销</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>特征</th>
<th>全局设备</th>
<th>总线设备</th>
</tr>
</thead>
<tbody><tr>
<td>硬件连接方式</td>
<td>板载集成</td>
<td>通过PCI/PCIe/USB等总线连接</td>
</tr>
<tr>
<td>地址发现机制</td>
<td>固定地址或配置文件指定</td>
<td>通过总线枚举发现</td>
</tr>
<tr>
<td>典型设备示例</td>
<td>RAM磁盘、GPIO控制器</td>
<td>网卡、显卡、USB控制器</td>
</tr>
<tr>
<td>热插拔支持</td>
<td>不支持</td>
<td>支持（依赖总线类型）</td>
</tr>
<tr>
<td>代码复杂度</td>
<td>较低（直接初始化）</td>
<td>较高（需要处理总线协议）</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>特征</th>
<th>MMIO</th>
<th>PCI</th>
</tr>
</thead>
<tbody><tr>
<td>发现机制</td>
<td>预定义内存区域扫描</td>
<td>总线枚举+配置空间读取</td>
</tr>
<tr>
<td>地址分配</td>
<td>固定物理地址</td>
<td>动态分配BAR空间</td>
</tr>
<tr>
<td>配置方式</td>
<td>直接内存读写</td>
<td>通过配置空间寄存器</td>
</tr>
<tr>
<td>典型应用场景</td>
<td>嵌入式系统/VirtIO虚拟设备</td>
<td>物理服务器/标准PC硬件</td>
</tr>
<tr>
<td>设备识别</td>
<td>魔数检查（如0x74726976=”virt”）</td>
<td>厂商ID+设备ID检查</td>
</tr>
<tr>
<td>中断配置</td>
<td>通常固定中断号</td>
<td>MSI/MSI-X动态中断分配</td>
</tr>
</tbody></table>
</blockquote>
<h4 id="support-crates-3"><a href="#support-crates-3" class="headerlink" title="support crates"></a>support crates</h4><ul>
<li>axdriver_base</li>
</ul>
<h3 id="axfs"><a href="#axfs" class="headerlink" title="axfs"></a>axfs</h3><p>文件系统模块，负责接入不同来源的文件系统，并为用户提供统一的 文件系统功能调用接口，如文件读写、目录操作等。</p>
<h4 id="abstract-graph-7"><a href="#abstract-graph-7" class="headerlink" title="abstract graph"></a>abstract graph</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[应用层] --&gt;|系统调用| B(api模块)</span><br><span class="line">    B --&gt;|封装操作| C(fops模块)</span><br><span class="line">    C --&gt;|路径解析| D(root模块)</span><br><span class="line">    D --&gt;|主文件系统| E1(fatfs&#x2F;lwext4)</span><br><span class="line">    D --&gt;|挂载管理| E2(devfs)</span><br><span class="line">    D --&gt;|挂载管理| E3(ramfs)</span><br><span class="line">    D --&gt;|挂载管理| E4(procfs)</span><br><span class="line">    E1 --&gt;|块设备操作| F(dev模块)</span><br><span class="line">    E2 --&gt;|虚拟设备| F</span><br><span class="line">    E3 --&gt;|内存管理| F</span><br><span class="line">    C --&gt;|权限检查| G[Capability系统]</span><br><span class="line">    D --&gt;|VFS接口| H[VFS抽象层]</span><br><span class="line">    H --&gt;|具体实现| E1</span><br><span class="line">    H --&gt;|具体实现| E2</span><br><span class="line">    H --&gt;|具体实现| E3</span><br><span class="line">    F --&gt;|硬件交互| I[块设备驱动]</span><br><span class="line">    </span><br><span class="line">    classDef box fill:#e6f3ff,stroke:#004c99;</span><br><span class="line">    class A,B,C,D,E1,E2,E3,E4,F,G,H,I box;</span><br></pre></td></tr></table></figure>

<h4 id="Data-structure-3"><a href="#Data-structure-3" class="headerlink" title="Data structure"></a>Data structure</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// root.rs</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MountPoint</span></span> &#123;</span><br><span class="line">    path: &amp;<span class="symbol">'static</span> <span class="built_in">str</span>,</span><br><span class="line">    fs: Arc&lt;<span class="keyword">dyn</span> VfsOps&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RootDirectory</span></span> &#123;</span><br><span class="line">    main_fs: Arc&lt;<span class="keyword">dyn</span> VfsOps&gt;,</span><br><span class="line">    mounts: RwLock&lt;<span class="built_in">Vec</span>&lt;MountPoint&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> ROOT_DIR: LazyInit&lt;Arc&lt;RootDirectory&gt;&gt; = LazyInit::new()</span><br><span class="line"></span><br><span class="line"><span class="comment">// dev.rs</span></span><br><span class="line"><span class="comment">/// A disk device with a cursor.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Disk</span></span> &#123;</span><br><span class="line">    block_id: <span class="built_in">u64</span>,</span><br><span class="line">    offset: <span class="built_in">usize</span>,</span><br><span class="line">    dev: AxBlockDevice,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fops.rs</span></span><br><span class="line"><span class="comment">/// An opened file object, with open permissions and a cursor.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">File</span></span> &#123;</span><br><span class="line">    node: WithCap&lt;VfsNodeRef&gt;,</span><br><span class="line">    is_append: <span class="built_in">bool</span>,</span><br><span class="line">    offset: <span class="built_in">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// An opened directory object, with open permissions and a cursor for</span></span><br><span class="line"><span class="comment">/// [`read_dir`](Directory::read_dir).</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Directory</span></span> &#123;</span><br><span class="line">    node: WithCap&lt;VfsNodeRef&gt;,</span><br><span class="line">    entry_idx: <span class="built_in">usize</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>axfs基于axdriver初始化得到的块设备进行初始化，根据指定的feature初始化ROOT_DIR,再基于已经实现的devfs<br>ramfs  procfs在根目录挂载一些初始目录</p>
<p>具体的文件系统实现基于已经实现的axfs_vfs crates,其提供了对文件操作VfsOps和VfsNodeOps的上层抽象，再通过复用已有的文件系统，并对其封装vfs操作，使其适配arceos</p>
<p>具体核心操作抽象层,具体实现在fops.rs中，其定义了<code>struct file</code> 和 <code>struct directory</code>向上提供标准API，向下对接具体文件系统实现是文件系统的核心枢纽</p>
<h4 id="support-crates-4"><a href="#support-crates-4" class="headerlink" title="support crates"></a>support crates</h4><ul>
<li>axfs_vfs</li>
<li>axfs_devfs</li>
<li>axfs_ramfs</li>
<li>fatfs</li>
<li>lwext4_rust</li>
</ul>
<h3 id="axnet"><a href="#axnet" class="headerlink" title="axnet"></a>axnet</h3><p>网络兼容模块，通过调用网络设备的功能，来实现网络协议栈对内核 的兼容，并为上层提供统一的网络功能调用接口。</p>
<h3 id="axdma"><a href="#axdma" class="headerlink" title="axdma"></a>axdma</h3><p>提供符合DMA硬件要求的物理连续、缓存一致的内存区域。DMA控制器需直接访问物理连续的内存块，确保无需CPU分页即可传输数据。同时处理CPU虚拟地址、物理地址与设备总线地址之间的映射关系。为ixgbe等驱动的实现提供支持</p>
<h3 id="axsync"><a href="#axsync" class="headerlink" title="axsync"></a>axsync</h3><p>同步原语模块，它基于 axtask 模块，提供了对内核的同步原语的支 持，如信号量、互斥锁、读写锁等</p>
<h4 id="support-crates-5"><a href="#support-crates-5" class="headerlink" title="support crates"></a>support crates</h4><ul>
<li>kspin</li>
</ul>
<h3 id="axlog-1"><a href="#axlog-1" class="headerlink" title="axlog"></a>axlog</h3><p>日志组件</p>
<h3 id="Appendix-A-Makefile"><a href="#Appendix-A-Makefile" class="headerlink" title="Appendix A: Makefile"></a>Appendix A: Makefile</h3><h3 id="Appendix-B-Linker-lds-S"><a href="#Appendix-B-Linker-lds-S" class="headerlink" title="Appendix B: Linker.lds.S"></a>Appendix B: Linker.lds.S</h3><table>
<thead>
<tr>
<th align="left">段名</th>
<th align="left">内容</th>
<th align="left">起始符号</th>
<th align="left">结束符号</th>
<th align="left">对齐</th>
</tr>
</thead>
<tbody><tr>
<td align="left">.text</td>
<td align="left">代码（指令）</td>
<td align="left"><code>_stext</code></td>
<td align="left"><code>_etext</code></td>
<td align="left">4KB</td>
</tr>
<tr>
<td align="left">.rodata</td>
<td align="left">只读数据</td>
<td align="left"><code>_srodata</code></td>
<td align="left"><code>_erodata</code></td>
<td align="left">4KB</td>
</tr>
<tr>
<td align="left">.init_array</td>
<td align="left">初始化函数数组</td>
<td align="left"><code>__init_array_start</code></td>
<td align="left"><code>__init_array_end</code></td>
<td align="left">16B</td>
</tr>
<tr>
<td align="left">.data</td>
<td align="left">已初始化数据</td>
<td align="left"><code>_sdata</code></td>
<td align="left"><code>_edata</code></td>
<td align="left">4KB</td>
</tr>
<tr>
<td align="left">.tdata/.tbss</td>
<td align="left">线程本地存储</td>
<td align="left"><code>_stdata</code>/<code>_stbss</code></td>
<td align="left"><code>_etdata</code>/<code>_etbss</code></td>
<td align="left">16B</td>
</tr>
<tr>
<td align="left">.percpu</td>
<td align="left">每 CPU 数据</td>
<td align="left"><code>_percpu_start</code></td>
<td align="left"><code>_percpu_end</code></td>
<td align="left">64B</td>
</tr>
<tr>
<td align="left">.bss</td>
<td align="left">未初始化数据 + 启动栈</td>
<td align="left"><code>_sbss</code></td>
<td align="left"><code>_ebss</code></td>
<td align="left">4KB</td>
</tr>
</tbody></table>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/author-Anekoique/" rel="tag"># author:Anekoique</a>
              <a href="/blog/tags/repo-https-github-com-Anekoique-ArceOS-Record-github/" rel="tag"># repo:https://github.com/Anekoique/ArceOS-Record.github</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/2025/04/22/zhouyuhan-stage2-and-stage-3/" rel="prev" title="zhouyuhan-stage2 and stage 3">
      <i class="fa fa-chevron-left"></i> zhouyuhan-stage2 and stage 3
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/2025/04/24/451846939-rcore-2025-reports/" rel="next" title="451846939-rcore-2025-reports">
      451846939-rcore-2025-reports <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rcore-os Group</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>


  















  

  

  

</body>
</html>
